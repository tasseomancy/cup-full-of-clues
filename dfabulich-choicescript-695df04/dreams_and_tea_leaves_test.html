<!DOCTYPE html>
<html>
<!--
Copyright 2010 by Dan Fabulich.

Dan Fabulich licenses this file to you under the
ChoiceScript License, Version 1.0 (the "License"); you may
not use this file except in compliance with the License. 
You may obtain a copy of the License at

 http://www.choiceofgames.com/LICENSE-1.0.txt

See the License for the specific language governing
permissions and limitations under the License.

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied.
-->
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name = "viewport" content = "width = device-width, initial-scale = 1.0, maximum-scale = 1.0">
<!-- INSERT correct meta values -->
<!-- <title>Dreams and Tea Leaves</title> -->

<script>window.version="UNKNOWN"</script>










<!--[if IE 6]><style>.alertify-logs { position: absolute; }</style><![endif]-->
<meta name="apple-mobile-web-app-capable" content="yes" />
<script>
// INSERT store name; disabled by default because it's confusing for newbie authors
window.storeName = null;
//Scene.generatedFast = true;
var rootDir = "../";
</script><script>allScenes = {"startup": {"crc":21221882, "lines":["*comment Copyright 2016 by Alice Leung\r","*comment \r","\r","*title Dreams and Tea Leaves\r","*author Alyse Leung\r","*scene_list\r","\tinterview\r","\tpostinterview\r","\tdivination_style\r","\tjob_offer\r","\tmeet_boss\r","\tmeet_team\r","\tcase_1_suspects\r","\tcase_1_investigation\r","\tcase_1_resolution\r","\tcolleague_dinner\r","\tmorning_2\r","\taccidental_disclosure\r","\tintro_case_2\r","\tcase_2_suspects\r","\tawkward_coffee\r","\tcase_2_evaluation\r","\tawkward_dinner\r","\tmouse_dream\r","\tcase_2_identities\r","\tcase_2_asides\r","\tcase_2_investigation\r","\tcase_2_resolution\r","\tanxiety_dream\r","\tjob_outcome\r","\thousemate_outcome\r","\tlast_dream\r","\r","*comment These are your stats\r","*comment the idea in this story is that you reveal your beliefs, rather than increasing your skills\r","*comment so it's not so much that you earn stat points, but that you expose more of yourself and this affects your story\r","*create boss_regard 0\r","*create resist_colleague 0\r","*comment may not need diligence if it's similar to boss regard, being success at the job?\r","*create diligence 0\r","*create housemate_relationship 0\r","*create history 0\r","*comment history is about how much you rely on the past for signs of the future\r","*create interaction 0\r","*comment interaction is about how much you rely on interogating people to find out stuff\r","*create soul 0\r","*comment soul is about introversion and looking deeply in yourself because you know the answers\r","*create rumor 0\r","*comment rumor is about finding out stuff by listening to what people say about each other\r","*comment These are for gender personalization\r","*comment p is the main character\r","*create phe \"she\"\r","*create phis \"her\"\r","*create phim \"her\"\r","*create pMr \"Ms\"\r","*create egirlfriend \"girlfriend\"\r","*create pgirlfriend \"girlfriend\"\r","*comment e is your ex\r","*create ehe \"she\"\r","*create ehis \"her\"\r","*create ehim \"her\"\r","*comment i is someone who is interested in you\r","*create ihe \"he\"\r","*create ihis \"his\"\r","*create ihim \"him\"\r","*create iman \"man\"\r","*create iguy \"guy\"\r","*comment This is for your divination dream object, a bell, a mirror, a bowl, or a stuffed bunny\r","*create dream_object \"bell\"\r","*comment This is for testing, so you can skip scenes\r","*create skip false\r","*comment These are for keeping track of what order you investigate Case 1 suspects\r","*create investigate_1 \"Jason\"\r","*create investigate_2 \"Monica\"\r","*create investigate_3 \"Tonya\"\r","*create investigate_4 \"Van\"\r","*create investigate_5 \"Zenina\"\r","*comment This is if you decided to investigate them in a random order\r","*create did_random false\r","*comment These are to track if you read the Case 1 suspect files for each person\r","*create read_Monica false\r","*create read_Tonya false\r","*create read_Van false\r","*create read_Zenina false\r","*comment These are to track your conclusion about each Case 1 suspect. \r","*comment 0=no meaning\r","*comment 1=wrong doing SEKA right, 2=problem behavior SEKA right, 3=odd behavior SEKA wrong, 4=totally normal SEKA wrong\r","*create Jason_choice 0\r","*create Monica_choice 0\r","*create Tonya_choice 0\r","*create Van_choice 0\r","*create Zenina_choice 0\r","*comment This is to track how you reacted to a fancy dinner invite from your colleague\r","*comment 1=refuse, 2=invite to your cookout, 3=agree, 4=agree if you split the check\r","*create pickup_choice 4\r","*comment These are to track your decision about Case 2 suspects\r","*comment A is Jamie, C is Edgar\r","*comment 0=no meaning, 1=investigate, 2=drop investigation\r","*comment This is relevant later, because it impacts whether you get assigned to investigate Jamie or Edgar\r","*create A_choice 2\r","*create B_choice 0\r","*create C_choice 1\r","*comment These are to track your decision about who is the most likely insider threat or innocent in Case 2\r","*comment A=Jamie, B=other guy, C=Edgar \r","*create case_2_insider \"None\"\r","*create case_2_innocent \"None\"\r","*comment This is to track how you decide to handle Jamie's issues with his current SO (Bobby) living with an ex (you)\r","*comment 1=recommend Bobby move in with Jamie, 2=recommend Jamie move in with both of you\r","*comment 3=you camp out at work, 4=you move in with Jamie\r","*comment Bobby rejects 1 & 3, so you end up going with 2 or 4\r","*create housemate_choice 2\r","*comment This is to track if you snooped through Jamie's stuff during the moving around\r","*comment 1=snooped, 0=did not\r","*create snooped 0\r","*comment This is to track your intent in Case 2\r","*comment 1=protect Jamie, 2=do the best investigation you can, \r","*comment 3=avoid awkwardness with Bobby or Jamie, 4=get Jamie in trouble\r","*create case_2_goal 1\r","*create case_2_accuse \"None\"\r","*comment accuse \"Margot\" or \"Rene\" or \"Jamie\" or \"Edgar\"\r","*comment these are for tracking your dreams\r","*create show_dream_1 false\r","*create show_dream_2 false\r","*create show_dream_3 false\r","*create show_dream_4 false\r","*create show_dream_5 false\r","*create dream_1_description \"\"\r","*create dream_2_description \"\"\r","*create dream_3_description \"\"\r","*create dream_4_description \"\"\r","*create dream_5_description \"\"\r","\r","Welcome to Dreams and Tea Leaves!\r","\r","This is a story you'll play like a game.\r","\r","Before this story can get started, you\u2019ll need to make some choices about the main character, \r","the person you'll inhabit for a few days.\r","\r","*page_break\r","*if skip\r","\t*finish\r","What gender would you like to play?\r","*choice\r","\t#female \r","\t\t*goto ex\r","\t#male\r","\t\t*set phe \"he\"\r","\t\t*set phis \"his\"\r","\t\t*set phim \"him\"\r","\t\t*set pMr \"Mr\"\r","\t\t*set pgirlfriend \"boyfriend\"\r","\t\t*goto ex\r","\t#none of the above\r","\t\t*set phe \"they\"\r","\t\t*set phis \"their\"\r","\t\t*set phim \"them\"\r","\t\t*set pMr \"Mx\"\r","\t\t*set pgirlfriend \"significant other\"\r","\t\t*goto ex\r","\r","*label ex\r","There\u2019s a person you\u2019ve dated before. What gender are they?\r","*choice\r","\t#female \r","\t\t*goto interest\r","\t#male\r","\t\t*set egirlfriend \"boyfriend\"\r","\t\t*set ehe \"he\"\r","\t\t*set ehis \"his\"\r","\t\t*set ehim \"him\"\r","\t\t*goto interest\r","\r","*label interest\r","There\u2019s a person who may flirt with you. What gender are they?\r","*choice\r","\t#female \r","\t\t*set ihe \"she\"\r","\t\t*set ihis \"her\"\r","\t\t*set ihim \"her\"\r","\t\t*set iman \"woman\"\r","\t\t*set iguy \"gal\"\r","\t\t*goto magic\r","\t#male\r","\t\t*goto magic\r","\r","*label magic\r","Do you believe in magic?\r","*fake_choice\r","\t#yes\r","\t\tIndeed, the world can be hard to explain by science alone.\r","\t#no\r","\t\tYou'll find that sometimes, it doesn\u2019t matter whether you believe or not.\r","*finish"], "labels":{"ex":161,"interest":173,"magic":186}},"choicescript_stats": {"crc":-713832373, "lines":["[b]Dream Journal[/b]\r","\r","Mom gave me this journal five years ago, but I could never come up with anything to write about. Apparently, keeping a dream journal is supposed to help you 'get in touch' with your 'intuitive side'. Guess I'll give it a try.\r","\r","*if (show_dream_1)\r","\t${dream_1_description}\r","\t*goto dream2\r","*label dream2\r","\r","*if (show_dream_2)\r","\t${dream_2_description}\r","\t*goto dream3\r","*label dream3\r","\r","*if (show_dream_3)\r","\t${dream_3_description}\r","\t*goto dream4\r","*label dream4\r","\r","*if (show_dream_4)\r","\t${dream_4_description}\r","\t*goto dream5\r","*label dream5\r","\t\r","*if (show_dream_5)\r","\t${dream_5_description}\r","\t*finish"], "labels":{"dream2":7,"dream3":12,"dream4":17,"dream5":22}},"choicescript_upgrade": {"crc":0, "lines":[""], "labels":{}},"interview": {"crc":1029427471, "lines":["*if skip\r","\t*finish\r","If you weren\u2019t so desperate to finally land a job, you wouldn\u2019t be here with your cheek muscles sore from a day of fake-smiling. [i]Surely they won\u2019t keep asking questions all night, will they?[/i]\r","\r","The neatly dressed representative from Ubiquity\u2019s human resources department looks at the clock and closes her notebook. \u201cI\u2019ll just remind you that you signed an agreement before this interview that you will not disclose any privileged information about Ubiquity and our operations. You need to be especially about our competitors, Everything Everywhere for Everyone, otherwise known as EV3. We have to take security very seriously here.\u201d\r","\r","You put on your very serious face and reassure her that you understand. \r"," \r","\u201cYou have quite the unique resume. We don\u2019t get many applicants with experience in the fortune telling business. If you can read my mind, maybe you don\u2019t need to ask any last questions before we wrap up.\u201d She laughs at her own joke. Before you can stop yourself, you blurt out:\r","\r","*choice\r","\t#\u201cCan you tell me more about what the job is?\u201d \r","\t\tShe laughs a little and tosses her head. \r","\t\t*set interaction +1\r","\t\t*goto interaction\r","\t#\u201cCan you tell me what a typical timeline is for Ubiquity\u2019s decision?\u201d\r","\t\tShe laughs a little and tosses her head. \r","\t\t*set history +1\r","\t\t*goto history\r","\t#\u201cI really hope I\u2019ll have the opportunity to join Ubiquity!\u201d\r","\t\tShe laughs a little and tosses her head. \r","\t\t*set soul +1\r","\t\t*goto soul\r","\t#\u201cThanks! Can I use the bathroom before I go?\u201d\r","\t\tShe laughs a little and tosses her head. \r","\t\t*set rumor +1\r","\t\t*goto rumor\r","\r","*label interaction\r","\r","\u201cUbiquity is always looking for people with the right talents. If you are selected and decide to join, that\u2019s when you\u2019ll be matched with a specific job opening. No one finds out about their first assignment until they start, because we want the kind of team members who are willing to pitch in wherever they can make the biggest contribution at Ubiquity.\u201d \r","*goto byebye\r","\r","*label history\r","\r","\u201cYou\u2019ll hear from us in a week. We don\u2019t interview for a specific job opening, so if a candidate is found to have the right talents, that\u2019s when we\u2019ll match them to a group where they can make the biggest contribution at Ubiquity.\u201d\r","*goto byebye\r","\r","*label soul\r","\r","\u201cUbiquity is such an exciting place to work! Since successful candidates are matched to the group where they can make the biggest contribution, everyone has a chance to use and grow their unique talents.\u201d\r","*goto byebye\r","\r","*label rumor\r","\r","She shakes your hand, thanks you for your time, and drops you off at the bathroom in the lobby. As you\u2019re washing you hands, you overhear someone talking. \r","\r","\u201cYeah, the first week here is crazy. Since Ubiquity assigns you to a group after you get hired, it\u2019s this big surprise what your first job assignment turns out to be. They decided I\u2019d be a great fit for marketing, even though I\u2019d never done it before.\u201d\r","*finish\r","\r","*label byebye\r","\r","She shakes your hand, thanks you for your time, and bustles you out the door. \r","*finish"], "labels":{"interaction":28,"history":33,"soul":38,"rumor":43,"byebye":50}},"postinterview": {"crc":267162742, "lines":["*if skip\r","\t*finish\r","That evening, you and your housemate (and ex-${egirlfriend}), Bobby, take turns microwaving frozen burritos. $!{ehe} looks about as tired as you feel.\r","\r","\u201cSo\u2026do you think you\u2019ll get the job?\u201d ${ehe} asks. \u201cJamie tried to put in a good word for you.\u201d\r","\r","After almost a year of job hunting, applying to every open position you could find, you can\u2019t help being jealous. Jamie had offers from all the hottest technology companies, including Ubiquity, before graduation. Bobby was working in ${ehis} family\u2019s import business. You, on the other hand, with a degree in modern literature and work experience doing tarot card readings for gullible tourists, had not gotten a single offer.\r","\r","*choice\r","\t#\u201cI appreciate his help. And thank you for suggesting it to him in the first place; I know he wasn\u2019t sure there\u2019d be anything I could do at a place like Ubiquity.\u201d \r","\t\t*set history +1\r","\t\t*set housemate_relationship +1\r","\t\t\u201cI think you\u2019ll be great at whatever job you get.\u201d Bobby gives you a quick hug. \u201cIf my parents\u2019 company was doing better, they\u2019d hire you in a minute.\u201d\r","\t\t*goto lastjob\r","\t#\u201cI hope so! I\u2019m so nervous. I couldn\u2019t really figure out what kinds of \u2018special talents\u2019 Ubiquity was looking for.\u201d\r","\t\t*set soul +1\r","\t\t\u201cYou can probably figure it out as you go along.\u201d Bobby says.\r","\t\t*goto lastjob\r","\t#\u201cI guess I\u2019ll find out in a week or so. How was your day?\u201d\r","\t\t*set interaction +1\r","\t\t*set housemate_relationship +1\r","\t\tBobby sighs. \u201cThings at my parents\u2019 company aren\u2019t looking so good. If we can\u2019t find some new customers soon, my whole family might be looking for different jobs soon.\u201d\r","\r","\t\t\u201cI hope it works out,\u201d you say. \u201cYour parents made it through the last recession.\u201d \r","\t\t\r","\t\t$!{ehe} nods.\r","\t\t*goto lastjob\r","\t#\u201cI\u2019ve heard Ubiquity\u2019s pretty selective and everyone comes away thinking they failed the interview.\u201d\r","\t\t*set rumor +1\r","\t\t\u201cI know Jamie was convinced he\u2019d bombed it,\u201d Bobby says. \u201cAnd you\u2019re right, a lot of his co-workers thought the same thing, too.\u201d\r","\t\t*goto lastjob\r","\r","*label lastjob\r","\r","You sigh.\r","\r","\u201cMaybe they won\u2019t try calling my references. My Mom\u2019s going to be out of touch all month, and my former boss at that frozen yogurt cafe isn\u2019t my biggest fan.\u201d\r","\r","\u201cYou never told me what went wrong at the frozen yogurt place,\u201d Bobby says.\r","*choice\r","\t#\"Oh, it\u2019s not a very interesting story.\"\r","\t\t*set housemate_relationship -1\r","\t\t*goto miffed\r","\t#\"Well, it wasn\u2019t a great moment, but I threw a coffee mug at my boss.\"\r","\t\t*set boss_regard -1\r","\t\t*goto eyeroll\r","\t#\"I was younger and dumber, and partied all night a few times. Which wouldn\u2019t have been so bad, except I kept falling asleep at work\"\r","\t\t*set diligence -1\r","\t\t*goto eyeroll\r","\t#\"I had a fling with a coworker and it got messy.\"\r","\t\t*set resist_colleague -1\r","\t\t*goto eyeroll\r","\r","*label eyeroll\r","Bobby rolls ${ehis} eyes. \u201cClassy all the way, huh?\u201d \u201cIt was a long time ago! Before college!\u201d you offer.\r","*page_break\r","*goto bed\r","\r","*label miffed\r","Bobby starts to clean up. \u201cOh, and Casey\u2026can you figure out how to get your cat to stop shredding my couch?\u201d \r","*page_break\r","*goto bed\r","\r","*label bed\r","Lying in bed, you can\u2019t stop wondering. [i]What if I don\u2019t get this job? How am I going to pay Bobby back for the last three month\u2019s rent? Maybe I don\u2019t have any marketable talents and should just move back in with Mom, and join her bogus fortune telling business.[/i]\r","*finish\r",""], "labels":{"lastjob":32,"eyeroll":53,"miffed":58,"bed":63}},"divination_style": {"crc":855708342, "lines":["*if skip\r","\t*finish\r","You feel yourself drifting off to sleep. Your future stretches in front of you like a vast forest of question marks, obscured by fog. \r","\r","[i]If only I could perform real divinations! Seeing the future and reading people\u2019s minds would be awesome. I could do anything I wanted.[/i]\r","\r","Suddenly, you\u2019re in a bright room you\u2019ve never seen before. Pillars stretch upward, holding up a sky blue dome. In the middle of the room, you see a table draped in purple velvet. Small cushions cradling four unfamiliar artifacts are lined up across the table.\r","\r","*page_break\r","You approach the table, footsteps echoing loudly. On the left side is a shining golden bell with a heart-shaped handle. Next is an antique copper hand mirror, pitted with black tarnish. Third in line is a clear crystal bowl filled with a bubbling green liquid. On the right side is a grubby, tattered stuffed bunny.\r","\r","When you reach the table, you pick up the artifact that calls out to you.\r","*set dream_1_description \"[b]Dream #1[/b] I was in a sort of temple, and had to pick between four objects. Right away, I was attracted to this \"\r","*choice\r","\t#Ring the bell.\r","\t\t*set rumor +3\r","\t\t*set dream_object \"bell\"\r","\t\t*goto rumor\r","\t#Look in the mirror.\r","\t\t*set soul +3\r","\t\t*set dream_object \"mirror\"\r","\t\t*goto soul\r","\t#Smell the green liquid.\r","\t\t*set interaction +3\r","\t\t*set dream_object \"bowl\"\r","\t\t*goto interaction\r","\t#Hug the stuffed bunny.\r","\t\t*set history +3\r","\t\t*set dream_object \"stuffed bunny\"\r","\t\t*goto history\r","\r","*label rumor\r","The golden bell swings easily in your hand, like it was waiting for you. The sound of the ringing gets louder and louder, transforming into the massed voices of a triumphant choir, before fading to mystical chanting. Finally, whispering voices surround you. \r","\r","\u201cI heard that she\u2019s worried.\u201d\r","*line_break\r","\u201cThere\u2019s always been something odd about him.\u201d\r","*line_break\r","\u201cRemember what happened at the last place they worked?\u201d\r","*line_break\r","\u201cEveryone\u2019s older and wiser now, but do you think that will be enough?\u201d\r","\r","Looking at the bell in your hand, you see: \u201cRumors are siblings to the truth. Listen for them,\u201d inscribed along the bottom edge.\r","*set dream_1_description dream_1_description&\"bell. When I rang it, I heard whispers and someone told me that 'rumors are siblings to the truth.' The really weird thing is that when I woke up, the bell was real.\"\r","*gosub wake\r","...the golden bell, standing right next to your phone.\r","*goto phone\r","\r","*label soul\r","The surface of the mirror is as tarnished and pitted as the frame. You tilt it, catching the light, and a shape seems to move across the mirror\u2019s face. It swirls, dividing into two comets spiraling around each other. When they collide in the middle, the mirror\u2019s surface flashes with bright light, and you see faces looking out at you. \r","*set dream_1_description dream_1_description&\"mirror. When looked in it, I saw people making faces, and someone told me to look into souls for insight (however that's supposed to work). The really weird thing is that when I woke up, the mirror was real.\"\r","\r","As you watch, the one face beams at you. Another looks surprised. One cries silently, and one glares and sticks its tongue out.\r","\r","Looking at the mirror in your hand, you see: \u201cGlimpses of soul bring insight. Look for them,\u201d inscribed around the edge.\r","*gosub wake\r","...the antique bronze mirror, lying right next to your phone.\r","*goto phone\r","\r","*label interaction\r","The bowl is cold and your hands shake as you lift it closer to your face. You smell medicinal herbs and hear the liquid fizzing. Now a green mist swirls above the surface, and sparks fly out of the bowl. The liquid burns your throat, and as you swallow, the taste in your month changes from bitter to sweet.\r","*set dream_1_description dream_1_description&\"bowl. I drank the potion, and someone told me to ask questions if I wanted answers. The really weird thing is that when I woke up, the bowl was real.\"\r","\r","Looking at the bowl in your hand, you see: \u201cConversation leads to answers. Ask if you want to know,\u201d inscribed around the rim.\r","*gosub wake\r","...the now empty crystal bowl, sitting next to your phone.\r","*goto phone\r","\r","*label history\r","As soon as you touch the bunny, memories float through your head. \r","*set dream_1_description dream_1_description&\"stuffed bunny. When I touched it, it came alive and told me that the past was the key to everything. The really weird thing is that when I woke up, the stuffed bunny was real (but not alive anymore).\"\r","\r","A small boy throws the bunny out of his crib. \r","*line_break\r","A toddler sleeps with the bunny under his pillow. \r","*line_break\r","A young girl runs across the lawn, waving the bunny. \r","*line_break\r","A college student carefully tucks the bunny into a laptop bag. \r","\r","The people change in each scene, but the bunny looks the same.\r","\r","The stuffed bunny in your hand wiggles its nose and speaks. \u201cThe past leads to the present and future. You\u2019ll understand when you know what came before.\u201d\r","*gosub wake\r","...the stuffed bunny, lying motionless on your bed. You never had a stuffed bunny, but here it is, clearly well-loved, with the soft fabric nearly worn through.\r","*goto phone\r","\r","*label wake\r","*page_break\r","You are jerked awake by your phone ringing, and your heart races. [i]That dream felt so real![/i] When you sit up, you see...\r","*page_break\r","*return\r","\r","*label phone\r","*set show_dream_1 true\r","*page_break\r","You let the call go to voicemail. You don\u2019t recognize the number, and it\u2019s still too early in the morning to talk to anyone.\r","*finish"], "labels":{"rumor":31,"soul":48,"interaction":59,"history":68,"wake":87,"phone":93}},"job_offer": {"crc":37330315, "lines":["*if skip\r","\t*finish\r","It\u2019s not even 9 o\u2019clock, but you know Bobby usually leaves for work a lot earlier. You listen to your voicemail while drinking coffee and eating cereal.\r","\r","\u201cPumpkin, it\u2019s Mom. You\u2019re probably wondering what that dream was all about, aren\u2019t you? I know most people your age don\u2019t really believe in woo-woo New Age hocus-pocus occult stuff. But in your dream, you just made a choice to accept the family gift of divination. Sorry I can\u2019t talk long; I\u2019m supposed to be at a silent meditation retreat all month and I\u2019ll be in trouble if they catch me blabbing. I\u2019m so proud of you, Pumpkin; I knew you\u2019d have the gift. Better download that Virtual Teacup app, in case you need it for the new job.\u201d\r","\r","*page_break\r","[i]Divination? How did Mom know about the dream? And I didn\u2019t even tell her about the interview.[/i]\r","\r","Your phone rings again. This time, it\u2019s the recruiter from Ubiquity. You stand up, brush the breadcrumbs off your lap, and try to sound professional and decisive, instead of confused. \r","\r","\u201cHello, this is Casey Morganson.\u201d\r","\r","*page_break\r","\u201c$!{pMr}. Morganson, we\u2019re happy to extend you an offer to join Ubiquity. If you accept, as with all our new employees, you\u2019ll be given a contract for a six month trial probationary period and assigned to a team where you can make a significant contribution to our mission. We\u2019ve sent you all the details, and hope to see you next Monday.\u201d\r","\r","[i]Figuring out the family gift can wait. I\u2019ve finally got a job![/i]\r","\r","*page_break\r","But before your first day on the job, you do download the Virtual Teacup app. \r","\r","[i]Why not listen to Mom. A little cosmic help could come in handy![/i]\r","*finish"], "labels":{}},"meet_boss": {"crc":-916236129, "lines":["*if skip\r","\t*finish\r","On Monday, you arrive at the Ubiquity\u2019s local office, with no idea of what you\u2019ll be doing. [i]No matter which group I get assigned to, a six month trial period at Ubiquity sounds a lot better than all my other non-existent job offers![/i]\r","\r","While the receptionist calls your new boss to tell her you\u2019ve arrived, you sit down in the snazzy lobby and watch flames flicker in the gas fireplace. Your contemplations are interrupted by a woman arguing with someone on her cell phone. She stops in front of you and hangs up on whomever she\u2019s talking to. She hasn\u2019t stopped frowning, but nods at you.\r","\r","*page_break\r","\u201cYou must be Casey Morganson. I\u2019m Margot Lyles, and I\u2019ll be your manager. Come on, we\u2019re on the 7th floor. You can meet everyone at the team meeting in five minutes. Except there\u2019s only more person other than the two of us, since my most experienced person is taking a sabbatical to ride his bike around the country. Bastard! That\u2019s partly why we needed another person for the group. Though with the spike in our workload lately, we\u2019d be stretched even if he was here.\u201d \r","\r","As you wait for the elevator, you:\r","*choice\r","\t#Try making small talk with Margot.\r","\t\t*set boss_regard +1\r","\t\t*goto margot\r","\t#Look around at the other people.\r","\t\t*set diligence +1\r","\t\t*goto chatter\r","\t#Quickly give Virtual Teacup a try.\r","\t\t*goto divination\r","\t#Let your mind wander.\r","\t\t*goto wander\r","\r","*label margot\r","At first, Margot responds to your questions with monosyllables, but by the time you get into the elevator, she\u2019s become slightly more chatty. She takes a deep breath and manages a tight lipped smile. \r","\r","\u201cSorry I\u2019m so frazzled this morning. Welcome to Ubiquity, and I hope you won\u2019t quit as soon as you find out what you\u2019ll be doing! Like the last new person they gave me. Useless!\u201d\r","*finish\r","\r","*label chatter\r","You listen to a couple of men complaining about their computers while waiting for the elevator. \r","\r","\u201cYeah, it keeps saying the disk is full, but that doesn\u2019t make any sense. I\u2019ve had IT come over to look at it twice this week, but as soon as they were there, I couldn\u2019t get the error to happen again. I think it\u2019s gremlins.\u201d\r","*finish\r","\r","*label divination\r","You feel silly taking divination half-seriously, but you haven\u2019t been able to come up with a scientific explanation for the ${dream_object} that materialized from your dream either. \r","\r","You click on the Virtual Teacup app, jiggle your phone to give the tea leaves sitting at the bottom of the cup a swirl, then dump the dregs of tea out of the cup by turning your phone face down. [i]What should I expect today?[/i] \r","\r","You look at the screen again to study the clump of virtual leaves stuck to the bottom of the virtual cup. It looks like a ring, or a zero, the symbol for potential. That symbol means that something\u2019s ending and something else is beginning. [i]Right, stupid question. Mom always said \u2018Ask a generic question, get a generic answer.\u2019[/i]\r","*finish\r","\r","*label wander\r","[i]I guess I\u2019ll be on a different floor than Jamie. I wasn\u2019t sure about him when Bobby started going out with him. But he\u2019s been cool with me, never even made a fuss about Bobby sharing an apartment with an ex-${pgirlfriend}. And he likes cats, so he\u2019s been backing up my attempts to argue that Mischief isn\u2019t really that much of a disaster for the apartment. I wonder if I\u2019ll run into him much at work.[/i]\r","*finish\r","\r","\r",""], "labels":{"margot":22,"chatter":28,"divination":34,"wander":42}},"meet_team": {"crc":102776980, "lines":["*if skip\r","\t*finish\r","After she shows you your new office, you and Margot sit down in a small conference room decorated with paper lanterns, waiting for the rest of the team. \r","\r","\u201cThe first thing you need to know is that the real purpose of our team is a secret. Only a few people at Ubiquity know that we\u2019re not just the Taskforce to Improve Efficiency. It\u2019s critical that you stick to the cover story. If you think that\u2019s going to be a problem, tell me now, and we\u2019ll transfer you to another group.\u201d\r","\r","*page_break\r","\u201cI can handle that,\u201d you say.\r","\r","\u201cGood. Here\u2019s Rene now. $!{ihe}\u2019s the other member of our team, but ${ihe} doesn\u2019t work for Ubiquity. $!{ihe}\u2019s with the company that makes the SEKA software. SEKA stands for See Everything, Know All.\u201d\r","\r","A young ${iman} with wavy hair and dimples comes into the room and shuts the door. \u201cCasey, it\u2019s good to meet you. I\u2019m Rene and I\u2019m looking forward to working with you.\u201d As you shake ${ihis} hand, you can\u2019t help smiling back, even though you still have no idea what your super-secret job is going to be.\r","\r","*page_break\r","Margot checks her phone and purses her lips, muttering an obscenity. \r","\r","\u201cRene, since you\u2019re the expert on SEKA, why don\u2019t you sit with Casey and explain the purpose of our team. I\u2019ve got to go pick up today\u2019s info dump; looks like we\u2019ll be busy. Be back soon.\u201d\r","\r","As she gets up, you notice she\u2019s carrying three file folders labeled \u201curgent\u201d \u201cepic\u201d and \u201creally weird\u201d.\r","\r","*page_break\r","Rene moves to the chair next to you, and pulls it away from the table so ${ihe}\u2019s looking into your eyes. \r","\r","\u201cThis group is a bit hush-hush because Ubiquity has just installed See Everything, Know All, or SEKA. SEKA is the newest technology for automatically monitoring all employee activities, and automatically identifying thieves, blackmailers, or other bad guys who are hurting the organization.\u201d\r","\r","\u201cHow does that even work?\u201d you interrupt.\r","\r","*page_break\r","$!{ihe} leans closer and lowers ${ihis} voice. \r","\r","\u201cIt\u2019s amazing artificial intelligence. Think of it as finding a needle in a field of haystacks, using powerful X-rays and magnets, so you don\u2019t even have to bother touching most of the haystacks. Once we get SEKA\u2019s settings adjusted exactly right, Ubiquity will be much more secure and efficient, which is why our team is officially known as the Taskforce to Improve Efficiency. It\u2019s not all about finding bad guys. It\u2019s also for finding other problems that need attention.\u201d\r","\r","That sounds great, but you\u2019ve got another burning question:\r","*choice\r","\t#\"Isn\u2019t that a huge invasion of privacy?\"\r","\t\t*set resist_colleague +1\r","\t\t*goto privacy\r","\t#\"Sounds cool. How do we make the right adjustments to SEKA?\"\r","\t\t*set resist_colleague -1\r","\t\t*goto adjust\r","\t#\"Why did I get matched to this assignment?\"\r","\t\t*goto dunno\r","\t#\"How\u2019s it been going with rolling out SEKA so far?\"\r","\t\t*set history +1\r","\t\t*goto evade\r","\r","*label privacy\r","\u201cOh no, no. Since it\u2019s all automated, unlike most of the other monitoring systems on the market, you don\u2019t need a team of people actually digging through everyone\u2019s activity logs all the time. Once we get it working right, I\u2019ll be off to another customer site, and it\u2019ll be running by itself. People like you and Margot will only be called in for rare cases when a human needs to take a closer look at someone who\u2019s been flagged by SEKA.\u201d\r","*finish\r","\r","*label adjust\r","\u201cWe need to help teach SEKA the range of normal behavior here at Ubiquity, so SEKA gets better at identifying real bad guys. We\u2019ll go talk to the Ubiquity employees that SEKA thinks are acting strange, and help SEKA understand whether they\u2019re unusual for innocent reasons, or strange because they\u2019re criminals.\u201d\r","*finish\r","\r","*label dunno\r","\u201cI\u2019m delighted that Ubiquity picked you as my colleague, but I\u2019m afraid I don\u2019t know how they decided. It\u2019s certainly been busy enough that Margot wanted another person on our team. The last person washed out after a few days, but I\u2019m sure you\u2019ll be a much better fit.\u201d\r","*finish\r","\r","*label evade\r","Rene stops smiling for a minute. \r","\r","\u201cOh, you know how tricky it can be to get any kind of software set up, even something as advanced as SEKA. Technology can be so fussy. But now that we have you on the team, I\u2019m sure things will improve!\u201d\r","*finish"], "labels":{"privacy":46,"adjust":50,"dunno":54,"evade":58}},"case_1_suspects": {"crc":-780165050, "lines":["*if skip\r","\t*finish\r","The door bangs open and Margot staggers in, holding a thick stack of three-ring binders. She piles them onto the conference table and throws herself onto a chair.\r","\r","\u201cCasey, did Rene thoroughly explain the drill?\u201d\r","*choice\r","\t#\"Yep, I\u2019m ready to go.\"\r","\t\t*set resist_colleague -1\r","\t\t\u201cGood, because we\u2019re in a rush.\u201d\r","\t\t*goto brief\r","\t#\"Yes, but I have a few more questions.\"\r","\t\t*set resist_colleague +1\r","\t\t\u201cNo time now, but we\u2019ll talk again later.\u201d\r","\t\t*goto brief\r","\t#\"Mostly, but did you want to add anything?\"\r","\t\t*set boss_regard +1\r","\t\t\u201cJust remember, don\u2019t mention SEKA to anyone.\u201d\r","\t\t*goto brief\r","\r","*label brief\r","*page_break\r","\u201cToday, we\u2019re trying to tune SEKA\u2019s ability to understand whether someone is running an illicit business while they\u2019re on the job. SEKA has flagged fifteen Ubiquity employees as behaving suspiciously. We\u2019ll need to investigate them, figure out if they\u2019re doing anything wrong, and then adjust SEKA so it\u2019ll handle this topic better in the future. Each of us will examine five case studies.\" \r","\r","\"Take five binders, skim the info, and prioritize the least suspicious people first, since those might be the cases where SEKA made the biggest mistakes. Come back here by 3pm with your decisions on each case, whether you had time to interview everyone or not. We\u2019ll input our corrections into SEKA together.\u201d\r","\r","*page_break\r","You start flipping through one of the binders which contains records for [b]Jason L[/b]. Your attention is caught by one phrase in particular:\r","*fake_choice\r","\t#From a peer review: \u201cHe\u2019s got a hair trigger temper, and we\u2019re all walking on eggshells, trying not to set him off.\u201d\r","\t\t[i]This guy sounds like a real joy to work with. Not.[/i]\r","\t#From a manager evaluation: \u201cHe arrives 30-60 minutes late to work, on average, twice a week.\u201d\r","\t\t[i]Hard to run a secret side-business when you\u2019re on the clock at work if you\u2019re late getting here all the time.[/i]\r","\t#From a web browsing log: \u201cSocial media: 30 views, Online dating: 50 views, Forums: 100 views\u201d\r","\t\t[i]I wonder what kinds of forums he\u2019s looking at.[/i]\r","\t#From an email: \u201cWe need to reschedule our raid to start at 11pm, because a couple people need to work late.\u201d\r","\t\t[i]It\u2019s kind of hard-core to set up your guild raid at 11pm, but not super hard-core if people in your guild are letting work interfere with previously scheduled raids![/i]\r","\r","*page_break\r","You look up. Margot and Rene are also flipping through binders. \u201cAny instructions for how should I investigate people?\u201d\r","\r","\u201cTake 30 minutes to skim the files so you can start with the least suspicious individuals. Since we\u2019re correcting SEKA, we need to be able to tell it how it went wrong. So try to understand why it flagged each person and decide if SEKA was right.\" \r","\r","\"You can talk to the people who were flagged, talk to their coworkers, watch them at lunch, or read their email logs for the week - do whatever\u2019s necessary to understand the real explanation for their suspicious behavior. Don\u2019t mention SEKA and get back here by 3pm with all your decisions.\u201d\r","\r","*page_break\r","[i]That\u2019s less than 6 minutes to look at each case study, and figure out who to study first! And that leaves about an hour per case for detailed investigation. No wonder Margot was desperate to get a new employee for the team.[/i]\r","\r","Do you:\r","*choice\r","\t#Flip through the rest of the case files and prioritize each person. \r","\t\t*set diligence +1\r","\t\t*goto other_files\r","\t#Try using Virtual Teacup to pick the first person to investigate. Then get started right away, to save a little time. \r","\t\t*set boss_regard -1\r","\r","\t\tYou launch Virtual Teacup. [i]Should I start with Jason L?[/i]\r","\t\t\r","\t\tThe tea leaves look like a perched crow. \r","\t\t\r","\t\t*if soul > 2 \r","\t\t\t[i]Okay, Jason is someone who is annoying or poorly regarded, but he\u2019s a messenger rather than a culprit.[/i] \r","\t\t\t*goto jason_choice\r","\t\t*else\r","\t\t\t[i]Is that supposed to mean that he has a bad reputation but is actually a good guy? Or does it mean follow the messenger and proceed in the current direction?[/i]\r","\t\t\t*goto jason_choice\r","\t\t\r","\t\t*label jason_choice\r","\t\tDo you start with Jason?\r","\t\t*choice\r","\t\t\t#Yes\r","\t\t\t\t*set investigate_1 \"Jason\"\r","\t\t\t\t*set investigate_2 \"Tonya\"\r","\t\t\t\t*set investigate_3 \"Zenina\"\r","\t\t\t\t*set investigate_4 \"Monica\"\r","\t\t\t\t*set investigate_5 \"Van\"\r","\t\t\t\t*goto breakup\r","\t\t\t#No\r","\t\t\t\tYou try another virtual tea leaf reading. [i]Which person should I start with?[/i] \r","\t\t\t\t \r","\t\t\t\tThe tea leaves look like a sun. \r","\t\t\t\t*if soul > 2\r","\t\t\t\t\t[i]Fame and glory, so start with someone well known.[/i] \r","\t\t\t\t\t*goto tonya_start\r","\t\t\t\t*else \r","\t\t\t\t\t[i]Does that mean look for someone with no secrets? Or someone who has gotten a lot of attention?[/i]\r","\t\t\t\t\t*goto tonya_start\r","\r","\t\t\t\t*label tonya_start\r","\t\t\t\t*page_break\r","\t\t\t\tYou grab a binder, and skim the records of [b]Tonya S[/b].\r","\t\t\t\t*gosub sub_Tonya_file\r","\t\t\t\t*page_break\r","\t\t\t\tDo you start with Tonya?\r","\t\t\t\t*choice\r","\t\t\t\t\t#Yes\r","\t\t\t\t\t\t*set investigate_1 \"Tonya\"\r","\t\t\t\t\t\t*set investigate_5 \"Jason\"\r","\t\t\t\t\t\t*set investigate_2 \"Zenina\"\r","\t\t\t\t\t\t*set investigate_3 \"Monica\"\r","\t\t\t\t\t\t*set investigate_4 \"Van\"\r","\t\t\t\t\t\t*goto breakup\r","\t\t\t\t\t#No\r","\t\t\t\t\t\t*set investigate_1 \"Monica\"\r","\t\t\t\t\t\t*set investigate_5 \"Jason\"\r","\t\t\t\t\t\t*set investigate_2 \"Tonya\"\r","\t\t\t\t\t\t*set investigate_3 \"Zenina\"\r","\t\t\t\t\t\t*set investigate_4 \"Van\"\r","\t\t\t\t\t\t*page_break\r","\t\t\t\t\t\tYou grab another binder, and flip through the case file of [b]Monica T[/b]. \r","\t\t\t\t\t\t*gosub sub_Monica_file \r","\r","\t\t\t\t\t\tLooks like Monica will be your first interview of the day.\r","\t\t\t\t\t\t*goto breakup\r","\t\t\t\r","\t#Decide to save time and plan to do them in random order. It won\u2019t matter as long as you get to everyone before 3pm. \r","\t\t*set boss_regard -1\r","\t\t*set did_random true\r","\t\tYou put the binders in a row, and count out eeny-meenie-miny-moe. Your first investigation will be Jason L.\r","\t\t*goto breakup\t\t\r","\t\t\r","*label sub_Tonya_file\r","*set read_Tonya true\r","Your attention is caught by one phrase in particular:\r","*fake_choice\r","\t#From a peer review: \u201cShe\u2019s even cooler in person that she seems online.\u201d\r","\t\t[i]I wonder how they know her from online?[/i]\r","\t\t\r","\t#From a manager evaluation: \u201cExcellent customer-facing skills; several successful presentations at customer sites this year.\u201d\r","\t\t[i]I\u2019m jealous; she sounds like a dynamo.[/i]\r","\t\t\r","\t#From web browsing log: \u201cNews: 0 views, Social media: 0 views, Online dating: 0 views, Forums: 0 views\u201d\r","\t\t[i]Really? Zero web browsing? I wonder if SEKA doesn\u2019t get data from smart phones.[/i]\r","\t\t\r","\t#From an incoming email: \u201cI hope you\u2019ll write back, or start posting again! I miss your humor and flair for the ridiculous.\u201d\r","\t\t[i]I wonder what she used to post about?[/i]\r","\r","[i]Tonya sounds like she\u2019d be more interesting to talk to...but interesting is not supposed to be our criteria.[/i]\r","*return\r","\r","*label sub_Monica_file\r","*set read_Monica true\r","Your attention is caught by one phrase in particular:\r","*fake_choice\r","\t#From a peer review: \u201cHer office is literally stuffed with stuffed animals.\u201d\r","\t\t[i]I wonder if she has any stuffed bunny rabbits?[/i]\r","\t\t\r","\t#From a manager evaluation: \u201cShe needed extensions on deadlines for two reports. She should focus more on time management.\u201d\r","\t\t[i]At least she doesn\u2019t have to interview five people before 3pm.[/i]\r","\r","\t#From web browsing log: \u201cNews: 10 views, Social media: 100 views, Online dating: 0 views, Forums: 0 views\u201d\r","\t\t[i]Nothing too unusual there.[/i]\r","\t\t\r","\t#From an incoming email: \u201cI haven\u2019t received it yet, and wanted to make sure the package wasn\u2019t stolen off my porch.\u201d\r","\t\t[i]I heard about some petty theft rings following delivery trucks around to steal packages. Wonder why they\u2019re asking her about their package.[/i]\r","\r","[i]Monica sounds a little flakey. Does that make her more or less suspicious than the others?[/i]\r","*return\r","\t\t\r","*label other_files\r","*page_break\r","You pick up the second case file for [b]Zenina B[/b].  \r","*set read_Zenina true\r","\r","Your attention is caught by one phrase in particular:\r","*fake_choice\r","\t#From a peer review: \u201cShe\u2019s nice, but sometimes tries to act like my Mom and tell me how to dress.\u201d\r","\t\t[i]At least your work Mom isn\u2019t telling you to go into the family divination business.[/i]\r","\t\t\r","\t#From a manager evaluation: \u201cShe is eager and willing to learn new software features, and then help teach her coworkers.\u201d\r","\t\t[i]Maybe Margot should recruit her to join the team.[/i]\r","\t\t\r","\t#From a web browsing log: \u201cNews: 30 views, Social media: 200 views, Online dating: 0 views, Forums: 0 views\u201d\r","\t\t[i]I wonder if she\u2019s one of those people who posts news articles on Facebook all the time.[/i]\r","\t\t\r","\t#From an incoming email: \u201cMy grandson is still being treated for his allergies and we\u2019re praying he\u2019ll grow out of it.\u201d\r","\t\t[i]I wonder if they\u2019re trying homeopathic treatments. [/i]\r","\r","[i]I have no idea if Zenina sounds more or less innocent than Jason.[/i]\r","*page_break\r","Who\u2019s next? You pick up the third binder, a case file for [b]Tonya S[/b]. \r","\r","*gosub sub_Tonya_file\r","\r","*page_break\r","Two more. You pick up the binder for [b]Monica T[/b]. \r","\r","*gosub sub_Monica_file\r","\r","*page_break\r","Last one. You pick up the final case file for [b]Van O[/b]. \r","\r","Your attention is caught by one phrase in particular:\r","*set read_Van true\r","*fake_choice\r","\t#From a peer review: \u201cDon\u2019t let him corner you at lunch, or he\u2019ll bore you to death with statistics about politics.\u201d\t\r","\t\t[i]Probably not hard to get him talking, then. But it might be tough to steer the conversation.[/i]\r","\t#From a manager evaluation: \u201cGood attention to documentation, but has a tendency to cover some topics in unnecessary detail.\r","\t\t[i]Sounds like he probably doesn\u2019t take direction that well.[/i]\r","\t#From web browsing log: \u201cNews: 60 views, Social media: 10 views, Online dating: 30 views, Forums: 100 views\u201d\r","\t\t[i]I wonder what kind of forums he\u2019s on. Probably political stuff.[/i]\r","\t#From an incoming email: \u201cThings are going to go crazy in Indonesia. The government\u2019s just making the situation more unstable every time they try to crack down.\u201d\r","\t\t[i]I wonder if political analysis is part of his job, or just a serious hobby.[/i]\r","\r","*page_break\r","*temp person_choice\r","*temp total 15\r","Who do you investigate first?\r","*gosub pick_order\r","*set investigate_1 \"${person_choice}\"\r","\r","*page_break\r","Who will be second on your list?\r","*gosub pick_order\r","*set investigate_2 \"${person_choice}\"\r","\r","*page_break\r","Who will be third on your list?\r","*gosub pick_order\r","*set investigate_3 \"${person_choice}\"\r","\r","*page_break\r","Who will be next to last on your list?\r","*gosub pick_order\r","*set investigate_4 \"${person_choice}\"\r","\r","*page_break\r","Looks like your last choice is obvious.\r","*if total = 1\r","\t*set investigate_5 \"Van\"\r","*if total = 2\r","\t*set investigate_5 \"Monica\"\r","*if total = 3\r","\t*set investigate_5 \"Tonya\"\r","*if total = 4\r","\t*set investigate_5 \"Zenina\"\r","*if total = 5\r","\t*set investigate_5 \"Jason\"\r","*goto breakup\r","\r","*label pick_order\r","*choice\r","\t*disable_reuse #Van O - boring, politics\r","\t\t*set person_choice \"Van\"\r","\t\t*set total -1\r","\t\t*return\r","\t*disable_reuse #Monica T - late reports, stuffed animals\r","\t\t*set person_choice \"Monica\"\r","\t\t*set total -2\r","\t\t*return\r","\t*disable_reuse #Tonya S - online persona, go-getter\r","\t\t*set person_choice \"Tonya\"\r","\t\t*set total -3\r","\t\t*return\r","\t*disable_reuse #Zenina B - helpful, possibly a busybody\r","\t\t*set person_choice \"Zenina\"\r","\t\t*set total -4\r","\t\t*return\r","\t*disable_reuse #Jason L - slacker gamer\r","\t\t*set person_choice \"Jason\"\r","\t\t*set total -5\r","\t\t*return\r","\r","*label breakup\r","*page_break\r","Margot and Rene have finished looking through their case files. \r","\r","\u201cSee you at 3pm,\u201d Margot mutters as she rushes out. \r","\r","\u201cCan\u2019t wait to hear how your investigations go. See you later,\u201d Rene chirps, strolling out behind her.\r","*finish\r","\r",""], "labels":{"brief":19,"jason_choice":66,"tonya_start":87,"sub_tonya_file":120,"sub_monica_file":139,"other_files":158,"pick_order":239,"breakup":262}},"case_1_investigation": {"crc":-1325182810, "lines":["*if skip\r","\t*finish\r","\r","*temp actions_left\r","*set actions_left 5\r","*temp person_total \r","*set person_total 0\r","*temp see_completion\r","*set see_completion false\r","*temp worse_score\r","*set worse_score 0\r","*temp worse_person\r","*set worse_person \"None\"\r","*temp worse_choice \r","*set worse_choice \"None\"\r","*comment  For each person, there will be 4 possible things to do, for a total of 20 possible things. \r","*comment If you read all the files or did Divination, you can do a total of 5 things now. \r","*comment If you picked randomly, you can do a total of 6 things now. \r","*comment The 4 things per person will be: (1) Divination (2) Talk to person (3) Talk to coworkers (4) Flip through archived records)\r","*comment go through the people in order until you run out of time.\r","\r","You cross your fingers and begin your investigations.\r","*if did_random\r","\tactions_left +1\r","\r","*temp show1 true\r","*temp show2 true\r","*temp show3 true\r","*temp stat_check\r","*label investigate\r","*page_break\r","*comment check total\r","*if actions_left = 0\r","\t*goto actions_done\r","*if (actions_left = 3) and show1\r","\t*set show1 false\r","\tYou\u2019ve spent 2 hours and you have 3 hours left to finish your investigations. \r","\t*if person_total < 2\r","\t\tBetter get going! You\u2019ve got five people to investigate by 3pm! \r","\t\t*goto continue_investigate\r","\t*else\r","\t\tMaking good progress - you\u2019re on track to finish five investigations by 3pm!\r","\t\t*goto continue_investigate\r","*if (actions_left = 2) and show2\r","\t*set show2 false\r","\tIt\u2019s clear that you\u2019re not going to have time for lunch today, but you press on. It would be great to impress your new boss on your first day!\r","\t*goto continue_investigate\r","*if (actions_left = 1) and show3\r","\t*set show3 false\r","\tYou\u2019ve got one more hour before 3pm to make up your mind about the five people on your list. You wonder what Rene and Margot found out!\r","\t*goto continue_investigate\r","\r","*label continue_investigate\t\t\r","*if person_total = 0\r","\t*gosub {investigate_1}\r","\t*goto investigate\r","*if person_total = 1\r","\t*gosub {investigate_2}\r","\t*goto investigate\r","*if person_total = 2\r","\t*gosub {investigate_3}\r","\t*goto investigate\r","*if person_total = 3\r","\t*gosub {investigate_4}\r","\t*goto investigate\r","*if person_total = 4\r","\t*gosub {investigate_5}\r","\t*goto investigate\r","*if person_total = 5\r","\t*goto people_done\r","\r","*label finish_reporting\r","*temp target_report\r","*if person_total = 0\r","\t*set target_report investigate_1&\"_report\"\r","\t*gosub {target_report}\r","\t*set person_total +1\r","\tYour report on ${investigate_1} is submitted!\r","\t*goto next_person_1\r","*label next_person_1\r","*if person_total = 1\r","\t*set target_report investigate_2&\"_report\"\r","\t*gosub {target_report}\r","\t*set person_total +1\r","\tYour report on ${investigate_2} is submitted!\r","\t*goto next_person_2\r","*label next_person_2\r","*if person_total = 2\r","\t*set target_report investigate_3&\"_report\"\r","\t*gosub {target_report}\r","\t*set person_total +1\r","\tYour report on ${investigate_3} is submitted!\r","\t*goto next_person_3\r","*label next_person_3\r","*if person_total = 3\r","\t*set target_report investigate_4&\"_report\"\r","\t*gosub {target_report}\r","\t*set person_total +1\r","\tYour report on ${investigate_4} is submitted!\r","\t*goto next_person_4\r","*label next_person_4\r","*if person_total = 4\r","\t*set target_report investigate_5&\"_report\"\r","\t*gosub {target_report}\r","\t*set person_total +1\r","\tYour report on ${investigate_5} is submitted!\r","\t*return\r","\r","*label Jason\r","*comment Jason L\r","*if not(see_completion)\r","\t*page_break\r","\tIt\u2019s a short walk to Jason L\u2019s work area, where most of the software engineers for Ubiquity\u2019s cloud services division sit. From the case records, you remember that he\u2019s the one who shows up late with a bad temper. A few people are standing around the water cooler, and one guy stands in Jason\u2019s doorway talking. \r","\t*gosub Jason_action\r","\t*return\r","*else\r","\t*gosub Jason_action\r","\t*return\r","\t\r","*label Jason_action\r","*page_break\r","*if not(see_completion)\r","\tWhat do you do first to investigate Jason?\r","\t*goto Jason_choice\r","*else\r","\tWhat do you do next?\r","\t*goto Jason_choice\r","*label Jason_choice\r","*choice\r","\t*disable_reuse #Approach him directly.\r","\t\t*set actions_left -1\r","\t\t*gosub Jason_interact\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Talk to his coworkers about him.\r","\t\t*set actions_left -1\r","\t\t*gosub Jason_rumor\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Flip through the binder for more archived records.\r","\t\t*set actions_left -1\r","\t\t*gosub Jason_history\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Perform divination.\r","\t\t*set actions_left -1\r","\t\t*gosub Jason_divination\r","\t\t*set see_completion true\r","\t\t*return\r","\t*if see_completion \r","\t\t#Complete your report on him.\r","\t\t\t*set person_total +1\r","\t\t\t*gosub Jason_report\r","\t\t\t*set see_completion false\r","\t\t\tYour report on Jason is submitted!\r","\t\t\t*return\r","\r","*label Jason_interact\r","You knock on Jason\u2019s doorframe and introduce yourself. How do you explain your errand?\r","*set stat_check interaction + diligence\r","*choice\r","\t#You were recommended to me as an example of a high achieving engineer. Do you have time to talk about how you succeed?\r","\t\t*gosub Jason_talk\r","\t\t*return\r","\t#I\u2019m trying to understand more about how software engineers at Ubiquity work. Do you have time to talk?\r","\t\t*gosub Jason_talk\r","\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Jason_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Jason_refuse\r","\t\t\t*return\r","\t#You don\u2019t know me, but I\u2019m hiding from an annoying coworker. Can I sit in your office for a while?\r","\t\t*gosub Jason_refuse\r","\t\t*return\r","\r","*label Jason_talk\t\r","Jason blinks and nods. \u201cOkay, I\u2019ve got a few minutes. What do you want to know?\u201d\r","\r","\u201cA lot of times in large companies, people are hampered in getting things done. Are there some things you notice about the work environment, people you work with, or company rules that hurt productivity?\u201d\r","*line_break\r","\u201cWe have too many boring meetings. And some of the my coworkers aren\u2019t very good programmers.\u201d\r","*line_break\r","\u201cHave you noticed any issues that impact you more than other people? Or things that you do, but other people don\u2019t do?\u201d\r","*line_break\r","\u201cI\u2019ve been complaining about this since I started working here. Every day, I get a ton of wrong number phone calls. It\u2019s really disruptive, but my manager won\u2019t let me disconnect my phone.\u201d\r","*return\r","\r","*label Jason_refuse\r","Jason looks at the clock. \u201cSorry, this isn\u2019t a good time, I\u2019ve got a deadline today.\u201d\r","*return\r","\r","*label Jason_rumor\r","After the coworker finishes his conversation with Jason, you follow him to his office. How do you explain your errand?\r","*set stat_check rumor + diligence\r","*choice\r","\t#You were recommended to me as an example of someone who understand how things work in this group. Do you have time to explain it?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Jason_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Jason_rumor_mid\r","\t\t\t*return\r","\t#I\u2019m thinking of transferring, and wanted to know more about your group. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Jason_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Jason_rumor_mid\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*gosub Jason_rumor_refuse\r","\t\t*return\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Jason_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Jason_rumor_refuse\r","\t\t\t*return\r","\t\t\t\r","*label Jason_rumor_talk\r","\u201cSure, I\u2019ve got a minute if you can be quick. What can I tell you?\u201d\r","*line_break\r","\u201cI was wondering if you ever noticed anything unusual about Jason\u2019s work habits.\u201d\r","*line_break\r","\u201cHe\u2019s kind of paranoid, but he gets it wrong. Like, he thinks one of us has been giving out his phone number as a prank. But what I think is going on is his number is just one digit off from the Ubiquity main line. People think they\u2019ve called directory assistance and ask Jason if they can speak to so-and-so, and it pisses him off.\u201d\r","*return\r","\r","*label Jason_rumor_mid\r","\u201cHe gets in late a lot, and he\u2019s kind of paranoid. He always thinks random things that happen are because someone\u2019s persecuting him. I mean, stuff like wrong number phone calls.\u201d\r","*return\r","\r","*label Jason_rumor_refuse\r","He looks at the clock. \u201cI\u2019d like to help, but this isn\u2019t a great time, I\u2019ve got a deadline today.\u201d\r","*return\r","\r","*label Jason_history\r","*page_break\r","*set stat_check history + diligence\r","You see several letters from Jason complaining about his office space, coworkers, and general working conditions.\r","\r","*if stat_check > 3\r","\t\u201cI am constantly interrupted by wrong number phone calls. On average, I get twenty calls per day asking for people I don\u2019t even know. I think a coworker must have circulated my number as a prank.\u201d\r","\t*return\r","*else\r","\t\u201cI told my manager about the phone problem, but she hasn\u2019t done anything about it. My coworkers are all incompetent and spend their time pranking me instead of doing their work.\u201d\r","\t*return\r","\r","*label Jason_divination\r","*page_break\r","*set stat_check soul\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a perched crow.\r","\r","*if stat_check > 3 \r","\t[i]Right, he\u2019s someone who complains and people don\u2019t like, but who isn\u2019t actually a problem.[/i]\r","\t*return\r","*else\r","\t[i]Crows are usually a sign that you\u2019ll know what to do, so I guess I\u2019ll just go with my instinct on Jason.[/i]\r","\t*return\r","*return\r","\r","*label Jason_report\r","What do you decide about Jason L?\r","*choice\r","\t#He is doing something bad, and SEKA was right to be suspicious.\r","\t\t*set Jason_choice 1\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Jason\"\r","\t\t\t*set worse_choice 1\r","\t\t\t*goto j1\r","\t\t*label j1\r","\t\t*return\r","\t#He is doing something unusual and which demonstrated a problem, and SEKA was right to flag his case as needing followup investigation. \r","\t\t*set Jason_choice 2\r","\t\t*set boss_regard +1\r","\t\t*return\r","\t#He is doing something outside of the norm, but SEKA shouldn\u2019t have flagged his case as needing followup investigation.\r","\t\t*set Jason_choice 3\r","\t\t*if worse_score = 0\r","\t\t\t*set worse_score 0\r","\t\t\t*set worse_person \"Jason\"\r","\t\t\t*set worse_choice 3\r","\t\t\t*goto j3\r","\t\t*label j3\r","\t\t*return\r","\t#He isn\u2019t doing anything unusual, and SEKA shouldn\u2019t have noticed him at all. \r","\t\t*set Jason_choice 4\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Jason\"\r","\t\t\t*set worse_choice 4\r","\t\t\t*goto j4\r","\t\t*label j4\r","\t\t*return\r","\r","*label Monica\r","*comment Monica T\r","*if not(see_completion)\r","\t*page_break\r","\tYou start walking over to Monica T\u2019s work area. She\u2019s a project manager for some of Ubiquity\u2019s newer ventures.\r","\t*if read_Monica\r","\t\tYou remember from her case record that she\u2019s the one who missed report deadlines and stuffs her office with stuffed animals.\r","\t\t*goto mp1\r","\t*label mp1\r","\tA meeting is breaking up in the conference room, and as people file out, you see that the last person in the room is Monica. \r","\t*gosub Monica_action\r","\t*return\r","*else\r","\t*gosub Monica_action\r","\t*return\r","\t\r","*label Monica_action\r","*page_break\r","*if not(see_completion)\r","\tWhat do you do first to investigate her? \r","\t*goto Monica_choice\r","*else\r","\tWhat do you do next?\r","\t*goto Monica_choice\r","*label Monica_choice\r","*choice\r","\t*disable_reuse #Approach her directly.\r","\t\t*set actions_left -1\r","\t\t*gosub Monica_interact\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Talk to her coworkers about her.\r","\t\t*set actions_left -1\r","\t\t*gosub Monica_rumor\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Flip through the binder for more archived records.\r","\t\t*set actions_left -1\r","\t\t*gosub Monica_history\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Perform divination.\r","\t\t*set actions_left -1\r","\t\t*gosub Monica_divination\r","\t\t*set see_completion true\r","\t\t*return\r","\t*if see_completion \r","\t\t#Complete your report on her.\r","\t\t\t*set person_total +1\r","\t\t\t*gosub Monica_report\r","\t\t\t*set see_completion false\r","\t\t\tYour report on Monica is submitted!\r","\t\t\t*return\r","\r","*label Monica_interact\r","You slip into the conference room and introduce yourself. How do you explain your errand?\r","*set stat_check interaction + diligence\r","*choice\r","\t#You were recommended to me as an example of a high achieving project manager. Do you have time to talk about how you succeed?\r","\t\t*gosub Monica_talk_low\r","\t\t*return\r","\t#I\u2019m trying to understand more about how project managers at Ubiquity work. Do you have time to talk?\r","\t\t*gosub Monica_talk_mid\r","\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*gosub Monica_talk_mid\r","\t\t*return\r","\t#You don\u2019t know me because I just started at Ubiquity. Can I ask you a few questions?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Monica_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Monica_talk_low\r","\t\t\t*return\r","\t\t\r","*label Monica_talk_high\r","Monica sets down her notebook. \u201cSure, I\u2019d be happy to help. What do you want to know?\u201d\r","\r","\u201cWhen it comes to getting things done, what kinds of things slow you down or make your job harder?\u201d\r","*line_break\r","\u201cReally, sometimes the project deadlines and staffing plans handed to us are unrealistic, the project managers get stuck trying to make the team accomplish the impossible.\u201d\r","*line_break\r","\u201cThat must be stressful, feeling like the schedule isn\u2019t realistic and not being able to change it.\u201d\r","*line_break\r","\u201cExactly. I\u2019m actually considering going into business for myself, so I can have more control over setting goals.\u201d\r","*line_break\r","\u201cWow, that\u2019s great. What kind of business would you start?\u201d\r","*line_break\r","\u201cI\u2019ve had a little side business on Etsy for a while, making custom stuffed animals that are dressed wearing animal versions of someone\u2019s favorite outfit. It\u2019s really started to take off, and it\u2019s getting to the point where I can\u2019t keep growing the business while doing my day job.\u201d\r","*line_break\r","\u201cAwesome, good luck with that.\u201d\r","*return\r","\r","*label Monica_talk_low\r","Monica sets down her notebook. \u201cSure, I\u2019d be happy to help. What do you want to know?\u201d\r","\r","\u201cWhen it comes to getting things done, what kinds of things slow you down or make your job harder?\u201d\r","*line_break\r","\u201cSometimes, there are just too many competing demands. Every wants to ask me about something, and I need to help them, but then there isn\u2019t enough time to do the reports. We\u2019re supposed to write a formal report for every project every week, which is a lot when you\u2019re managing five project.\r","*line_break\r","\u201cDo you ever find that hobbies or things outside of work get pushed to the side in your life?\u201d\r","*line_break\r","\u201cI\u2019d definitely like more time to work on hobby projects. Maybe once I retire!\u201d\r","*line_break\r","\u201cThanks for talking to me\u201d\r","*return\r","\r","*label Monica_talk_mid\r","Monica sets down her notebook. \u201cSure, I\u2019d be happy to help. What do you want to know?\u201d\r","\r","\u201cWhen it comes to getting things done, what kinds of things slow you down or make your job harder?\u201d\r","*line_break\r","\u201cReally, sometimes the project deadlines and staffing plans handed to us are unrealistic, the project managers get stuck trying to make the team accomplish the impossible.\u201d\r","*line_break\r","\u201cThat must be stressful, feeling like the schedule isn\u2019t realistic and not being able to change it.\u201d\r","*line_break\r","\u201cExactly. I\u2019m actually considering going into business for myself, so I can have more control over setting goals.\u201d\r","*line_break\r","\u201cWow, that\u2019s great. What kind of business would you start?\u201d\r","*line_break\r","\u201cMaybe something with custom arts and crafts, like an Etsy store.\u201d\r","*line_break\r","\u201cAwesome, good luck with that.\u201d\r","*return\r","\r","*label Monica_rumor\r","You follow one of Monica\u2019s coworkers to his office. How do you explain your errand?\r","*set stat_check rumor + diligence\r","*choice\r","\t#You were recommended to me as an example of someone who understand how things work in this group. Do you have time to explain it?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Monica_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Monica_rumor_mid\r","\t\t\t*return\r","\t#I\u2019m thinking of transferring, and wanted to know more about your group. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Monica_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Monica_rumor_mid\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Monica_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Monica_rumor_mid\r","\t\t\t*return\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Monica_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Monica_rumor_refuse\r","\t\t\t*return\r","\r","\r","*label Monica_rumor_talk\r","\u201cSure, I\u2019ve got a minute if you can be quick. What can I tell you?\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual with how Monica gets her work done.\u201d\r","*line_break\r","\u201cOh, everyone knows she has a little side business making stuffed animals, so she\u2019s usually at work 12 hours a day, but not always doing work for Ubiquity.\u201d\r","*return\r","\r","*label Monica_rumor_mid\r","He shrugs. \u201cI\u2019ve got a minute, if your question isn\u2019t too involved.\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual with how Monica gets her work done.\u201d\r","*line_break\r","\u201cOther than there being like a thousand stuffed animals in her office?\u201d\r","*line_break\r","\u201cI guess that\u2019s pretty unusual.\u201d\r","*line_break\r","\u201cI don\u2019t work with her that closely, but I know that she sends emails at all hours of the day or night. I\u2019d like to help you more, but this isn\u2019t a great time. Maybe stop by another day if you want to talk more.\u201d\r","*return\r","\r","*label Monica_rumor_refuse\r","He looks at the clock. \u201cI\u2019d like to help, but this isn\u2019t a great time, I\u2019ve got a deadline today.\u201d\r","*return\r","\r","*label Monica_history\r","*page_break\r","*set stat_check history + diligence\r","*if stat_check > 3\r","\tYou see an agreement form between Ubiquity and Monica, acknowledging her copyright to the Mini-Me Stuffies, stuffed animals custom made as cute caricatures of their owners.\r","\t*return\r","*else\r","\tYou see Monica\u2019s orginal job application, where she lists prior experience managing a fast food franchise, and working at a make-your-own-bear store.\r","\t*return\r","\r","*label Monica_divination\r","*page_break\r","*set stat_check soul\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a knapsack.\r","\r","*if stat_check > 3 \r","\t[i]Looks like she\u2019s busy with a financial venture, which could be a side business.[/i] \r","\t*return\r","*else\r","\t[i]A knapsack usually means the start of a journey. I wonder if she\u2019s going to switch jobs.[/i]\r","\t*return\r","*return\r","\r","*label Monica_report\r","What do you decide about Monica T?\r","*choice\r","\t#She is doing something bad, and SEKA was right to be suspicious.\r","\t\t*set Monica_choice 1\r","\t\t*set boss_regard +1\r","\t\t*return\r","\t#She is doing something unusual and which demonstrated a problem, and SEKA was right to flag her case as needing followup investigation. \r","\t\t*set Monica_choice 2\r","\t\t*if worse_score = 0\r","\t\t\t*set worse_score 0\r","\t\t\t*set worse_person \"Monica\"\r","\t\t\t*set worse_choice 2\r","\t\t\t*goto m2\r","\t\t*label m2\r","\t\t*return\r","\t#She is doing something outside of the norm, but SEKA shouldn\u2019t have flagged her case as needing followup investigation.\r","\t\t*set Monica_choice 3\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Monica\"\r","\t\t\t*set worse_choice 3\r","\t\t\t*goto m3\r","\t\t*label m3\r","\t\t*return\r","\t#She isn\u2019t doing anything unusual, and SEKA shouldn\u2019t have noticed her at all. \r","\t\t*set Monica_choice 4\r","\t\t*if worse_score < 2\r","\t\t\t*set worse_score 2\r","\t\t\t*set worse_person \"Monica\"\r","\t\t\t*set worse_choice 4\r","\t\t\t*goto m4\r","\t\t*label m4\r","\t\t*set boss_regard -2\r","\t\t*return\r","\r","*label Tonya\r","*comment Tonya S\r","*if not(see_completion)\r","\t*page_break\r","\tIt\u2019s a short walk to Tonya S\u2019s work area, where the software usability research group sits. \r","\t*if read_Tonya\r","\t\tFrom her case record, you remember she\u2019s the one who wows her boss and is some kind of Internet famous person.\r","\t\t*goto tp1\r","\t*label tp1\r","\tHer office is empty, but you see her talking with people around a white board. They finish their discussion. The others leave, but she stays to make a few more notes on the board. \r","\t*gosub Tonya_action\r","\t*return\r","*else\r","\t*gosub Tonya_action\r","\t*return\r","\r","*label Tonya_action\r","*page_break\r","*if not(see_completion)\r","\tWhat do you do first to investigate Tonya?\r","\t*goto Tonya_choice\r","*else\r","\tWhat do you do next?\r","\t*goto Tonya_choice\r","*label Tonya_choice\r","*choice\r","\t*disable_reuse #Approach her directly.\r","\t\t*set actions_left -1\r","\t\t*gosub Tonya_interact\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Talk to her coworkers about her.\r","\t\t*set actions_left -1\r","\t\t*gosub Tonya_rumor\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Flip through the binder for more archived records.\r","\t\t*set actions_left -1\r","\t\t*gosub Tonya_history\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Perform divination.\r","\t\t*set actions_left -1\r","\t\t*gosub Tonya_divination\r","\t\t*set see_completion true\r","\t\t*return\r","\t*if see_completion \r","\t\t#Complete your report on her.\r","\t\t\t*set person_total +1\r","\t\t\t*gosub Tonya_report\r","\t\t\t*set see_completion false\r","\t\t\tYour report on Tonya is submitted!\r","\t\t\t*return\r","\r","*label Tonya_interact\r","You walk over to the whiteboard and introduce yourself. How do you explain your errand?\r","*set stat_check interaction + diligence\r","*choice\r","\t#You were recommended to me as an example of a high achieving project manager. Do you have time to talk about how you succeed?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_talk_mid\r","\t\t\t*return\r","\t#I\u2019m trying to understand more about how usability researchers at Ubiquity work. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_talk_mid\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_talk_mid\r","\t\t\t*return\r","\t#You don\u2019t know me, but I\u2019m hiding from an annoying coworker. Can I sit in your office for a while?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_talk_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_talk_low\r","\t\t\t*return\r","\r","*label Tonya_talk_high\r","Tonya nods. \u201cLet\u2019s go sit in my office for a minute. How can I help you?\u201d\r","\r","You both sit in her office. Her desk is neat, and she has flowers on her desk. She\u2019s also got a picture of herself as a teenager, shaking hands with a talk show host. \r","\r","\u201cIn your experience, what are some things about the work environment, Ubiquity company rules, or human psychology that hurt productivity?\u201d\r","*line_break\r","\u201cWell, there are a million reasons for non-optimal productivity that are rooted in human psychology, like cognitive biases.\u201d\r","*line_break\r","\u201cAny particular phenomena that you find impacts your work at Ubiquity often?\u201d\r","\r","She points to the picture. \u201cThis is funny, but also a little sad. When I was in high school, I posted a lot of videos about building LEGO models, and got to be kind of famous. It\u2019s been years, but recently someone posted my work contact information on some old forums, and now I\u2019m getting phone calls and emails from all these fans with detailed questions about things I can\u2019t even remember. I really need Ubiquity to come up with a way to block these kinds of calls, without blocking people who need to talk to me for work.\u201d\r","*return\t\t\t\r","\r","*label Tonya_talk_low\r","Tonya nods. \u201cSure! I\u2019m in meetings for the next hours, but help yourself.\u201d\r","\r","You walk into her office. Her desk is neat, and she has flowers on her desk. She\u2019s also got a picture of herself as a teenager, shaking hands with a talk show host. \r","*return\r","\r","*label Tonya_talk_mid\r","Tonya nods. \u201cLet\u2019s go sit in my office for a minute. How can I help you?\u201d\r","\r","You both sit in her office. Her desk is neat, and she has flowers on her desk. She\u2019s also got a picture of herself as a teenager, shaking hands with a talk show host. The phone rings. \r","\r","\"I\u2019d better get this.\u201d \r","*line_break\r","You smile and gesture for her to continue. \r","*line_break\r","\u201cOh, I\u2019m sorry, I can\u2019t help you with that; I\u2019m not supporting those old LEGO video instructions anymore. No, I don\u2019t know whom else to call. Good luck with your project.\u201d\r","*line_break\r","\u201cDoes that happen to you a lot?\u201d you ask.\r","*line_break\r","\u201cUnfortunately, yes.\u201d\r","*return\r","\r","*label Tonya_rumor\r","You follow one of Tonya\u2019s coworkers to her office. How do you explain your errand?\r","*set stat_check rumor + diligence\r","*choice\r","\t#You were recommended to me as an example of someone who understand how things work in this group. Do you have time to explain it?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_rumor_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_rumor_refuse\r","\t\t\t*return\r","\t#I\u2019m thinking of transferring, and wanted to know more about your group. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_rumor_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_rumor_refuse\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_rumor_mid\r","\t\t\t*return\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Tonya_rumor_talk\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Tonya_rumor_mid\r","\t\t\t*return\r","\r","*label Tonya_rumor_talk\r","\u201cSure, if you can be quick. What can I tell you?\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual about Tonya\u2019s work routine?\u201d\r","*line_break\r","\u201cI don\u2019t know how she does it, but she gets more done than anyone else in the group.\u201d\r","*line_break\r","\u201cShe must be a very focused person.\u201d\r","*line_break\r","\u201cFor sure. Even when she was a teenager, she was making these detailed online videos about LEGOs spaceships or something. People still track her down and bother her with questions about her designs.\u201d\r","*return\r","\r","*label Tonya_rumor_mid\r","\u201cSure, if you can be quick. What can I tell you?\u201d\r","\r","\u201cShe gets to work pretty early, compared to most of us. I think she likes to get an hour of uninterrupted work done before everyone else gets in!\u201d\r","*line_break\r","\u201cIt can be good to have some uninterrupted time.\u201d\r","*line_break\r","\u201cRight, because everyone is always pestering her.\u201d\r","*return\r","\r","*label Tonya_rumor_refuse\r","She looks at the clock. \u201cOh, I\u2019m probably not the best person to talk about that kind of thing. Maybe you should talk to Tonya.\u201d\r","*return\r","\r","*label Tonya_history\r","*page_break\r","*set stat_check history + diligence\r","*if stat_check > 3\r","\tYou see a security report from Tonya, alerting the front desk to refuse visitors who want to talk to her about her old portfolio of LEGO videos.\r","\t*return\r","*else\r","\tYou see Tonya\u2019s original employment application, listing scholarships and awards including Best Student Paper for \u201cFrontiers of Video Blogs and Mobile Platforms\u201d, a STEM education award for online videos inspiring an interest in engineering.\r","\t*return\r","\r","*label Tonya_divination\r","*page_break\r","*set stat_check soul\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a Sun.\r","\r","*if stat_check > 3 \r","\t[i]She draws a lot of attention, but has nothing to hide. Doesn\u2019t sound like she\u2019s running any kind of shady business, but people might be pestering her.[/i] \r","\t*return\r","*else\r","\t[i]The Sun is usually a positive personality, so she\u2019s probably not doing anything wrong.[/i]\r","\t*return\r","*return\r","\r","*label Tonya_report\r","What do you decide about Tonya S?\r","*choice\r","\t#She is doing something bad, and SEKA was right to be suspicious.\r","\t\t*set Tonya_choice 1\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Tonya\"\r","\t\t\t*set worse_choice 1\r","\t\t\t*goto t1\r","\t\t*label t1\r","\t\t*return\r","\t#She is doing something unusual and which demonstrated a problem, and SEKA was right to flag her case as needing followup investigation. \r","\t\t*set Tonya_choice 2\r","\t\t*set boss_regard +1\r","\t\t*return\r","\t#She is doing something outside of the norm, but SEKA shouldn\u2019t have flagged her case as needing followup investigation.\r","\t\t*set Tonya_choice 3\r","\t\t*if worse_score = 0\r","\t\t\t*set worse_score 0\r","\t\t\t*set worse_person \"Tonya\"\r","\t\t\t*set worse_choice 3\r","\t\t\t*goto t3\r","\t\t*label t3\r","\t\t*return\r","\t#She isn\u2019t doing anything unusual, and SEKA shouldn\u2019t have noticed her at all. \r","\t\t*set Tonya_choice 4\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Tonya\"\r","\t\t\t*set worse_choice 4\r","\t\t\t*goto t4\r","\t\t*label t4\r","\t\t*return\r","\r","*label Van\r","*comment Van O\r","*if not(see_completion)\r","\t*page_break\r","\tVan O\u2019s office is in a central location. He\u2019s the group\u2019s administrative assistant, and sits in an open, airy lobby. \r","\t*if read_Van\r","\t\tYou remember from his case record that he\u2019s the one obsessed with politics and statistics.\r","\t\t*goto vp1\r","\t*label vp1\r","\tYou watch people walking through, seemingly in a hurry. Everyone waves to Van and smiles, but no one stops to talk. \t\r","\t*gosub Van_action\r","\t*return\r","*else\r","\t*gosub Van_action\r","\t*return\r","\r","\r","*label Van_action\r","*page_break\r","*if not(see_completion)\r","\tWhat do you do first to investigate Van?\r","\t*goto Van_choice\r","*else\r","\tWhat do you do next?\r","\t*goto Van_choice\r","*label Van_choice\r","*choice\r","\t*disable_reuse #Approach him directly.\r","\t\t*set actions_left -1\r","\t\t*gosub Van_interact\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Talk to his coworkers about him.\r","\t\t*set actions_left -1\r","\t\t*gosub Van_rumor\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Flip through the binder for more archived records.\r","\t\t*set actions_left -1\r","\t\t*gosub Van_history\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Perform divination.\r","\t\t*set actions_left -1\r","\t\t*gosub Van_divination\r","\t\t*set see_completion true\r","\t\t*return\r","\t*if see_completion \r","\t\t#Complete your report on him.\r","\t\t\t*set person_total +1\r","\t\t\t*gosub Van_report\r","\t\t\t*set see_completion false\r","\t\t\tYour report on Van is submitted!\r","\t\t\t*return\r","\r","*label Van_interact\r","You walk over to Van\u2019s desk and introduce yourself. How do you explain your errand?\r","*set stat_check interaction + diligence\r","*choice\r","\t#You were recommended to me as an example of a high achieving administrative assistant. Do you have time to talk about how you succeed?\r","\t\t*gosub Van_talk\r","\t\t*return\r","\t#I\u2019m trying to understand more about how administrative assistants at Ubiquity work. Do you have time to talk?\r","\t\t*gosub Van_talk\r","\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*gosub Van_talk\r","\t\t*return\r","\t#You don\u2019t know me, but I\u2019m considering becoming an administrative assistant. Can I ask you about the job?\r","\t\t*gosub Van_talk\r","\t\t*return\r","\r","*label Van_talk\r","Van points to a seat next to his. \u201cThe first thing you need to know is that my job at Ubiquity, like many other jobs anywhere, can be analyzed and the types of requests I get can be ranked by probability. Once I understand the probability distribution of different requests, I can optimize preparations and scheduling for high expected efficiency values.\u201d\r","\r","You interrupt. \u201cHave you found anything about the environment, people, or rules at Ubiquity that cuts down on your productivity?\u201d\r","*line_break\r","\u201cOf course, if the probability distribution was narrower, and there was less daily variability, I could probably optimize more. If I could convince the group that I\u2019m supporting to make some travel booking requests only on Mondays, for example\u2026\u201d\r","*line_break\r","You interrupt again. \u201cAny sorts of distractions give you trouble?\u201d\r","*line_break\r","Van stops to consider. \u201cI\u2019ve been grappling with what I think will happen at the upcoming economic summit. Chances are low for an international agreement, but chances are high that the US and China will push for a delay in implementation for the\u2026\u201d\r","\r","A tall woman in a suit walks over. \u201cExcuse me, Van, can I give you the innovations review meeting agenda for next week? We need to make sure that all the key presenters can make their slots, but they don\u2019t all have to stay the whole time.\u201d\r","\r","You wave at Van, and make your escape.\r","*return\r","\r","*label Van_rumor\r","You go over to the water cooler, where two people are talking about baseball. After the man leaves, how do you explain your errand to the woman remaining?\r","*set stat_check rumor + diligence\r","*choice\r","\t#Hi, I\u2019m trying to understand how things work in this group. Do you have time to explain a little?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Van_rumor_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Van_rumor_refuse\r","\t\t\t*return\r","\t#I\u2019m surveying people about administrative assistant support. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Van_rumor_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Van_rumor_refuse\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Van_rumor_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Van_rumor_refuse\r","\t\t\t*return\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Van_rumor_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Van_rumor_refuse\r","\t\t\t*return\r","\r","*label Van_rumor_high\r","\u201cSure thing. What can I tell you?\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual about Van\u2019s work habits.\u201d\r","*line_break\r","\u201cHe\u2019s unusual in several ways.\u201d\r","*line_break\r","\u201cDo you think his interest in calculating probabilities is helpful or harmful in terms of doing his job?\u201d\r","*line_break\r","\u201cTo be honest, it\u2019s awkward to have a secretary whom everyone has to keep dodging conversations with. Plus, he\u2019s always trying to convince people to join his online political predictions game, which is the most boring thing ever.\r","*line_break\r","\u201cSounds like you\u2019ve seen what it\u2019s about?\u201d\r","*line_break\r","\u201cYeah, players basically bet on whether different things will happen or not, like the outcome of elections, but all kinds of minor stuff that no one really cares about.\u201d\r","*return\r","\r","*label Van_rumor_mid\r","\u201cI think there are a couple ways we could improve things around here. First of all, we need to have fewer required online training course.\u201d\r","\r","\u201cYeah, I\u2019ve heard that from some people. Do you have any thoughts about administrative assistants like Van?\u201d\r","*line_break\r","\u201cI don\u2019t think there are any other administrative assistants like Van.\u201d\r","*line_break\r","\u201cOh?\u201d\r","*line_break\r","\u201cHe\u2019s efficient, as long as you don\u2019t get trapped talking to him, or let him show you his website.\u201d\r","*line_break\r","\u201cThen what?\u201d\r","*line_break\r","\u201cI hear from other folks that he\u2019ll try to get you to work on political analysis or something.\u201d\r","*return\r","\r","*label Van_rumor_refuse\r","\u201cI\u2019m new here, so probably not the right person to ask.\u201d\r","*return\r","\r","*label Van_history\r","*page_break\r","You see several letters from Van, suggesting ways Ubiquity could become more efficient\r","\r","*set stat_check history + diligence\r","*if stat_check > 3\r","\t\u201cAs I said last year, I would be happy to set up a predictions market for internal use, where Ubiquity employees could wager on the outcomes of projects and initiatives. This kind of crowdsourced prediction could help us get early warning about efforts that are likely to fail. I\u2019ve run this kind of service before, and could brief management about how it works.\u201d\r","\t*return\r","*else\r","\t\u201cThe are a number of inefficiencies caused by employees waiting until the last minute to submit requests to administrative assistants. If we set up an internal costs and incentives tracking system so that people would pay less for timely requests and more for urgent requests, we could use the power of economics to shape employee behaviors to facilitate efficiency.\u201d\r","\t*return\r","\t\r","*label Van_divination\r","*page_break\r","*set stat_check soul\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a pair of dice.\r","\r","*if stat_check > 3 \r","\t[i]Taking wagers on the future. Looks like he\u2019s playing the bookie.[/i] \r","\t*return\r","*else\r","\t[i]Rolling the dice. He might be gambling with his future?[/i]\r","\t*return\r","*return\r","\r","*label Van_report\r","What do you decide about Van 0?\r","*choice\r","\t#He is doing something bad, and SEKA was right to be suspicious.\r","\t\t*set Van_choice 1\r","\t\t*set boss_regard +1\r","\t\t*return\r","\t#He is doing something unusual and which demonstrated a problem, and SEKA was right to flag his case as needing followup investigation. \r","\t\t*set Van_choice 2\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Van\"\r","\t\t\t*set worse_choice 2\r","\t\t\t*goto v2\r","\t\t*label v2\r","\t\t*return\r","\t#He is doing something outside of the norm, but SEKA shouldn\u2019t have flagged his case as needing followup investigation.\r","\t\t*set Van_choice 3\r","\t\t*set boss_regard -2\r","\t\t*if worse_score < 2\r","\t\t\t*set worse_score 2\r","\t\t\t*set worse_person \"Van\"\r","\t\t\t*set worse_choice 3\r","\t\t\t*goto v3\r","\t\t*label v3\r","\t\t*return\r","\t#He isn\u2019t doing anything unusual, and SEKA shouldn\u2019t have noticed him at all. \r","\t\t*set Van_choice 4\r","\t\t*set boss_regard -2\r","\t\t*if worse_score < 2\r","\t\t\t*set worse_score 2\r","\t\t\t*set worse_person \"Van\"\r","\t\t\t*set worse_choice 4\r","\t\t\t*goto v4\r","\t\t*label v4\r","\t\t*return\r","\r","\r","*label Zenina\r","*comment Zenina B\r","*if not(see_completion)\r","\t*page_break\r","\tZenina works in Contracts, on the next-to-highest floor of the building.\r","\t*if read_Zenina\t\r","\t\tYou remember from her case record that she sounds like the helpful but potentially busybody type.\r","\t\t*goto zp1\r","\t*label zp1\r","\tHer team must be celebrating something, because they\u2019re gathered around the kitchenette having cake. They finish and go back to their offices, but Zenina stays for a minute to wash up.\r","\t*gosub Zenina_action\r","\t*return\r","*else\r","\t*gosub Zenina_action\r","\t*return\r","\r","*label Zenina_action\r","*page_break\r","*if not(see_completion)\r","\tWhat do you do first to investigate Zenina?\r","\t*goto Zenina_choice\r","*else\r","\tWhat do you do next?\r","\t*goto Zenina_choice\r","*label Zenina_choice\r","*choice\r","\t*disable_reuse #Approach her directly.\r","\t\t*set actions_left -1\r","\t\t*gosub Zenina_interact\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Talk to his coworkers about her.\r","\t\t*set actions_left -1\r","\t\t*gosub Zenina_rumor\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Flip through the binder for more archived records.\r","\t\t*set actions_left -1\r","\t\t*gosub Zenina_history\r","\t\t*set see_completion true\r","\t\t*return\r","\t*disable_reuse #Perform divination.\r","\t\t*set actions_left -1\r","\t\t*gosub Zenina_divination\r","\t\t*set see_completion true\r","\t\t*return\r","\t*if see_completion \r","\t\t#Complete your report on her.\r","\t\t\t*set person_total +1\r","\t\t\t*gosub Zenina_report\r","\t\t\t*set see_completion false\r","\t\t\tYour report on Zenina is submitted!\r","\t\t\t*return\r","\r","*label Zenina_interact\r","You walk over and introduce yourself. How do you explain your errand?\r","*set stat_check interaction + diligence\r","*choice\r","\t#You were recommended to me as an example of a high achieving Contracts representative. Do you have time to talk about how you succeed?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_talk_low\r","\t\t\t*return\r","\t#I\u2019m trying to understand more about how the Contracts department at Ubiquity works. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_talk_low\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_talk_low\r","\t\t\t*return\r","\t#You don\u2019t know me, but I like cake. Can I ask you about your job?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_talk_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_talk_low\r","\t\t\t*return\r","\r","*label Zenina_talk_high\r","Zenina hands you a slice of cake. \u201cWhat can I help you with?\u201d\r","\r","\u201cDo you ever find that for some reason, it\u2019s hard to be productive here at Ubiquity?\u201d\r","*line_break\r","\u201cThat\u2019s my life! If it\u2019s not a software upgrade changing all the menus, it\u2019s someone from my church who needs a casserole and prayers.\u201d\r","*line_break\r","\u201cYou must help a lot of people.\u201d\r","*line_break\r","\u201cThat\u2019s why I was put on this earth, so I do my best.\u201d\r","*line_break\r","\u201cWhat sorts of things seem like they help people the most?\u201d\r","*line_break\r","\u201cAt Ubiquity, like everywhere else, everyone hates change. So I try to volunteer to be the guinea pig when software systems change. I\u2019m not afraid to complain if the new system is bad, so they can fix it up before everyone else has to use it.\u201d\r","*line_break\r","\u201cMmm hmm\u201d\r","*line_break\r","\u201cAnd this week is my turn to run the prayer chain group, so I Facebook or email with anyone who has requests, make sure the request are appropriate, write up a big list, and send it out to volunteers. You wouldn\u2019t believe how many people need a little help, and how many willing volunteers there are.\u201d\r","*return\r","\r","*label Zenina_talk_low\r","Zenina hands you a slice of cake. \u201cWhat can I help you with?\u201d\r","\r","\u201cDo you ever find that for some reason, it\u2019s hard to be productive at your job here at Ubiquity?\u201d\r","*line_break\r","\u201cOh yes. If it\u2019s not a software upgrade changing all the menus, it\u2019s a youngster who needs advice or help. Such as yourself, for example!\u201d\r","*line_break\r","\u201cI appreciate your time.\u201d\r","*line_break\r","\u201cYou might want to consider upgrading your shoes. Polished leather always looks professional.\u201d\r","*line_break\r","\u201cUh, thank you.\u201d\r","*return\r","\r","*label Zenina_rumor\r","You follow one of Zenina\u2019s coworkers to his office. How do you explain your errand?\r","*set stat_check rumor + diligence\r","*choice\r","\t#You were recommended to me as an example of someone who understand how things work in Contracts. Do you have time to explain it?\r","\t\t*gosub Zenina_rumor_mid\r","\t\t*return\r","\t#I\u2019m thinking of transferring, and wanted to know more about Contracts. Do you have time to talk?\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_rumor_mid\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_rumor_refuse\r","\t\t\t*return\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*if stat_check > 3\r","\t\t\t*gosub Zenina_rumor_high\r","\t\t\t*return\r","\t\t*else\r","\t\t\t*gosub Zenina_rumor_mid\r","\t\t\t*return\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*gosub Zenina_rumor_mid\r","\t\t*return\r","\r","\r","*label Zenina_rumor_high\r","\u201cGo ahead and ask. What can I tell you?\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual about Zenina\u2019s work habits.\u201d\r","*line_break\r","\u201cShe\u2019s always patient and cheerful, even when the software is buggy. I\u2019ve never heard her swear.\u201d\r","*line_break\r","\u201cShe\u2019s pretty good with technology?\u201d\r","*line_break\r","\u201cYeah, she runs some parts of her church website, and she\u2019s kind of our go-to person for software questions.\u201d\r","*return\r","\r","*label Zenina_rumor_mid\r","\u201cSure, if it\u2019s quick.\u201d\r","\r","\u201cI was wondering if you ever noticed anything unusual about Zenina\u2019s work habits.\u201d\r","*line_break\r","\u201cShe sometimes acts like a mother hen, but I think people get along with her.\u201d\r","*line_break\r","\u201cDoes she do anything different with the computer than other people?\u201d\r","*line_break\r","\u201cI think she\u2019s got her screensaver set to cycle through Bible verses, which doesn\u2019t bother any of us.\u201d\r","*return\r","\r","*label Zenina_rumor_refuse\r","\u201cHonestly, I don\u2019t think we have any openings. But I think Subcontracts needs someone.\u201d\r","\r","*label Zenina_history\r","*page_break\r","You see a few more of Zenina's incoming emails.\r","\r","*set stat_check history + diligence\r","*if stat_check > 3\r","\t\u201cI\u2019d like to ask people to pray for my son, who\u2019s failing two classes.\u201d \r","\t*line_break\r","\t\u201cPlease find attached the draft contract for MC200045.\u201d \r","\t*line_break\r","\t\u201cMary and Lisa arrived back safely yesterday, thank you to everyone who prayed for their safe journey.\u201d\r","\t*return\r","*else\r","\t\u201cPlease find attached the draft contract for MC200045.\u201d \r","\t*line_break\r","\t\u201cThe rehearsal is canceled next week.\u201d \r","\t*line_break\r","\t\u201cShe\u2019s been suffering with asthma since she was born, but it\u2019s worse this year.\u201d\r","\t*return\r","\r","*label Zenina_divination\r","*page_break\r","*set stat_check soul\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a candle.\r","\r","*if stat_check > 3 \r","\t[i]She\u2019s honest, caring, and helping people in need.[/i] \r","\t*return\r","*else\r","\t[i]Candles often mean someone is caring.[/i]\r","\t*return\r","*return\r","\r","*label Zenina_report\r","What do you decide about Zenina B?\r","*choice\r","\t#She is doing something bad, and SEKA was right to be suspicious.\r","\t\t*set Zenina_choice 1\r","\t\t*set boss_regard -1\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Zenina\"\r","\t\t\t*set worse_choice 1\r","\t\t\t*goto z1\r","\t\t*label z1\r","\t\t*return\r","\t#She is doing something unusual and which demonstrated a problem, and SEKA was right to flag her case as needing followup investigation. \r","\t\t*set Zenina_choice 2\r","\t\t*if worse_score = 0\r","\t\t\t*set worse_score 0\r","\t\t\t*set worse_person \"Zenina\"\r","\t\t\t*set worse_choice 2\r","\t\t\t*goto z2\r","\t\t*label z2\r","\t\t*return\r","\t#She is doing something outside of the norm, but SEKA shouldn\u2019t have flagged her case as needing followup investigation.\r","\t\t*set Zenina_choice 3\r","\t\t*set boss_regard +1\r","\t\t*return\r","\t#She isn\u2019t doing anything unusual, and SEKA shouldn\u2019t have noticed her at all. \r","\t\t*set Zenina_choice 4\r","\t\t*if worse_score < 1\r","\t\t\t*set worse_score 1\r","\t\t\t*set worse_person \"Zenina\"\r","\t\t\t*set worse_choice 4\r","\t\t\t*goto z4\r","\t\t*label z4\r","\t\t*set boss_regard -1\r","\t\t*return\r","\r","\r","*label actions_done\r","*if person_total < 5\r","\tUh oh, it's almost 3pm. You have just enough time to jot down a decision for the rest of the suspects on your list.\r","\t*gosub finish_reporting\r","\t*finish\r","*else\r","\tYou head to your meeting with Margot and Rene.\r","\t*finish\r","\r","*label people_done\r","*comment (If you finished before using all your actions) \r","*page_break\r","You finished making your decision on all five suspects before 3pm. What do you do now?\r","*choice\r","\t#Head back to the conference room early, in case Rene or Margot are there. \r","\t\t*set boss_regard +1\r","\t\t*goto actions_done\r","\t#Stake out the cafeteria to try and overhear useful information. \r","\t\t*set diligence +1\r","\t\tYou sit down at the far end of the cafeteria with a cup of coffee, looking at a newspaper that someone left on the table. It\u2019s long past lunchtime, so there are only a few clusters of employees. \r","\t\r","\t\t\u201cHow was your weekend?\u201d \r","\t\t*line_break\r","\t\t\u201cEh, I had pager duty, so I ended up having to come in twice.\u201d \r","\t\t*line_break\r","\t\t\u201cOh yeah, there must be something going on with the network.\u201d \r","\t\t*line_break\r","\t\t\u201cIt\u2019s always something, but things seemed extra frantic this time. I just wanted to be home watching a bunch of shows I recorded.\u201d \r","\t\t*page_break\r","\t\t*goto actions_done\r","\t#Divination to check the decisions you made.\r","\t\t*gosub summary_divination\r","\t\t*page_break\r","\t\t*goto actions_done\r","\r","*label summary_divination\r","*page_break\r","You take out your Virtual Teacup. Which of these people should I re-examine? \r","*temp redivine\r","*set redivine worse_person&\"_redivine\"\r","*gosub {redivine}\r","*return\t\r","\r","*label was_doing\r","*if worse_choice = 1\r","\t*set doing_phrase \"was doing something bad.\"\r","\t*return\r","*if worse_choice = 2\r","\t*set doing_phrase \"was doing something unusual that needed followup.\"\r","\t*return\r","*if worse_choice = 3\r","\t*set doing_phrase \"was doing something odd with no followup needed.\"\r","\t*return\r","*if worse_choice = 4\r","\t*set doing_phrase \"was acting completely normal.\"\r","\t*return\r","\r","*label None_redivine\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of the world. [i]The picture is complete and nothing should be added or removed. No need to re-examine anyone.[/i]\r","*return\r","\t\r","*label Jason_redivine\r","*page_break\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a perched crow. Jason is someone who complains a lot and people don\u2019t like him, but he isn\u2019t actually causing the problem. \r","\r","You remember one phrase you saw in his case record, in a letter from Jason to his manager. \u201cI am constantly interrupted by wrong number phone calls. On average, I get twenty calls per day asking for people I don\u2019t even know.\u201d\r","\r","*temp doing_phrase\r","*gosub was_doing\r","*if worse_score = 2\r","\t*set boss_regard +2\r","\t*goto jrecap\r","*if worse_score = 1\r","\t*set boss_regard +1\r","\t*goto jrecap\r","*label jrecap\r","Previously, you decided that Jason L ${doing_phrase} You may re-evaluate that decision now.\r","\r","*gosub Jason_report\r","*return\r"," \r","*label Monica_redivine\r","*page_break\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a knapsack. Monica is seems busy with a financial venture, which could be a side business.\r","\r","You remember one phrase you saw in her case record, a comment from a coworker. \u201cHer office is literally stuffed with stuffed animals.\u201d\r","\r","*temp doing_phrase\r","*gosub was_doing\r","*if worse_score = 2\r","\t*set boss_regard +2\r","\t*goto mrecap\r","*if worse_score = 1\r","\t*set boss_regard +1\r","\t*goto mrecap\r","*label mrecap\r","Previously, you decided that Monica T ${doing_phrase} You may re-evaluate that decision now.\r","\r","*gosub Monica_report\r","*return\r","\r","*label Tonya_redivine\r","*page_break\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a Sun. Tonya draws a lot of attention, but has nothing to hide. Doesn\u2019t sound like she\u2019s running any kind of shady business, but people might be pestering her.\r","\r","You remember one phrase you saw in her case record, from an incoming email. \u201cI hope you\u2019ll write back, or start posting again! I miss your humor and flair for the ridiculous.\u201d\r","\r","*temp doing_phrase\r","*gosub was_doing\r","*if worse_score = 2\r","\t*set boss_regard +2\r","\t*goto trecap\r","*if worse_score = 1\r","\t*set boss_regard +1\r","\t*goto trecap\r","*label trecap\r","Previously, you decided that Tonya S ${doing_phrase} You may re-evaluate that decision now.\r","\r","*gosub Tonya_report\r","*return\r","\r","*label Van_redivine\r","*page_break\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a pair of dice. Van is taking wagers on the future. Looks like he\u2019s playing the bookie.\r","\r"," You remember one phrase you saw in his case record, from an incoming email. \u201cThings are going to go crazy in Indonesia. I\u2019ve put my money on a coup.\u201d\r"," \r","*temp doing_phrase\r","*gosub was_doing\r","*if worse_score = 2\r","\t*set boss_regard +2\r","\t*goto vrecap\r","*if worse_score = 1\r","\t*set boss_regard +1\r","\t*goto vrecap\r","*label vrecap\r","Previously, you decided that Van O ${doing_phrase} You may re-evaluate that decision now.\r","\r","*gosub Van_report\r","*return\r","\r","*label Zenina_redivine\r","*page_break\r","You swirl and dump your Virtual Teacup, and the leaves clump into the shape of a candle. Zenina\u2019s honest, caring, and helps people in need.\r","\r","You remember one phrase you saw in her case record, from an incoming email. \u201cI\u2019d like to ask people to pray for my son, who\u2019s failing two classes.\u201d\r"," \r","*temp doing_phrase\r","*gosub was_doing\r","*if worse_score = 2\r","\t*set boss_regard +2\r","\t*goto zrecap\r","*if worse_score = 1\r","\t*set boss_regard +1\r","\t*goto zrecap\r","*label zrecap\r","Previously, you decided that Zenina B ${doing_phrase} You may re-evaluate that decision now.\r","\r","*gosub Zenina_report\r","*return\r","\r","\r",""], "labels":{"investigate":29,"continue_investigate":52,"finish_reporting":71,"next_person_1":79,"next_person_2":86,"next_person_3":93,"next_person_4":100,"jason":108,"jason_action":119,"jason_choice":127,"jason_interact":157,"jason_talk":178,"jason_refuse":190,"jason_rumor":194,"jason_rumor_talk":223,"jason_rumor_mid":231,"jason_rumor_refuse":235,"jason_history":239,"jason_divination":251,"jason_report":264,"j1":275,"j3":288,"j4":298,"monica":301,"mp1":309,"monica_action":317,"monica_choice":325,"monica_interact":355,"monica_talk_high":376,"monica_talk_low":394,"monica_talk_mid":408,"monica_rumor":426,"monica_rumor_talk":460,"monica_rumor_mid":468,"monica_rumor_refuse":480,"monica_history":484,"monica_divination":494,"monica_report":507,"m2":521,"m3":531,"m4":540,"tonya":544,"tp1":552,"tonya_action":560,"tonya_choice":568,"tonya_interact":598,"tonya_talk_high":631,"tonya_talk_low":645,"tonya_talk_mid":651,"tonya_rumor":667,"tonya_rumor_talk":700,"tonya_rumor_mid":712,"tonya_rumor_refuse":722,"tonya_history":726,"tonya_divination":736,"tonya_report":749,"t1":760,"t3":773,"t4":783,"van":786,"vp1":794,"van_action":803,"van_choice":811,"van_interact":841,"van_talk":858,"van_rumor":874,"van_rumor_high":907,"van_rumor_mid":923,"van_rumor_refuse":939,"van_history":943,"van_divination":955,"van_report":968,"v2":983,"v3":993,"v4":1003,"zenina":1007,"zp1":1015,"zenina_action":1023,"zenina_choice":1031,"zenina_interact":1061,"zenina_talk_high":1094,"zenina_talk_low":1114,"zenina_rumor":1128,"zenina_rumor_high":1154,"zenina_rumor_mid":1166,"zenina_rumor_refuse":1178,"zenina_history":1181,"zenina_divination":1201,"zenina_report":1214,"z1":1225,"z2":1234,"z4":1247,"actions_done":1252,"people_done":1261,"summary_divination":1287,"was_doing":1295,"none_redivine":1309,"jason_redivine":1313,"jrecap":1327,"monica_redivine":1333,"mrecap":1347,"tonya_redivine":1353,"trecap":1367,"van_redivine":1373,"vrecap":1387,"zenina_redivine":1393,"zrecap":1407}},"case_1_resolution": {"crc":907104267, "lines":["*if skip\r","\t*finish\r","You get back to the conference room at the same time as both Rene and Margot. \r","\r","\u201cTeam\u2019s all here. Let\u2019s get started, then, so we aren\u2019t here all night, trying to figure out why people were setting off SEKA\u2019s alarms.\u201d Margot says.\r","*page_break\r","Rene quickly opens ${ihis} laptop. \u201cI\u2019m going to log into SEKA\u2019s artificial intelligence retraining module. For each person who was an investigation target, we can let SEKA know whether it made a correct decision to flag them as running an illicit side business, or otherwise needing attention. If SEKA was wrong, we can also explain what the person was really doing, so the artificial intelligence can get smarter about the range of employees at Ubiquity.\u201d\r","\r","\u201cCasey, you can go first. Tell us your decisions in alphabetical order, and we\u2019ll quickly double-check them with the information in the case records. If we have to, we can also query SEKA for more information.\u201d \r","\r","You stand up and start reviewing your decisions.\r","*page_break\r","*gosub Zenina\r","*page_break\r","*gosub Jason\r","*page_break\r","*gosub Van\r","*page_break\r","*gosub Tonya\r","*page_break\r","*gosub Monica\r","*page_break\r","*gosub wrapup\r","\r","*label Zenina\r","*if Zenina_choice = 1\r","\tChecking out Zenina B, I got the sense that she is running an illicit side business, probably selling blessings and prayers for a cult.\r","\t\r","\tMargot glances through Zenina\u2019s binder and frowns at you. \u201cI don\u2019t see that at all. What was the basis of your decision?\u201d\r","\t*line_break\r","\t\u201cI\u2026that was just what I thought.\u201d\r","\t*line_break\r","\t\u201cYou\u2019re going to have to do better than wild guesses.\u201d\r","\t*return\r","*if Zenina_choice = 2\r","\tChecking out Zenina B, she runs her church\u2019s website and sometimes organizes for their prayer chain. It was worth a look to check, but I don\u2019t think she\u2019s using a lot of company time or resources.\r","\r","\t\u201cAlright, I think SEKA should have been able to figure that out itself, but I agree with your conclusion about what Zenina\u2019s been doing,\u201d Margot says.\r","\t*return\r","*if Zenina_choice = 3\r","\tChecking out Zenina B, the only odd thing she\u2019s been doing is running her church\u2019s website and taking a turn organizing for their prayer chain. It\u2019s not much company time or resources, and I don\u2019t think SEKA should flag people like this.\r","\r","\t\u201cI agree,\u201d Margot says.\r","\t*return\r","*if Zenina_choice = 4\r","\tChecking out Zenina B, she seemed to have completely normal behavior, and I have no idea why SEKA flagged her.\r","\t\r","\t\u201cMaybe because she\u2019s running her church\u2019s website and being the prayer chain organizer,\u201d Margot says. \u201cI agree that SEKA shouldn\u2019t have suspected her of running an illicit business, but her behavior wasn\u2019t totally normal either. You\u2019ve got to look a little harder at these people.\u201d\r","\t*return\r","\r","*label Jason\r","*if Jason_choice = 1\r","\tI\u2019m pretty sure that Jason L is running an illicit business, probably gold farming in an online game.\r","\t\r","\tMargot gives you a look. \u201cI don\u2019t see that at all. How did you draw that conclusion?\r","\t*line_break\r","\t\u201cHe just seems like the type.\u201d\r","\t*line_break\r","\t\u201cYou\u2019re going to have to be more evidence-based here.\u201d\r","\t*return\r","*if Jason_choice = 2\r","\tJason L has a problem that needs some followup. He\u2019s getting dozens of wrong-number phone calls every day because his phone number is very similar to Ubiquity\u2019s central directory number. This is upsetting him and causing tensions in his group. I can see why SEKA would flag the situation, though there\u2019s no side business going on.\r","\r","\tMargot closes Jason\u2019s binder. \u201cThat sounds right,\u201d she says.\r","\t*return\r","*if Jason_choice = 3\r","\tJason L has a strange problem where he\u2019s dozens of wrong-number phone calls every day because his phone number is very similar to Ubiquity\u2019s central directory number. SEKA shouldn\u2019t have flagged him, since there\u2019s no illicit side business going on.\r","\r","\t\u201cAlright, I think it\u2019s good when SEKA flags these situations that Ubiquity should try to fix, but you\u2019re right that Jason isn\u2019t running a problematic side business.\r","\t*return\r","*if Jason_choice = 4\r","\tJason L is just a normal acting guy, and I don\u2019t know why SEKA flagged him.\r","\r","\tMargot closes Jason\u2019s binder. \u201cI\u2019d say it was because he\u2019s getting so many wrong-number phone calls from outside callers every day, and that we need to do something so it\u2019s not so easy for people to reach him by mistake when they misdial Ubiquity\u2019s central directory number. He\u2019s not running a pirate company, but his behavior pattern is not normal.\" \r","\t*line_break\r","\t\"Dig deeper when you investigate these people.\u201d\r","\t*return\r","\r","*label Van\r","*if Van_choice = 1\r","\tFrom what I can tell, SEKA got it right about Van. He\u2019s running a sort of gambling prediction market about geo-political events, using company resources, and trying to get coworkers to participate.\r","\t\r","\t\u201cThat\u2019s a serious allegation,\u201d Margot says, \u201cbut your evidence is clear. We cannot have Ubiquity employees running a gambling site and taking bets on political assassinations. His manager will need to have a long talk with Van.\u201d\r","\t\r","\t\u201cIt might be impossible to have a short talk with Van,\u201d you note.\r","\t*return\r","*if Van_choice = 2\r","\tFrom what I can tell, Van\u2019s not doing anything really wrong, though his prediction market website is something Ubiquity needs to deal with.\r","\r","\t\u201cActually, running a gambling site at work is not okay,\u201d Margo says. \u201cEspecially when someone pesters their coworkers to join a prediction site where people bet on terrorist attacks.\" \r","\t*line_break\r","\t\"You need to use a little more common sense when you interpret the evidence.\u201d\r","\t*return\r","*if Van_choice = 3\r","\tFrom what I can tell, Van\u2019s a quirky guy, but SEKA was wrong to think someone needed to intervene with Van.\r","\r","\tMargot slams the binder shut. \u201cCasey, the guy\u2019s running a gambling prediction market with Ubiquity company servers and trying to get his coworkers to place bets on political assassinations and terrorist attacks!\" \r","\t*line_break\r","\t\"No, that is not okay. Pay more attention!\u201d\r","\t*return\r","*if Van_choice = 4\r","\tFrom what I can tell, Van\u2019s just another normal employee, and I don\u2019t know why SEKA flagged him.\r","\r","\tMargot slams the binder shut. \u201cCasey, the guy\u2019s running a gambling prediction market with company servers and trying to get his coworkers to place bets on political assassinations and terrorist attacks. If people found out, SEKA would probably get investigated by the Federal government.\"\r","\t*line_break\r","\t\"I know this is your first day, but you need to pay more attention!\u201d\r","\t*return\r","\r","*label Tonya\r","*if Tonya_choice = 1\r","\tTonya\u2019s up to no good, and SEKA was right to flag her. She\u2019s been running a video blog and fan business, which Ubiquity should shut down.\r","\r","\t\u201cExcuse me?\u201d Margot hisses. \u201cObviously, she used to run a video blog, but that was years ago. Now, it just looks like she\u2019s got some overly enthusiastic former fans, and Ubiquity needs to help her deal with them.\"\r","\t*line_break\r","\t\"I hope you can do better than this.\u201d\r","\t*return\r","*if Tonya_choice = 2\r","\tTonya\u2019s dealing with a strange situation, and SEKA was right to flag it as a problem for Ubiquity to deal with. Some of the former fan from her old LEGO blog have tracked her down, and now she\u2019s getting pestered with LEGO questions. Ubiquity might be able to help find a way to deal with them.\r","\r","\t\u201cExactly what I would say,\u201d Margot nods.\r","\t*return\r","*if Tonya_choice = 3\r","\tTonya\u2019s not an average employee, because she has a group of obsessed fans from her old LEGO video blogging days, but there\u2019s no reason that SEKA should have suggested that someone look into her situation.\r","\r","\t\u201cShe\u2019s not doing anything wrong, but Ubiquity should help her stave off these fans,\u201d Margot says. \u201cSo I don\u2019t mind if SEKA alerts us to this kind of problem.\u201d\r","\t*return\r","*if Tonya_choice = 4\r","\tTonya\u2019s just a normal employee, and I don\u2019t know why SEKA flagged her.\r","\r","\t\u201cAre you serious?\u201d Margot demands. \u201cTonya is a great employee who\u2019s being hassled by fans from her old LEGO blog. Ubiquity needs to help her deal with them.\"\r","\t*line_break\r","\t\"I hope you can do better than this.\u201d\r","\t*return\r","\r","*label Monica\r","*if Monica_choice = 1\r","\tBased on my investigation, SEKA was right about Monica. She\u2019s been running an Etsy business at work, and it\u2019s a big distraction. Even if Ubiquity doesn\u2019t do anything, she\u2019ll probably quit soon.\r","\r","\t\u201cWhat is she selling?\u201d Margot asks.\r","\t*line_break\r","\t\u201cShe makes these customized stuffed animals that look like their owners.\u201d\r","\t*line_break\r","\t\u201cAt least it\u2019s not sex or politics,\u201d Margot notes. \u201cUbiquity needs to avoid any publicity related to sex and politics.\u201d\r","\t*return\r","*if Monica_choice = 2\r","\tBased on my investigation, SEKA was right to flag Monica\u2019s behavior. She\u2019s been distracted from work by her Etsy business, and she\u2019s about ready to quit her job.\r","\r","\t\u201cWhat is she selling?\u201d Margot asks.\r","\t*line_break\r","\t\u201cShe makes these customized stuffed animals that look like their owners.\u201d\r","\t*line_break\r","\t\u201cNot too scandalous, but Ubiquity doesn\u2019t want to pay employees to run side businesses at work,\u201d Margot nods.\r","\t*return\r","*if Monica_choice = 3\r","\tBased on my investigation, SEKA shouldn\u2019t have flagged Monica\u2019s behavior. Her stuffed animal situation is unusual, but Ubiquity doesn\u2019t need to do anything about it.\r","\r","\t\u201cI disagree,\u201d Margot says. \u201cEmployees are not allowed to run side businesses from work, and an Etsy store counts as a side business.\" \r","\t*line_break\r","\t\"Think a little more about these situations.\u201d\r","\t*return\r","*if Monica_choice = 4\r","\tBased on my investigation, Monica is pretty much a typical employee, and I don\u2019t know why SEKA flagged her.\r","\r","\tMargo slaps the table. \u201cWake up! Just from looking through her binder, I can tell there\u2019s something going on. She\u2019s using her office as a stuffed animal warehouse, and running an Etsy business from work.\" \r","\t*line_break\r","\t\"You need to pay more attention!\u201d\r","\t*return\r","\r","*label wrapup\r","Finally, you\u2019re done presenting your decisions. \r","\r","Next its Rene\u2019s turn, and Margot mostly agrees with ${ihis} assessments. $!{ihis} dimples and charming smile seem to have worked with everyone ${ihe} talked to. Both the subjects of his investigations and their coworkers cooperated with ${ihim}. \r","\r","Margot\u2019s investigation tactics seem to mostly involve searching logs and data records, supplemented by an occasional phone call. She explains that since she\u2019s worked at Ubiquity so long, she already knows people in most departments. She seems to have a sixth sense for zeroing in on the real reasons behind odd behaviors.\r","\r","It\u2019s nearly 6pm by the time you\u2019ve all agreed on the fifteen investigations from today.\r","*page_break\r","*if boss_regard > 4\r","\tMargot looks tired, but at least she\u2019s not frowning. \u201cWe got a lot done today. Rene, nice job. Casey, I\u2019m glad you\u2019re on the team. See you tomorrow.\u201d\r","\t*goto pickup\r","*elseif boss_regard > 2\r","\tMargot looks tired. \u201cWe got a lot done today. Rene, nice job. Casey, not bad for the first day. See you tomorrow.\u201d\r","\t*goto pickup\r","*else\r","\tMargot looks tired, and she\u2019s frowning. \u201cWe survived a lot of investigations today. Rene, nice job.\" \r","\t\r","\t\"Casey, you need to get with the program. I know you\u2019ve been thrown into the deep end of the pool, so I hope you can swim. If you\u2019re unclear on what is and is not acceptable employee behavior here at Ubiquity, I suggest you read that company handbook they sent you with your job offer. See you tomorrow.\u201d\r","\t*goto pickup\r","\r","*label pickup\r","*page_break\r","After Margot leaves, Rene stretches and sighs. \u201cThat must have been a long first day for you. Want to grab dinner at The Fancy Cat? My treat, since we were all too busy to take you to lunch today.\r","\r","[i]The Fancy Cat? Isn\u2019t that the new super expensive ultra trendy restaurant where no one who\u2019s not in the 1% can get a reservation?[/i]\r","*choice\r","\t#No thanks, I\u2019ve got a hot date with a frozen burrito.\r","\t\t*set pickup_choice 1\r","\t\t*finish\r","\t#Why don\u2019t you come back to my place. My housemate and I are grilling burgers tonight. \r","\t\t*set pickup_choice 2\r","\t\t*finish\r","\t#Thanks, that place sounds amazing.\r","\t\t*set pickup_choice 3\r","\t\t*set resist_colleague -2\r","\t\t*finish\r","\t#I\u2019d be up for dinner, but only if we split the check. So maybe we should go to the pho shop down the street.\r","\t\t*set pickup_choice 4\r","\t\t*set resist_colleague +1\r","\t\t*finish\r",""], "labels":{"zenina":24,"jason":50,"van":78,"tonya":108,"monica":134,"wrapup":168,"pickup":189}},"colleague_dinner": {"crc":319422819, "lines":["*if skip\r","\t*finish\r","*if pickup_choice = 1\r","\t\u201cI can\u2019t let you just go home thinking about how overwhelming the job is,\u201d Rene insists. \r","\t\r","\t\u201cYou\u2019d talk yourself out of coming back, and then where would that leave us? As a favor to the ${iguy} who would be left as Margot\u2019s only minion if you quit, I\u2019m begging you to give me a chance to help end your day with a something more delicious than microwave burritos.\u201d\r","\r","\t\u201cSince you put it that way, I can\u2019t say no.\u201d\r","\r","\t\u201cIt will be the highlight of my week. I shall be in your debt.\u201d\r","\t*goto dinner\r","*if pickup_choice = 4\r","\t\u201cI shan\u2019t argue with my new and esteemed colleague,\u201d Rene says.\r","\t*goto dinner\r","*if pickup_choice = 3\r","\t*goto dinner\r","*if pickup_choice = 2\r","\tYou text Bobby to let ${ehim} know that Rene will be coming over for burgers. When you get home, ${ehe} and Jamie have the grill already fired up and the food ready to go. Rene presents them with a bottle of wine. \r","\t\r","\t[i]Has ${ihe} been carrying that around in ${ihis} bag all day? I wonder if ${ihe} can pull a rabbit out of someone\u2019s ear?[/i]\r","\t*page_break\r","\tBobby and Rene take charge of the grilling, and Jamie pours the wine.\r","\r","\t\u201cHow did your first day go? Which group did they assign you to?\u201d Jamie asks. \r","\t*choice\r","\t\t#\"I\u2019m on the Taskforce for Improving Efficiency. There\u2019s a lot to learn, but I think it\u2019ll be fun.\"\r","\t\t\t\r","\t\t\t\u201cThat sounds like a cover story for one of Ubiquity\u2019s secret projects,\u201d Jamie laughs. \r","\t\t\t\r","\t\t\t\u201cThey have a lot of them. Well, don\u2019t tell me anything you\u2019re not supposed to say, but if you need help, let me know.\u201d\r","\t\t\t*goto grill\r","\t\t#\"I\u2019m working with Rene and Margot Lyles, looking at some internal company processes.\"\r","\t\t\t\u201cOh, that must be one of Ubiquity\u2019s secret projects,\u201d Jamie says. \r","\t\t\t\r","\t\t\t\u201cMargot ends up on most of them. She\u2019s really smart. I\u2019m kind of surprised she hasn\u2019t made vice president yet.\u201d\r","\t\t\t*goto grill\r","\t\t#\"It\u2019s another one of those secret projects, so I can\u2019t say much.\"\r","\t\t\r","\t\t\t\u201cSometimes I think half of Ubiquity is working on secret projects,\u201d Jamie says. \r","\t\t\t\r","\t\t\t\u201cWell, don\u2019t tell me anything you\u2019re not supposed to say, but if you need help, let me know.\u201d\r","\t\t\t*goto grill\r","\r","*label grill\t\r","*page_break\t\t\r","The burgers come out perfect. Rene gets everyone laughing when ${ihe} tries to juggle the ketchup, mustard, and a burger, taking bites from the moving target. After the party breaks up, you walk ${ihim} out to ${ihis} car.\r","\r","\u201cYou know, Margot really understands how much SEKA can help Ubiquity. It\u2019s not just about finding people doing something wrong. It\u2019s about getting Ubiquity to notice when and where it needs to give its employees a hand.\u201d\r","\r","\u201cYou mean things like helping Tonya stave off obsessed fans, or dealing with Jason\u2019s wrong phone number calls.\u201d\r","*line_break\r","\u201cExactly. There\u2019s so much good that SEKA can do for Ubiquity, if we can just convince management to be patient while we\u2019re adjusting the artificial intelligence. I\u2019m afraid they expect SEKA to work perfectly as soon as it\u2019s installed, which is completely impossible!\u201d\r","*line_break\r","\u201cYeah, people can be impatient.\u201d\r","*line_break\r","\u201cSEKA can really make Ubiquity better, but it needs a training period to understand Ubiquity as an organization. Look, Casey, can Margot and I count on you to help?\u201d\r","*goto query\r","\r","*label query\r","*page_break\r","*if resist_colleague < 2\r","\tYou\u2019re touched by ${ihis} dedication to helping Ubiquity, and ${ihis} loyalty to Margot.\r","\r","\t\u201cCount me in.\u201d \r","\t*goto goodbye\r","*elseif resist_colleague > 0 \r","\t$!{ihe} seems so earnest about helping Ubiquity.\r","\r","\t\u201cI\u2019ll do what I can.\u201d \r","\t*goto goodbye\r","*else\r","\t[i]I guess ${ihe}\u2019ll be out of a job if Ubiquity decides that buying SEKA was a mistake.\r","\r","\t\u201cI\u2019m certainly not planning to quit.\u201d \r","*if boss_regard < 3\r","\r","\t\u201cThough I\u2019m not sure Margot won\u2019t just fire me.\u201d \r","\t\r","\t\u201cShe can seem like a rather demanding boss, but she\u2019ll at least keep you for the six month trial period. By that time, she\u2019ll probably love you. Either that, or she\u2019ll have gotten poached from Ubiquity by EEE, and you won\u2019t have to worry what she thinks!\u201d\r","\t*goto goodbye\r","\r","*label goodbye\r","\r","*if pickup_choice = 2\r","\t*goto grill_goodbye\r","*else\r","\t*goto dinner_goodbye\r","\r","*label grill_goodbye\r","Rene clasps your shoulder. \u201cI knew I could count on you.\u201d \r","\r","$!{ihe} gets into his car and rolls down the window. \r","\r","\u201cWith all three of us working together, I\u2019m sure we can keep Ubiquity management from killing the SEKA deployment project!\u201d\r","*finish\r","\r","*label dinner\r","*page_break\t\t\r","The restaurant is crowded, but you and Rene are ushered to seats at a table in the corner.\r","\r","\u201cIt must be interesting working with all the different customer companies to get SEKA trained up right,\u201d you say.\r","\r","\u201cIt\u2019s so different at each customer site. Margot, and Ubiquity, have been great. She really understand the SEKA system, and why it\u2019s necessary to do a lot of manual investigation in the beginning, to tune the artificial intelligence. I just hope she doesn\u2019t quit before the SEKA rollout project is finished.\u201d\r","*line_break\r","\u201cHow long does the tuning take?\r","*line_break\r","\u201cWith a large organization like Ubiquity, a place that has a lot of different types of products and departments, it could take up to six months. But the pace of investigations is much higher right at the beginning, and the last couple months are more like fine tuning and carrying out a few followup recommendations from SEKA. Most companies find that the investigation team naturally transitions into a problem solving team.\r","*line_break\r","\u201cYou mean doing things like helping Tonya stave off obsessed fans, or dealing with Jason\u2019s wrong phone number calls.\u201d\r","*line_break\r","\u201cExactly - by the time Ubiquity can trust SEKA to identify the rare employees who are doing something wrong, Ubiquity can also trust SEKA to flag problem situations that need intervention.\u201d\r","*page_break\r","Your food arrives, and the entree you ordered turns out to be an unusual bowl of noodles. There\u2019s a mixture of thick and thin noodles of different colors, and there are strange things in the soup that might be vegetables or might be animal parts. You try not to slurp or splash too much.\r","\r","\u201cThere\u2019s so much good that SEKA can do for Ubiquity, if Margot and I can just convince management to be patient while we\u2019re adjusting the artificial intelligence. I\u2019m afraid they expect SEKA to work perfectly as soon as it\u2019s installed, which is completely impossible!\u201d\r","\r","\u201cYeah, people expect to be living in the future with smart software systems.\u201d\r","\r","\u201cSEKA really is amazingly smart, but it just needs a training period to understand a new customer organization. Casey, can we count on you to help?\u201d\r","*goto query\r","\r","*label dinner_goodbye\r","Rene refills your glass. \u201cI knew I could count on you.\u201d $!{ihe} clinks ${ihis} glass against yours.\r","\r","\u201cWith all three of us working together, I\u2019m sure we can keep Ubiquity management from killing the SEKA deployment project!\u201d\r","*finish\r",""], "labels":{"grill":43,"query":58,"goodbye":81,"grill_goodbye":88,"dinner":96,"dinner_goodbye":121}},"morning_2": {"crc":-37647062, "lines":["*if skip\r","\t*finish\r","By the time you collapse into bed, your head is spinning. \r","\r","[i]Can we get SEKA adjusted before Ubiquity decides it\u2019s making too many false alarms? What if I make mistakes investigating, and get the wrong employees in trouble? [/i] \r","*if boss_regard < 3\r","\t[i]Will Margot fire me before the end of my probation period?[/i]\r","\t*goto wake\r","*label wake\r","*page_break\r","You jolt awake from a nightmare of drowning in a giant swirling teacup, despite Rene, Margot, Bobby, and Jamie all throwing life preservers at you. You couldn\u2019t reach any of the floating rings because one of them kept hitting you in the head with their throws. \r","You shake off the dream.\r","*set dream_2_description \"[b]Dream #2[/b] I was drowning in a giant teacup, with everyone trying to throw me life preservers. I think someone was deliberately throwing them at my head.\" \r","*set show_dream_2 true\r","\r","It\u2019s almost time to get ready for work. Do you:\r","*choice\r","\t#Start the day with some divination.\r","\t\tYou turn on the coffee pot and launch Virtual Teacup on your phone. What should I do different today at work? \r","\t\t\r","\t\t*if boss_regard < 2\r","\t\t\tThe leaves clump into the shape of a hammer. \r","\t\t\t\r","\t\t\t[i]Great, a hammer means hard work and diligence.  Which is a little insulting as an answer to that question - I worked plenty hard yesterday! Maybe it means I should stop hitting myself over the head with a hammer? [/i]\r","\t\t\t*finish\r","\t\t*elseif resist_colleague < 2 \r","\t\t\tThe leaves clump into the shape of a lopsided heart. \r","\t\t\t\r","\t\t\t[i]Beware of inadvisable romance or relationship? I don\u2019t think there\u2019s much danger of that.[/i]\r","\t\t\t*finish\r","\t\t*else\r","\t\t\tThe leaves clump up into the shape of hourglass. \r","\t\t\t\r","\t\t\t[i]Work on time management. I guess that\u2019s always good to keep in mind.[/i]\r","\t\t\t*finish\t\t\r","\t#Make a good breakfast. \r","\t\t*set housemate_relationship +1\r","\t\tYou hand Bobby a plate with a fresh omelet as she walks into the kitchen. \r","\t\t\r","\t\t\u201cOoh, that looks great, thanks!\u201d $!{ehe} sits down with a big sigh. \u201cAre you liking the job so far?\u201d\r","\t\t*line_break\r","\t\t\u201cStill trying to get the hang of it, but I\u2019m just glad to finally be working. I should be able to pay you back for all the rent in a few months.\u201d\r","\t\t*line_break\r","\t\tBobby takes a big drink of coffee. \u201cThat\u2019s great, since my parents might not be able to pay me this month.\u201d\r","\t\t*line_break\r","\t\t\u201cCrap, I\u2019m sorry.\u201d\r","\t\t*line_break\r","\t\t\u201cWe have a couple leads on new customers, but everyone\u2019s worried.\u201d \r","\t\t\r","\t\t$!{ehe} throws you a couple granola bars. \u201cIf you aren\u2019t going to have time for lunch, you\u2019d better carry provisions.\u201d\r","\t\t*finish\r","\t#Flip through Ubiquity\u2019s employee handbook \r","\t\t*set boss_regard +1\r","\t\t*set diligence +1\r","\t\tThe Ubiquity employee handbook almost puts you back to sleep. There are over a hundred chapters on everything from selecting  professional attire to guidance for politely refusing bribes from foreign governments. You note that the Ubiquity corporate computer policy advises employees that all actions on the job may be monitored and analyzed. You also see that employees are not permitted to run commercial businesses or other activities involving financial transactions using company computers. \r","\t\t\r","\t\t[i]Monica and Van must have ignored the handbook, probably like almost every other employee at Ubiquity.[/i] \r","\t\t\r","\t\tThere\u2019s also an extensive section on IT security guidelines to protect computers from viruses and malware.\r","\t\t*finish"], "labels":{"wake":8}},"accidental_disclosure": {"crc":1884221117, "lines":["*if skip\r","\t*finish\r","You run into Jamie coming into the office. \r","\r","\u201cSwing by my office if you have questions or want to get lunch sometime,\u201d he offers. \r","\r","\u201cI\u2019m not sure how busy they\u2019ll keep me today, but thanks.\u201d \r","\r","He makes a little bow. \u201cIt\u2019s the least I could do, oh favored housemate of my amazing Bobby. Plus, I only get the full referral bonus if you make it past the trial period, so I have an ulterior motive for helping you.\u201d\r","\r","\u201cNot everyone would be so helpful to their ${egirlfriend}\u2019s ex, even for a referral bonus!\u201d you joke.\r","*page_break\r","Margot interrupts. \u201cCasey, sorry, we need to start the meeting early. It\u2019s urgent.\u201d She drags you along behind her, talking quickly. \r","\r","\u201cI got paged last night. Been here since 5am looking at SEKA\u2019s data dumps. Today\u2019s going to be a doozy.\u201d\r","*finish"], "labels":{}},"intro_case_2": {"crc":1941606226, "lines":["*if skip\r","\t*finish\r","Margot pulls you all the way into her office. \r","\r","\u201cLook, Ubiquity is always under attack by wannabe hackers and we have a whole full-time cyber security team. But the problem is that attacks and security breaches have been skyrocketing. We\u2019ve had more problems just this last week than we normally have during two or three months.\u201d\r","\r","Your first reaction is to:\r","*choice\r","\t#Keep your mouth shut and nod.\r","\t\t*goto margot_explains\r","\t#Ask how you can help. \r","\t\t\u201cI\u2019m getting to that part.\u201d \r","\t\t*goto margot_explains\r","\t#Make a suggestion. \r","\t\t*set boss_regard -1\r","\t\t\u201cI know you\u2019re trying to help, but I\u2019ve already thought of that, and it won\u2019t work!\u201d\r","\t\t*goto margot_explains\r","\r","*label margot_explains\r","*page_break\r","Margo continues. \u201cEven though SEKA isn\u2019t fully trained up yet, I want to use it to help find out if there\u2019s someone on the inside gone wrong. I\u2019m afraid someone working for Ubiquity is sabotaging security. So today, we\u2019re looking for that kind of bad guy.\u201d\r","\r","Rene knocks on her door. \u201cHi team! Ready to tackle today\u2019s challenges?\u201d $!{ihe} does a little dance on the way to the conference room.\r","\r","\u201cWe\u2019ll be there in a minute. Casey can help me carry the binders.\u201d\r","\r","*if boss_regard > 4\r","\t\u201cCasey, don\u2019t tell Rene, but I\u2019m afraid there might be a connection with the SEKA rollout. The rate of attacks went through the roof as soon as Ubiquity installed SEKA. It\u2019s a suspicious coincidence.\u201d\r","\t*goto margot_phone\r","*elseif boss_regard > 2\r","\t\u201cI know you don\u2019t have much experience investigating people, but you seem to have decent common sense. I\u2019m less sure about Rene sometimes. Don\u2019t necessarily give too much weight to what he tells you.\u201d\r","\t*goto margot_phone\r","*else\r","\t\u201cRene\u2019s a nice guy, and I\u2019m glad you\u2019re hitting it off. Just FYI, according to the employee handbook, employees should let their managers know if they date anyone inside Ubiquity. But since ${ihe}\u2019s a consultant from the SEKA company, ${ihe} wouldn\u2019t be covered by that rule.\u201d\r","\t*goto margot_phone\r","\r","*label margot_phone\r","*page_break\r","Margot\u2019s phone rings. \u201cUgh, you go ahead, I\u2019ll be right in.\u201d \r","\r","You walk slowly, and overhear Margot arguing with someone about how this week\u2019s assignments are completely unreasonable.\r","*finish"], "labels":{"margot_explains":18,"margot_phone":36}},"case_2_suspects": {"crc":-1491772976, "lines":["*if skip\r","\t*finish\r","\u201cWe\u2019ve been correcting SEKA for over a week now, and we\u2019ve covered some important topics. I\u2019m sure you both remember yesterday\u2019s work tuning SEKA to recognize Ubiquity employees running illicit side businesses. We previously looked at overclaiming on expense reports, harassing coworkers, and a couple types of unfair business practices.\u201d\r","\r","Rene produces a box of artisanal donuts and offers them around. \u201cWhat\u2019s on the list for today?\u201d ${ihe} asks.\r","\r","Have a donut?\r","*choice\r","\t#Yes, please\r","\t\t*set resist_colleague -1\r","\t\t[i]Rene sure knows where to get amazing donuts.[/i]\r","\t\t*page_break\r","\t\t*goto margot_explains\r","\t#No thanks\r","\t\t*goto margot_explains\r","\r","*label margot_explains\r","\u201cIt\u2019s a biggie,\u201d Margot warns. \u201cWe\u2019re targeting cyber security saboteurs, Ubiquity employees who are deliberately aiding attackers in bringing down our computers or stealing company data.\u201d\r","\r","\u201cSame operating procedures as before?\u201d Rene asks.\r","\r","\u201cMinor changes. It\u2019s such a serious allegation that we\u2019ll start by just reviewing all the case files with people\u2019s names and identifying information blacked out. That way, we can correct SEKA when it mistakenly flags somebody, without accidentally starting any rumors about them.\u201d\r","\r","\u201cAny other changes from yesterday?\u201d you ask.\r","\r","\u201cWe\u2019ll budget more time per candidate. Today we\u2019ll only review case files and correct SEKA for the more obvious cases. Tomorrow, we\u2019ll reveal the identities of the most suspicious individual and investigate them in more depth.\u201d\r","\r","Margot hands each of you a stack of binders. \u201cDocument your assessment and reasoning for each of these three people. We\u2019ll talk again at 3pm.\u201d\r","*page_break\r","You make it back to your office without dropping any binders, and you take a deep breath before digging into the case records. \r","\r","[i]These ten binders cover just three people? Should at least be easier than investigating 10 separate people![/i]\r","\r","Margot left you a sticky note in the first binder.\r","\r","\u201cI gave you the easy ones, since you\u2019re new to the job.\u201d\r","*temp actions_taken\r","*set actions_taken 0\r","*temp section_1\r","*temp section_2\r","*temp next_part\r","\r","*page_break\r","[b]Case History for Person A[/b]\r","\r","*gosub pick_sections\r","*page_break\r","*gosub A_info\r","*page_break\r","*gosub A_divination\r","*page_break\r","[b]Case History for Person B[/b]\r","\r","*gosub pick_sections\r","*page_break\r","*gosub B_info\r","*page_break\r","*gosub B_divination\r","*page_break\r","[b]Case History for Person C[/b]\r","\r","*gosub pick_sections\r","*page_break\r","*gosub C_info\r","*page_break\r","*gosub C_divination\r","*page_break\r","*gosub case_2_summary\r","*finish\r","\r","*label pick_sections\r","Which section of the case history do you read most carefully?\r","*choice\r","\t#Manager reviews and responses to reviews.\r","\t\t*set section_1 \"annual_reviews\"\r","\t\t*goto secondary\r","\t#Peer ratings.\r","\t\t*set section_1 \"peer_ratings\"\r","\t\t*goto secondary\r","\t#Incoming emails.\r","\t\t*set section_1 \"email\"\r","\t\t*goto secondary\r","\t#Cyber attack trail analysis.\r","\t\t*set section_1 \"cyber_trail\"\r","\t\t*goto secondary\r","*label secondary\r","*page_break\r","Which other section do you focus on?\r","*choice\r","\t*selectable_if (not(section_1 = \"annual_reviews\")) #Manager reviews and responses to reviews.\r","\t\t*set section_2 \"annual_reviews\"\r","\t\t*return\r","\t*selectable_if (not(section_1 = \"peer_ratings\")) #Peer ratings.\r","\t\t*set section_2 \"peer_ratings\"\r","\t\t*return\r","\t*selectable_if (not(section_1 = \"email\")) #Incoming emails.\r","\t\t*set section_2 \"email\"\r","\t\t*return\r","\t*selectable_if (not(section_1 = \"cyber_trail\")) #Cyber attack trail analysis.\r","\t\t*set section_2 \"cyber_trail\"\r","\t\t*return\r","\r","*label A_info\r","*page_break\r","*set next_part \"A_\"&section_1\r","*gosub {next_part}\r","*page_break\r","*set next_part \"A_\"&section_2\r","*gosub {next_part}\r","*return\r","\r","*label B_info\r","*page_break\r","*set next_part \"B_\"&section_1\r","*gosub {next_part}\r","*page_break\r","*set next_part \"B_\"&section_2\r","*gosub {next_part}\r","*return\r","\r","*label C_info\r","*page_break\r","*set next_part \"C_\"&section_1\r","*gosub {next_part}\r","*page_break\r","*set next_part \"C_\"&section_2\r","*gosub {next_part}\r","*return\r","\r","*label A_annual_reviews\r","The manager reviews look pretty good:\r","\r","\u201cPerson A is a strong performer and well-regarded by his colleagues. His background in finance has been helpful when communicating with Customer M.\u201d \r","\r","\u201cPerson A should be less hasty about making changes to the software, and spend more time testing for bugs.\u201d\r","\r","\u201cPerson A has solid programming skills, and the team relies on his contributions, but he\u2019s not ready to be a technical lead.\u201d \r","\r","It doesn\u2019t look like this person wrote many response to reviews: \r","\r","\u201cI\u2019ve enjoyed working in this group and learned a lot. I would like to take on more leadership roles.\u201d\r","*return\r","\r","*label A_peer_ratings\r","Peer ratings:\r","\r","\u201cPerson A is a little young, and thinks he knows a little more than he does, but he\u2019s a solid engineer.\u201d \r","\r","\u201cPerson A\u2019s got a big ego (e.g. he loves to give out unsolicited investment tips), but he\u2019s also got a good attitude and is willing to learn.\u201d \r","\r","\u201cHe\u2019s not happy when he has to admit he\u2019s made mistakes, but he has been getting better about it.\u201d\r","*return\r","\r","*label A_email\r","Incoming email: \r","\r","\u201cI\u2019m just not a cat fan - they seem like so much trouble.\u201d \r","\r","\u201cCongratulations on the new condo! I heard it\u2019s beautiful.\u201d \r","\r","\u201cDo you want to meet up for dinner tomorrow?\u201d \r","\r","\u201cI have some more questions about those investments you recommended.\u201d \r","\r","\u201cI don\u2019t think you\u2019ve been getting all my emails, so I cc\u2019d your web email address.\u201d\r","*return\r","\r","*label A_cyber_trail\r","Cyber trail analysis:\r","\r","\u201cURL records for Person A include several sites for malware download.\u201d \r","\r","\u201cPerson A\u2019s activity logs on the server were erased last week.\u201d \r","\r","\u201cPerson A\u2019s activity logs include downloads of the Project Z archives, a project Person A is not assigned to.\u201d\r","*return\r","\r","*label A_divination\r","It\u2019s going to be hard to figure out the real story behind this would-be investment wiz. You decide to get some help from divination.\r","\r","The leaves in your Virtual Teacup take the shape of:\r","\r","*if soul > 3\r","\tA fulcrum, the balance point for a scale. This person faces a temptation, but has not yet made a decision.\r","\t*gosub A_decide\r","\t*return\r","*elseif (history > 3) or (rumor > 3)\r","\tA coin. This person is attracted to the high life.\r","\t*gosub A_decide\r","\t*return\r","*else\r","\t*comment presumably your interaction > 3\r","\tA mask. This person is worried about reputation and appearing successful.\r","\t*gosub A_decide\r","\t*return\r","\r","*label A_decide\t\r","*page_break\r","What do you decide about Person A?\r","*choice\r","\t#Investigate further\r","\t\tYou submit a recommendation to further investigate Person A.\r","\t\t*set A_choice 1\r","\t\t*return\r","\t#Drop the investigation \r","\t\t*set boss_regard -1\r","\t\t*set A_choice 2\r","\t\tYou submit a recommendation to stop investigation of Person A.\r","\t\t*return\r","\r","*label B_annual_reviews\r","The manager reviews are full of complaints: \r","\r","\u201cPerson B is on his fourth group in five years. He voluntarily transferred twice, and was re-assigned due to complaints once.\u201d \r","\r","\u201cPerson B prefers to work outside of core business hours, and so is missing important coordination meetings.\u201d \r","\r","\u201cPerson B refuses to use common software packages such as Microsoft PowerPoint due to philosophical objections to Microsoft.\u201d\r","\r","This person wrote quite a few responses: \r","\r","\u201cI have been unfairly targeted by managers who spend all their time enforcing useless policies and no time doing real work.\u201d \r","\r","\u201cI accomplish twice the work of any of my peers by avoiding \u2018required\u2019 meetings and time-wasting small talk.\u201d\r","*return\r","\r","*label B_peer_ratings\r","Peer ratings:\r","\r","\u201cPerson B does best when he can work on tasks that do not require communication with other people, so he doesn\u2019t have a chance to yell at them.\u201d \r","\r","\u201cI have never had a personal conversation with Person B, except he did once ask if I could loan him money.\u201d \r","\r","\u201cI was warned by his former teammates that Person B likes to blame other people for problems. Loudly.\u201d\r","*return\r","\r","*label B_email\r","Incoming email:\r","\r","\u201cSend any class reunion notes to the Reunion Chair by the end of the month.\u201d \r","\r","\u201cEnroll in a debt management plan now, and reduce your monthly payments by 50%!\u201d \r","\r","\u201cI need your status report ASAP.\u201d\r","*return\r","\r","*label B_cyber_trail\r","Cyber trail analysis:\r","\r","\u201cMalware was installed on Person B\u2019s computer last week by launching an executable file on the desktop, Friday at 1am.\u201d \r","\r","\u201cPerson B\u2019s account logs on the server showed port scanning activity lasting 12 hours.\u201d \r","\r","\u201cPerson B logged into the server remotely at 9pm on Sunday.\u201d\r","*return\r","\r","*label B_divination\r","It\u2019s going to be hard to figure out the real story behind this engineer with anger management issues. You decide to get some help from divination.\r","\r","The leaves in your Virtual Teacup take the shape of:\r","\r","*if soul > 3\r","\tA mule. This person instinctively resists and opposes.\r","\t*gosub B_decide\r","\t*return\r","*elseif (interaction > 3) or (rumor > 3)\r","\tA sword. This person is often the center of conflict and strife.\r","\t*gosub B_decide\r","\t*return\r","*else\r","\t*comment presumably you are > 3 in history\r","\tA shoe. This person moves from place to place, and will not settle down. \r","\t*gosub B_decide\r","\t*return\r","\r","*label B_decide\t\r","*page_break\r","What do you decide about Person B?\r","*choice\r","\t#Investigate further\r","\t\tYou submit a recommendation to further investigate Person B.\r","\t\t*set B_choice 1\r","\t\t*return\r","\t#Drop the investigation \r","\t\t*set B_choice 2\r","\t\t*set boss_regard -1\r","\t\tYou submit a recommendation to stop investigation of Person B.\r","\t\t*return\r","\r","*label C_annual_reviews\r","The manager reviews are mixed: \r","\r","\u201cPerson C has a solid record over the many years since he came here from EV3, but his performance this year has been uneven.\u201d \r","\r","\u201cPerson C is well-regarded by colleagues, but several recent unexplained absences put unnecessary pressure on the team to cover for him at the last minute.\u201d \r","\r","\u201cPerson C mentors the junior staff and establishes a collaborative atmosphere.\u201d\r","\r","This person responded to some of the reviews: \r","\r","\u201cI am deeply sorry for being unreliable, and will not repeat these mistakes.\u201d\r","*return\r","\r","*label C_peer_ratings\r","Peer ratings:\r","\r","\u201cPerson C is friendly and knows the business.\u201d \r","\r","\u201cI\u2019m worried that Person C must have something really bad going on outside of work, because he\u2019s been so distracted.\u201d \r","\r","\u201cDuring our last business trip, Person C drank a lot at a dinner with EV3 reps, and missed the morning meetings.\u201d \r","*return\r","\r","*label C_email\r","Incoming email:\r","\r","\u201cThe custody hearing will be in two months.\u201d \r","\r","\u201cWhere were you? We thought you were running the workshop yesterday, but when you didn\u2019t show up, F had to take over.\u201d \r","\r","\u201cThank you for volunteering last weekend; we raised $2000 for charity.\u201d\r","*return\r","\r","*label C_cyber_trail\r","Cyber trail analysis:\r","\r","\u201cPerson C disabled the automatic virus checker updates on his computer.\u201d \r","\r","\u201cMalware reached Person C\u2019s computer through a flash drive.\u201d \r","\r","\u201cThe backup server was activated when the primary server went down last week. The backup server did not have updated anti-virus and was infected from Person C\u2019s computer.\u201d\r","*return\r","\r","*label C_divination\r","It\u2019s going to be hard to figure out the real story behind this recruiter with a drinking problem. You decide to get some help from divination.\r","\r","The leaves in your Virtual Teacup take the shape of:\r","\r","*if (soul > 3) or (rumor >3)\r","\tA manacle and chain. This person is at the mercy of external influences.\r","\t*gosub C_decide\r","\t*return\r","*elseif interaction > 3\r","\tA cup lying on its side. This person will disappoint others.\r","\t*gosub C_decide\r","\t*return\r","*else\r","\t*comment presumably you are > 3 in history\r","\tAn egg. This person protects his children. \r","\t*gosub C_decide\r","\t*return\r","\r","*label C_decide\r","*page_break\r","What do you decide about Person C?\r","*choice\r","\t#Investigate further\r","\t\tYou submit a recommendation to further investigate Person C.\r","\t\t*set C_choice 1\r","\t\t*return\r","\t#Drop the investigation \r","\t\t*set boss_regard -1\r","\t\t*set C_choice 2\r","\t\tYou submit a recommendation to stop investigation of Person C.\r","\t\t*return\r","\r","*label case_2_summary\r","*page_break\r","Who do you think is the most likely to be deliberately sabotaging Ubiquity?\r","*choice\r","\t#Person A - would-be investment wiz\r","\t\t*set case_2_insider \"A\"\r","\t\t*gosub accident\r","\t\t*return\r","\t#Person B - engineer with anger management issues\r","\t\t*set case_2_insider \"B\"\r","\t\t*gosub accident\r","\t\t*return\r","\t#Person C - recruiter with a drinking problem\r","\t\t*set case_2_insider \"C\"\r","\t\t*gosub accident\r","\t\t*return\r","\t#No one\r","\t\t*gosub accident\r","\t\t*return\r","\r","*label accident\r","*page_break\r","Who do you think is the most likely to have accidentally caused a security breach?\r","*choice\r","\t*selectable_if (not(case_2_insider = \"A\")) #Person A - would-be investment wiz\r","\t\t*set case_2_innocent \"A\"\r","\t\t*gosub end_report\r","\t\t*return\r","\t*selectable_if (not(case_2_insider = \"B\")) #Person B - engineer with anger management issues\r","\t\t*set case_2_innocent \"B\"\r","\t\t*gosub end_report\r","\t\t*return\r","\t*selectable_if (not(case_2_insider = \"C\")) #Person C - recruiter with a drinking problem\r","\t\t*set case_2_innocent \"C\"\r","\t\t*gosub end_report\r","\t\t*return\r","\t#No one\r","\t\t*gosub end_report\r","\t\t*return\r","\r","*label end_report\r","*page_break\r","You finish writing up short reports summarizing your assessment of each person\u2019s behavior, giving yourself a pat on the back for your time management triumph.\r","*return"], "labels":{"margot_explains":16,"pick_sections":70,"secondary":85,"a_info":102,"b_info":111,"c_info":120,"a_annual_reviews":129,"a_peer_ratings":143,"a_email":153,"a_cyber_trail":167,"a_divination":177,"a_decide":196,"b_annual_reviews":210,"b_peer_ratings":226,"b_email":236,"b_cyber_trail":246,"b_divination":256,"b_decide":275,"c_annual_reviews":289,"c_peer_ratings":303,"c_email":313,"c_cyber_trail":323,"c_divination":333,"c_decide":352,"case_2_summary":366,"accident":386,"end_report":406}},"awkward_coffee": {"crc":1624012636, "lines":["*if skip\r","\t*finish\r","Your phone rings. It\u2019s Bobby, who never calls.\r","\r","\u201cCasey, we need to talk right away! Meet me at the coffee shop down the street in 15 minutes. It\u2019s really important.\u201d\r","\r","Before you can say anything, ${ehe} hangs up. You text ${ehim}, but ${ehe} doesn\u2019t respond. You\u2019ve got less than an hour before your meeting with Margot and Rene at 3pm.\r","\r","What do you do?\r","*choice\r","\t#Go straight to the coffee shop. Bobby must be in trouble. \r","\t\t*set boss_regard -1\r","\t\tYou\u2019re sure to annoy Margot if you\u2019re late getting back, but Bobby wouldn\u2019t be so insistent if it wasn\u2019t an emergency.\r","\t\t*goto shop\r","\t#Tell Margot where you\u2019re going. She\u2019ll understand.\r","\t\tMargot isn\u2019t thrilled, but since you\u2019ve already written up summaries of your candidates, she says she won\u2019t start calling to look for you until 3:30pm. \r","\t\t*goto shop\r","\t#Ask Rene to cover for you if you\u2019re late getting back. Maybe ${ihe} can just go first presenting ${ihis} assessments. \r","\t\t*set resist_colleague -1\r","\t\tRene agrees that you should go talk to your friend now, and assures you that he\u2019ll smooth things over with Margot if you\u2019re late to the meeting.\r","\t\t*goto shop\r","\r","*label shop\r","*page_break\r","Bobby\u2019s waiting for you and doesn\u2019t even let you order any coffee before pulling you into the back of the shop. \r","\r","\u201cWhy did you tell Jamie that we used to date? Now he\u2019s insisting that either I kick you out of our apartment or I move into his condo!\u201d\r","\r","\u201cI just assumed he knew. Were you trying to keep it a secret?\u201d\r","*line_break\r","\u201cNot exactly. Our history just never really came up.\u201d\r","*line_break\r","\u201cHow could I never come up? He sees me around all the time. He helped me get a job interview at Ubiquity!\u201d\r","*line_break\r","\u201cHe knows we\u2019ve known each other a long time, he just didn\u2019t know the details. We weren\u2019t even dating that long, and you know I always thought it was a mistake to go out with a housemate.\u201d\r","*line_break\r","\u201cAre you saying I didn\u2019t count because you never wanted to date me in the first place?\u201d\r","*line_break\r","\u201cCan we not have this argument for the millionth time about whether we\u2019re just better as friends? We need to figure out who has to move out of our apartment!\u201d\r","*line_break\r","\u201cHow about neither of us moves out of our apartment, and Jamie minds his own business about who you want to live with?\u201d\r","*line_break\r","\u201cYou can\u2019t say it\u2019s unreasonable for him to care if I\u2019m still living with an ex.\u201d\r","*line_break\r","\u201cIf that\u2019s what you think, why didn\u2019t you tell him about us before?\u201d\r","\r","*page_break\r","After an hour of arguing, nothing is resolved. \r","\r","[i]Feels like old times - this is exactly how it was back when we were dating![/i] \r","\r","You tell Bobby that you have to get back to work, and ${ehe} asks what you want to do. You suggest that:\r","*choice\r","\t#Bobby can stay at Jamie\u2019s place for a while, to see if ${ehe} likes it.\r","\t\t*set housemate_choice 1\r","\t\tBobby reminds you that ${ehe} works for ${ehis} parents, and that they would have a cow if ${ehe} moved in with ${ehis} boyfriend. Plus, ${ehe}\u2019s not sure they\u2019re really that serious yet, so ${ehe} doesn\u2019t even want to live with Jamie. $!{ehe} decides that the two of you should both talk with Jamie tonight to figure out a solution.\r","\t\t*goto leave\r","\t#Bobby invites Jamie to move in with the two of you for a while, so he can tell that there\u2019s really nothing going on between you and Bobby.\r","\t\t*set housemate_choice 2\r","\t\t*set housemate_relationship +1\r","\t\tBobby hugs you and declares your idea to be brilliant. $!{ehe}\u2019ll talk to Jamie about it right away.\r","\t\t*goto leave\r","\t#You can just camp out at work temporarily, until Jamie comes to his senses.\r","\t\t*set housemate_choice 3\r","\t\tBobby is dubious that Ubiquity will let you do that, plus ${ehe} doesn\u2019t want to be in charge of your cat while you\u2019re not home. $!{ehe} decides that the two of you should both talk with Jamie tonight to figure out a solution.\r","\t\t*goto leave\r","\t#You and your cat can go stay with Jamie, until he gets sick of the idea.\r","\t\t*set housemate_relationship +1\r","\t\t*set housemate_choice 4\r","\t\tBobby hugs you and declares your idea to be brilliant. $!{ehe}\u2019ll talk to Jamie about it right away. \r","\t\t*goto leave\r","\r","*label leave\r","*page_break\r","You rush back to work, bringing back coffee and muffins.\r","*finish"], "labels":{"shop":22,"leave":72}},"case_2_evaluation": {"crc":884792281, "lines":["*if skip\r","\t*finish\r","Margot and Rene are arguing about ${ihis} last candidate when you get back to work. \r","*temp case_2_total\r","*set case_2_total ((6 - A_choice) + (B_choice + C_choice))\r","*if case_2_total > 1 \r","\tMargot insists that SEKA was wrong to flag this person, and that their behavior seems perfectly normal given their job responsibilities. Rene gives in, the person is taken off the list for investigation, and they feed that information back into SEKA.\r","\t*goto p_report\r","*elseif (B_choice = 1) and (case_2_total = 1)\r","\tMargot insists that SEKA was wrong to flag this person, and that their behavior seems perfectly normal given their job responsibilities. Rene gives in, the person is taken off the list for investigation, and they feed that information back into SEKA.\r","\t*goto p_report\r","*else\r","\tRene insists that SEKA was correct to flag this person, and that their activities suggest they might be sabotaging Ubiquity. Margot gives in, and the person is added to the list for further investigation.\r","\t*goto p_report\r","\r","*label p_report\r","\r","\u201cCasey, we\u2019re ready for your report,\u201d Margot says.\r","\r","*page_break\r","*if A_choice = 1 \r","\t*if case_2_insider = \"A\"\r","\t\t\u201cI believe that Person A is likely to be sabotaging Ubiquity. We\u2019ll need to look into him more.\"\r","\r","\t\tMargot nods. \u201cThat\u2019s a serious allegation, and we\u2019ll need to investigate.\u201d\r","\t\t*goto report_B\r","\t*elseif case_2_innocent = \"A\"\r","\t\t\u201cFrom what I can see, Person A just made some bad mistakes with security. We\u2019ll need to look into it more to understand why.\u201d \r","\t\r","\t\tMargot nods. \u201cWe\u2019ll put him on the list.\u201d\r","\t\t*goto report_B\r","\t*else\r","\t\t\u201cI\u2019m not sure if Person A is doing something bad, or just making mistakes, but we need more information.\u201d\r","\r","\t\tMargot puts him on the list\r","\t\t*goto report_B\r","*elseif A_choice = 2\r","\t*if case_2_insider = \"A\"\r","\t\t\u201cPerson A is likely to be sabotaging Ubiquity. It\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot slams her hand on the table. \u201cNo way! Sabotage is a really serious allegation, so if you think this person is doing something wrong, we\u2019re putting him on the list for further investigation!\u201d \r","\t\t*goto report_B\r","\t*elseif case_2_innocent = \"A\"\r","\t\t\u201cPerson A was careless and made some mistakes with security. That\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot shakes her head. \u201cI\u2019d want to understand more about why he made serious mistakes, so we can prevent that kind of thing from happening again. We\u2019ll put him on the list for further investigation.\u201d \r","\t\t*goto report_B\r","\t*else\r","\t\t\u201cThere\u2019s nothing unusual happening with Person A, and I don\u2019t know why SEKA flagged him. I recommend we drop the investigation.\u201d\r","\t\t\r","\t\tMargot shakes her head. \u201cThere\u2019s way too much going on with this person. I think we need to keep him on the list.\u201d \r","\t\t*goto report_B\r","*else\r","\t*goto report_B\r","\t\t\r","*label report_B\r","*page_break\r","*if B_choice = 1 \r","\t*if case_2_insider = \"B\"\r","\t\t\u201cI believe that Person B is likely to be sabotaging Ubiquity. We\u2019ll need to look into him more.\"\r","\r","\t\tMargot nods. \u201cThat\u2019s a serious allegation, and we\u2019ll need to investigate.\u201d\r","\t\t*goto report_C\r","\t*elseif case_2_innocent = \"B\"\r","\t\t\u201cFrom what I can see, Person B just made some bad mistakes with security. We\u2019ll need to look into it more to understand why.\u201d \r","\t\r","\t\tMargot nods. \u201cWe\u2019ll put him on the list.\u201d\r","\t\t*goto report_C\r","\t*else\r","\t\t\u201cI\u2019m not sure if Person B is doing something bad, or just making mistakes, but we need more information.\u201d\r","\r","\t\tMargot puts him on the list\r","\t\t*goto report_C\r","*elseif B_choice = 2\r","\t*if case_2_insider = \"B\"\r","\t\t\u201cPerson B is likely to be sabotaging Ubiquity. It\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot slams her hand on the table. \u201cNo way! Sabotage is a really serious allegation, so if you think this person is doing something wrong, we\u2019re putting him on the list for further investigation!\u201d \r","\t\t*goto report_C\r","\t*elseif case_2_innocent = \"B\"\r","\t\t\u201cPerson B was careless and made some mistakes with security. That\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot shakes her head. \u201cI\u2019d want to understand more about why he made serious mistakes, so we can prevent that kind of thing from happening again. We\u2019ll put him on the list for further investigation.\u201d \r","\t\t*goto report_C\r","\t*else\r","\t\t\u201cThere\u2019s nothing unusual happening with Person B, and I don\u2019t know why SEKA flagged him. I recommend we drop the investigation.\u201d\r","\t\t\r","\t\tMargot shrugs. \u201cI\u2019m not sure I agree with you, but we can\u2019t investigate everyone. Let\u2019s leave him off the list for now.\u201d\r","\t\t*goto report_C\r","*else\r","\t*goto report_C\r","\r","*label report_C\r","*page_break\t\r","*if C_choice = 1 \r","\t*if case_2_insider = \"C\"\r","\t\t\u201cI believe that Person C is likely to be sabotaging Ubiquity. We\u2019ll need to look into him more.\"\r","\r","\t\tMargot nods. \u201cThat\u2019s a serious allegation, and we\u2019ll need to investigate.\u201d\r","\t\t*goto end_2\r","\t*elseif case_2_innocent = \"B\"\r","\t\t\u201cFrom what I can see, Person C just made some bad mistakes with security. We\u2019ll need to look into it more to understand why.\u201d \r","\t\r","\t\tMargot nods. \u201cWe\u2019ll put him on the list.\u201d\r","\t\t*goto end_2\r","\t*else\r","\t\t\u201cI\u2019m not sure if Person C is doing something bad, or just making mistakes, but we need more information.\u201d\r","\r","\t\tMargot puts him on the list\r","\t\t*goto end_2\r","*elseif C_choice = 2\r","\t*if case_2_insider = \"C\"\r","\t\t\u201cPerson C is likely to be sabotaging Ubiquity. It\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot slams her hand on the table. \u201cNo way! Sabotage is a really serious allegation, so if you think this person is doing something wrong, we\u2019re putting him on the list for further investigation!\u201d \r","\t\t*goto end_2\r","\t*elseif case_2_innocent = \"C\"\r","\t\t\u201cPerson C was careless and made some mistakes with security. That\u2019s clear enough from the case records, so we don\u2019t really need to dig anymore.\u201d \r","\r","\t\tMargot shakes her head. \u201cI\u2019d want to understand more about why he made serious mistakes, so we can prevent that kind of thing from happening again. We\u2019ll put him on the list for further investigation.\u201d \r","\t\t*goto end_2\r","\t*else\r","\t\t\u201cThere\u2019s nothing unusual happening with Person C, and I don\u2019t know why SEKA flagged him. I recommend we drop the investigation.\u201d\r","\t\t\r","\t\tMargo shakes her head. \u201cI have a feeling something\u2019s going on here. We better keep him on the list.\u201d\r","\t\t*goto end_2\r","*else\r","\t*goto end_2\r","\r","\r","*label end_2\r","*page_break\r","Margot quickly reviews her list, steamrolling over any opinions you or Rene offer. \r","\r","\u201cThat\u2019s three top candidates for investigation tomorrow, one for each of us.\u201d Margot says. \u201cGet a good night\u2019s sleep - it\u2019s going to be a long day.\u201d\r","\r","Rene suggests going out for drinks, but you need to go deal with your housemate situation.\r","*finish"], "labels":{"p_report":15,"report_b":55,"report_c":92,"end_2":130}},"awkward_dinner": {"crc":-881947682, "lines":["*comment If previously [1] or [3], Bobby, Jamie, and you have an awkward dinner. \r","*comment You have to come out of it with either the idea that you and Mischief move in with Jamie, or he moves in with you and Bobby.\r","*if skip\r","\t*finish\r","*temp canoe_option\r","*set canoe_option 0\r","*if (housemate_choice = 2) or (housemate_choice = 4)\r","\t*goto recap_dinner\r","*else\r","\t*goto dinner\r","\t\r","*label dinner\r","You meet Bobby and Jamie at a frozen yogurt shop, on the theory that it will be harder for everyone to get upset if you\u2019re all eating dessert. Bobby explains that it won\u2019t work for ${ehim} to move into Jamie\u2019s condo because ${ehis} parents would be unhappy, but that the current situation with you and ${ehim} sharing an apartment makes Jamie unhappy.\r","\r","\u201cYou make it sound like one of those problems where you have a canoe that only holds one extra item and you need to get a sack of grain, a chicken, and a fox across the river,\u201d Jamie says.\r","\r","\u201cExactly,\u201d Bobby agrees. \r","\r","\u201cIf I was solving that kind of problem, I\u2019d have Jamie move into our apartment so I\u2019m not alone with Bobby, or I\u2019d move in with Jamie,\u201d you suggest. \r","\r","\u201cYou\u2019re brilliant, Casey. I think either one of those ideas works,\u201d Bobby says.\r","\r","\u201cIt would be a little silly to leave my place empty while we all crowd into your apartment,\u201d Jamie says, taking you seriously.\r","*page_break\r","\u201cJamie already vetoed our current situation, and Bobby vetoed the two of you living together at Jamie's place. I\u2019m the only one who didn\u2019t get to veto anything yet, so I should get to pick,\u201d you assert.\r","\r","Which do you pick?\r","*choice\r","\t#You and Mischief will move in with Jamie.\r","\t\tYou decide that you and your cat will be staying with Jamie, at least temporarily. You\u2019ll keep splitting the apartment rent with Bobby, but you won\u2019t pay Jamie anything.\r","\t\t*set canoe_option 1\r","\t\t*goto pack\r","\t#Jamie will move in with you and Bobby.\r","\t\tYou decide that Jamie can sublet his place if he doesn\u2019t want to leave it empty while he\u2019s staying with you and Bobby, and suggest that you can turn the dining room into a third bedroom so the two of them don\u2019t have to share.\r","\t\t*set canoe_option 2\r","\t\t*goto pack\r","\r","*label recap_dinner\r","*if housemate_choice = 4\r","\tBobby\u2019s let Jamie know that you and Mischief will be staying with him, at least temporarily. You\u2019ll keep splitting the apartment rent with Bobby, but won\u2019t need to pay Jamie anything.\r","\t*goto pack\r","*elseif housemate_choice = 2\r","\tBobby\u2019s let Jamie know that he can move in with the two of you. The plan will be to turn the dining room into a third bedroom.\r","\t*goto pack\r","\r","*label pack\r","*page_break\r","Bobby\u2019s working late again tonight, so you and Jamie handle the moving without ${ehim}.\r","\r","*if (housemate_choice = 4) or (canoe_option = 1)\r","\tYou throw a bunch of clothes into a suitcase, bribe Mischief to get into his cat carrier, and show up at Jamie\u2019s condo. He\u2019s cleared most of the stuff out of his home office, stacking it in a corner of the living room. Mischief knocks over that pile of papers and boxes, then claws at the couch. Hopefully the hassle of having you at his place will convince Jamie that he should just stop objecting to you and Bobby sharing the apartment!\r","\t*goto cat\r","*elseif (housemate_choice = 2) or (canoe_option = 2)\r","\tYou rig up a curtain for the doorway of the dining room and crowd the table and chairs awkwardly into a corner of the living room. It\u2019s not elegant, but hopefully the crowding and hassle will convince Jamie that he should just stop objecting to you and Bobby sharing the apartment! Jamie shows up with a suitcase and some overflowing boxes. As soon as he stacks his stuff in a corner of the room, Mischief knocks it over.\r","\t*goto cat\r","\r","*label cat\r","*page_break\r","\u201cWell, I\u2019ve always wanted a cat,\u201d Jamie says. \u201cNow I\u2019ll get to see what it\u2019s like living with yours.\u201d\r","\r","\u201cIf this whole things turns out to be a disaster, we can always figure out another plan later. I just can\u2019t afford to get a new apartment and put down first and last month\u2019s rent, not when I already owe Bobby for the last few months,\u201d you say.\r","\r","Jamie heads out to his weekly poker game. \u201cDon\u2019t worry about that pile of stuff, I\u2019ll deal with it when I get back.\u201d\r","\r","What do you do?\r","*choice\r","\t#You head for Jamie\u2019s papers. It\u2019s only polite to help tidy up, since your cat knocked things over.\r","\t\t*set snooped 1\r","\t\tYeah, you\u2019re being a snoop, but it\u2019s all good practice for work, right? You see books on growing your career in management, a lot of financial reports on technology start-ups, a large stack of brochures from Reliable Trust advertising a new type of insurance investment plan that is \u201cstatistically superior to most 401K plans,\u201d and an advertisement for diamond jewelry. \r","\t\t*finish\r","\t#You need to get some real food. Donuts, granola bars, muffins, and frozen yogurt are all fine and good, but no one can live on dessert alone.\r","\t\tFrozen burritos might not be the best dinner, but it\u2019s not like you have that many choices! \r","\t\t*finish"], "labels":{"dinner":11,"recap_dinner":37,"pack":45,"cat":56}},"mouse_dream": {"crc":-1815301821, "lines":["*if skip\r","\t*finish\r","That night, you fall asleep to the sound of Mischief chasing his tail up and down the hallways. You dream that you\u2019re a black cat, pacing around a treasure chest, on guard. Mice dressed as pirates try to fight their way past you, while mice dressed as ninjas sneak around behind you. You chase them all away, and the treasure chest bursts open, revealing a mouse dancing on a heap of gold coins.\r","*set dream_3_description \"[b]Dream #3[/b] I was a black cat, defending a treasure chest from mouse pirates and mouse ninjas. I got rid of the attacking mice, but then another mouse was inside with the treasure.\" \r","*set show_dream_3 true\r","\r","You wake up feeling frazzled. Mischief barely opens an eye as you get dressed for work, but stalks over to see what you\u2019re doing when you\u2019re examining the tea leaves in your Virtual Teacup. [i]What should I pay attention to today?[/i] \r","\r","The clump of leaves is the shape of a waterfall. [i]Looks like a warning. Waterfalls, cascades, and avalanches - small errors can add up to big problems.[/i]\r","\r","You decide to do a second divination. What do you ask?\r","*choice\r","\t#What should I do to convince Jamie that I\u2019m not a threat to his relationship with Bobby?\r","\t\t*set housemate_relationship +1\r","\t\tThe clump of leaves looks like upturned hands. A display of honesty. [i]That probably doesn\u2019t mean I should just tell him that his aftershave smells terrible.[/i]\r","\t\t*goto ending\r","\t#Rene\u2019s been flirting with me. Should I pursue this possibility? \r","\t\t*set resist_colleague -1\r","\t\tThe clump of leaves looks like a balloon. Colorful and catches the eye, but not much substance. [i]That doesn\u2019t preclude having some fun, though.[/i]\r","\t\t*goto ending\r","\t#How can I make a good impression on Margot so I can keep this job?\r","\t\t*set boss_regard +1\r","\t\tThe clump of leaves looks like a wreath. Achievements that are earned. [i]I suppose doing everything right during today\u2019s investigation would be a start.[/i]\r","\t\t*goto ending\r","\r","*label ending\r","\r","You ponder the morning\u2019s oracles as you head into work. \r",""], "labels":{"ending":25}},"case_2_identities": {"crc":-29305786, "lines":["*if skip\r","\t*finish\r","You arrive at work prepared, carrying muffins and coffee for the team, and with granola bars in your backpack.\r","\r","Margot hands out another set of binders which are all chained together. \u201cHere are the case records that have the real names of all parties. These binders will remain locked in this room; do you understand? Read what you need to read now, and come back later if you have a question.\u201d\r","\r","*if A_choice = 1\r","\t*comment (If you picked Person A for investigation, you are assign him.)\r","\t\u201cCasey, here\u2019s the file on Person A. You\u2019ll be on him today.\u201d\r","\r","\tInside the binder, Person A\u2019s name is written in big letter. JAMIE TRAVERS.\r","\t*goto reveal\r","*else\r","\t*comment (Otherwise, Margot gets him, and you get Person C.)\r","\t\u201cCasey, here\u2019s the file on Person C. You\u2019ll be on him today. I\u2019m taking Person A myself.\u201d\r","\r","\tAs she opens her binder, you can\u2019t help glancing over and seeing Person A\u2019s name in big letters. [b]JAMIE TRAVERS.[/b]\r","\t*goto reveal\r","\r","*label reveal\r","*page_break\r","Jamie Travers! You\u2019re living with one of the people being investigated. Your team thinks that Jamie\u2019s either deliberately or accidentally responsible for some of the recent cyber attacks against Ubiquity.\r","\r","[i]What do I do now? Things are sure going to be awkward with Bobby if she thinks I got ${ehis} boyfriend investigated for some kind of cyber crime.[/i]\r","\r","What do you want to do?\r","*choice\r","\t#Protect Jamie from getting in trouble.\r","\t\t*set case_2_goal 1\r","\t\t*if A_choice = 1\r","\t\t\tYou know Jamie, and you know he wouldn\u2019t deliberately sabotage Ubiquity. Maybe SEKA is just wrong about him acting like a bad guy at all, or maybe he\u2019s made some security mistakes. Since you\u2019re leading the investigation, you\u2019ll do your best to protect him from being blamed.\r","\t\t\t*finish\r","\t\t*else\r","\t\t\tYou know Jamie, and you know he wouldn\u2019t deliberately sabotage Ubiquity. Maybe SEKA is just wrong about him acting like a bad guy at all, or maybe he\u2019s made some security mistakes. You\u2019ll have a talk with him, just so he knows to cooperate with Margot.\r","\t\t\t*finish\r","\t#Use your relationship with Jamie to get more truthful information out of him for the investigation.\r","\t\t*set case_2_goal 2\r","\t\t*if A_choice = 1\r","\t\t\tYou\u2019re in luck. Since you\u2019re living with Jamie, and he trusts you, you\u2019ll be able to get to the bottom of why SEKA flagged him.\r","\t\t\t*finish\r","\t\t*else\r","\t\t\tSince you\u2019re living with Jamie, and he trusts you, you\u2019ll be able to get to the bottom of why SEKA flagged him. You\u2019ll just casually mention Jamie to Margot, not letting on that you peeked at her binder. That\u2019ll give her the opportunity to invite you to help with the investigation.\r","\t\t\t*finish\r","\t#Distance yourself from the investigation, so Bobby and Jamie can\u2019t blame you for whatever happens.\r","\t\t*set case_2_goal 3\r","\t\t*if A_choice = 1\r","\t\t\tBefore you read any further, you need to get Margot to take you off this assignment. You don\u2019t want to be the one that Jamie and Bobby blame, if he gets in trouble over some security breaches. Maybe you\u2019d also better talk to Bobby too, so ${ehe}\u2019ll know you aren\u2019t involved in the investigation.\r","\t\t\t*finish\r","\t\t*else\r","\t\t\tSince Margot will be leading the investigation into Jamie\u2019s activities, you should be able to keep your name out of it. But wait - Jamie already knows you\u2019re working with Margot. Would Jamie believe Margot if she told him that you weren\u2019t involved on his case? Maybe Bobby would believe you if you talked to ${ehim} before the investigation goes much further.\r","\t\t\t*finish\r","\t#Get Jamie into trouble so he won\u2019t have any time to fuss about you and Bobby living together.\r","\t\t*set case_2_goal 4\r","\t\t*if A_choice = 1\r","\t\t\tYou\u2019re in luck. Since you\u2019re in charge of his investigation, you can make sure to find enough suspicious activity to keep Jamie too busy to object when you propose to go back to your original housemate setup with Bobby. \r","\t\t\t*finish\r","\t\t*else\r","\t\t\tYou don\u2019t want to admit to Margot that you peeked at her binder, but how else can you help her find some suspicious activity in her investigations? Maybe if you find anything incriminating in Jamie\u2019s bedroom and papers, you can get Rene to help make sure it\u2019s included in the case record compiled by SEKA. Margot notices everything important in the case records.\r","\t\t\t*finish\r","\r","\r","\r","\r",""], "labels":{"reveal":19}},"case_2_asides": {"crc":-736832159, "lines":["*if skip\r","\t*finish\r","Rene finishes reading first. $!{ihe} whistles and waves, leaving you and Margot in the conference room.\r","\r","Margot clears her throat.\r","*if boss_regard < 4\r","\t\u201cRemember, don\u2019t jump to conclusions. If there\u2019s a someone deliberately helping with these attacks, let\u2019s nail them. But if there\u2019s an innocent explanations, we\u2019ll find it.\u201d\r","\t\r","\t*goto Margot_aside\r","*else\r","\t\u201cRemember, don\u2019t jump to conclusions. If there\u2019s a someone deliberately helping with these attacks, let\u2019s nail them. But if SEKA is the problem, let\u2019s figure out how.\u201d\r","\r","\t*goto Margot_aside\r","*comment (see case 2 suspects for outline of choice points)\r","*label Margot_aside\r","\r","*if (case_2_goal = 3) and (A_choice = 1)\r","\tYou agree with her, then change the subject.\r","\r","\t\u201cMargot, This a weird coincidence, but I actually know the person I\u2019m supposed to investigate today.\u201d\r","\r","\t\u201cI know, I saw you talking to him yesterday.\u201d\r","\t*line_break\r","\t\u201cI just feel like that could really get messy, since we\u2019re friends. Could I switch with you?\u201d\r","\t*line_break\r","\t\u201cIf you don\u2019t think you can do a good investigation, we\u2019d better switch.\r","\t*set A_choice 2\r","\t*if boss_regard < 4\r","\t\tIf there\u2019s someone at Ubiquity helping attackers break into our computer systems, we absolutely need to find them.\u201d\r","\t\t*goto takeover\r","\t*else\r","\t\tThere have been so many security breaches lately that we absolutely need to get to the bottom of it. If it\u2019s an employee helping attackers, we need to catch them. If it\u2019s some kind of side effect from SEKA, we\u2019ve got to prove it.\u201d\r","\t\t*goto takeover\r","\t*label takeover\r","\r","\t\u201cSo you\u2019ll take over Person A, and I can work on Person C?\u201d\r","\t\r","\t\u201cThat\u2019s fine. Whatever you do, don\u2019t tip off your friend that he\u2019s being investigated.\u201d\r","\t*page_break\r","\tYou switch binders with Margot.  \r","\t*goto read\r","*label read\r","You don\u2019t need that long with the case records, since you read most of the material just yesterday.\r","\r","*if A_choice = 1\r","\tIt\u2019s strange to read through Jamie\u2019s emails, especially the ones from Bobby. $!{eHe}\u2019s dubious, then worried, then angry about some investments that Jamie sold ${ehis} parents. Strangely, the amount of his incoming and outgoing emails per day dropped dramatically recently.\r","\t*goto Margot_leaving\r","*else\r","\tPerson C turns out to be a company recruiter named Edgar Yee. You remember his solid work history and good coworker relationships, now threatened by a drinking problem. Flipping through the binder, you see typical parental emails to his kids, both in college, and knock-down-drag-out fights with his soon-to-be-ex wife. On a lighter note, it seems that his coworkers all enjoy the assorted swag and give-aways that he brings back from career fairs. \r","\t*goto Margot_leaving\r","\r","*label Margot_leaving\r","*page_break\r","*if case_2_goal = 2\r","\t*if A_choice = 1\r","\t\tYou figure you\u2019ll go chat with Jamie before lunch.\r","\t\t*gosub Rene_aside\r","\t\t*finish\r","\t*else\r","\t\tYou catch Margot\u2019s eye as she stands up to leave. \r","\r","\t\t\u201cI know you saw his name in my binder,\u201d she says. \u201cAnd you were talking to Jamie yesterday, so I assume you two know each other.\u201d\r","\r","\t\t\u201cMore than know each other,\u201d you reply. \u201cAs of last night, we\u2019re also housemates.\u201d\r","\r","\t\t\u201cI imagine you\u2019ll have some extra insight into his character and motivations.\u201d\r","\t\t*choice\r","\t\t\t#Hint that you\u2019d be willing to sneak a look into his room.\r","\t\t\t\r","\t\t\t\t\u201cDefinitely. Seeing where someone lives can tell you a lot about them.\u201d\r","\t\t\t\r","\t\t\t\t\u201cIf I think there\u2019s something he\u2019s afraid to tell me, I may ask you to see what you can find out.\u201d\r","\t\t\t\t*gosub Rene_aside\r","\t\t\t\t*finish\r","\t\t\t#Leave it to Margot to say what she wants you to do\r","\t\t\t\r","\t\t\t\t\u201cLet me know how I can help.\u201d\r","\t\t\r","\t\t\t\t\u201cI\u2019m not going to ask you to ransack his room, or anything inappropriate. But if I think there\u2019s something he\u2019s afraid to tell me, I may have you take a shot.\u201d\r","\t\t\t\t*gosub Rene_aside\r","\t\t\t\t*finish\r","*if case_2_goal = 1\r","\t*if A_choice = 1\r","\t\tYou figure you\u2019ll go chat with Jamie before lunch.\r","\t\t*gosub Rene_aside\r","\t\t*finish\r","\t*else\r","\t\tYou figure you\u2019ll go chat with Jamie before you start investigating Edgar.\r","\t\t*gosub Rene_aside\r","\t\t*finish\r","*if case_2_goal = 4\r","\t*if A_choice = 1\r","\t\tYou figure you\u2019ll go chat with Jamie before lunch.\r","\t\t*gosub Rene_aside\r","\t\t*finish\r","\t*else\r","\t\tYou\u2019ll have time to talk to Jamie\u2019s coworkers before you start investigating Edgar.\r","\t\t*gosub Rene_aside\r","\t\t*finish\r","*if case_2_goal = 3\r","\tYou\u2019d better call Bobby before you start investigating Edgar.\r","\t*gosub Rene_aside\r","\t*goto Bobby_aside\r","\r","*label Rene_aside\t\r","*page_break\r","Rene stops you as you pass by ${ihis} office.\r","\r","\u201cYou have to try one of these chocolate covered apricots from Turkey,\u201d ${ihe} says. \u201cFortify yourself so you\u2019ll be extra sharp when you go poking around today.\u201d\r","\r","\u201cIt\u2019s been interesting so far,\u201d you say.\r","\r","\u201cI think the tricky part is making a decision about whether SEKA was right or wrong to flag concern about a situation. I mean, you saw yesterday how there are so many well-intentioned employees, who find themselves in a messy situation through no fault of their own. The artificial intelligence is right to notice that kind of stuff, so Ubiquity can attention and help people like Tonya and Jason. Those are genuinely good situations for SEKA to flag.\u201d\r","\r","\u201cSure.\u201d\r","\r","\u201cI know you and Margot both see how much SEKA can benefit Ubiquity, if we can just get it tuned up. Surely Margot wouldn\u2019t be trying to use it to solve this security breach problem if she didn\u2019t believe the software worked.\u201d\r","\r","$!{ihe} offers you the dish of treats again.\r","*choice\r","\t#Thank ${ihim} and bat your eyelashes\r","\t\t*set resist_colleague -1\r","\t\t*goto Rene_continue\r","\t#Smile and shake your head \r","\t\t*goto Rene_continue\r","\r","*label Rene_continue\r","\u201cWhen we\u2019re writing up our reports today, let\u2019s keep teaching the artificial intelligence as much information about Ubiquity as fast as we can, but also just give it the benefit of the doubt when scoring whether SEKA was right to flag a situation.\u201d\r","\r","*if resist_colleague < 0\r","\tYou agree. SEKA does seem to mostly notice real issues.\r","\t\r","\t*goto Rene_agree\r","*else\r","\tYou agree to think it over. SEKA did seem to flag pretty reasonable situations overall.\r","\t\r","\t*goto Rene_agree\r","*label Rene_agree\r","*if (case_2_goal = 4) and (A_choice = 1)\r","\t\u201cOf course, SEKA might also help us find someone who\u2019s deliberately hurting Ubiquity,\u201d you point out. \r","\t*goto Rene_cont2\r","*label Rene_cont2\r","\u201cOh yes, and if you do find the person who\u2019s been sabotaging Ubiquity\u2019s computer system, management would be quite impressed. They\u2019d probably give you a permanent position and end your probation period early. Good luck!\u201d\r","*return\r","\r","*label Bobby_aside\r","*page_break\r","You know Bobby doesn\u2019t like to talk on the phone, but since ${ehe} dragged you to the coffee shop yesterday, you feel justified calling ${ehim} today. $!{ehe} answers on the first ring.\r","\r","\u201cLook, I\u2019m sorry Jamie was so set against me living with an ex, but I thought you came up with a great temporary solution, so let\u2019s see how that goes.\u201d\r","\r","\u201cI\u2019m not calling about the housemate situation! Here\u2019s the story. I found out that something is going on at work, and they\u2019re investigating Jamie. I\u2019m not involved and I just don\u2019t want you to get mad at me if it turns out they find some stuff.\u201d\r","\r","\u201cWhat? Is this about his investment pyramid scheme thing with Reliable Trust? He\u2019s already got my parents losing money with his ridiculous investments. He told me he was going to keep it completely separate from work and not even pitch it to coworkers.\u201d\r","\r","\u201cI don\u2019t know exactly what it\u2019s about. But do you believe me? I\u2019m not trying to mess things up for Jamie at work. I\u2019m totally staying out of it.\u201d\r","\r","\u201cYou shouldn\u2019t stay out of it! You should help him.\u201d\r","\r","\u201cYou just said he might be selling bogus investments to people. You want me to help?\u201d\r","\r","\u201cNot help him sell bad investments. I don\u2019t know. Just make sure people understand that he\u2019s not trying to rip anyone off. He honestly believes they\u2019re great investments, and he\u2019s not doing it at work anyways.\u201d\r","\r","\u201cI don\u2019t know if I can do anything to help.\u201d\r","\r","\u201cJust promise you\u2019ll try!\u201d\r","*finish\r",""], "labels":{"margot_aside":14,"takeover":33,"read":41,"margot_leaving":51,"rene_aside":104,"rene_continue":126,"rene_agree":137,"rene_cont2":141,"bobby_aside":145}},"case_2_investigation": {"crc":1262274878, "lines":["*if skip\r","\t*finish\r","*temp searched_room  0\r","*temp interviewed_jamie 0\r","\r","*if case_2_goal = 1\r","\tYou\u2019ve got to tell Jamie what\u2019s happening, so he can cooperate with Ubiquity to get everything straightened out. \r","\t*page_break\r","\t*gosub interview_jamie\r","\t*if A_choice = 1\r","\t\t*finish\r","\t*else\r","\t\t*page_break\r","\t\t*gosub interview_edgar\r","\t\t*finish\r","*elseif case_2_goal = 3\r","\t*gosub interview_edgar\r","\t*finish\r","*elseif A_choice = 1\r","\t*comment 2A or 4A\r","\tDo you talk to Jamie now, or head home to look in his room?\r","\t*choice\r","\t\t#Talk first.\r","\t\t\t*gosub interview_jamie\r","\t\t\t*page_break\r","\t\t\t*gosub search_room\r","\t\t\t*finish\r","\t\t#Head home.\r","\t\t\t*gosub search_room\r","\t\t\t*page_break\r","\t\t\t*gosub interview_jamie\r","\t\t\t*finish\r","*else\r","\t*comment 2C or 4C\r","\tDo you start by investigating Edgar Yee, or head home to check out Jamie\u2019s room?\r","\t*choice\r","\t\t#Visit Edgar\u2019s department.\r","\t\t\t*gosub interview_edgar\r","\t\t\t*page_break\r","\t\t\t*gosub search_room\r","\t\t\t*finish\r","\t\t#Take advantage of Jamie not being home.\r","\t\t\t*gosub search_room\r","\t\t\t*page_break\r","\t\t\t*gosub interview_edgar\r","\t\t\t*finish\r","\r","*label interview_jamie\r","*set interviewed_jamie 1\r","When you get to Jamie's office, he's telling some of his coworkers about your cat, and everyone\u2019s showing each other cat pictures.\r","\r","\u201cHere\u2019s Casey now! This is ${phis} first week at Ubiquity.\u201d Everyone introduces themselves, and you joke around with the group before people head back to their computers.\r","*page_break\r","\u201cJamie, I\u2019ve got a question for you.\u201d\r","*line_break\r","\u201cIs this about a secret project? You\u2019d better be careful not to tell me anything, or you\u2019ll have to kill me.\u201d\r","*line_break\r","\u201cI\u2019m not joking, this could be a problem for you.\u201d\r","*line_break\r","\u201cFor me? Is this about Bobby?\u201d\r","*line_break\r","\u201cNo, it\u2019s about IT issues. You know, malware, viruses.\u201d\r","\r","He looks completely confused. You go on. \u201cHas anything strange been happening with your computer lately?\u201d\r","\r","\u201cI don\u2019t know why you\u2019re the one asking, but I have noticed a few things.\u201d\r","*page_break\r","Jamie explains that about two weeks ago, he noticed he was getting a lot less email from people outside Ubiquity. The same thing was happening to his entire group. They assumed that Ubiquity had switched to a different spam filtering system that must be dropping a bunch of their real emails. When they complained, the IT people insisted that there hadn\u2019t been any change in Ubiquity spam filtering, and weren\u2019t able to explain or fix the problem.\r","\r","\u201cSo what did you do?\u201d\r","\r","\u201cEveryone just started using their personal gmail accounts, or other kinds of email accounts they could access from work. It was a pain trying to find all the people who might have been trying to email us, thinking we were ignoring them, when actually we just weren\u2019t getting their messages anymore. But after about a week, I think I mostly got people to stop using my Ubiquity email, and stopped missing messages. I know we\u2019re not supposed to use check other email accounts on work computers, but we didn\u2019t really have a choice.\u201d\r","\r","*page_break\r","\u201cAnything else strange?\u201d\r","\r","\u201cA few days ago, a bunch of us started getting weird pop-up messages. Some other people had their machines get super slow.\u201d\r","\r","*if (case_2_goal = 1) and (A_choice = 2)\r","\t\"Look, I know you\u2019re just trying to do your job, but obviously people in the group have been getting viruses, probably from messages in their other emails accounts. If anyone starts asking you questions, or talks to other people in your group, you really need to explain all of this. Don\u2019t try to cover anything up.\u201d\r","\r","\tHe shrugs. \u201cIf you say so. By the way, I hope you don\u2019t mind that I took a bunch of pictures of your cat this morning.\u201d\r","\t*return\r","*elseif ((case_2_goal = 1) and (A_choice = 1)) or ((case_2_goal = 2) and (A_choice = 1))\r","\t\u201cLook, I know you\u2019re just trying to do your job, but obviously people in the group have been getting viruses, probably from messages in their other emails accounts. Ubiquity is going to have to fix something.\u201d\r","\r","\tHe shrugs. \u201cIf you can get them to stop dropping so much legit email, that would be great. By the way, I hope you don\u2019t mind that I took a bunch of pictures of your cat this morning.\u201d\r","\t*return\r","*else\r","\t*comment 4A\r","\tJamie and the others have obviously been picking up computer viruses from their other email accounts, which they weren\u2019t supposed to be using. That alone might not be enough to get him into much trouble, but \r","\t*if searched_room = 1\r","\t\tcombined with what you found in his room, it might look bad enough. \r","\t\t\t\r","\t\tYou try to catch him by surprise. \u201cSo, you\u2019re also an investment advisor with Reliable Trust?\u201d\r","\t\r","\t\t\u201cRight! Now that you\u2019ve got a job, I\u2019ll have to talk to you about some alternatives to traditional 401Ks. But I\u2019m keeping it totally separate from work time, so we can\u2019t talk now. And I\u2019d only be talking to you as a friend, because I\u2019m staying away from Ubiquity coworkers.\u201d\r","\t\t*return\r","\t*else\r","\t\tif you find something else incriminating in his room, it sure won\u2019t help.\r","\t\t*return\r","\r","*label search_room\r","Now to have a quick look around Jamie's room.\r","*set searched_room 1\r","*comment (if you snooped last night, you know about career focus, tech startups, investments, jewelry)\r","*if snooped = 1\r","\tIf Jamie is really hawking sketchy investments to his coworkers, Ubiquity isn\u2019t going to be any more pleased than they were with Van.\r","\t*goto search1\r","*label search1\r","\r","Mischief is glad to see you, but goes back to sleep after you refuse to feed him again. You aren't too careful about touching things, since you could always blame it on Mischief if Jamie notices anything out of place. You pay special attention to some stacks of paper. \r","\r","*if case_2_goal = 2\r","\tYou\u2019re not exactly sure what you\u2019re looking for. [i]I guess if Jamie was actually doing anything wrong, like running a side business from work, or helping attack computers, there might be some hints.[/i]\r","\t*goto search2\r","*if case_2_goal = 4\r","\tYou\u2019re not exactly sure what you\u2019re looking for. [i]I guess anything that might suggest that Jamie was doing something wrong, like running a side business from work, or helping attack computers. Or even some motivation for wrongdoing.[/i]\r","\t*goto search2\r","*label search2\r","*page_break\r","*if snooped = 0\r","\tYou don\u2019t know the password to his laptop, but you can look through the boxes of papers you noticed last night. You see books on growing your career in management, a lot of financial reports on technology start-ups, a large stack of brochures from Reliable Trust advertising a new type of insurance investment plan that is \u201cstatistically superior to most 401K plans,\u201d and an advertisement for diamond jewelry. \r","\t*goto search3\r","*if snooped = 1\r","\tYou don\u2019t know the password to his laptop, but you can take a closer look through the boxes and papers you looked through last night. It looks like Jamie\u2019s completed a certification course to become an \u201cLevel 1 Investments Advisor\u201d with Reliable Trust. He\u2019ll get a 2% commission on the investments he sells, and if he recruits new people to join, he\u2019ll get a 1% commission on the investments they sell. He doesn\u2019t seem to have had much success finding clients yet, except for Bobby\u2019s parents.\r","\t*goto search3\r","*label search3\r","\r","Mischief checks back to see if you\u2019ll feed him now. [i]Better get back to Ubiquity. I don\u2019t think there\u2019s much more to see here.[/i]\r","*if case_2_goal = 2\r","\tNo clear connections to anyone who\u2019d want to attack Ubiquity computers, but you\u2019ll have to look into whether Jamie might be running a side-business at work.\r","\t*goto search4\r","*if case_2_goal = 4\r","\tNo clear connections to anyone who\u2019d want to attack Ubiquity computers, but he might be running a side-business at work. And who knows, if he\u2019s working Reliable Trust selling investment, they might even want to get Ubiquity\u2019s employee information to target potential clients.\r","\t*goto search4\r","*label search4\r","*page_break\r","*comment (if you already interviewed Jamie, go back again)\r","*if interviewed_jamie = 1\r","\tWhen you get back to Ubiquity and drop by Jamie\u2019s office, he\u2019s alone.\r","\t\r","\tYou try to catch him by surprise. \u201cSo, Jamie, I forgot to ask before. I heard you\u2019re also an investment advisor with Reliable Trust?\u201d\r","\t\r","\t\u201cRight! Now that you\u2019ve got a job, I\u2019ll have to talk to you about some alternatives to traditional 401Ks.\u201d\r","\t\r","\t\u201cSounds interesting.\u201d\r"," \t\r","\t\u201cBut sorry, I\u2019m keeping it strictly separate from work time, so we can\u2019t talk about it now. And I\u2019d only be talking to you as a friend, because I\u2019m staying away from Ubiquity coworkers.\u201d\r","\t*return\r","*else\r","\t*return\r","\r","*label interview_edgar\r","*if case_2_goal = 1 \r","\tNow that you\u2019ve told Jamie to cooperate when Margot investigates him, you\u2019re ready to look into Edgar Yee.\r","\t*page_break\r","\t*goto edgar_start\r","*elseif case_2_goal = 4\r","\tYou do need to investigate Edgar Yee today, even if your main goal is to get Jamie into trouble.\r","\t*page_break\r","\t*goto edgar_start\r","*else\r","\t*comment(2.C, 3.A, 3.C) \r","\tNow your job is to investigate Edgar Yee, by talking to him and his coworkers.\r","\t*page_break\r","\t*goto edgar_start\r","\t\r","*label edgar_start\r","When you get to his office, you find that Edgar hasn\u2019t come to work yet. You notice one woman stop by his office twice looking for him, so you follow her and introduce yourself. How do you explain why you\u2019re here?\r","*temp discussed_computers\r","*temp discussed_alcohol\r","*set discussed_computers 0\r","*set discussed_alcohol 0\r","*choice\r","\t#You were recommended to me as an example of someone who understand how things work in this group. Do you have time to explain it?\r","\t\t*gosub edgar_1\r","\t\t*gosub edgar_4\r","\t\t*goto edgar_self\r","\t#I\u2019m curious how corporate recruiting works, and what it takes to succeed. Could you give me some advice?\r","\t\t*gosub edgar_2\r","\t\t*gosub edgar_3b\r","\t\t*goto edgar_self\r","\t#Ubiquity is studying productivity, and I need to do a quick assessment with you.\r","\t\t*gosub edgar_3\r","\t\t*goto edgar_self\r","\t#I\u2019ve been a little worried about one of your coworkers. Can I ask you some questions?\r","\t\t*gosub edgar_4\r","\t\t*goto edgar_self\r","\r","*label edgar_1\r","She laughs. \u201cNo one really understands how things should work, but we\u2019re doing the best we can. What do you want to know?\u201d\t\r","\r","\u201cDo people work together a lot, or is it more doing independent projects?\u201d\r","\r","\u201cUsually, for things like career fairs, a few of us will be working together. But in terms of screening potential candidates, we divide them up.\u201d\r","\r","\u201cWhat happens if someone has trouble getting things done?\u201d\r","\r","*comment \u201cDo you mean Edgar? We\u2019re all a little worried about him.\u201d\r","*page_break\r","*return\r","\r","*label edgar_2\r","She sits you down in her office. \u201cYou must be one of the new interns. Sure, I\u2019ve got a minute. What do you want to know?\u201d\r","\r","\u201cWhat sort of person does well in the job?\u201d\r","\r","\u201cSomeone who is outgoing, doesn\u2019t mind traveling, good at managing chaotic events.\u201d\r","\r","\u201cAre most of your coworkers good at the job?\r","\r","\u201cFor the most part, everyone here is friendly and competent.\u201d\r","\r","\u201cHas anything been difficult lately?\u201d\r","*page_break\r","\u201cOh my God, the computers are driving us crazy. First they all slowed to a crawl, and we had to turn off a bunch of applications until they could limp along.\r","\r","*return\r","\r","*label edgar_3\r","She looks surprised. \u201cI think I already answered that survey last week.\u201d\r","\r","\u201cUh, the one about computer glitches?\u201d\r","\r","\u201cNo, I did the one about scheduling. But we\u2019ve had a ton of computer glitches lately. They\u2019re driving us crazy. First they all slowed to a crawl, and we had to turn off a bunch of applications until they could limp along.\u201d\r","\r","*label edgar_3b\r","*set discussed_computers 1\r","\u201cThat\u2019s a problem.\u201d\r","\r","\u201cWe had to uninstall half our applications, disable auto-updates, basically we lost half of last week dealing with it. And we were at a conference, so couldn\u2019t drop off our computers with Ubiquity\u2019s IT team.\u201d\r","\r","\u201cThen what?\u201d\r","*page_break\r","\u201cWell, for while, the email server was down, and when it started working again, it was running an older version of the software, so no one could get their email, except Edgar, for some reason. So for the rest of the trip, we all had to use his computer to check email.\u201d\r","\r","\u201cSounds like a hassle.\u201d\r","\r","\u201cLuckily we had a whole pile of flash drives someone picked up as free giveaways, so he could just hand everyone copies of their email every couple hours.\u201d\r","\r","\u201cCreative way to survive the problem.\u201d\r","\r","\u201cIt just got worse and worse. When we got back, the IT team pretty much had to wipe everyone\u2019s computers because things were so messed up.\u201d\r","*page_break\r","*return\r","\r","*label edgar_4\r","*set discussed_alcohol 1\r","She sighs. \u201cYou must mean Edgar. We\u2019re all a little worried about him.\u201d\r","\r","\u201cHe hasn\u2019t been acting like himself lately?\u201d\r","\r","\u201cI think he\u2019s been an alcoholic for a while, but I guess all the stress from the divorce is just making it worse. He\u2019s been a no-show for some presentations. Everyone\u2019s been trying to help him out.\u201d\r","\r","\u201cPeople seem to like him.\u201d\r","\r","\u201cHe\u2019s worked here a long time, and used to be the person everyone relied on. Hopefully he\u2019ll get himself straightened out soon.\u201d\r","\r","\u201cIs he getting any professional help?\u201d\r","\r","\u201cI think he\u2019s afraid that if he\u2019s in treatment, it\u2019ll look bad for getting custody of the kids. Not like things look so good with the way he\u2019s been acting now, though.\u201d\r","*page_break\r","*return\r","\r","*label edgar_self\r","You thank her for her help, and go for a walk. You\u2019ll be able to do some divination, and maybe Edgar will get to work by the time you get back. \r","\r","You look at your Virtual Teacup. [i]Should I keep doing what I\u2019m doing, or change course? The leaves clump into a roundish oval shape.[/i]\r","\r","How do you interpret the sign?\r","*choice\r","\t#[i]It\u2019s an acorn. An acorn might grow into an oak tree, or be lunch for a squirrel. Weigh the long term and short term payoffs.[/i]\r","\t\t*goto edgar_5\r","\t#[i]It\u2019s a stone. Throw a stone only if you want the stone to hit something. Choose actions based on goals.[/i]\r","\t\t*goto edgar_5\r","\t#[i]It\u2019s an island. An island is isolated from outside influences. Focus on what\u2019s nearby and immediate.[/i]\r","\t\t*goto edgar_5\r","*label edgar_5\r","*page_break\r","When you get back to Edgar\u2019s office, you can hear him shouting on the phone, even with his door closed. After he\u2019s been quiet for a while, you knock.\r","\r","\u201cNaomi said you\u2019d been asking questions. I guess you want to talk to me now.\u201d\r","\r","Edgar waves you toward a chair in his office, and you sit down. \r","*if discussed_computers =1\r","\r","\t\u201cNaomi already told you about the mess with everyone\u2019s computers last week. What else do you want to know?\u201d\r","\t*page_break\r","\t\u201cSound like your computer was the only one with an older version of the email software?\u201d\r","\r","\t\u201cI must have been the first person to turn off the auto-updating on a bunch of the applications. My guess is that everyone else\u2019s computer automatically upgraded.\u201d\r","\r","\t\u201cAnd you turned off the updating because your computer was running too slow?\u201d\r","\r","\t\u201cYeah, I don\u2019t know if that even helped, but we were just trying anything we could think of.\u201d\r","\t*page_break\r","\t\u201cYou know that makes it so your anti-virus can\u2019t get updates.\u201d \r","\t\r","\tEdgar fidgets. \u201cSure, but I\u2019d already disabled the anti-virus program anyways, because the scans were slowing down the computers even more.\u201d\r","\r","\t\u201cSounds like everyone got some malware, maybe from sharing bad flashdrives.\u201d\r","\r","\tEdgar shakes his head. \u201cBut all the flashdrives were brand-new giveaways from the exhibit hall. Those companies wouldn\u2019t be giving away bad drives.\u201d\r","\r","\t\u201cThey might not know, or might not notice if someone puts back a couple after modifying them,\u201d you point out.\r","\t*page_break\r","\t\u201cOh no, then maybe that whole mess was my fault! And I missed a big meeting, and forgot to tell the dog sitter I was going out of town.\u201d He starts crying. \u201cI\u2019m such a mess. I\u2019m such a failure.\u201d\r","\r","\tWhat do you say?\r","\t*fake_choice\r","\t\t#I\u2019m sure those were just mistakes.\r","\t\t#What\u2019s been going wrong lately?\r","\t\t#It\u2019ll be okay.\r","\tNaomi comes in. \u201cWhy don\u2019t you let me take over. Edgar, look, it\u2019s not too late to get help.\u201d \r","\r","\tYou flee. You\u2019ve never made someone cry at work before. Hopefully everyone will go easy on this guy.\r","\t*return\r","*if discussed_alcohol = 1\r","\t\u201cNaomi probably already told you about my drinking problem. What else do you want to know?\u201d\r","\t*page_break\r","\t\u201cI heard you\u2019ve also had some computer problems.\u201d\r","\r","\t\u201cWell yeah, but so has everyone else in this group. I thought you were going to tell me I was on performance probation and a mandatory alcohol treatment plan.\u201d\r","\r","\t\u201cUmmm, actually, I\u2019m just part of the Taskforce on Improving Efficiency.\u201d\r","\r","\t\u201cOh.\u201d\r","\r","\t\u201cNot that I think a treatment plan would be a bad idea.\u201d\r","\r","\t\u201cRight.\u201d\r","\r","\t\u201cSo, uh, have your computer issues been worse recently?\u201d\r","\t*page_break\r","\t\u201cYeah, terrible. The IT team had to wipe everyone\u2019s computers when we got back from the conference last week because they got so messed up. Viruses or something.\u201d\r","\r","\t\u201cWhen did the problems start?\u201d\r","\r","\t\u201cJust after we left for the conference, of course, so we couldn\u2019t just hand the computers over to the IT team. Instead, we had to try a bunch of things ourselves.\u201d\r","\r","\t\u201cLike what?\r","\r","\t\u201cThey were all really slow to startup, and kept crashing, so I uninstalled all the applications I don\u2019t use, and disabled things like auto-update.\u201d\r","\r","\t\u201cDid that help?\u201d\r","\t*page_break\r","\t\u201cIt was enough better that I could use my computer, so I showed everyone else how to do the same thing the next day.\u201d\r","\r","\t\u201cThen what?\u201d\r","\r","\t\u201cThe email server was down for a while too, and when it came back, no one\u2019s computer could connect anymore, except mine. So I had to download everyone\u2019s email every few hours, and copy everything to flash drives.\u201d\r","\r","\t\u201cHuh\u201d\r","\r","\t\u201cSince we had whole pile from the conference, I could just give people their email that way. But the computers kept getting slower and we were getting weird pop-ups and stuff, so it was great to get back here and let the IT team take over.\u201d\r","\t*return\r","\t"], "labels":{"interview_jamie":47,"search_room":102,"search1":109,"search2":119,"search3":127,"search4":136,"interview_edgar":153,"edgar_start":168,"edgar_1":190,"edgar_2":203,"edgar_3":220,"edgar_3b":227,"edgar_4":247,"edgar_self":265,"edgar_5":278}},"case_2_resolution": {"crc":1632039309, "lines":["*if skip\r","\t*finish\r","Whew. You\u2019ve found out a lot you didn\u2019t know this morning.\r","\r","*if case_2_goal = 1\r","\tYou\u2019ve been trying to protect Jamie. Is that still what you want to do?\r","\t*choice\r","\t\t#Yes, he\u2019s a friend. \r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","\t\t#No, now I want to be fair and impartial.\r","\t\t\t*set case_2_goal 2\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","\t\t#No, I\u2019ve changed my mind. Now I want to make sure Jamie gets blamed for something.\r","\t\t\t*set case_2_goal 4\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","*elseif case_2_goal = 2\r","\tYou\u2019ve been trying to do a thorough investigation. Is that still your goal?\r","\t*choice\r","\t\t#Yes, that\u2019s my job.\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","\t\t#No, now I want to protect my friend. \r","\t\t\t*set case_2_goal 1\r","\t\t\t*gosub meeting\r","\t\t\t*finish\t\t\t\r","\t\t#No, I\u2019ve changed my mind. Now I want to make sure Jamie gets blamed for something. \r","\t\t\t*set case_2_goal 4\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","*elseif case_2_goal = 3\r","\tYou wanted to stay out of the investigation, so Bobby wouldn\u2019t blame you for any consequences. Is that still what you want to do?\r","\t*choice\r","\t\t#Yes, I don\u2019t want to be involved in making decisions about Jamie.\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","\t\t#No, now I want to protect him.\r","\t\t\t*set case_2_goal 1\r","\t\t\t*gosub meeting\r","\t\t\t*finish\t\t\t\r","\t\t#No, I\u2019ve changed my mind. Now I want to make sure Jamie gets blamed for something. \r","\t\t\t*set case_2_goal 4\r","\t\t\t*gosub meeting\r","\t\t\t*finish\t\t\t\r","*else\r","\t*comment case_2_goal is 4\r","\tYou wanted to get Jamie into enough hot water that he couldn\u2019t make a fuss about you and Bobby living together. Is that still what you want to do?\r","\t*choice\r","\t\t#Yes, he deserves some trouble.\r","\t\t\t*gosub meeting\r","\t\t\t*finish\r","\t\t#No, now I want to protect him.\r","\t\t\t*set case_2_goal 1\r","\t\t\t*gosub meeting\r","\t\t\t*finish\t\t\t\r","\t\t#No, now I want to be fair and impartial.\r","\t\t\t*set case_2_goal 2\r","\t\t\t*gosub meeting\r","\t\t\t*finish\t\t\t\r","\r","*label meeting\r","*page_break\r","When you meet again with Margot and Rene, you\u2019ve thought a lot about your decisions. Margot wastes no time getting the meeting started.\r","*comment (If you are 1AC, you don\u2019t get option 1.1 below, if you are 4AC, you only get option 1.1 and 2 below)\r","*comment (If you have low healthy relationship with coworker, you don\u2019t get 1.3 and get a shorter version of 3.3)\r","\r","\u201cToday, I didn\u2019t ask you to submit your assessments ahead of time. Instead of reviewing each candidate one at a time, I want to get everyone\u2019s sense of the big picture. Rene, what do you think?\u201d\r","\r","\u201cSEKA is finding a lot of problems that Ubiquity otherwise wouldn\u2019t notice. There aren\u2019t a lot of bad guys, but there are a lot of people making mistakes.\u201d\r","*page_break\r","\u201cHmmph. What about you, Casey?\u201d\r","*choice\r","\t#There is someone deliberately sabotaging Ubiquity!\r","\t\t*gosub accuse\r","\t\t*gosub interrupt\r","\t\t*return\r","\t#It\u2019s just a lot of people making mistakes.\r","\t\t*gosub excuse\r","\t\t*gosub interrupt\r","\t\t*return\r","\t*selectable_if (not(case_2_goal = 4)) #Something else entirely unexpected is going on!\r","\t\t*gosub surprise\r","\t\t*gosub interrupt\r","\t\t*return\r","\r","*label accuse\r","*page_break\r","\u201cThat\u2019s a very serious accusation. Have you found this person?\u201d\r","*choice\r","\t*if ((not(case_2_goal = 1)) and (not(case_2_goal = 3))) #It\u2019s Jamie Travers!\r","\t\t*page_break\r","\t\t*set boss_regard -3\r","\t\t*set case_2_accuse \"Jamie\"\r","\t\t\u201cJamie\u2019s been working as an investment advisor, working for Reliable Trust. They\u2019ve been trying to steal information about Ubiquity\u2019s employees for their list of potential clients. They paid Jamie to help mess up a Ubiquity mail server, and to convince everyone to use web email instead. Now they\u2019re having him forward phishing emails to his coworkers\u2019 external accounts.\u201d\r","\t\t*return\r","\t*selectable_if (not(case_2_goal = 4)) #It\u2019s Edgar Yee!\r","\t\t*page_break\r","\t\t*set boss_regard -3\r","\t\t*set case_2_accuse \"Edgar\"\r","\t\t\u201cEdgar\u2019s getting blackmailed by someone at EV3. They\u2019re threatening to get him put on performance probation at work and also mess up his custody case. They\u2019ve got him teaching people to disable anti-virus updates and then hand around malware on flashdrives.\u201d \r","\t\t*return\r","\t*selectable_if ((not(case_2_goal = 4)) and (resist_colleague > 0)) #It\u2019s you, Rene!\r","\t\t*page_break\r","\t\t*set boss_regard -2\r","\t\t*set case_2_accuse \"Rene\"\r","\t\t\u201cYou\u2019ve been covering up tons of problems with SEKA so Ubiquity doesn\u2019t dump the project. We\u2019re just the latest of many customers you\u2019ve ripped off, taking advantage of your access to our data to get employee passwords to sell on the black market and fund your life of luxury.\u201d\r","\t\t*return\r","\t*selectable_if (not(case_2_goal = 4)) #It\u2019s you, Margot!\r","\t\t*page_break\r","\t\t*set boss_regard -4\r","\t\t*set case_2_accuse \"Margo\"\r","\t\t\u201cYou\u2019ve been trying to distract people from your own actions by launching all these other investigations. You\u2019ve taken advantage of the SEKA rollout to install a bunch of backdoors and make it easy for EV3 to overload our servers and computers. They bribed you by promising to hire you away from Ubiquity once rollout was over, to a vice president position.\u201d\r","\t\t*return\r","\t\t\r","*label excuse\r","*page_break\r","*set boss_regard +1\r","*if case_2_goal = 4\r","\t*if A_choice = 1\r","\t\t*set case_2_accuse \"Jamie\"\r","\t\t\u201cLook at Jamie Travers, for example. He\u2019s distracted by his side business, trying to get rich selling investments for Reliable Trust. So he accesses external email from his work computer all the time, and ends up infecting his computer by clicking on bogus email links. He also showed his entire group how to use external email to get around Ubiquity\u2019s spam and malware filtering, so the problem spreads.\u201d\r","\t\t*goto sniff\r","\t*else\r","\t\t*set case_2_accuse \"Jamie\"\r","\t\t\u201cLook at Jamie Travers, for example. He\u2019s distracted by his side business, trying to get rich selling investments for Reliable Trust. So he probably accesses external email from his work computer all the time, and ends up infecting his computer by clicking on bogus email links.\u201d\r","\t\t*goto sniff\r","\t*label sniff\r","\t\r","\tMargot sniffed. \u201cSo you\u2019d agree with Rene. There definitely are a lot of people making the same kinds of mistakes. Maybe we need to increase the penalties to get everyone to pay more attention.\u201d\r","\t*return\r","*elseif case_2_goal = 3\r","\t*comment if 3AC\r","\t\u201cLook at Edward Yee, for example. He\u2019s got some personal problems and then has to deal with slow applications and email outages. So he and his group come up with work arounds, use flash drives they pick up from trade shows, and end up infecting Ubiquity computers. They turned out auto-updates to avoid the email problem, disabling the virus checkers, so the problem spread.\u201d\r","\r","\tMargot sniffed. \u201cSo you\u2019d agree with Rene. There definitely are a lot of people making the same kinds of mistakes. Maybe we need to increase the penalties to get everyone to pay more attention.\u201d\r","\t*return\r","*else\r","\t*comment (if not 4AC or 3AC) \r","\t\u201cLook at Jamie Travers and his group, for example. Like lots of other employees, they access external personal email accounts from work because it\u2019s convenient, and they end up accidentally infecting their computers when they click on bogus email links.\u201d\r","\r","\tMargot sniffed. \u201cSo you\u2019d agree with Rene. There definitely are a lot of people making the same kinds of mistakes, and Ubiquity does need to figure out how to break the pattern.\u201d\r","\t*return\r","\r","*label surprise\r","*page_break\r","\u201cSomething else? What did you find out?\u201d\r","*choice\r","\t#A competitor has been attacking us with no inside help!\r","\t\t*page_break\r","\t\t*set boss_regard -3\r","\t\t\u201cEV3 has been losing out to Ubiquity in recruiting new talent, so they\u2019ve been trying to steal our employee salary information. They\u2019ve also been trying to poach our recruiters and engineers.\u201d\r","\t\t*return\r","\t#The problem is that Ubiquity has self-defeating cyber security practices!\r","\t\t*page_break\r","\t\t*set boss_regard +3\r","\t\t\u201cThe Ubiquity\u2019s own security measures are causing enough inconvenience that people are deliberately disabling applications, sharing login accounts, and teaching each other how to get around password selection policies. We\u2019re making employees unite to fight against security rules, instead of coming together to get work done and protect Ubiquity.\u201d\r","\t\t*return\r","\t#The problem is being caused by SEKA!\r","\t\t*page_break\r","\t\t*set boss_regard +4\r","\t\t\u201cSEKA is trying to monitor and log so much employee activity that it\u2019s overloading servers and computers all across Ubiquity. This overload is slowing down computers, making employees think they need to turn off things like auto-updaters or virus scanners. It\u2019s also taking down servers, making emails get dropped and activating older back-up servers with outdated security applications.\u201d\r","\t\t*if resist_colleague > 0\r","\t\t\t\r","\t\t\t\u201cRene\u2019s been trying to cover up these issues so that Ubiquity won\u2019t dump SEKA.\u201d\r","\t\t\t*set case_2_accuse \"Rene\"\r","\t\t\t*set boss_regard +1\r","\t\t\t*return\r","\t\t*return\r","\t\t\r","*label interrupt\r","*page_break\r","Before you can say anything else, the President of Ubiquity comes running into the room. He\u2019s got a couple of security guard with him, and they\u2019re all out of breath.\r","\r","\u201cThank you, folks, why don\u2019t you all take the rest of the day off,\u201d the President gasps between huffing and puffing. \u201cWe\u2019ve been monitoring the situation, and have it completely under control. No need to go back to your office, we\u2019ll pick up anything you need and then walk you out.\u201d He gasps some more. \u201cNow that I think about it, maybe you\u2019d better just go on a short vacation while we take care of a few details. You can all expect to hear from me soon. Don\u2019t worry about coming back to work until then.\u201d\r","*page_break\r","The three of you are bustled out of the building, and the President himself takes your badges and keys. \u201cJust a little precaution, nothing to be alarmed about. Don\u2019t call us, I\u2019ll call you.\u201d\r","\r","You part ways with Margot and Rene. Awkward. \u201cUh, see you around. Or not, I guess,\u201d you say. They seem just as confused as you are.\r","*return"], "labels":{"meeting":62,"accuse":87,"excuse":116,"sniff":128,"surprise":145,"interrupt":171}},"anxiety_dream": {"crc":-459675655, "lines":["*if skip\r","\t*finish\r","You hole up in your room with a microwave burrito, watching Mischief lick his paws.\r","\r","You\u2019d only been working at Ubiquity for 3 days, but it felt so natural to be reading case records and investigating people. You can imagine a career at Ubiquity, using divination professionally instead of dressing up in a hokey costume to do palm readings for tourists. [i]If that last investigation gets me fired, where am I going to find another job?[/i]\r","*page_break\r","You hear Jamie \r","*if housemate_choice = 2 \r","\tand Bobby \r","\t*goto comehome\r","*label comehome\r","come home, but you don\u2019t want to tell anyone about the events leading up to your current indefinite vacation situation, so you stay in your room. Mischief abandons you to check whether Jamie might feed him.\r","\r","That night, you dream that \r","*if boss_regard > 2\r","\tyou\u2019re juggling five porcelain teacups, but the tea doesn\u2019t spill as they spin in the air. With a flourish, you whip out a white tablecloth which stays floating in the air. The teacups land right-side up on the tablecloth in front of you.\r","\t*set dream_4_description \"[b]Dream #4[/b] I was juggling teacups and managed not to spill the tea, even when the teacups landed on a floating tablecloth.\" \r","\t*set show_dream_4 true\t\r","\t*finish\r","*elseif boss_regard > 0\r","\tyou\u2019re juggling five porcelain teacups, sloshing tea everywhere as they tumble in the air. A table appears, set with a white tablecloth and vase of flowers. The teacups, now empty, land on the table and roll onto their sides.\r","\t*set dream_4_description \"[b]Dream #4[/b] I was juggling teacups and spilled tea everywhere, but didn't break any of the cups, even when they landed on a table.\" \r","\t*set show_dream_4 true\t\r","\t*finish\r","*else\r","\tyou\u2019re juggling five porcelain teacups, the hot tea sloshing over your hands each time you touch one. You fumble one cup, and they all fall to the ground.\r","\t*set dream_4_description \"[b]Dream #4[/b] I was juggling teacups and burned myself with the spilled tea before dropping the cups. So stressful.\" \r","\t*set show_dream_4 true\t\r","\t*finish"], "labels":{"comehome":10}},"job_outcome": {"crc":-1989065779, "lines":["*if skip\r","\t*finish\r","*if case_2_accuse = \"Jamie\"\r","\t*set housemate_relationship -3\r","\t*goto job_reveal\r","*if case_2_goal = 1\r","\t*set housemate_relationship +2\r","\t*goto job_reveal\t\r","*label job_reveal\r","*if boss_regard > 8\r","\t*gosub big_win\r","\t*finish\r","*elseif boss_regard > 6\r","\t*gosub high_moderate_win\r","\t*finish\r","*elseif boss_regard > 4\r","\t*gosub low_moderate_win\r","\t*finish\r","*elseif boss_regard > 2\r","\t*gosub survive\r","\t*finish\r","*elseif boss_regard > 0\r","\t*gosub fail\r","\t*finish\r","*else\r","\t*gosub epic_fail\r","\t*finish\r","\r","*label big_win\r","The doorbell wakes you up. You throw on some clothes and answer the door. It\u2019s Margot, who\u2019s actually smiling. \u201cI brought donuts.\u201d\r","\r","You put the coffee pot on. Margot tells you that the President of Ubiquity is busy negotiating a financial settlement from the company that makes SEKA, but asked her to give you the good news. Your investigation uncovered serious problems caused by SEKA, which Rene was trying to help cover up. Ubiquity is skipping the rest of your probationary period and hiring you for a permanent job immediately.\r","*page_break\r","\u201cBut if Ubiquity is dumping SEKA, they won\u2019t need us to tune up the artificial intelligence anymore.\u201d\r","\r","\u201cOh, our Taskforce on Improving Efficiency will now be reporting directly to the President, and trying to fix Ubiquity\u2019s most critical problems. I\u2019ve been promoted and we\u2019ll be getting a few new people for the team. I\u2019ll be counting on you to help them get the hang of it.\u201d\r","*return\r","\r","*label high_moderate_win\r","The doorbell wakes you up. You answer the door in your pajamas. It\u2019s Margot, who\u2019s almost smiling. \u201cI brought donuts.\u201d\r","\r","You put the coffee pot on. Margot tells you that the President of Ubiquity is busy negotiating a financial settlement from the company that makes SEKA, but asked her to give you the good news. Your investigation uncovered serious problems caused by SEKA, which Rene was trying to help cover up. Margo will be giving you a good recommendation when it comes time for your probationary period evaluation.\r","*page_break\r","\u201cBut if Ubiquity is dumping SEKA, they won\u2019t need us to tune up the artificial intelligence anymore.\u201d\r","\r","\u201cOh, there will always be issues for the Taskforce on Improving Efficiency to investigate. I\u2019m looking forward to working on them with you.\u201d\r","*return\r","\r","*label low_moderate_win\r","You hear nothing from Ubiquity for the rest of the week. It\u2019s getting harder to avoid talking to \r","*if housemate_choice = 2\r","\tJamie and Bobby. \r","\t*goto low_moderate_win_2\r","*else\r","\tJamie. \r","\t*goto low_moderate_win_2\r","*label low_moderate_win_2\r","None of your divinations or dreams have been particularly informative, and you\u2019re starting to get sick of frozen burritos.\r","*page_break\r","On Monday, the doorbell wakes you up. You can\u2019t find your bathrobe and haven\u2019t brushed your teeth. It\u2019s Margot, who\u2019s not exactly smiling, but at least isn\u2019t glaring at you. \r","*if case_2_accuse = \"Margot\"\r","\tWhich is better than you\u2019d expect, since your last interaction was to accuse her of sabotaging Ubiquity.\r","\t*goto low_moderate_win_3\r","*label low_moderate_win_3\r","\r","Margot tells you that you\u2019ll need to do better to pass the probationary evaluation, but she thinks you\u2019ve got some potential. You\u2019ll still be in her group, but Rene will be gone.\r","*page_break\r","\u201cWill we still be working on the SEKA rollout investigations, or is Ubiquity dumping it?\u201d\r","\r","\u201cYou don\u2019t need to know the details, but the Taskforce on Improving Efficiency will be looking into other issues. Hopefully you\u2019ll become a real asset to the team.\u201d \r","*if case_2_accuse = \"Margot\"\r","\tShe gives you a displeased look.\r","\t*return\r","*return\r","\r","*label survive\r","You hear nothing from Ubiquity for the rest of the week. It\u2019s getting harder to avoid talking to \r","*if housemate_choice = 2\r","\tJamie and Bobby. \r","\t*goto survive_2\r","*else\r","\tJamie. \r","\t*goto survive_2\r","*label survive_2\r","None of your divinations or dreams have been particularly informative, and you\u2019re starting to get sick of frozen burritos.\r","*page_break\r","On Monday, the doorbell wakes you up. You can\u2019t find your bathrobe and haven\u2019t brushed your teeth. It\u2019s the HR woman from your interview.\r","\r","She tells you that you\u2019ll need to do better to pass the probationary evaluation, but that Ubiquity has decided to give you a chance at another assignment. You\u2019ll meet your new boss when you report to work tomorrow. They\u2019ll be keeping a close eye on you with monthly performance evaluations. \r","*page_break\r","\u201cWhat happened with Margot and Rene, and the President of Ubiquity?\u201d\r","\r","She completely ignores your question. \u201cI\u2019m sorry to hear that your first assignment didn\u2019t turn out very well. Hopefully you\u2019ll be a better fit with the new team.\u201d \r","*return\r","\r","*label fail\r","You hear nothing from Ubiquity for the rest of the week. Jamie and Bobby both think that you\u2019ve been fired. None of your divinations or dreams have been particularly informative, and you\u2019re really sick of frozen burritos.\r","*page_break\r","On Monday, the doorbell wakes you up. You can\u2019t find your bathrobe and haven\u2019t brushed your teeth. It\u2019s the HR woman from your interview.\r","\r","She tells you that Ubiquity has decided to give you one last chance at another assignment. You\u2019ll meet your new boss when you report to work tomorrow. They\u2019ll be keeping a close eye on you with monthly performance evaluations. \r","*page_break\r","\u201cWhat happened with Margot and Rene, and the President of Ubiquity?\u201d\r","\r","\u201cI would recommend that you never bring up the subject of your first assignment again, and maybe everyone else will forget about it too. Hopefully you\u2019ll be a better fit with the new team.\u201d \r","*return\r","\r","*label epic_fail\r","The doorbell wakes you up. You jump out of bed, trip over your cat, and end up with leftover burrito in your hair. The HR woman from your interview is at the door.\r","\r","She tells you that Ubiquity is terminating your employment immediately.\r","\r","\u201cBut what happened with Margot and Rene, and the President of Ubiquity?\u201d\r","\r","\u201cYou\u2019re not a very good fortune teller, either, are you?\u201d\r","*return"], "labels":{"job_reveal":8,"big_win":28,"high_moderate_win":38,"low_moderate_win":48,"low_moderate_win_2":56,"low_moderate_win_3":63,"survive":75,"survive_2":83,"fail":95,"epic_fail":107}},"housemate_outcome": {"crc":969510754, "lines":["*if skip\r","\t*finish\r","*comment (check roommate relationship) (scale 0-4)\r","*comment (if 1AC +2, if 4AC -4)\r","*if boss_regard > 4\r","\t*comment (if win) \r","\tNow that you know you\u2019ll be going back to Ubiquity and working with Margot, you\u2019d better get the housemate situation settled. \r","\t*goto living_location\r","*elseif boss_regard > 0\r","\t*comment (if survive or fail) \r","\tAt least you\u2019ve still got a job. Once you pull yourself together, you\u2019d better get the housemate situation settled. \r","\t*goto living_location\r","*else\r","\tWhat a mess. No job, no prospects. Still, you're no worse off than you were a week ago. Time to figure out the housemate situation. \r","*label living_location\r","*if housemate_choice = 4\r","\t*comment (if at Jamie\u2019s) \r","\tJamie\u2019s condo is nice, but it\u2019s weird being his houseguest. \r","\t*goto housemate_resolution\r","*else\r","\t*comment housemate_choice = 2\r","\t*comment (if all in apartment) \r","\tThe apartment\u2019s too crowded with the three of you, and living with your ex and ${ehis} current boyfriend isn\u2019t really ideal.\r","\t*goto housemate_resolution\r","*label housemate_resolution\r","*page_break\r","The next day, \r","*if housemate_relationship > 4\r","\t*comment (if very positive)\r","\tyou\u2019re surprised to find Bobby making pancakes, and Jamie not around. \r","\r","\t\u201cI think you were right,\u201d ${ehe} says. \u201cI probably should have told Jamie the whole story about you sooner.\u201d\r","\r","\t\u201cI can see how it would be awkward to bring up.\u201d\r","\r","\t\u201cI hate how he\u2019s obsessed with investments and trying to get rich. He even thinks I should stop working with my parents and get a job at Ubiquity.\u201d\r","\r","\t\u201cWhat do you want to do?\u201d\r","\t*page_break\r","\t\u201cMake you pancakes? Tell Jamie I\u2019m in charge of my own life? Go back to us sharing an apartment and him living in his condo?\u201d\r","\t*if housemate_choice = 4\r","\t\t*comment(if you\u2019re at Jamie\u2019s) \r","\t\t\r","\t\tThe two of you leave the dishes in his sink, then move Mischief and your things back to the apartment.\r","\t\t*finish\r","\t*else\r","\t\t*comment (if he\u2019s at your place) \r","\t\t\r","\t\tThe two of you move Jamie\u2019s things into the hallway and put your dining room back together before the pancakes get cold.\r","\t\t*finish\r","\t*finish\r","*elseif housemate_relationship > 2\r","\t*comment (if moderately positive)\r","\tJamie offers you some cereal when you come into the kitchen.\r","\r","\t\u201cI\u2019m glad you\u2019ll still be working at Ubiquity.\u201d\r","\r","\t\u201cIt\u2019s definitely interesting.\u201d\r","\r","\t\u201cSorry about flipping out over the apartment situation. I know you\u2019re not trying to make Bobby break up with me.\u201d\r","\r","\t\u201cWe\u2019ve been friends a long time, but I don\u2019t know if I\u2019ve ever succeeded in making ${ehim} do anything.\u201d\r","\t*page_break\r","\t\u201cRight. And I like you and Mischief, but how about if we go back to you and Bobby in the apartment and me alone at my place.\u201d\r","\t*if housemate_choice = 4\r","\t\t*comment(if you\u2019re at Jamie\u2019s) \r","\t\t\r","\t\tYou\u2019ve got your things packed before leaving for work.\r","\t\t*finish\r","\t*else\r","\t\t*comment (if he\u2019s at your place) \r","\t\t\r","\t\tYou help him get his things packed up before leaving for work.\r","\t\t*finish\r","\t*finish\r","*else\r","\tyou can't dodge the question anymore. \r","\t*if case_2_accuse = \"Jamie\"\r","\t\t*comment (if negative or 0, you were 4AC)\r","\t\tYou\u2019re not sure if Jamie found out that you tried to blame him for security breaches at Ubiquity, but you\u2019ve been avoiding him anyways. You haven\u2019t talked to Bobby much either. \r","\t\t*goto tough_chat\r","\t*else\r","\t\tYou've been avoiding Jamie, and haven't talked to Bobby much either. \r","\t\t*goto tough_chat\r","\t*label tough_chat\r","\r","\tYou see a note on your box of cereal when you come into the kitchen.\r","\t*if housemate_choice = 4\r","\t\t*comment (if you\u2019re at his place) \r","\r","\t\tCasey - I don\u2019t think this housemate situation is working out. Bobby\u2019s going to move back in with ${ehis} parents to save money, so you\u2019ll have to find another apartment. Can you be out of here by the end of the month?\r","\t\t*goto couchsurf\r","\t*else\r","\t\t*comment(if he\u2019s at your place) \r","\r","\t\tCasey - I don\u2019t think this housemate situation is working out. I\u2019m going to move back in with my parents to save money, and Jamie\u2019s going back to his place, so you\u2019ll have to find another apartment. Can you be out of here by the end of the month?\r","\t\t*goto couchsurf\r","\t*label couchsurf\r","\t*page_break\r","\t[i]Oh great, I\u2019m going to be couch surfing with a cat.[/i] \r","\t*if boss_regard > 0\r","\t\t[i]I wonder if someone at Ubiquity is looking for a housemate.[/i]\r","\t\t*finish\r","\t*else\r","\t\t[i]Maybe it's time to move back in with Mom.[/i]\r","\t\t*finish\r","\t*finish"], "labels":{"living_location":14,"housemate_resolution":24,"tough_chat":84,"couchsurf":97}},"last_dream": {"crc":716201817, "lines":["You feel yourself drifting off to sleep. Your future stretches in front of you like a vast forest of question marks, obscured by fog. \r","\r","[i]Life\u2019s tricky, even when you use divination.[/i] \r","\r","You\u2019re paddling through a lake. Brightly colored frogs sit on giant lily pads croaking loudly. Out of their gaping mouths fly a swarm of paper airplanes, which zoom around your head before falling into your canoe. You unfold one of the airplanes.\r","\r","*if boss_regard > 6\r","\tPumpkin, I dreamed you were doing really well with your new job! We both know that seeing signs won\u2019t always reveal the answers. It keeps life interesting that way. Best wishes on your next adventures - I can\u2019t wait to hear the details. \r","\t*goto wake\r","*elseif boss_regard > 4\r","\tPumpkin, I dreamed you were doing pretty well with your new job! We both know that seeing signs won\u2019t always reveal the answers. It keeps life interesting that way. Best wishes on your next adventures - I can\u2019t wait to hear the details. \r","\t*goto wake\r","*else\r","\tPumpkin, I dreamed you were having a tough time with your new job. You\u2019ve probably figured out that seeing signs won\u2019t always show you the right answers. If it was that easy all the time, life wouldn\u2019t be much of an adventure. Keep your chin up - I\u2019m rooting for you. \r","\t*if housemate_relationship <=2\r","\t\tAnd don\u2019t worry, you can always stay with me until you find another apartment.\r","\t\t*goto wake\r","\t*goto wake\r","*label wake\r","*set dream_5_description \"[b]Dream #5[/b] I was in a canoe on a lake, with neon frogs, and I got a paper airplane note from Mom. I wonder what she would have done with the Ubiquity job.\" \r","*set show_dream_5 true\t\r","*page_break\r","You wake up and look around expecting frogs, but all you see are Mischief\u2019s eyes glowing in the dark.\r","\r","*ending"], "labels":{"wake":18}}}</script><script>//
// Copyright (c) 2008, 2009 Paul Duncan (paul@pablotron.org)
// 
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
//


/* 
 * The contents of gears_init.js; we need this because Chrome supports
 * Gears out of the box, but still requires this constructor.  Note that
 * if you include gears_init.js then this function does nothing.
 */
(function() {
  // We are already defined. Hooray!
  if (window.google && google.gears)
    return;

  // factory 
  var F = null;

  // Firefox
  if (typeof GearsFactory != 'undefined') {
    F = new GearsFactory();
  } else {
    // IE
    try {
      F = new ActiveXObject('Gears.Factory');
      // privateSetGlobalObject is only required and supported on WinCE.
      if (F.getBuildInfo().indexOf('ie_mobile') != -1)
        F.privateSetGlobalObject(this);
    } catch (e) {
      // Safari
      if ((typeof navigator.mimeTypes != 'undefined')
           && navigator.mimeTypes["application/x-googlegears"]) {
        F = document.createElement("object");
        F.style.display = "none";
        F.width = 0;
        F.height = 0;
        F.type = "application/x-googlegears";
        document.documentElement.appendChild(F);
      }
    }
  }

  // *Do not* define any objects if Gears is not installed. This mimics the
  // behavior of Gears defining the objects in the future.
  if (!F)
    return;

  // Now set up the objects, being careful not to overwrite anything.
  //
  // Note: In Internet Explorer for Windows Mobile, you can't add properties to
  // the window object. However, global objects are automatically added as
  // properties of the window object in all browsers.
  if (!window.google)
    google = {};

  if (!google.gears)
    google.gears = {factory: F};
})();

/**
 * Persist - top-level namespace for Persist library.
 * @namespace
 */
Persist = (function() {
  var VERSION = '0.2.0', P, B, esc, init, empty, ec;

  // easycookie 0.2.1 (pre-minified)
  // (see http://pablotron.org/software/easy_cookie/)
  ec = (function(){var EPOCH='Thu, 01-Jan-1970 00:00:01 GMT',RATIO=1000*60*60*24,KEYS=['expires','path','domain'],esc=escape,un=unescape,doc=document,me;var get_now=function(){var r=new Date();r.setTime(r.getTime());return r;}
var cookify=function(c_key,c_val){var i,key,val,r=[],opt=(arguments.length>2)?arguments[2]:{};r.push(esc(c_key)+'='+esc(c_val));for(i=0;i<KEYS.length;i++){key=KEYS[i];if(val=opt[key])
r.push(key+'='+val);}
if(opt.secure)
r.push('secure');return r.join('; ');}
var alive=function(){var k='__EC_TEST__',v=new Date();v=v.toGMTString();this.set(k,v);this.enabled=(this.remove(k)==v);return this.enabled;}
me={set:function(key,val){var opt=(arguments.length>2)?arguments[2]:{},now=get_now(),expire_at,cfg={};if(opt.expires){cfg.expires=new Date(now.getTime()+opt.expires*RATIO);cfg.expires=cfg.expires.toGMTString();}
var keys=['path','domain','secure'];for(i=0;i<keys.length;i++)
if(opt[keys[i]])
cfg[keys[i]]=opt[keys[i]];var r=cookify(key,val,cfg);doc.cookie=r;return val;},has:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length);return((!ofs&&key!=sub)||ofs<0)?false:true;},get:function(key){key=esc(key);var c=doc.cookie,ofs=c.indexOf(key+'='),len=ofs+key.length+1,sub=c.substring(0,key.length),end;if((!ofs&&key!=sub)||ofs<0)
return null;end=c.indexOf(';',len);if(end<0)
end=c.length;return un(c.substring(len,end));},remove:function(k){var r=me.get(k),opt={expires:EPOCH};doc.cookie=cookify(k,'',opt);return r;},keys:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push(un(p[0]));}
return r;},all:function(){var c=doc.cookie,ps=c.split('; '),i,p,r=[];for(i=0;i<ps.length;i++){p=ps[i].split('=');r.push([un(p[0]),un(p[1])]);}
return r;},version:'0.2.1',enabled:false};me.enabled=alive.call(me);return me;}());

  // wrapper for Array.prototype.indexOf, since IE doesn't have it
  var index_of = (function() {
    if (Array.prototype.indexOf)
      return function(ary, val) { 
        return Array.prototype.indexOf.call(ary, val);
      };
    else
      return function(ary, val) {
        var i, l;

        for (i = 0, l = ary.length; i < l; i++)
          if (ary[i] == val)
            return i;

        return -1;
      };
  })();


  // empty function
  empty = function() { };

  /**
   * Escape spaces and underscores in name.  Used to generate a "safe"
   * key from a name.
   *
   * @private
   */
  esc = function(str) {
    return 'PS' + str.replace(/_/g, '__').replace(/ /g, '_s');
  };

  C = {
    /* 
     * Backend search order.
     * 
     * Note that the search order is significant; the backends are
     * listed in order of capacity, and many browsers
     * support multiple backends, so changing the search order could
     * result in a browser choosing a less capable backend.
     */ 
    search_order: [
      // TODO: air
      'cefStorage',
      'winOldStorage',
      'winStoreStorage',
      'macStorage',
      'iosStorage',
      'localChromeStorage',
      'androidStorage',
      'whatwg_db', 
      'localstorage',
      'globalstorage', 
      'cookie',
      'gears',
      'ie', 
      'flash'
    ],

    // valid name regular expression
    name_re: /^[a-z][a-z0-9_ -]+$/i,

    // list of backend methods
    methods: [
      'init', 
      'get', 
      'set', 
      'remove', 
      'load', 
      'save'
      // TODO: clear method?
    ],

    // sql for db backends (gears and db)
    sql: {
      version:  '1', // db schema version

      // XXX: the "IF NOT EXISTS" is a sqlite-ism; fortunately all the 
      // known DB implementations (safari and gears) use sqlite
      create:   "CREATE TABLE IF NOT EXISTS persist_data (k TEXT UNIQUE NOT NULL PRIMARY KEY, v TEXT NOT NULL)",
      get:      "SELECT v FROM persist_data WHERE k = ?",
      set:      "INSERT INTO persist_data(k, v) VALUES (?, ?)",
      remove:   "DELETE FROM persist_data WHERE k = ?" 
    },

    // default flash configuration
    flash: {
      // ID of wrapper element
      div_id:   '_persist_flash_wrap',

      // id of flash object/embed
      id:       '_persist_flash',

      // default path to flash object
      path: 'persist.swf',
      size: { w:1, h:1 },

      // arguments passed to flash object
      args: {
        autostart: true
      }
    } 
  };

  // built-in backends
  B = {
    // gears db backend
    // (src: http://code.google.com/apis/gears/api_database.html)
    gears: {
      // no known limit
      size:   -1,

      test: function() {
        // test for gears
        return (window.google && window.google.gears) ? true : false;
      },

      methods: {
        transaction: function(fn) {
          var db = this.db;

          // begin transaction
          db.execute('BEGIN').close();

          // call callback fn
          fn.call(this, db);

          // commit changes
          db.execute('COMMIT').close();
        },

        init: function() {
          var db;

          // create database handle (TODO: add schema version?)
          db = this.db = google.gears.factory.create('beta.database');

          // open database
          // from gears ref:
          //
          // Currently the name, if supplied and of length greater than
          // zero, must consist only of visible ASCII characters
          // excluding the following characters:
          //
          //   / \ : * ? " < > | ; ,
          //
          // (this constraint is enforced in the Store constructor)
          db.open(esc(this.name));

          // create table
          db.execute(C.sql.create).close();
        },

        get: function(key, fn, scope) {
          var r, sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // begin transaction
          this.transaction(function (t) {
            var is_valid, val;
            // exec query
            r = t.execute(sql, [key]);

            // check result and get value
            is_valid = r.isValidRow();
            val = is_valid ? r.field(0) : null;

            // close result set
            r.close();

            // call callback
            fn.call(scope || this, is_valid, val);
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set, r;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.execute(rm_sql, [key]).close();

            // exec set query
            t.execute(sql, [key, val]).close();
            
            // run callback (TODO: get old value)
            if (fn)
              fn.call(scope || this, true, val);
          });
        },

        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove,
              r, val = null, is_valid = false;

          // begin remove transaction
          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              r = t.execute(get_sql, [key]);

              // check validity and get value
              is_valid = r.isValidRow();
              val = is_valid ? r.field(0) : null;

              // close result set
              r.close();
            }

            // exec remove query if no callback was defined, or if a
            // callback was defined and there was an existing value
            if (!fn || is_valid) {
              // exec remove query
              t.execute(sql, [key]).close();
            }

            // exec callback
            if (fn)
              fn.call(scope || this, is_valid, val);
          });
        } 
      }
    }, 

    cefStorage: {
      size:   -1,

      test: function() {
        return !!window.cefQuery;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        query: function(method, paramString, callback) {
          cefQuery({request:method+" "+paramString,
            onSuccess: function(response) {
              callback(true, response);
            },
            onFailure: function(error_code, error_message) {
              console.error(method + " error: " + error_message);
              callback(false);
            }
          });
        },

        get: function(key, fn, scope) {
          key = this.key(key);

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          this.query("StorageGet", key, function(ok, results) {
            fn.call(scope, ok, results);
          });
        },

        set: function(key, val, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageSet", key + " " + val, function(ok){
            if (fn) fn.call(scope, ok, val);
          });
          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          key = this.key(key);
          scope = scope || this;
          this.query("StorageRemove", key, function(ok) {
            // return original value? meh
            if (fn) fn.call(scope, ok);
          });
        }
      }
    },

    // whatwg db backend (webkit, Safari 3.1+)
    // (src: whatwg and http://webkit.org/misc/DatabaseExample.html)
    whatwg_db: {
      // size based on DatabaseExample from above (should I increase
      // this?)
      size:   200 * 1024,

      test: function() {
        var name = 'PersistJS Test', 
            desc = 'Persistent database test.';

        // test for openDatabase
        if (!window.openDatabase)
          return false;

        // make sure openDatabase works
        // XXX: will this leak a db handle and/or waste space?
        if (!window.openDatabase(name, C.sql.version, desc, B.whatwg_db.size))
          return false;

        // return true
        return true;
      },

      methods: {
        transaction: function(fn) {
          // lazy create database table;
          // this is done here because there is no way to
          // prevent a race condition if the table is created in init()
          if (!this.db_created) {
            this.db.transaction(function(t) {
              // create table
              t.executeSql(C.sql.create, [], function() {
                this.db_created = true;
              });
            }, empty); // trap exception
          } 

          // execute transaction
          this.db.transaction(fn);
        },

        init: function() {
          // create database handle
          this.db = openDatabase(
            this.name, 
            C.sql.version, 
            this.o.about || ("Persistent storage for " + this.name),
            this.o.size || B.whatwg_db.size 
          );
        },

        get: function(key, fn, scope) {
          var sql = C.sql.get;

          // if callback isn't defined, then return
          if (!fn)
            return;

          // get callback scope
          scope = scope || this;

          // begin transaction
          this.transaction(function (t) {
            t.executeSql(sql, [key], function(t, r) {
              if (r.rows.length > 0)
                fn.call(scope, true, r.rows.item(0)['v']);
              else
                fn.call(scope, false, null);
            });
          });
        },

        set: function(key, val, fn, scope) {
          var rm_sql = C.sql.remove,
              sql    = C.sql.set;

          // begin set transaction
          this.transaction(function(t) {
            // exec remove query
            t.executeSql(rm_sql, [key], function() {
              // exec set query
              t.executeSql(sql, [key, val], function(t, r) {
                // run callback
                if (fn)
                  fn.call(scope || this, true, val);
              });
            });
          });

          return val;
        },

        // begin remove transaction
        remove: function(key, fn, scope) {
          var get_sql = C.sql.get;
              sql = C.sql.remove;

          this.transaction(function(t) {
            // if a callback was defined, then get the old
            // value before removing it
            if (fn) {
              // exec get query
              t.executeSql(get_sql, [key], function(t, r) {
                if (r.rows.length > 0) {
                  // key exists, get value 
                  var val = r.rows.item(0)['v'];

                  // exec remove query
                  t.executeSql(sql, [key], function(t, r) {
                    // exec callback
                    fn.call(scope || this, true, val);
                  });
                } else {
                  // key does not exist, exec callback
                  fn.call(scope || this, false, null);
                }
              });
            } else {
              // no callback was defined, so just remove the
              // data without checking the old value

              // exec remove query
              t.executeSql(sql, [key]);
            }
          });
        } 
      }
    }, 
    
    // globalstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://developer.mozilla.org/en/docs/DOM:Storage#globalStorage)
    // https://developer.mozilla.org/En/DOM/Storage
    //
    // TODO: test to see if IE8 uses object literal semantics or
    // getItem/setItem/removeItem semantics
    globalstorage: {
      // (5 meg limit, src: http://ejohn.org/blog/dom-storage-answers/)
      size: 5 * 1024 * 1024,

      test: function() {
        try {
          if (window.globalStorage && window.globalStorage[this.o.domain]) return true;
        } catch (e) {}
        return false;
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = globalStorage[this.o.domain];
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store[key];

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 
    
    // localstorage backend (globalStorage, FF2+, IE8+)
    // (src: http://www.whatwg.org/specs/web-apps/current-work/#the-localstorage)
    // also http://msdn.microsoft.com/en-us/library/cc197062(VS.85).aspx#_global
    localstorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.localStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = localStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // chrome packaged app storage
    // http://developer.chrome.com/stable/apps/storage.html
    localChromeStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.chrome && window.chrome.storage && window.chrome.storage.local;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = chrome.storage.local;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          scope = scope || this;
          this.store.get(key, function(val){
            if (fn) fn.call(scope, true, val[key]);
          });
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          var out = {};
          out[key] = val;
          if (fn) {
            scope = scope || this;  
            this.store.set(out, function(){
              fn.call(scope, true, val);
            });
          } else {
            this.store.set(out);
          }
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          if (fn) {
            // get value first
            scope = scope || this;
            this.store.get(key, function(val){
              this.store.remove(key, function(){
                fn.call(scope, (val[key] !== null), val[key]);
              });
            });
          } else {
            this.store.remove(key);
          }
        } 
      }
    }, 
    
    // DGF Fake local storage
    androidStorage: {
      // (unknown?)
      // ie has the remainingSpace property, see:
      // http://msdn.microsoft.com/en-us/library/cc197016(VS.85).aspx
      size: -1,

      test: function() {
        try {
          return window.androidStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = androidStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.getItem(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setItem(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.getItem(key);

          // delete value
          this.store.removeItem(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF iOS managed storage
    iosStorage: {
      size: -1,

      test: function() {
        try {
          return window.isIosApp ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {

        },

        callIos: function(url) {
          var iframe = document.createElement("IFRAME");
          iframe.setAttribute("src", url);
          document.documentElement.appendChild(iframe);
          iframe.parentNode.removeChild(iframe);
          iframe = null;
        },

        get: function(key, fn, scope) {
          if (!fn) return;
          // expand key
          key = this.key(key);

          var nonce = "storageget" + key + (+new Date);
          window[nonce] = function(value) {
            delete window[nonce];
            fn.call(scope || this, true, value);
          }
          this.callIos("storageget://" + key + " " + nonce);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          var nonce = "storageset" + key + (+new Date);
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, true, val);
          }
          this.callIos("storageset://" + key + " " + nonce + " " + encodeURIComponent(encodeURIComponent(val)));
        },

        remove: function(key, fn, scope) {
          if (fn) {
            this.get(key, function(val) {
              this._remove(key, fn, scope, val);
            }, this);
          } else {
            this._remove(key, fn, scope);
          }
        },

        _remove: function(key, fn, scope, val) {
          var val;

          // expand key
          key = this.key(key);

          // delete value
          var nonce = "storagerem" + key + (+new Date);
          window[nonce] = function() {
            delete window[nonce];
            if (fn) fn.call(scope || this, (val !== null), val);
          }
          this.callIos("storagerem://" + key + " " + nonce + " " + encodeURIComponent(val));
        } 
      }
    }, 

    // DGF OSX managed storage
    macStorage: {
      size: -1,

      test: function() {
        try {
          return window.macStorage ? true : false;
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = macStorage;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.objectForKey_(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.setObject_forKey_(val, key);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.objectForKey_(key)

          // delete value
          this.store.removeObjectForKey_(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

    // DGF Old win app managed storage
    winOldStorage: {
      size: -1,

      test: function() {
        try {
          return window.external.IsWinOldApp();
        } catch (e) {
          return false;
        }
      },

      methods: {
        key: function(key) {
          return esc(this.name) + esc(key);
        },

        init: function() {
          this.store = window.external;
        },

        get: function(key, fn, scope) {
          // expand key
          key = this.key(key);

          if (fn)
            fn.call(scope || this, true, this.store.GetValue(key));
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = this.key(key);

          // set value
          this.store.SetValue(key, val);

          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = this.key(key);

          // get value
          val = this.store.GetValue(key)

          // delete value
          this.store.DeleteValue(key);

          if (fn)
            fn.call(scope || this, (val !== null), val);
        } 
      }
    }, 

      // DGF WinStore managed storage
    winStoreStorage: {
        size: -1,

        test: function () {
            try {
                return Windows.Storage.ApplicationData.current.roamingFolder;
            } catch (e) {
                return false;
            }
        },

        methods: {
            key: function (key) {
                return esc(this.name) + esc(key);
            },

            init: function () {
                var self = this;
                function doneLoadingWinStore() {
                  self.loaded = true;
                  for (var i = self.loadListeners.length - 1; i >= 0; i--) {
                    setTimeout(self.loadListeners[i], 0);
                  }
                }
                this.loaded = false;
                this.loadListeners = [];

                Windows.Storage.ApplicationData.current.roamingFolder
                  .createFileAsync("data.txt", Windows.Storage.CreationCollisionOption.openIfExists)
                  .then(function (file) {
                    self.file = file;
                    return Windows.Storage.FileIO.readTextAsync(file);
                  }).done(function (data) {
                    self.store = {};
                    if (data && typeof data == "string") {
                      var rows = data.split("\n");
                      for (var i = rows.length - 1; i >= 0; i--) {
                        var row = rows[i].split("\t");
                        self.store[row[0]] = decodeURIComponent(row[1]);
                      }
                    }
                    doneLoadingWinStore();
                  },
                  function(){
                    self.store = {};
                    doneLoadingWinStore();
                  });
            },

            get: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.get(key, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                if (fn)
                    fn.call(scope || this, true, this.store[key]);
            },

            set: function (key, val, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.set(key, val, fn, scope)});
                  return;
                }
                // expand key
                key = this.key(key);

                // set value
                this.store[key] = val;
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, true, val);
            },

            remove: function (key, fn, scope) {
                if (!this.loaded) {
                  var self = this;
                  this.loadListeners.push(function() {self.remove(key, fn, scope)});
                  return;
                }
                var val;

                // expand key
                key = this.key(key);

                // get value
                val = this.store[key];

                // delete value
                delete this.store[key];
                this.writeAsync();

                if (fn)
                    fn.call(scope || this, (val !== null), val);
            },

            writeAsync: function() {
              var output = [];
              for (var key in this.store) {
                output.push(key, '\t', encodeURIComponent(this.store[key]), '\n');
              }
              Windows.Storage.FileIO.writeTextAsync(this.file, output.join(''));
            }
        }
    },

    // IE backend
    ie: {
      prefix:   '_persist_data-',
      // style:    'display:none; behavior:url(#default#userdata);',

      // 64k limit
      size:     64 * 1024,

      test: function() {
        // make sure we're dealing with IE
        // (src: http://javariet.dk/shared/browser_dom.htm)
        return window.ActiveXObject ? true : false;
      },

      make_userdata: function(id) {
        var el = document.createElement('div');

        // set element properties
        // http://msdn.microsoft.com/en-us/library/ms531424(VS.85).aspx 
        // http://www.webreference.com/js/column24/userdata.html
        el.id = id;
        el.style.display = 'none';
        el.addBehavior('#default#userdata');

        // append element to body
        document.body.appendChild(el);

        // return element
        return el;
      },

      methods: {
        init: function() {
          var id = B.ie.prefix + esc(this.name);

          // save element
          this.el = B.ie.make_userdata(id);

          // load data
          if (this.o.defer)
            this.load();
        },

        get: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get value
          val = this.el.getAttribute(key);

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        set: function(key, val, fn, scope) {
          // expand key
          key = esc(key);
          
          // set attribute
          this.el.setAttribute(key, val);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // expand key
          key = esc(key);

          // load data
          if (!this.o.defer)
            this.load();

          // get old value and remove attribute
          val = this.el.getAttribute(key);
          this.el.removeAttribute(key);

          // save data
          if (!this.o.defer)
            this.save();

          // call fn
          if (fn)
            fn.call(scope || this, val ? true : false, val);
        },

        load: function() {
          this.el.load(esc(this.name));
        },

        save: function() {
          this.el.save(esc(this.name));
        }
      }
    },

    // cookie backend
    // uses easycookie: http://pablotron.org/software/easy_cookie/
    cookie: {
      delim: ':',

      // 4k limit (low-ball this limit to handle browser weirdness, and 
      // so we don't hose session cookies)
      size: 4000,

      test: function() {
        // XXX: use easycookie to test if cookies are enabled
        return P.Cookie.enabled ? true : false;
      },

      methods: {
        key: function(key) {
          return this.name + B.cookie.delim + key;
        },

        get: function(key, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // get value
          val = ec.get(key);

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        },

        set: function(key, val, fn, scope) {
          // expand key 
          key = this.key(key);

          // save value
          ec.set(key, val, this.o);

          // call fn
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, val, fn, scope) {
          var val;

          // expand key 
          key = this.key(key);

          // remove cookie
          val = ec.remove(key)

          // call fn
          if (fn)
            fn.call(scope || this, val != null, val);
        } 
      }
    },

    // flash backend (requires flash 8 or newer)
    // http://kb.adobe.com/selfservice/viewContent.do?externalId=tn_16194&sliceId=1
    // http://livedocs.adobe.com/flash/8/main/wwhelp/wwhimpl/common/html/wwhelp.htm?context=LiveDocs_Parts&file=00002200.html
    flash: {
      test: function() {
        // TODO: better flash detection
        if (!window.deconcept || !window.deconcept.SWFObjectUtil)
          return false;

        // get the major version
        var major = deconcept.SWFObjectUtil.getPlayerVersion().major;

        // check flash version (require 8.0 or newer)
        return (major >= 8) ? true : false;
      },

      methods: {
        init: function() {
          if (!B.flash.el) {
            var o, key, el, cfg = C.flash;

            // create wrapper element
            el = document.createElement('div');
            el.id = cfg.div_id;

            // FIXME: hide flash element
            // el.style.display = 'none';

            // append element to body
            document.body.appendChild(el);

            // create new swf object
            o = new deconcept.SWFObject(this.o.swf_path || cfg.path, cfg.id, cfg.size.w, cfg.size.h, '8');

            // set parameters
            for (key in cfg.args)
              o.addVariable(key, cfg.args[key]);

            // write flash object
            o.write(el);

            // save flash element
            B.flash.el = document.getElementById(cfg.id);
          }

          // use singleton flash element
          this.el = B.flash.el;
        },

        get: function(key, fn, scope) {
          var val;

          // escape key
          key = esc(key);

          // get value
          val = this.el.get(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, val !== null, val);
        },

        set: function(key, val, fn, scope) {
          var old_val;

          // escape key
          key = esc(key);

          // set value
          old_val = this.el.set(this.name, key, val);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        },

        remove: function(key, fn, scope) {
          var val;

          // get key
          key = esc(key);

          // remove old value
          val = this.el.remove(this.name, key);

          // call handler
          if (fn)
            fn.call(scope || this, true, val);
        }
      }
    }
  };

  /**
   * Test for available backends and pick the best one.
   * @private
   */
  var init = function() {
    var i, l, b, key, fns = C.methods, keys = C.search_order;

    // set all functions to the empty function
    for (i = 0, l = fns.length; i < l; i++) 
      P.Store.prototype[fns[i]] = empty;

    // clear type and size
    P.type = null;
    P.size = -1;

    // loop over all backends and test for each one
    for (i = 0, l = keys.length; !P.type && i < l; i++) {
      b = B[keys[i]];

      // test for backend
      try {
        if (b.test()) {
          // found backend, save type and size
          P.type = keys[i];
          P.size = b.size;

          // extend store prototype with backend methods
          for (key in b.methods)
            P.Store.prototype[key] = b.methods[key];
        }
      } catch (e) {}
    }

    // mark library as initialized
    P._init = true;
  };

  // create top-level namespace
  P = {
    // version of persist library
    VERSION: VERSION,

    // backend type and size limit
    type: null,
    size: 0,

    // XXX: expose init function?
    // init: init,

    add: function(o) {
      // add to backend hash
      B[o.id] = o;

      // add backend to front of search order
      C.search_order = [o.id].concat(C.search_order);

      // re-initialize library
      init();
    },

    remove: function(id) {
      var ofs = index_of(C.search_order, id);
      if (ofs < 0)
        return;

      // remove from search order
      C.search_order.splice(ofs, 1);

      // delete from lut
      delete B[id];

      // re-initialize library
      init();
    },

    // expose easycookie API
    Cookie: ec,

    // store API
    Store: function(name, o) {
      // verify name
      if (!C.name_re.exec(name))
        throw new Error("Invalid name");

      // XXX: should we lazy-load type?
      // if (!P._init)
      //   init();

      if (!P.type)
        throw new Error("No suitable storage found");

      o = o || {};
      this.name = name;

      // get domain (XXX: does this localdomain fix work?)
      o.domain = o.domain || location.host || 'localhost';
      
      // strip port from domain (XXX: will this break ipv6?)
      o.domain = o.domain.replace(/:\d+$/, '')

      // append localdomain to domains w/o '."
      // (see https://bugzilla.mozilla.org/show_bug.cgi?id=357323)
      // (file://localhost/ works, see: 
      // https://bugzilla.mozilla.org/show_bug.cgi?id=469192)
/* 
 *       if (!o.domain.match(/\./))
 *         o.domain += '.localdomain';
 */ 

      this.o = o;

      // expires in 2 years
      o.expires = o.expires || 365 * 2;

      // set path to root
      o.path = o.path || '/';

      // call init function
      this.init();
    } 
  };

  // init persist
  init();

  // return top-level namespace
  return P;
})();
/**
 * alertify
 * An unobtrusive customizable JavaScript notification system
 *
 * @author Fabien Doiron <fabien.doiron@gmail.com>
 * @copyright Fabien Doiron 2012
 * @license MIT <http://opensource.org/licenses/mit-license.php>
 * @link http://fabien-d.github.com/alertify.js/
 * @module alertify
 * @version 0.3.0
 */
(function(e,t){"use strict";var n=e.document,r;r=function(){var r={},i={},s=!1,o={ENTER:13,ESC:27,SPACE:32},u=[],a,f,l,c,h;return i={buttons:{holder:'<nav class="alertify-buttons">{{buttons}}</nav>',submit:'<button type="submit" class="alertify-button alertify-button-ok" id="alertify-ok" />{{ok}}</button>',ok:'<a href="#" class="alertify-button alertify-button-ok" id="alertify-ok">{{ok}}</a>',cancel:'<a href="#" class="alertify-button alertify-button-cancel" id="alertify-cancel">{{cancel}}</a>'},input:'<div class="alertify-text-wrapper"><input type="text" class="alertify-text" id="alertify-text"></div>',message:'<p class="alertify-message">{{message}}</p>',log:'<article class="alertify-log{{class}}">{{message}}</article>'},a=function(e){return n.getElementById(e)},r={labels:{ok:"OK",cancel:"Cancel"},delay:5e3,addListeners:function(r){var i=a("alertify-resetFocus"),s=a("alertify-ok")||t,u=a("alertify-cancel")||t,f=a("alertify-text")||t,l=a("alertify-form")||t,c=typeof s!="undefined",h=typeof u!="undefined",p=typeof f!="undefined",d="",v=this,m,g,y,b,w;m=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof f!="undefined"&&(d=f.value),typeof r=="function"&&r(!0,d)},g=function(e){typeof e.preventDefault!="undefined"&&e.preventDefault(),y(e),typeof r=="function"&&r(!1)},y=function(e){v.hide(),v.unbind(n.body,"keyup",b),v.unbind(i,"focus",w),p&&v.unbind(l,"submit",m),c&&v.unbind(s,"click",m),h&&v.unbind(u,"click",g)},b=function(e){var t=e.keyCode;t===o.SPACE&&!p&&m(e),t===o.ESC&&h&&g(e)},w=function(e){p?f.focus():h?u.focus():s.focus()},this.bind(i,"focus",w),c&&this.bind(s,"click",m),h&&this.bind(u,"click",g),this.bind(n.body,"keyup",b),p&&this.bind(l,"submit",m),e.setTimeout(function(){f?(f.focus(),f.select()):s.focus()},50)},bind:function(e,t,n){typeof e.addEventListener=="function"?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},build:function(e){var t="",n=e.type,r=e.message,s=e.cssClass||"";t+='<div class="alertify-dialog">',n==="prompt"&&(t+='<form id="alertify-form">'),t+='<article class="alertify-inner">',t+=i.message.replace("{{message}}",r),n==="prompt"&&(t+=i.input),t+=i.buttons.holder,t+="</article>",n==="prompt"&&(t+="</form>"),t+='<a id="alertify-resetFocus" class="alertify-resetFocus" href="#">Reset Focus</a>',t+="</div>";switch(n){case"confirm":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"prompt":t=t.replace("{{buttons}}",i.buttons.cancel+i.buttons.submit),t=t.replace("{{ok}}",this.labels.ok).replace("{{cancel}}",this.labels.cancel);break;case"alert":t=t.replace("{{buttons}}",i.buttons.ok),t=t.replace("{{ok}}",this.labels.ok);break;default:}return c.className="alertify alertify-show alertify-"+n+" "+s,l.className="alertify-cover",t},close:function(e,t){var n=t&&!isNaN(t)?+t:this.delay;this.bind(e,"click",function(){h.removeChild(e)}),setTimeout(function(){typeof e!="undefined"&&e.parentNode===h&&h.removeChild(e)},n)},dialog:function(e,t,r,i,o){f=n.activeElement;var a=function(){if(c&&c.scrollTop!==null)return;a()};if(typeof e!="string")throw new Error("message must be a string");if(typeof t!="string")throw new Error("type must be a string");if(typeof r!="undefined"&&typeof r!="function")throw new Error("fn must be a function");return typeof this.init=="function"&&(this.init(),a()),u.push({type:t,message:e,callback:r,placeholder:i,cssClass:o}),s||this.setup(),this},extend:function(e){if(typeof e!="string")throw new Error("extend method must have exactly one paramter");return function(t,n){return this.log(t,e,n),this}},hide:function(){u.splice(0,1),u.length>0?this.setup():(s=!1,c.className="alertify alertify-hide alertify-hidden",l.className="alertify-cover alertify-hidden",f?f.focus():null)},init:function(){n.createElement("nav"),n.createElement("article"),n.createElement("section"),l=n.createElement("div"),l.setAttribute("id","alertify-cover"),l.className="alertify-cover alertify-hidden",n.body.appendChild(l),c=n.createElement("section"),c.setAttribute("id","alertify"),c.className="alertify alertify-hidden",n.body.appendChild(c),h=n.createElement("section"),h.setAttribute("id","alertify-logs"),h.className="alertify-logs",n.body.appendChild(h),n.body.setAttribute("tabindex","0"),delete this.init},log:function(e,t,n){var r=function(){if(h&&h.scrollTop!==null)return;r()};return typeof this.init=="function"&&(this.init(),r()),this.notify(e,t,n),this},notify:function(e,t,r){var i=n.createElement("article");i.className="alertify-log"+(typeof t=="string"&&t!==""?" alertify-log-"+t:""),i.innerHTML=e,h.insertBefore(i,h.firstChild),setTimeout(function(){i.className=i.className+" alertify-log-show"},50),this.close(i,r)},set:function(e){var t;if(typeof e!="object"&&e instanceof Array)throw new Error("args must be an object");for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},setup:function(){var e=u[0];s=!0,c.innerHTML=this.build(e),typeof e.placeholder=="string"&&e.placeholder!==""&&(a("alertify-text").value=e.placeholder),this.addListeners(e.callback)},unbind:function(e,t,n){typeof e.removeEventListener=="function"?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)}},{alert:function(e,t,n){return r.dialog(e,"alert",t,"",n),this},confirm:function(e,t,n){return r.dialog(e,"confirm",t,"",n),this},extend:r.extend,init:r.init,log:function(e,t,n){return r.log(e,t,n),this},prompt:function(e,t,n,i){return r.dialog(e,"prompt",t,n,i),this},success:function(e,t){return r.log(e,"success",t),this},error:function(e,t){return r.log(e,"error",t),this},set:function(e){r.set(e)},labels:r.labels}},typeof define=="function"?define([],function(){return new r}):typeof e.alertify=="undefined"&&(e.alertify=new r)})(this);/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */

_global = this;

(function() {
  var userAgent, url, protocol;
  if (typeof window !== "undefined") {
    userAgent = navigator.userAgent;
    url = window.location.href;
    protocol = window.location.protocol;
  }
  _global.isWebOS = /webOS/.test(userAgent);
  _global.isMobile = _global.isWebOS || /Mobile/.test(userAgent);
  _global.isFile = /^file:/.test(url);
  _global.isXul = /^chrome:/.test(url);
  _global.isWinOldApp = false;
  try {
    isWinOldApp = window.external.IsWinOldApp();
  } catch (ignored) {}
  _global.isWeb = !_global.isWinOldApp && /^https?:/.test(url);
  _global.isAndroid = /Android/.test(userAgent);
  _global.isSecureWeb = /^https:?$/.test(protocol);
  _global.isSafari = /Safari/.test(userAgent);
  _global.isIE = /(MSIE|Trident)/.test(userAgent);
  _global.isIPad = /iPad/.test(userAgent);
  _global.isKindleFire = /Kindle Fire/.test(userAgent);
  _global.isWinStoreApp = "ms-appx:" == protocol;
  _global.isCef = !!_global.cefQuery;
})();

_global.loadTime = new Date().getTime();

function callIos(scheme, path) {
  if (!_global.isIosApp) return;
  if (path) {
    path = encodeURIComponent(path);
  } else {
    path = "";
  }
  setTimeout(function() {
    var iframe = document.createElement("IFRAME");
    iframe.setAttribute("src", scheme + "://" + path);
    iframe.setAttribute("style", "display:none");
    document.documentElement.appendChild(iframe);
    iframe.parentNode.removeChild(iframe);
    iframe = null;
  }, 0);
}

function safeCall(obj, fn) {
    if (!fn) return;
    var isHeadless = typeof window == "undefined";
    var debug = false || (!isHeadless && window.debug);
    if (isIE || isHeadless) {
        // just call through; onerror will be called and debugger will handle it
        if (typeof MSApp != "undefined") {
            if (obj) {
                MSApp.execUnsafeLocalFunction(function () { fn.call(obj); });
            } else {
                MSApp.execUnsafeLocalFunction(fn);
            }
        } else if (obj) {
            fn.call(obj);
        } else {
            fn.call();
        }
    } else {
        try {
            if (obj) {
                fn.call(obj);
            } else {
                fn.call();
            }
        } catch (e) {
            if (e.message) {
              window.onerror(e.message, e.fileName, e.lineNumber, e.stack);
            } else if (e.stack) {
              window.onerror(e.stack, e.fileName, e.lineNumber, e.stack);
            } else {
              window.onerror(toJson(e, '\n'));
            }

            if (window.console) {
              window.console.error(e);
              if (e.message) window.console.error("Message: " + e.message);
              if (e.stack) window.console.error("Stack: " + e.stack);
            }
            // Rethrow here so the debugger can handle it
            // On Firefox this causes a second prompt.  Meh!
            if (debug) throw e;
        }
    }
}

function safeCallback(callback) {
  return function() {
    safeCall(null, callback);
  };
}

function safeTimeout(fn, time) {
  setTimeout(function() {
    safeCall(null, fn);
  }, time);
}

function isDefined(x) {
    return "undefined" !== typeof x;
}

function jsonStringifyAscii(obj) {
  var stringified = JSON.stringify(obj, function replacer(key, value) {
    if (key == "scene") return undefined;
    return value;
  });
  var output = stringified.replace(/(.)/g, function(x) {
    var code = x.charCodeAt(0);
    if (code > 127 || code < 32) {
     var outCode = code.toString(16);
     switch (outCode.length) {
       case 4:
         return "\\u" + outCode;
       case 3:
         return "\\u0" + outCode;
       case 2:
         return "\\u00" + outCode;
       case 1:
         return "\\u000" + outCode;
       default:
         return x;
     }
    }
    return x;
  });
  return output;
}

function toJson(obj, standardized) {
 if (typeof JSON != "undefined" && JSON.stringify) {
  return jsonStringifyAscii(obj);
 }
 switch (typeof obj) {
  case 'object':
   if (obj) {
    var list = [];
    if (obj instanceof Array) {
     for (var i=0;i < obj.length;i++) {
      list.push(toJson(obj[i], standardized));
     }
     return '[' + list.join(',') + ']';
    } else {
     for (var prop in obj) {
      if (prop == "scene") continue;
      if (!standardized && /^[a-zA-Z][a-zA-Z_0-9]\w+$/.test(prop) && !/\b(abstract|boolean|break|byte|case|catch|char|class|comment|const|continue|debugger|default|delete|do|double|else|enum|export|extends|false|final|finally|float|for|function|goto|if|implements|import|in|instanceof|int|interface|label|long|native|new|null|package|private|protected|public|return|short|static|super|switch|synchronized|this|throws|transient|true|try|typeof|var|void|volatile|while|with)\b/.test(prop)) {
        list.push(prop + ':' + toJson(obj[prop], standardized));
      } else {
        list.push('"' + prop + '":' + toJson(obj[prop], standardized));
      }
     }
     return '{' + list.join(',') + '}';
    }
   } else {
    return 'null';
   }
   break;
  case 'string':
   var encoded = obj.replace(/(.)/g, function(x) {
     if (x == "'" || x == '"' || x == '\\') {
       return "\\" + x;
     }
     var code = x.charCodeAt(0);
     if (code > 127 || code < 32) {
       var outCode = code.toString(16);
       switch (outCode.length) {
         case 4:
           return "\\u" + outCode;
         case 3:
           return "\\u0" + outCode;
         case 2:
           return "\\u00" + outCode;
         case 1:
           return "\\u000" + outCode;
         default:
           return x;
       }
     }
     return x;
   });
   return '"' + encoded + '"';
  case 'number':
  case 'boolean':
   return String(obj);
  case 'function':
   return 'badfunction';
  case 'undefined':
    return 'undefined';
  default:
   throw new Error("invalid type: " + typeof obj);
 }
}

var loginUrlBase = "https://www.choiceofgames.com/api/";
function xhrAuthRequest(method, endpoint, callback) {
  var paramBuilder = new Array(arguments.length*3);
  for (var i = 3; i < arguments.length; i=i+2) {
    if (i > 3) paramBuilder.push("&");
    paramBuilder.push(arguments[i]);
    paramBuilder.push("=");
    paramBuilder.push(arguments[i+1]);
  }
  var params = paramBuilder.join("");
  var xhr = findXhr();
  if (method == "POST") {
    xhr.open(method, loginUrlBase + endpoint + ".php", true);
    xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
  } else {
    xhr.open(method, loginUrlBase + endpoint + ".php?" + params, true);
  }

  var done = false;

  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    var ok = xhr.status == 200;
    var response = {};
    try {
      if (xhr.responseText) response = JSON.parse(xhr.responseText);
    } catch (e) {
      ok = false;
    }
    if (!ok && !response.error) response.error = "unknown error";
    if (callback) safeCall(null, function() {callback(ok, response);});
  };
  xhr.send(params);
}

function login(email, password, register, subscribe, callback) {
  xhrAuthRequest("POST", "login", callback, "email", encodeURIComponent(email), "password", encodeURIComponent(password), "register", register, "subscribe", subscribe);
}

function forgotPassword(email, callback) {
  xhrAuthRequest("POST", "forgot", callback, "email", encodeURIComponent(email));
}

function logout(callback) {
  document.cookie = 'login=0;path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
  xhrAuthRequest("GET", "logout", callback);
  recordLogin(false);
  window.knownPurchases = null;
  if (typeof FB != "undefined" && FB.logout) FB.logout();
  if (typeof gapi != "undefined" && gapi.auth && gapi.auth.signOut) gapi.auth.signOut();
}

function recordLogin(registered, email, callback) {
  if (initStore()) {
    if (registered) recordEmail(email);
    window.store.set("login", registered, function() {safeCall(null, callback);});
    window.registered = registered;
  } else {
    safeTimeout(callback, 0);
  }
}

function getRemoteEmail(callback) {
  xhrAuthRequest("GET", "getuser", callback);
}

function saveCookie(callback, slot, stats, temps, lineNum, indent) {
    var value = computeCookie(stats, temps, lineNum, indent);
    return writeCookie(value, slot, callback);
}

function computeCookie(stats, temps, lineNum, indent) {
  var scene = stats.scene;
  delete stats.scene;
  if (scene) stats.sceneName = scene.name;
  var version = "UNKNOWN";
  if (typeof(window) != "undefined" && window && window.version) version = window.version;
  var value = toJson({version:version, stats:stats, temps:temps, lineNum: lineNum, indent: indent});
  stats.scene = scene;
  return value;
}

function writeCookie(value, slot, callback) {
  if (!window.pseudoSave) window.pseudoSave = {};
  if (!slot) {
    slot = "";
  }
  window.pseudoSave[slot] = value;
  if (!initStore()) {
    if (callback) safeTimeout(callback, 0);
    return;
  }
  window.store.set("state"+slot, value, safeCallback(callback));
}

function clearCookie(callback, slot) {
    writeCookie('', slot, safeCallback(callback));
}

function areSaveSlotsSupported() {
  return !!(initStore() && window.Persist.type != "cookie");
}

function recordSave(slot, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (saveList) {
    saveList.push(slot);
    window.store.set("save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordDirtySlots(slots, callback) {
  if (!areSaveSlotsSupported()) {
    safeTimeout(callback, 0);
    return;
  }
  restoreObject(initStore(), "dirty_save_list", [], function (saveList) {
    saveSet = {};
    for (var i = 0; i < saveList.length; i++) {
      saveSet[saveList[i]] = 1;
    }
    for (i = 0; i < slots.length; i++) {
      if (!saveSet[slots[i]]) saveList.push(slots[i]);
    }
    window.store.set("dirty_save_list", toJson(saveList), safeCallback(callback));
  });
}

function recordEmail(email, callback) {
  if (initStore()) {
    window.store.set("email", email, safeCallback(callback));
  } else {
    safeTimeout(callback, 0);
  }
}

function fetchEmail(callback) {
  if (!initStore()) {
    safeTimeout(function(){callback("");}, 0);
    return;
  }
  // For some reason, this get seems to not respond sometimes
  // adding a fallback timeout
  window.store.get("email", function(ok, value) {
    safeCall(null, function() {
      if (!callback) return;
      var temp = callback;
      callback = null;
      if (ok && value) {
        temp(value);
      } else {
        temp("");
      }
    });
  });
  safeTimeout(function() {
    if (!callback) return;
    var temp = callback;
    callback = null;
    temp("");
  }, 1000);
}

function restoreObject(store, key, defaultValue, callback) {
  if (!store) {
    safeTimeout(function() {callback(defaultValue);}, 0);
    return;
  }
  store.get(key, function(ok, value) {
    var result = defaultValue;
    if (ok && value) {
      try{
        result = jsonParse(value);
      } catch (e) {}
    }
    safeCall(null, function() {callback(result);});
  });
}

function getDirtySaveList(callback) {
  restoreObject(initStore(), "dirty_save_list", [], function (slotList) {
    callback(slotList);
  });
}

function remoteSaveMerger(i, callback) {
  var remoteStore = new Persist.Store(window.remoteStoreNames[i]);
  restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
    fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
      mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, function() {
        i++;
        if (i < window.remoteStoreNames.length) {
          remoteSaveMerger(i, callback);
        } else {
          callback.apply(null, arguments);
        }
      });
    });
  });
}

function getSaves(callback) {
  if (window.remoteStoreNames && window.remoteStoreNames.length) {
    remoteSaveMerger(0, callback);
  } else if (window.remoteStoreName && window.storeName != window.remoteStoreName) {
    var remoteStore = new Persist.Store(window.remoteStoreName);
    restoreObject(remoteStore, "save_list", [], function (remoteSlotList) {
      fetchSavesFromSlotList(remoteStore, remoteSlotList, 0, [], function(remoteSaveList) {
        mergeRemoteSaves(remoteSaveList, 0/*recordDirty*/, callback);
      });
    });
  } else {
    restoreObject(initStore(), "save_list", [], function (localSlotList) {
      fetchSavesFromSlotList(initStore(), localSlotList, 0, [], callback);
    });
  }
}

function fetchSavesFromSlotList(store, slotList, i, saveList, callback) {
  if (i >= slotList.length) {
    return safeCall(null, function() {callback(saveList);});
  }
  restoreObject(store, "state"+slotList[i], null, function(saveState) {
    if (saveState) {
      saveState.timestamp = slotList[i].substring(4/*"save".length*/);
      saveList.push(saveState);
    }
    fetchSavesFromSlotList(store, slotList, i+1, saveList, callback);
  });
}

function isWebSavePossible() {
  if (!initStore()) return false;
  if (/^http/.test(window.location.protocol)) {
    return document.domain == window.webSaveDomain || document.domain == "localhost";
  }
  // if it's a file URL with a valid store, either you're a 3rd party developer
  // who knows what you're doing, or you're a mobile app
  return true;
}


webSaveDomain = "www.choiceofgames.com";
webSaveUrl = "https://" + webSaveDomain + "/ajax_proxy.php/websave";

function submitRemoteSave(slot, email, subscribe, callback) {
  if (!isWebSavePossible()) return safeTimeout(function() { callback(false); });
  window.store.get("state"+slot, function(ok, value) {
    if (ok) {
      var timestamp = slot.substring(4/*"save".length*/);
      var xhr = findXhr();
      var gameName = window.remoteStoreName || window.storeName;
      var params = "email="+email+"&game="+gameName+"&realGame="+window.storeName+"&json="+encodeURIComponent(value)+"&timestamp="+ timestamp+"&subscribe="+subscribe;
      xhr.open("POST", webSaveUrl,true);
      xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
      var done = false;

      xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        var ok = xhr.status == 200;
        if (ok) {
          safeCall(null, function() {callback(true);});
        } else {
          recordDirtySlots([slot], function() {
            safeCall(null, function() {callback(false);});
          });
        }
      };
      xhr.send(params);
    } else {
      recordDirtySlots([slot], function() {
        asyncAlert("There was a problem uploading the saved game. This is probably a bug; please contact support@choiceofgames.com with code 17891.", function() {
          safeCall(null, function() {callback(false);});
        });
      });
    }
  });
}

function submitDirtySaves(dirtySaveList, email, callback) {
  function submitDirtySave(i) {
    if (dirtySaveList[i]) {
      submitRemoteSave(dirtySaveList[i], email, false, function(ok) {
        if (ok) {
          submitDirtySave(i+1);
        } else {
          safeCall(null, function() {callback(false);});
        }
      });
    } else {
      window.store.remove("dirty_save_list", function() {
        safeCall(null, function() {callback(true);});
      });
    }
  }
  submitDirtySave(0);
}

function submitAnyDirtySaves(callback) {
  if (!callback) callback = function(ok) {};
  try {
    getDirtySaveList(function(dirtySaveList) {
      if (dirtySaveList && dirtySaveList.length) {
        try {
          fetchEmail(function(email) {
            if (email) {
              submitDirtySaves(dirtySaveList, email, callback);
            } else {
              callback(false);
            }
          });
        } catch (e) {
          callback(false);
        }
      }
    });
  } catch (e) {
    callback(false);
  }
}

function getRemoteSaves(email, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() {callback([]);}, 0);
    return;
  }
  var xhr = findXhr();
  var gameName = window.remoteStoreName || window.storeName;
  xhr.open("GET", webSaveUrl + "?email="+email+"&game="+gameName, true);
  var done = false;
  xhr.onreadystatechange = function() {
    if (done) return;
    if (xhr.readyState != 4) return;
    done = true;
    if (xhr.status != 200) {
      if (window.console) console.log("Couldn't load remote saves. " + xhr.status + ": " + xhr.responseText);
      safeCall(null, function() {callback(null);});
    } else {
      var result = xhr.responseText;
      result = jsonParse(result);
      var remoteSaveList = [];
      for (var i = 0; i < result.length; i++) {
        var save = result[i].json;
        save.timestamp = result[i].timestamp;
        remoteSaveList.push(save);
      }
      safeCall(null, function() {callback(remoteSaveList);});
    }
  };
  xhr.send();
}

function mergeRemoteSaves(remoteSaveList, recordDirty, callback) {
  if (!isWebSavePossible()) {
    safeTimeout(function() { callback([], 0, []); }, 0);
    return;
  }
  restoreObject(initStore(), "save_list", [], function (localSlotList) {
    fetchSavesFromSlotList(initStore(), localSlotList, 0, [], function(localSaveList) {
      var localSlotMap = {};
      for (var i = 0; i < localSlotList.length; i++) {
        localSlotMap[localSlotList[i]] = 1;
      }
      var remoteSlotMap = {};
      for (i = 0; i < remoteSaveList.length; i++) {
        remoteSlotMap["save"+remoteSaveList[i].timestamp] = 1;
      }
      var newRemoteSaves = 0;
      for (i = 0; i < remoteSaveList.length; i++) {
        var remoteSave = remoteSaveList[i];
        var slot = "save"+remoteSave.timestamp;
        if (!localSlotMap[slot]) {
          saveCookie(null, slot, remoteSave.stats, remoteSave.temps, remoteSave.lineNum, remoteSave.indent);
          localSlotList.push(slot);
          localSaveList.push(remoteSave);
          newRemoteSaves++;
        }
      }

      var dirtySaveList = [];
      for (i = 0; i < localSlotList.length; i++) {
        if (!remoteSlotMap[localSlotList[i]]) {
          dirtySaveList.push(localSlotList[i]);
        }
      }

      if (recordDirty) {
        window.store.set("dirty_save_list", toJson(dirtySaveList), finale);
      } else {
        finale();
      }

      function finale() {
        if (newRemoteSaves) {
          window.store.set("save_list", toJson(localSlotList), function() {
            safeCall(null, function() { callback(localSaveList, newRemoteSaves, dirtySaveList); });
          });
        } else {
          safeCall(null, function() {callback(localSaveList, newRemoteSaves, dirtySaveList);});
        }
      }
    });
  });
}

function delayBreakStart(callback) {
  var nowInSeconds = Math.floor(new Date().getTime() / 1000);
  if (!initStore()) {
    safeTimeout(function() {callback(nowInSeconds);}, 0);
    return;
  }
  window.store.get("delayBreakStart", function(ok, value) {
    var valueNum = value*1;
    safeCall(null, function() {
      if (ok && value && !isNaN(valueNum)) {
        callback(valueNum);
      } else {
        window.store.set("delayBreakStart", nowInSeconds);
        callback(nowInSeconds);
      }
    });
  });
}

function delayBreakEnd() {
  if (initStore()) window.store.remove("delayBreakStart");
}

function initStore() {
  if (!window.storeName) return false;
  if (window.store) return window.store;
  try {
    window.store = new Persist.Store(window.storeName);
  } catch (e) {}
  return window.store;
}
function loadAndRestoreGame(slot, forcedScene) {
  function valueLoaded(ok, value) {
    safeCall(null, function() {
      var state = null;
      if (ok && value && ""+value) {
        state = jsonParse(value);
      } else if (window.Persist.type == "androidStorage" && document.cookie) {
        return upgradeAndroidCookies(slot,forcedScene);
      }
      restoreGame(state, forcedScene);
    });
  }
  if (!slot) slot = "";
  if (window.pseudoSave && pseudoSave[""]) return valueLoaded(true, pseudoSave[""]);
  if (!initStore()) return restoreGame(null, forcedScene);
  window.store.get("state"+slot, valueLoaded);
}

// we used to use cookies on some Android devices; now we use androidStorage
function upgradeAndroidCookies(slot, forcedScene) {
  var ck = document.cookie;
  var components = ck.split("; ");
  function upgradeComponent(i) {
    if (!components[i]) {
      loadAndRestoreGame(slot, forcedScene);
      return;
    }
    var parts = components[i].split("=");
    var key = parts[0];
    var deletion = key + "=x; path=/; domain=localhost; expires=Thu, 01-Jan-1970 00:00:01 GMT";
    document.cookie = deletion;
    // key is in the format "storeName:actualKey"
    key = unescape(key).substring(window.storeName.length + 1);
    var value = unescape(parts[1]);
    window.store.set(key, value, function() {
      upgradeComponent(i+1);
    });
  }
  safeCall(this, function() {upgradeComponent(0);});
}

function isStateValid(state) {
  if (!state) return false;
  if (!state.stats) return false;
  if (!state.stats.sceneName) return false;
  return true;
}

function restartGame(shouldPrompt) {
  if (window.tickerRunning) {
    asyncAlert("Please wait until the timer has run out.");
    return;
  }
  function actuallyRestart(result) {
    if (!result) return;
    submitAnyDirtySaves();
    clearCookie(function() {}, 'temp');
    clearCookie(function() {
      window.nav.resetStats(window.stats);
      clearScreen(restoreGame);
    }, "");
  }
  if (shouldPrompt) {
    asyncConfirm("Start over from the beginning?", actuallyRestart);
  } else {
    actuallyRestart(true);
  }
}

function restoreGame(state, forcedScene, userRestored) {
    var scene;
    var secondaryMode = null;
    var saveSlot = "";
    var forcedSceneLabel = null;
    if (/\|/.test(forcedScene)) {
      var parts = forcedScene.split("|");
      forcedScene = parts[0];
      forcedSceneLabel = parts[1];
    }
    if (forcedScene == "choicescript_stats") {
      secondaryMode = "stats";
      saveSlot = "temp";
    } else if (forcedScene == "choicescript_upgrade") {
      secondaryMode = "upgrade";
      saveSlot = "temp";
    }
    if (!isStateValid(state)) {
        var startupScene = forcedScene ? forcedScene : window.nav.getStartupScene();
        scene = new Scene(startupScene, window.stats, window.nav, {debugMode:window.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
    } else {
      if (forcedScene) state.stats.sceneName = forcedScene;
      window.stats = state.stats;
      // Someday, inflate the navigator using the state object
      scene = new Scene(state.stats.sceneName, state.stats, window.nav, {debugMode:state.debug || window.debug, secondaryMode:secondaryMode, saveSlot:saveSlot});
      if (!forcedScene) {
        scene.temps = state.temps;
        scene.lineNum = state.lineNum;
        scene.indent = state.indent;
      }
      if (userRestored) {
        scene.temps.choice_user_restored = true;
      }
    }
    if (forcedSceneLabel !== null) {
      scene.targetLabel = {label:forcedSceneLabel, origin:"url", originLine:0}
    }
    safeCall(scene, scene.execute);
}

function redirectScene(sceneName, label, originLine) {
  var scene = new Scene(sceneName, window.stats, window.nav, {debugMode:window.debug});
  if (label) scene.targetLabel = {label:label, origin:"choicescript_stats", originLine:originLine};
  clearScreen(function() {scene.execute();});
}

tempStatWrites = {};

function transferTempStatWrites() {
  if (!_global.isIosApp) return;
  callIos("transferwrites", JSON.stringify(tempStatWrites));
}

function getCookieByName(cookieName, ck) {
    if (!ck) ck = window.document.cookie;
    if (!ck) return null;
    var ckPairs = ck.split(/;/);
    for (var i = 0; i < ckPairs.length; i++) {
        var ckPair = trim(ckPairs[i]);
        var ckNameValue = ckPair.split(/=/);
        var ckName = decodeURIComponent(ckNameValue[0]);
        if (ckName === cookieName) {
            return decodeURIComponent(ckNameValue[1]);
        }
    }
    return null;
}

function parseQueryString(str) {
  if (!str) return null;
  var map = {};
  var pairs = String(str).substring(1).split("&");
  var i = pairs.length;
  while (i--) {
    var pair = pairs[i];
    var parts = pair.split("=");
    map[parts[0]] = parts[1];
  }
  return map;
}
function trim(str) {
    if (str === null || str === undefined) return null;
    var result = str.replace(/^\s+/g, "");
    // strip leading
    return result.replace(/\s+$/g, "");
    // strip trailing
}


function findOptimalDomain(docDomain) {
    if (!docDomain) docDomain = document.domain;
    // localhost and 127.0.0.1 will cause cookie not to be set; just omit them, it works fine
    if (docDomain == "localhost" || docDomain == "127.0.0.1") return null;
    // ip address
    if (/^\d+\.\d+\.\d+\.\d+$/.test(docDomain)) return null;
    // dotcom
    var result = docDomain.match(/(\w+\.\w{3}$)/);
    if (result) return result[1];
    return null;
}

function num(x, line) {
    if (!line) line = "UNKNOWN";
    var x_num = x * 1;
    if (isNaN(x_num)) throw new Error("line "+line+": Not a number: " + x);
    return x_num;
}

function bool(x, line) {
  if (!line) line = "UNKNOWN";
  if ("boolean" == typeof x) {
    return x;
  } else if ("true" === x) {
    return true;
  } else if ("false" === x) {
    return false;
  }
  throw new Error("line "+line+": Neither true nor false: " + x);
}

function findXhr() {
  var ieFile = isIE && isFile;
  if (window.XMLHttpRequest && !ieFile) return new window.XMLHttpRequest();
  var ids = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'];
  for (var i = 0; i < 3; i++) {
    try {
      return new ActiveXObject(ids[i]);
    } catch (e) {}
  }
  throw new Error("Couldn't create XHR object");
}

    crcTable = "00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D";

    /* Number */
    function crc32( /* String */ str, /* Number */ crc ) {
        if( !crc ) crc = 0;
        var n = 0; //a number between 0 and 255 
        var x = 0; //an hex number 

        crc = crc ^ (-1);
        for( var i = 0, iTop = str.length; i < iTop; i++ ) {
            n = ( crc ^ str.charCodeAt( i ) ) & 0xFF;
            x = "0x" + crcTable.substr( n * 9, 8 );
            crc = ( crc >>> 8 ) ^ x;
        }
        return crc ^ (-1);
    }

function simpleDateTimeFormat(date) {
  var day = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"][date.getDay()];
  var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][date.getMonth()];
  var minutes = date.getMinutes();
  if (minutes < 10) minutes = "0" + (""+minutes);
  return day + " " + month + " " + date.getDate() + " " + date.getHours() + ":" + minutes;
}

function jsonParse(str) {
  if (typeof JSON != "undefined") {
    try {
      return JSON.parse(str);
    } catch (e) {
      // try to handle unquoted keys
      try {
        return eval('('+str+')');
      } catch (e2) {
        // that might have failed because eval is forbidden
        try {
          eval("1");
        } catch (e3) {
          // eval forbidden; let's try a hack to fix unquoted keys
          var str2 = (str+"").replace(/([,\{])\s*(\w+)\s*\:/g, '$1"$2":');
          try {
            return JSON.parse(str2);
          } catch (e4) {}
        }
        // at this point, just report a clear error
        return JSON.parse(str);
      }
    }
  } else {
    return eval('('+str+')');
  }
}

function cefQuerySimple(method) {
  cefQuery({
    request:method,
    onSuccess: function(response) {console.log(method + " success");},
    onFailure: function(error_code, error_message) {console.error(method + " error: " + error_message);}
  });
}

shortMonthStrings = [null, "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse
// "Given a date string of "March 7, 2014", parse() assumes a local time zone, but given an
// ISO format such as "2014-03-07" it will assume a time zone of UTC for ES5 or local for
// ECMAScript 2015."
function parseDateStringInCurrentTimezone(YYYY_MM_DD, line) {
  var result = /^(\d{4})-(\d{2})-(\d{2})$/.exec(YYYY_MM_DD);
  if (!result) throw new Error("line "+line+": invalid date string " + YYYY_MM_DD);
  var fullYear = result[1];
  var oneBasedMonthNumber = parseInt(result[2],10);
  var dayOfMonth = parseInt(result[3],10);
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  return new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear);
}
/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */


function printx(msg, parent) {
    if (msg === null || msg === undefined || msg === "") return;
    if (!parent) parent = document.getElementById('text');
    if (msg == " ") {
      // IE7 doesn't like innerHTML that's nothing but " "
      parent.appendChild(document.createTextNode(" "));
      return;
    }
    msg = (msg+"").replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/\[n\/\]/g, '<br>')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>');
    var frag = document.createDocumentFragment();
    temp = document.createElement('div');
    temp.innerHTML = msg;
    while (temp.firstChild) {
        frag.appendChild(temp.firstChild);
    }
    parent.appendChild(frag);
}

function println(msg, parent) {
    if (!parent) parent = document.getElementById('text');
    printx(msg, parent);
    var br = window.document.createElement("br");
    parent.appendChild(br);
}


function showStats() {
    if (document.getElementById('loading')) return;
    var button = document.getElementById("statsButton");
    if (button && button.innerHTML == "Return to the Game") {
      setButtonTitles();
      return clearScreen(loadAndRestoreGame);
    }
    setButtonTitles();
    var currentScene = window.stats.scene;
    var scene = new Scene("choicescript_stats", window.stats, this.nav, {secondaryMode:"stats", saveSlot:"temp"});
    main.innerHTML = "<div id='text'></div>";
    scene.execute();
}

function redirectFromStats(scene, label, originLine, callback) {
  if (window.isIosApp) {
    if (!label) label = "";
    callIos("redirectfromstats", scene + " " +label  + " " + originLine);
  } else if (window.isAndroidApp) {
    statsMode.redirectFromStats(scene, label || "", originLine);
  } else {
    safeTimeout(callback, 0);
  }
}

function showAchievements(hideNextButton) {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("achievementsButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    setButtonTitles();
    return clearScreen(loadAndRestoreGame);
  }
  setButtonTitles();
  button.innerHTML = "Return to the Game";
  clearScreen(function() {
    checkAchievements(function() {
      printAchievements(document.getElementById("text"));
      if (!hideNextButton) printButton("Next", main, false, function() {
        setButtonTitles();
        clearScreen(loadAndRestoreGame);
      });
    });
  });
}

function showMenu() {
  if (document.getElementById('loading')) return;
  var button = document.getElementById("menuButton");
  if (!button) return;
  if (button.innerHTML == "Return to the Game") {
    button.innerHTML = "Menu";
    return clearScreen(loadAndRestoreGame);
  }
  setButtonTitles();
  button.innerHTML = "Return to the Game";
  function menu() {
    options = [
      {name:"Return to the game.", group:"choice", resume:true},
      {name:"View the credits.", group:"choice", credits:true},
      {name:"Play more games like this.", group:"choice", moreGames:true},
      {name:"Email us at " + getSupportEmail() + ".", group:"choice", contactUs:true},
      {name:"Share this game with friends.", group:"choice", share:true},
      {name:"Email me when new games are available.", group:"choice", subscribe:true},
    ];
    printOptions([""], options, function(option) {
      if (option.resume) {
        setButtonTitles();
        return clearScreen(loadAndRestoreGame);
      } else if (option.credits) {
        absolutizeAboutLink();
        aboutClick();
      } else if (option.moreGames) {
        moreGames();
        curl();
      } else if (option.share) {
        clearScreen(function() {
          printShareLinks(document.getElementById("text"), "now");
          menu();
        });
      } else if (option.subscribe) {
        setButtonTitles();
        subscribeLink();
      } else if (option.contactUs) {
        window.location.href="mailto:"+getSupportEmail();
      }
    });
  }
  clearScreen(menu);
}

function setButtonTitles() {
  var button;
  button = document.getElementById("menuButton");
  if (button) {
    button.innerHTML = "Menu";
  }
  button = document.getElementById("statsButton");
  if (button) {
    button.innerHTML = "Show Stats";
  }
  button = document.getElementById("achievementsButton");
  if (button) {
    if (nav.achievementList.length) {
      button.style.display = "";
      button.innerHTML = "Achievements";
    } else {
      button.style.display = "none";
    }
  }

}


function spell(num) {
  if (num > 99) return num;
  var smallNumbers = ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
  var tens = ["zero", "ten", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];
  if (num < 20) {
    return smallNumbers[num];
  }
  var onesDigit = num % 10;
  if (onesDigit === 0) {
    return tens[num / 10];
  }
  var tensDigit = (num - onesDigit) / 10;
  return tens[tensDigit]+"-"+smallNumbers[onesDigit];
}

function printAchievements(target) {
  var unlockedBuffer = [];
  var lockedBuffer = [];
  var achievedCount = 0, hiddenCount = 0, score = 0, totalScore = 0;
  var totalAchievements = nav.achievementList.length;
  var buffer;
  for (var i = 0; i < totalAchievements; i++) {
    var name = nav.achievementList[i];
    var achievement = nav.achievements[name];
    var points = achievement.points;
    totalScore += points;

    var description;

    if (nav.achieved[name]) {
      achievedCount++;
      score += points;
      buffer = unlockedBuffer;
      description = achievement.earnedDescription;
    } else {
      if (achievement.visible) {
        buffer = lockedBuffer;
        description = achievement.preEarnedDescription;
      } else {
        hiddenCount++;
        continue;
      }
    }

    if (buffer.length) buffer.push("<br>");
    buffer.push("<b>");
    buffer.push(achievement.title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'));
    buffer.push(":");
    buffer.push("</b> ");
    buffer.push(description.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/\[b\]/g, '<b>')
      .replace(/\[\/b\]/g, '</b>')
      .replace(/\[i\]/g, '<i>')
      .replace(/\[\/i\]/g, '</i>')
    );
    buffer.push(" (");
    buffer.push(points);
    buffer.push(" points)");
  }

  // What if there's exactly one achievement worth exactly one point?
  if (achievedCount === 0) {
    if (hiddenCount === 0) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements, worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == 1) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including one hidden achievement), worth a total of "+totalScore+" points.<p>"];
    } else if (hiddenCount == totalAchievements) {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" hidden achievements, worth a total of "+totalScore+" points.<p>"];
    } else {
      buffer = ["You haven't unlocked any achievements yet. There are "+spell(totalAchievements)+" possible achievements (including "+spell(hiddenCount)+" hidden achievements), worth a total of "+totalScore+" points.<p>"];
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  } else if (score == totalScore) {
    if (totalAchievements == 2) {
      buffer = ["Congratulations! You have unlocked both achievements, earning a total of "+score+" points, a perfect score.<p>"];
    } else {
      buffer = ["Congratulations! You have unlocked all "+spell(totalAchievements)+" achievements, earning a total of "+score+" points, a perfect score.<p>"];
    }
    buffer.push.apply(buffer, unlockedBuffer);
    buffer.push("<p>");
  } else {
    buffer = ["You have unlocked "+spell(achievedCount)+" out of "+spell(totalAchievements)+" possible achievements, earning you a score of "+score+" out of a possible "+totalScore+" points.<p>"];
    buffer.push.apply(buffer, unlockedBuffer);
    var remaining = totalAchievements-achievedCount;
    if (remaining == hiddenCount) {
      if (remaining == 1) {
        buffer.push("<p>There is still one hidden achievement remaining.<p>");
      } else {
        buffer.push("<p>There are still " + spell(remaining) + " hidden achievements remaining.<p>");
      }
    } else if (hiddenCount > 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including "+spell(hiddenCount)+" hidden achievements.<p>");
    } else if (hiddenCount == 1) {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining, including one hidden achievement.<p>");
    } else if (remaining == 1) {
      buffer.push("<p>There is still one achievement remaining.<p>");
    } else {
      buffer.push("<p>There are still "+spell(remaining)+" achievements remaining.<p>");
    }
    if (lockedBuffer.length) {
      buffer.push.apply(buffer, lockedBuffer);
      buffer.push("<p>");
    }
  }

  target.innerHTML = buffer.join("");
}

// in the iOS app, display a page curl animation
function curl() {
  // TODO force a reflow before curling the page
  callIos("curl");
}

function asyncAlert(message, callback) {
  if (!callback) callback = function(){};
  if (window.isIosApp) {
    window.alertCallback = callback;
    callIos("alert", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      alert(message);
      if (callback) callback();
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      window.external.Alert(message);
      if (callback) callback();
    }, 0);
  } else {
    alertify.alert(message, function() {safeCall(null, callback);});
  }
}

function asyncConfirm(message, callback) {
  if (false/*window.isIosApp*/) {
    // TODO asyncConfirm
    window.confirmCallback = callback;
    callIos("confirm", message);
  } else if (window.isAndroidApp) {
    setTimeout(function() {
      var result = confirm(message);
      if (callback) callback(result);
    }, 0);
  } else if (window.isWinOldApp) {
    setTimeout(function() {
      var result = window.external.Confirm(message);
      if (callback) callback(result);
    }, 0);
  } else {
    alertify.confirm(message, function(result) {safeCall(null, callback(result));});
  }
}


function clearScreen(code) {
    // can't create div via innerHTML; div mysteriously doesn't show up on iOS
    main.innerHTML = "";
    var text = document.createElement("div");
    text.setAttribute("id", "text");
    main.appendChild(text);



    var useAjax = true;
    if (isWeb && window.noAjax) {
      useAjax = false;
    }

    if (useAjax) {
      doneLoading();
      setTimeout(function() {
        if (window.isChromeApp) {
          document.body.firstElementChild.scrollIntoView();
        } else {
          window.scrollTo(0,0);
          if (window.isIosApp || (window.isSafari && window.isMobile && !window.isAndroid)) {
            // focus on text for iOS Voiceover
            main.setAttribute("tabindex", "-1");
            main.focus();
          }
        }
      }, 0);
      safeCall(null, code);
    } else {
      if (!initStore()) alert("Your browser has disabled cookies; this game requires cookies to work properly.  Please re-enable cookies and refresh this page to continue.");
      startLoading();
      var form = window.document.createElement("form");
      var axn = window.location.protocol + "//" + window.location.host + window.location.pathname;
      form.setAttribute("action", axn);
      form.setAttribute("method", "POST");
      main.appendChild(form);
      form.submit();
    }
}

function safeSubmit(code) {
    return function safelySubmitted() {
        safeCall(code);
        return false;
    };
}

function startLoading() {
    var loading = document.getElementById('loading');
    if (!loading) {
      safeCall(null, function() {
        loading = document.createElement('div');
        loading.setAttribute("id", "loading");
        loading.innerHTML = "<p>Loading...</p><p>"+
          (/MSIE [67]/.test(navigator.userAgent)?"":"<img src=\"data:image/gif;base64,R0lGODlhgAAPAPEAAPf08WJhYMvJx2JhYCH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAgAAPAAACo5QvoIC33NKKUtF3Z8RbN/55CEiNonMaJGp1bfiaMQvBtXzTpZuradUDZmY+opA3DK6KwaQTCbU9pVHc1LrDUrfarq765Ya9u+VRzLyO12lwG10yy39zY11Jz9t/6jf5/HfXB8hGWKaHt6eYyDgo6BaH6CgJ+QhnmWWoiVnI6ddJmbkZGkgKujhplNpYafr5OooqGst66Uq7OpjbKmvbW/p7UAAAIfkECQoAAAAsAAAAAIAADwAAArCcP6Ag7bLYa3HSZSG2le/Zgd8TkqODHKWzXkrWaq83i7V5s6cr2f2TMsSGO9lPl+PBisSkcekMJphUZ/OopGGfWug2Jr16x92yj3w247bh6teNXseRbyvc0rbr6/x5Ng0op4YSJDb4JxhI58eliEiYYujYmFi5eEh5OZnXhylp+RiaKQpWeDf5qQk6yprawMno2nq6KlsaSauqS5rLu8cI69k7+ytcvGl6XDtsyzxcAAAh+QQJCgAAACwAAAAAgAAPAAACvpw/oIC3IKIUb8pq6cpacWyBk3htGRk1xqMmZviOcemdc4R2kF3DvfyTtFiqnPGm+yCPQdzy2RQMF9Moc+fDArU0rtMK9SYzVUYxrASrxdc0G00+K8ruOu+9tmf1W06ZfsfXJfiFZ0g4ZvEndxjouPfYFzk4mcIICJkpqUnJWYiYs9jQVpm4edqJ+lkqikDqaZoquwr7OtHqAFerqxpL2xt6yQjKO+t7bGuMu1L8a5zsHI2MtOySVwo9fb0bVQAAIfkECQoAAAAsAAAAAIAADwAAAsucP6CAt9zSErSKZyvOd/KdgZaoeaFpRZKiPi1aKlwnfzBF4jcNzDk/e7EiLuLuhzwqayfmaNnjCCGNYhXqw9qcsWjT++TqxIKp2UhOprXf7PoNrpyvQ3p8fAdu82o+O5w3h2A1+Nfl5geHuLgXhEZVWBeZSMnY1oh5qZnyKOhgiGcJKHqYOSrVmWpHGmpauvl6CkvhaUD4qejaOqvH2+doV7tSqdsrexybvMsZrDrJaqwcvSz9i9qM/Vxs7Qs6/S18a+vNjUx9/v1TAAAh+QQJCgAAACwAAAAAgAAPAAAC0Zw/oIC33NKKUomLxct4c718oPV5nJmhGPWwU9TCYTmfdXp3+aXy+wgQuRRDSCN2/PWAoqVTCSVxilQZ0RqkSXFbXdf3ZWqztnA1eUUbEc9wm8yFe+VguniKPbNf6mbU/ubn9ieUZ6hWJAhIOKbo2Pih58C3l1a5OJiJuflYZidpgHSZCOnZGXc6l3oBWrE2aQnLWYpKq2pbV4h4OIq1eldrigt8i7d73Ns3HLjMKGycHC1L+hxsXXydO9wqOu3brPnLXL3C640sK+6cTaxNflEAACH5BAkKAAAALAAAAACAAA8AAALVnD+ggLfc0opS0SeyFnjn7oGbqJHf4mXXFD2r1bKNyaEpjduhPvLaC5nJEK4YTKhI1ZI334m5g/akJacAiDUGiUOHNUd9ApTgcTN81WaRW++Riy6Tv/S4dQ1vG4ps4NwOaBYlOEVYhYbnplexyJf3ZygGOXkWuWSZuNel+aboV0k5GFo4+qN22of6CMoq2kr6apo6m5fJWCoZm+vKu2Hr6KmqiHtJLKebRhuszNlYZ3ncewh9J9z8u3mLHA0rvetrzYjd2Wz8bB6oNO5MLq6FTp2+bVUAACH5BAkKAAAALAAAAACAAA8AAALanD+ggLfc0opS0XeX2Fy8zn2gp40ieHaZFWHt9LKNO5eo3aUhvisj6RutIDUZgnaEFYnJ4M2Z4210UykQ8BtqY0yHstk1UK+/sdk63i7VYLYX2sOa0HR41S5wi7/vcMWP1FdWJ/dUGIWXxqX3xxi4l0g4GEl5yOHIBwmY2cg1aXkHSjZXmbV4uoba5kkqelbaapo6u0rbN/SZG7trKFv7e6savKTby4voaoVpNAysiXscV4w8fSn8fN1pq1kd2j1qDLK8yYy9/ff9mgwrnv2o7QwvGO1ND049UgAAIfkECQoAAAAsAAAAAIAADwAAAticP6CAt9zSilLRd2d8onvBfV0okp/pZdamNRi7ui3yyoo4Ljio42h+w6kgNiJt5kAaasdYE7D78YKlXpX6GWphxqTT210qK1Cf9XT2SKXbYvv5Bg+jaWD5ekdjU9y4+PsXRuZHRrdnZ5inVidAyCTXF+nGlVhpdjil2OE49hjICVh4qZlpibcDKug5KAlHOWqqR8rWCjl564oLFruIucaYGlz7+XoKe2wsIqxLzMxaxIuILIs6/JyLbZsdGF063Uu6vH2tXc79LZ1MLWS96t4JH/rryzhPWgAAIfkECQoAAAAsAAAAAIAADwAAAtWcP6CAt9zSilLRd2fEe4kPCk8IjqTonZnVsQ33arGLwLV8Kyeqnyb5C60gM2LO6MAlaUukwdbcBUspYFXYcla00KfSywRzv1vpldqzprHFoTv7bsOz5jUaUMer5vL+Mf7Hd5RH6HP2AdiUKLa41Tj1Acmjp0bJFuinKKiZyUhnaBd5OLnzSNbluOnZWQZqeVdIYhqWyop6ezoquTs6O0aLC5wrHErqGnvJibms3LzKLIYMe7xnO/yL7TskLVosqa1aCy3u3FrJbSwbHpy9fr1NfR4fUgAAIfkECQoAAAAsAAAAAIAADwAAAsqcP6CAt9zSilLRd2fEW7cnhKIAjmFpZla3fh7CuS38OrUR04p5Ljzp46kgMqLOaJslkbhbhfkc/lAjqmiIZUFzy2zRe5wGTdYQuKs9N5XrrZPbFu94ZYE6ms5/9cd7/T824vdGyIa3h9inJQfA+DNoCHeomIhWGUcXKFIH6RZZ6Bna6Zg5l8JnSamayto2WtoI+4jqSjvZelt7+URKpmlmKykM2vnqa1r1axdMzPz5LLooO326Owxd7Bzam4x8pZ1t3Szu3VMOdF4AACH5BAkKAAAALAAAAACAAA8AAAK/nD+ggLfc0opS0XdnxFs3/i3CSApPSWZWt4YtAsKe/DqzXRsxDqDj6VNBXENakSdMso66WzNX6fmAKCXRasQil9onM+oziYLc8tWcRW/PbGOYWupG5Tsv3TlXe9/jqj7ftpYWaPdXBzbVF2eId+jYCAn1KKlIApfCSKn5NckZ6bnJpxB2t1kKinoqJCrlRwg4GCs4W/jayUqamaqryruES2b72StsqgvsKlurDEvbvOx8mzgazNxJbD18PN1aUgAAIfkECQoAAAAsAAAAAIAADwAAArKcP6CAt9zSilLRd2fEWzf+ecgjlKaQWZ0asqPowAb4urE9yxXUAqeZ4tWEN2IOtwsqV8YkM/grLXvTYbV4PTZpWGYU9QxTxVZyd4wu975ZZ/qsjsPn2jYpatdx62b+2y8HWMTW5xZoSIcouKjYePeTh7TnqFcpabmFSfhHeemZ+RkJOrp5OHmKKapa+Hiyyokaypo6q1CaGDv6akoLu3DLmLuL28v7CdypW6vsK9vsE1UAACH5BAkKAAAALAAAAACAAA8AAAKjnD+ggLfc0opS0XdnxFs3/nkISI2icxokanVt+JoxC8G1fNOlm6tp1QNmZj6ikDcMrorBpBMJtT2lUdzUusNSt9qurvrlhr275VHMvI7XaXAbXTLLf3NjXUnP23/qN/n8d9cHyEZYpoe3p5jIOCjoFofoKAn5CGeZZaiJWcjp10mZuRkaSAq6OGmU2lhp+vk6iioay3rpSrs6mNsqa9tb+ntQAAA7AAAAAAAAAAAA\">")+
          "</p>";
        main.appendChild(loading);
      });
    }
}

function doneLoading() {
    var loading = document.getElementById('loading');
    if (loading) loading.parentNode.removeChild(loading);
    // TODO update header?
}

function setClass(element, classString) {
  element.setAttribute("class", classString);
  element.setAttribute("className", classString);
}

function printFooter() {
  // var footer = document.getElementById('footer');
  // We could put anything we want in the footer here, but perhaps we should avoid it.
  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    if (window.stats.scene.secondaryMode == "stats") {
      statsButton.innerHTML = "Return to the Game";
    } else {
      statsButton.innerHTML = "Show Stats";
      if (window.isAndroidApp && window.statsMode.get()) {
        showStats();
      }
    }
  }
  curl();
}

// retrieve value of HTML form
function getFormValue(name) {
    var field = document.forms[0][name];
    if (!field) return "";
    // may return either one field or an array of fields
    if (field.checked) return field.value;
    for (var i = 0; i < field.length; i++) {
        var element = field[i];
        if (element.checked) return element.value;
    }
    return null;
}

function printOptions(groups, options, callback) {
  var form = document.createElement("form");
  main.appendChild(form);
  var self = this;
  form.action="#";
  form.onsubmit = function() {
      safeCall(self, function() {
        var currentOptions = options;
        var option, group;
        for (var i = 0; i < groups.length; i++) {
            if (i > 0) {
                currentOptions = option.suboptions;
            }
            group = groups[i];
            if (!group) group = "choice";
            var value = getFormValue(group);
            if (value === null || value === undefined) {
              if (groups.length == 1) {
                asyncAlert("Please choose one of the available options first.");
              } else {
                var article = "a";
                if (/^[aeiou].*/i.test(group)) article = "an";
                asyncAlert("Please choose " + article + " " + group + " first.");
              }
              return;
            }
            option = currentOptions[value];
        }

        if (groups.length > 1 && option.unselectable) {
          asyncAlert("Sorry, that combination of choices is not allowed. Please select a different " + groups[groups.length-1] + ".");
          return;
        }
        safeCall(null, function() {callback(option);});
      });
      return false;
  };

  if (!options) throw new Error(this.lineMsg()+"undefined options");
  if (!options.length) throw new Error(this.lineMsg()+"no options");
  // global num will be used to assign accessKeys to the options
  var globalNum = 1;
  var currentOptions = options;
  var div = document.createElement("div");
  form.appendChild(div);
  setClass(div, "choice");
  for (var groupNum = 0; groupNum < groups.length; groupNum++) {
      var group = groups[groupNum];
      if (group) {
          var textBuilder = ["Select "];
          textBuilder.push(/^[aeiou]/i.test(group)?"an ":"a ");
          textBuilder.push(group);
          textBuilder.push(":");

          var p = document.createElement("p");
          p.appendChild(document.createTextNode(textBuilder.join("")));
          div.appendChild(p);
      }
      var checked = null;
      for (var optionNum = 0; optionNum < currentOptions.length; optionNum++) {
          var option = currentOptions[optionNum];
          if (!checked && !option.unselectable) checked = option;
          var isLast = (optionNum == currentOptions.length - 1);
          printOptionRadioButton(div, group, option, optionNum, globalNum++, isLast, checked == option);
      }
      // for rendering, the first options' suboptions should be as good as any other
      currentOptions = currentOptions[0].suboptions;
  }

  form.appendChild(document.createElement("br"));

  var useRealForm = false;
  if (useRealForm) {
    printButton("Next", form, false);
  } else {
    printButton("Next", main, false, function() {
      form.onsubmit();
    });
  }
}

function printOptionRadioButton(div, name, option, localChoiceNumber, globalChoiceNumber, isLast, checked) {
    var line = option.name;
    var unselectable = false;
    if (!name) unselectable = option.unselectable;
    var disabledString = unselectable ? " disabled" : "";
    var id = name + localChoiceNumber;
    if (!name) name = "choice";
    var radio;
    var div2 = document.createElement("div");
    var label = document.createElement("label");
    // IE doesn't allow you to dynamically specify the name of radio buttons
    if (!/^\w+$/.test(name)) throw new Error("invalid choice group name: " + name);
    label.innerHTML = "<input type='radio' name='"+name+
            "' value='"+localChoiceNumber+"' id='"+id+
            "' "+(checked?"checked":"")+disabledString+">";

    label.setAttribute("for", id);
    if (localChoiceNumber === 0) {
      if (isLast) {
        setClass(label, "onlyChild"+disabledString);
      } else {
        setClass(label, "firstChild"+disabledString);
      }
    } else if (isLast) {
      setClass(label, "lastChild"+disabledString);
    } else if (unselectable) {
      setClass(label, "disabled");
    }
    label.setAttribute("accesskey", globalChoiceNumber);
    if (!unselectable) {
      if (window.Touch) { // Make labels clickable on iPhone
          label.onclick = function labelClick(evt) {
              try {
                var target = evt.target;
                if (!/label/i.test(target.tagName)) return;
                var button = document.getElementById(target.getAttribute("for"));
                button.checked = true;
              } catch (e) {}
          };
      } else if (/MSIE 6/.test(navigator.userAgent)) {
        label.onclick = function labelClick() {
          try {
            var target = window.event.srcElement;
            if (!/label/i.test(target.tagName)) return;
            var button = document.getElementById(target.getAttribute("for"));
            button.checked = true;
          } catch (e) {}
        };
      }
    }
    printx(line, label);
    
    div2.appendChild(label);
    div.appendChild(div2);
}

function printImage(source, alignment, alt) {
  var img = document.createElement("img");
  img.src = source;
  if (alt !== null && String(alt).length > 0) img.setAttribute("alt", alt);
  setClass(img, "align"+alignment);
  document.getElementById("text").appendChild(img);
}

function playSound(source) {
  for (var existingAudios = document.getElementsByTagName("audio"); existingAudios.length;) {
    existingAudios[0].parentNode.removeChild(existingAudios[0]);
  }
  var audio = document.createElement("audio");
  if (audio.play) {
    audio.setAttribute("src", source);
    document.body.appendChild(audio);
    audio.play();
  }
}

function moreGames() {
    if (window.isIosApp) {
      window.location.href = "itms-apps://itunes.com/apps/choiceofgames";
    } else if (window.isAndroidApp) {
      if (window.isNookAndroidApp) {
        asyncAlert("Please search the Nook App Store for \"Choice of Games\" for more games like this!");
        return;
      }
      if (window.isAmazonAndroidApp) {
        var androidLink = document.getElementById('androidLink');
        if (androidLink && androidLink.href) {
          androidUrl = androidLink.href;
          var package = /id=([\.\w]+)/.exec(androidUrl)[1];
          window.location.href = "http://www.amazon.com/gp/mas/dl/android?p="+package+"&showAll=1&t=choofgam-20&ref=moreGames";
        } else {
          window.location.href = "http://www.amazon.com/gp/mas/dl/android?p=com.choiceofgames.dragon&showAll=1&t=choofgam-20&ref=moreGames";
        }
      } else {
        window.location.href = "market://search?q=pub:%22Choice+of+Games+LLC";
      }
    } else if (window.isSteamApp) {
      window.location.href = "https://www.choiceofgames.com/steam-curation.php";
    } else {
      try {
        if (window.isChromeApp) {
          window.open("https://www.choiceofgames.com/category/our-games/");
        } else {
          window.location.href = "https://www.choiceofgames.com/category/our-games/";
        }
      } catch (e) {
        // in xulrunner, this will be blocked, but it will trigger opening the external browser
      }
    }
}

function printShareLinks(target, now) {
  if (!target) target = document.getElementById('text');
  var msgDiv = document.createElement("div");
  if (window.isIosApp) {
    if (now) {
      callIos("share");
      return;
    }
    var button = document.createElement("button");
    button.appendChild(document.createTextNode("Share This Game"));
    button.onclick = function() {
      callIos("share");
    };
    msgDiv.appendChild(button);
    msgDiv.appendChild(document.createElement("br")); // insert our own paragraph break, to match <ul>
    msgDiv.appendChild(document.createElement("br"));
    target.appendChild(msgDiv);
    return;
  }

  var mobileMesg = "";
  if (window.isAndroidApp) {
    var androidLink = document.getElementById('androidLink');
    var androidUrl;
    if (window.isNookAndroidApp) {
      if (window.nookEan && nookEan != "UNKNOWN") {
        mobileMesg = "  <li><a href='choiceofgamesnook://"+window.nookEan+"'>Rate this app</a> in the Nook App Store</li>\n";
      }
    } else if (androidLink) {
      androidUrl = androidLink.href;
      if (androidUrl) {
        if (window.isAmazonAndroidApp) {
          var package = /id=([\.\w]+)/.exec(androidUrl)[1];
          androidUrl = "http://www.amazon.com/gp/mas/dl/android?p="+package+"&t=choofgam-20&ref=rate";
          mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Amazon Appstore</li>\n";
        } else {
          mobileMesg = "  <li><a href='"+androidUrl+"'>Rate this app</a> in the Google Play Store</li>\n";
        }

      }
    }
  } else if (/webOS/.test(navigator.userAgent) && window.isFile) {
    var palmLink = document.getElementById('palmLink');
    var palmUrl;
    if (palmLink) {
      palmUrl = palmLink.href;
      if (palmUrl) {
        mobileMesg = "  <li><a href='"+palmUrl+"'>Rate this app</a> in the Palm App Catalog</li>\n";
      }
    }
  } else if (window.isChromeApp) {
    var chromeLink = document.getElementById('chromeLink');
    var chromeUrl;
    if (chromeLink) {
      chromeUrl = chromeLink.href;
      if (chromeUrl) {
        mobileMesg = "  <li><a href='"+chromeUrl+"/reviews'>Rate this app</a> in the Chrome Web Store</li>\n";
      }
    }
  } else if (window.isSteamApp) {
    mobileMesg = "  <li><a href='#' onclick='try { purchase(\"adfree\", function() {}); } catch (e) {}; return false;'>Review this game</a> on Steam</li>\n";
  }

  var url = window.location.href;
  var links = document.getElementsByTagName("link");
  for (var i = links.length - 1; i >= 0; i--) {
    if (links[i].getAttribute("rel") == "canonical") {
      url = links[i].getAttribute("href") || url;
      break;
    }
  }

  if (/^\//.test(url)) {
    if (window.isWeb) {
      url = window.location.protocol + "//" + window.location.hostname + url;
    } else {
      url = "https://www.choiceofgames.com" + url;
    }
  }

  url = encodeURIComponent(url);
  var title = encodeURIComponent(document.title);
  var dataUriSupported = !/MSIE [67]/.test(navigator.userAgent);

  var shareLinkText = '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAACNFBMVEUAAAD///8ASZIASpIKTI0KSIcWSX5lgZ1YcIhYbYIAUpsHTpAhVIEAWaUAWaIAVp4AU5wAVJsAVJgAUpYAUpUBWaQWU4cAYqoAXqUAW6MAXKMAWqIAXKAFXZ8IWZZihZ8AbrgAbrcAaK0AZaoDbLIFZakGZqoKbrMAb7gAbrYBc7tsm7mizecge62izuiizeYBbqgId7INh8QQdqgXg7kVeK0fgLROm8Kh0uyducgRf7QXi8MvlcRTrNdZsdlvt9qDs8l/0O2v4/aY2u7j9/2/6fP4/f7s+/32/f71/f7t/P34/v76/v77/v76/f38/v7q7Oz9/v75/vvf8eX1/vjq/fDP+9zr/fDq/e+/9Mrq/e7E+Mxm3HN24YSC3YwTwSMUtSIXuycavikfxi4izDIhyTAhyTE8ykoauiclxjEowDUsxDYPthgsxTUDyQgg2iQ08jk43z3Q9tHP9dAA0gAA0QAA0AAAzwAAwQAAvAAAuwEAtAEAswAArAAB0AEBxQIBrAEC1AICtwMDvQUF1AUJ2QkL3wwL2gsKygwKwgsMxQwO3w4T6BMZ6xko7ChH3kdDyUN623qE64R8znx1wnX+/v79/f38/Pz7+/v6+vr5+fn4+Pj39/f29vby8vLx8fHq6urp6eno6Ojl5eXj4+Pg4ODf39/W1tbMzMzGxsbFxcXDw8PCwsKvr6+urq6srKypqamoqKiUlJSSkpKQkJCKioqIiIiHh4eGhoZ+fn5xcXFwcHBUP7YxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH1wgUDigoTpImZAAAARtJREFUGNMBEAHv/gABAQEBlZeanJ2dm5iVAQEBAAGYAZVyknGMho+RpJ+YlQEAAQGVc3CNi4WBdXSIqKGalQABlXOOh4R+dnV3d3pTrKKZAJVyb39fY2ZlZG54eVc5q6AAlpODWUtHR0pPVoJ7WC8HqACZkG2VPSclJjeVaH1VLAyvAJuJbFREQj4TLZVqfVouFLIAnIqAaV1bTDU2lWt8WDgStgCclGJhYFxRMzFJXmdSPxa3AJpQTU9PRkMVDUFITkUkCLMAmKM8NDowESMYIjI7HAW7sACVn0AqISkgKCEoFwoLCLWpAAGapSsdDxsaGQ4QBAi5rqYAAZWep64fHgIDBgm6ta2nngABAZeepqqxtLi4s7Cppp6XR0lhOIfKM38AAAAASUVORK5CYII=">':"")+
        ' <a href="http://www.stumbleupon.com/submit?url='+url+'&amp;title='+title+'" class="spacedLink">StumbleUpon</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsklEQVQ4EWNgoBAwgvQnVq75f+vBG5KMUlMQYZjfHsLIBNJFqmZkPSzEWKsqL8zQXebJICLIDVZuEzUTrg3sAjgPBwNZM7oSolyAzWaYQUS5AKYYG43XBUeWpaPogfGRwwCvAW/efwUbAPMCjI9sKl4DArKXgNXCbIbxkQ2gOAwoNgDsBS5ONgYNJTFkl2FlG2nLwMVv3HsFZlPHBTLifAznrj6Bm47OQI42mBwoM1EFAAAnVCliRFKHdQAAAABJRU5ErkJggg==">':"")+
        ' <a href="http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+'"'+
        'onclick="if (window.isFile || window.isXul) return true; '+
        'window.open(&quot;http://www.facebook.com/sharer.php?u='+url+'&amp;t='+title+
        '&quot;,&quot;sharer&quot;,&quot;toolbar=0,status=0,width=626,height=436&quot;);return false;" class="spacedLink">Facebook</a></li>'+

        '<li>'+(dataUriSupported?'<img height="16" width="16" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQ4EYVTO24UQRB9/dmZkdfCIK0QBhMACQdwgDgMN4AEiYALcAFy7kNABkYkGzhAWMa2DHg9n+7iVfXMaAmAknp7tuvVq1dV3Q6j9SlJlzLEOXgIPPcmRjf5/7ZHdWQRaVPCOjucDYJlcHi8AFLOErz/J4kRQASXGfjYDmhIeDwAKx9xBzz8jxUCgjqSfE8CPWi5EpeTjOu+F36CVcGxrEBBMVDiaDOB5vqVBQu6WAU+dQmnwZuGwkACstxlRDckqWIhMQLPOtfXvfw0AmfA95thqwBNWGg04PktLbTYrEAlXxJTEciemtd+KdvZf7ESTjipEyaazAgyu/2lTTjP2ZpICZZQYSp7gg8kelh5PFj4Kd56ZvhE2IUSMOMVm/niZoPDOqJl0FSAYlYhoNoabSmBiI5pVNouv39w32G3l05wIwaqKRq00XErWGWYFvXz3uAbA4+51lyf+wy9h0JVRqAgfmehc8vmJt7n/CrKP6J81fzqfIPTVOOAo+S9soko+GkzhxgNocUkDfLmosPrsyvwtpTDP5KRWBz2Of4PB3vYr8o9mNuZncfLvRrPdmveJJVNDn0G8yKUMV/pO+p16MVmAn00yvnu9g7erpZ4xAbUrFtXMy42AE9YwmHNxo42lzAd6AtMQ48NgjVVOz+BVNQ9Zql4UI9P/TehBOJIi+EJIAAAAABJRU5ErkJggg==">':"")+
        ' <a href="https://twitter.com/intent/tweet?related=choiceofgames&amp;text=Awesome+game%3A+'+title+'&amp;url='+url+'&amp;via=choiceofgames" class="spacedLink">Twitter</a></li>';

  var nowMsg = "";
  if (now) nowMsg = "<p>Please support our work by sharing this game with friends!  The more people play, the more resources we'll have to work on the next game.</p>";
  msgDiv.innerHTML = nowMsg + "<ul id='sharelist'>\n"+
    mobileMesg+
    shareLinkText+
    "</ul><br>\n"; // just one line break; <ul> provides its own
  target.appendChild(msgDiv);
}

function isShareConfigured() {
  return !!document.getElementById("share");
}

function shareAction(e) {
  clearScreen(function() {
    var target = document.getElementById('text');
    printShareLinks(target, "now");
    printButton("Next", target, false, function () {
      clearScreen(loadAndRestoreGame);
    });
  });
}

function isFollowEnabled() {
  if (!window.isWeb) return false;
  if ("localhost" != window.location.hostname && !/\.?choiceofgames\.com$/.test(window.location.hostname)) return false;
  return true;
}

function printFollowButtons() {
  if (!isFollowEnabled()) return;
  // Just FB Like, for now
  var target = document.getElementById('text');
  var iframe = document.createElement('iframe');
  var width = 300;
  var height = 66;
  iframe.setAttribute("src", "//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames"+
    "&amp;send=false&amp;layout=standard&amp;width="+width+"&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;"+
    "action=like&amp;height="+height+"&amp;appId=190439350983878");
  iframe.setAttribute("scrolling", "no");
  iframe.setAttribute("frameborder", "0");
  iframe.setAttribute("style", "border:none; overflow:hidden; width:"+width+"px; height:"+height+"px;");
  iframe.setAttribute("allowTransparency", "true");
  target.appendChild(iframe);
}

function subscribeLink(e) {
  clearScreen(function() {
    subscribe(document.getElementById('text'), "now", function() {
      clearScreen(loadAndRestoreGame);
    });
  });
}

function subscribeByMail(target, now, callback, code) {
  if (now) {
    code();
    safeTimeout(function() {callback(now);}, 0);
  } else {
    println("Click here to subscribe to our mailing list; we'll notify you when our next game is ready!");
    println("");
    printButton("Subscribe", target, false, function() {
        code();
      });
    printButton("Next", target, false, function() {
      safeTimeout(function() {callback(now);}, 0);
    });
    printFooter();
  }
}

function subscribe(target, now, callback) {
  if (!target) target = document.getElementById('text');
  if (window.isIosApp) {
    subscribeByMail(target, now, callback, function() {
      callIos("subscribe");
    });
    return;
  }
  var mailToSupported = isMobile && !window.isMacApp;
  if (window.isAndroidApp) mailToSupported = urlSupport.isSupported("mailto:support@choiceofgames.com");
  if (mailToSupported) {
    subscribeByMail(target, now, callback, function() {
      window.location.href = "mailto:subscribe-"+window.storeName+"-"+platformCode() + "@choiceofgames.com?subject=Sign me up&body=Please notify me when the next game is ready.";
    });
    return;
  }
  println("Type your email address below; we'll notify you when our next game is ready!");
  println("");
  fetchEmail(function(defaultEmail) {
    promptEmailAddress(target, defaultEmail, function(cancel, email) {
      if (cancel) {
        return safeCall(null, callback);
      }
      var head= document.getElementsByTagName('head')[0];
      var script = document.createElement('script');
      script.type = 'text/javascript';
      var timestamp = new Date().getTime();
      var timeout = setTimeout(function() {
        window["jsonp"+timestamp]({
          result:"error", msg:"Couldn't connect. Please try again later."
        });
      }, 10000);
      window["jsonp"+timestamp] = function(response) {
        clearTimeout(timeout);
        if (response.result == "error") {
          document.getElementById("errorMessage").innerHTML = response.msg;
        } else {
          clearScreen(function() {
            target = document.getElementById('text');
            println(response.msg, target);
            println("", target);
            printButton("Next", target, false, function() {
              safeCall(null, callback);
            });
          });
        }
      };
      var mailParams = "u=eba910fddc9629b2810db6182&id=e9cdee1aaa&SIGNUP="+window.storeName+"-"+platformCode()+"&EMAIL="+encodeURIComponent(email);
      if (window.isChromeApp) {
        chrome.permissions.contains({origins: ["http://choiceofgames.us4.list-manage.com/"]},function(isXhrAllowed) {
          if (isXhrAllowed) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams, true);
            xhr.onreadystatechange = function() {
              if (xhr.readyState != 4) return;
              if (xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                window["jsonp"+timestamp](response);
              } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
              } else {
                window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
              }
            };
            xhr.send();
          } else {
            window.addEventListener('message', function(event) {
              if (window["jsonp"+timestamp]) {
                var jsonpt = window["jsonp"+timestamp];
                window["jsonp"+timestamp] = null;
                if (jsonpt) jsonpt(event.data);
              }
            });
            var iframe = document.createElement("IFRAME");
            iframe.setAttribute("src", "sandbox.html");
            iframe.setAttribute("name", "sandbox");
            iframe.onload = function() {
              iframe.contentWindow.postMessage({email:email, game:window.storeName, platform:platformCode()}, "*");
            };
            document.documentElement.appendChild(iframe);
            return;
          }
        });
      } else {
        if (isWinStoreApp || window.location.protocol == "https:") {
          var xhr = findXhr();
          xhr.open("GET", 'https://www.choiceofgames.com/mailchimp_proxy.php/subscribe/post-json?'+mailParams, true);
          var done = false;
          xhr.onreadystatechange = function() {
            if (done) return;
            if (xhr.readyState != 4) return;
            done = true;
            if (xhr.status == 200) {
              var response = JSON.parse(xhr.responseText);
              window["jsonp"+timestamp](response);
            } else if (xhr.status === 0) {
                window["jsonp"+timestamp]({result:"error", msg:"There was a network error submitting your registration. Please try again later, or email subscribe@choiceofgames.com instead."});
            } else {
              window["jsonp"+timestamp]({result:"error", msg:"Sorry, our mail server had an error. It's our fault. Please try again later, or email subscribe@choiceofgames.com instead."});
            }
          };
          xhr.send();
        } else {
          script.src = 'http://choiceofgames.us4.list-manage.com/subscribe/post-json?'+mailParams+'&c=jsonp' + timestamp;
          head.appendChild(script);
        }
      }
    });
  });
}

function cacheKnownPurchases(knownPurchases) {
  if (!knownPurchases) return;
  var output = {billingSupported:true};
  for (i = 0; i < knownPurchases.length; i++) {
    var parts = knownPurchases[i].split(/\./);
    if (parts[0] != window.storeName) continue;
    output[parts[1]] = true;
  }
  window.knownPurchases = output;
}

function getKnownPurchases(callback) {
  isRegistered(function(registered){
    if (registered) {
      startLoading();
      xhrAuthRequest("GET", "get-purchases", function(ok, response) {
        doneLoading();
        if (ok) {
          cacheKnownPurchases(response);
        } else {
          if (response.error != "not registered") {
            alertify.error("There was an error downloading your purchases from Choiceofgames.com. "+
              "Please refresh this page to try again, or contact support@choiceofgames.com for assistance.", 15000);
          }
        }
        callback(ok, window.knownPurchases);
      });
    } else {
      callback("ok", {billingSupported: true});
    }
  });
}

// Callback expects a map from product ids to booleans
function checkPurchase(products, callback) {
  function publishPurchaseEvents(purchases) {
    if (window.purchaseSubscriptions) {
      for (var key in purchaseSubscriptions) {
        if (purchases[key]) purchaseSubscriptions[key].call();
      }
    }
  }

  var i;
  if (window.isIosApp) {
    window.checkPurchaseCallback = function(purchases) {
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    };
    callIos("checkpurchase", products);
  } else if (window.isAndroidApp && !window.isNookAndroidApp) {
    window.checkPurchaseCallback = function(purchases) {
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    };
    androidBilling.checkPurchase(products);
  } else if (window.isWinOldApp) {
    safeTimeout(function() {
      var purchases = eval(window.external.CheckPurchase(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isMacApp && window.macPurchase) {
    safeTimeout(function() {
      var purchases = JSON.parse(macPurchase.checkPurchases_(products));
      callback("ok",purchases);
      publishPurchaseEvents(purchases);
    }, 0);
  } else if (window.isCef) {
    cefQuery({
      request:"CheckPurchases " + products,
      onSuccess: function(response) {
        console.log("cp response " + response);
        var purchases = JSON.parse(response);
        callback("ok",purchases);
        publishPurchaseEvents(purchases);
      },
      onFailure: function(error_code, error_message) {
        console.error("CheckPurchases error: " + error_message);
        callback(!"ok");
      }
    });
  } else if (isWebPurchaseSupported()) {
    isRegistered(function (registered) {
      if (!registered) return callback("ok", {billingSupported: true});
      if (window.knownPurchases) {
        safeTimeout(function() {
          callback("ok", knownPurchases);
          publishPurchaseEvents(knownPurchases);
        }, 0);
      } else {
        getKnownPurchases(function(ok, purchases){
          callback(ok, purchases);
          publishPurchaseEvents(purchases);
        });
      }
    });
  } else {
    var productList = products.split(/ /);
    var purchases = {};
    for (i = 0; i < productList.length; i++) {
      purchases[productList[i]] = true;
    }
    purchases.billingSupported = false;
    publishPurchaseEvents(purchases);
    safeTimeout(function() {callback("ok", purchases);}, 0);
  }
}

function isWebPurchaseSupported() {
  return window.isSecureWeb && isWebSavePossible() && window.stripeKey;
}

function isRestorePurchasesSupported() {
  return !!window.isIosApp || !!window.isAndroidApp || isWebPurchaseSupported();
}

function restorePurchases(callback) {
  if (window.isIosApp) {
    window.restoreCallback = callback;
    callIos("restorepurchases");
  } else if (window.isAndroidApp) {
    window.restoreCallback = function(error) {
      window.restoreCallback = null;
      callback(error);
    };
    androidBilling.forceRestoreTransactions();
  } else if (isWebPurchaseSupported()) {
    isRegistered(function(registered) {
      var restoreCallback = function() {callback();};
      if (registered) {
        getKnownPurchases(restoreCallback);
      } else {
        clearScreen(function() {
          var target = document.getElementById('text');
          target.innerHTML="<p>Please sign in to Choiceofgames.com to restore purchases.</p>";
          loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, restoreCallback);
        });
      }
    });
  } else {
    safeTimeout(callback, 0);
  }
}
// Callback expects a localized string, or "", or "free", or "guess"
function getPrice(product, callback) {
  if (window.isIosApp) {
    window.priceCallback = callback;
    callIos("price", product);
  } else if (window.isAndroidApp) {
    window.priceCallback = callback;
    androidBilling.getPrice(product);
  } else {
    safeTimeout(function () {
      callback.call(this, "guess");
    }, 0);
  }
}
// Callback expects no args, but should only be called on success
function purchase(product, callback) {
  var purchaseCallback = function() {
    window.purchaseCallback = null;
    safeCall(null, callback);
    if (window.purchaseSubscriptions && purchaseSubscriptions[product]) {
      purchaseSubscriptions[product].call();
    }
  };
  if (window.isIosApp) {
    window.purchaseCallback = purchaseCallback;
    callIos("purchase", product);
  } else if (window.isAndroidApp) {
    window.purchaseCallback = purchaseCallback;
    var androidStackTrace = androidBilling.purchase(product);
    if (androidStackTrace) throw new Error(androidStackTrace);
  } else if (window.isWinOldApp) {
    window.external.Purchase(product);
  } else if (window.isMacApp && window.macPurchase) {
    macPurchase.purchase_(product);
  } else if (window.isCef) {
    cefQuerySimple("Purchase " + product);
    // no callback; we'll refresh on purchase
  } else if (window.isWeb && product == window.appPurchase) {
    var webStoreFallback = function() {
      window.appPurchase = null;
      purchase(product, callback);
    };
    var clickLink = function(id) {
      var link = document.getElementById(id);
      if (!link) return webStoreFallback();
      var href = link.getAttribute("href");
      if (!href) return webStoreFallback();
      window.location.href = href;
    };
    
    // instead of IAP, send the user to a store
    if (/(iPhone OS|iPad)/.test(navigator.userAgent)) {
      if (/iPhone OS [456]_/.test(navigator.userAgent)) {
        // ancient versions of iOS can't use our app
        webStoreFallback();
      } else {
        clickLink("iphoneLink");
      }
    } else if (/Silk/.test(navigator.userAgent)) {
      clickLink("kindleLink");
    } else if (/Android/.test(navigator.userAgent)) {
      clickLink("androidLink");
    } else if (window.steamClobber && document.getElementById("steamLink")) {
      clickLink("steamLink");
    } else {
      webStoreFallback();
    }
  } else if (isWebPurchaseSupported()) {
    if (!window.StripeCheckout) return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
      "network connection may be down.) Please refresh the page and try again, or contact "+
      "support@choiceofgames.com for assistance.");
    startLoading();
    isRegistered(function(registered) {
      doneLoading();
      var fullProductName = window.storeName + "." + product;
      function stripe(email) {
        startLoading();
        xhrAuthRequest("GET", "product-data", function(ok, data) {
          doneLoading();
          if (!ok) return asyncAlert("Sorry, we weren't able to initiate payment. (Your "+
            "network connection may be down.) Please refresh the page and try again, or contact "+
            "support@choiceofgames.com for assistance.");
          data = data[fullProductName];
          StripeCheckout.open({
            key:         window.stripeKey,
            address:     false,
            amount:      data.amount,
            name:        data.display_name,
            email:       email,
            panelLabel:  'Buy',
            token:       function(response) {
              clearScreen(function() {
                startLoading();
                xhrAuthRequest("POST", "purchase", function(ok, response) {
                  doneLoading();
                  if (ok) {
                    cacheKnownPurchases(response);
                    return purchaseCallback();
                  } else if (/^card error: /.test(response.error)) {
                    var cardError = response.error.substring("card error: ".length);
                    asyncAlert(cardError);
                    clearScreen(loadAndRestoreGame);
                  } else if ("purchase already in flight" == response.error) {
                    asyncAlert("Sorry, there was an error handling your purchase. Please wait five minutes and try again, or contact support@choiceofgames.com for assistance.");
                    clearScreen(loadAndRestoreGame);
                  } else {
                    asyncAlert("Sorry, there was an error processing your card. (Your "+
                      "network connection may be down.) Please refresh the page and try again, or contact "+
                      "support@choiceofgames.com for assistance.");
                    clearScreen(loadAndRestoreGame);
                  }
                }, "stripeToken", response.id, "product", fullProductName, "key", window.stripeKey);
              });
            }
          });
        }, "products", fullProductName);
      }
      if (registered) return fetchEmail(stripe);
      clearScreen(function() {
        var target = document.getElementById('text');
        target.innerHTML="<p>Please sign in to Choiceofgames.com to purchase.</p>";
        loginForm(document.getElementById('text'), /*optional*/1, /*err*/null, function(registered){
          if (registered) {
            checkPurchase(product, function(ok, response) {
              if (ok && response[product]) {
                purchaseCallback();
              } else {
                clearScreen(loadAndRestoreGame);
                return fetchEmail(stripe);
              }
            });
          } else {
            clearScreen(loadAndRestoreGame);
          }
        });
      });
    });
  } else {
    safeTimeout(purchaseCallback, 0);
  }
}

function printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, line, options) {
  if (window.updatedDiscountDates && updatedDiscountDates[product]) {
    var udd = updatedDiscountDates[product];
    fullYear = udd.fullYear;
    oneBasedMonthNumber = udd.oneBasedMonthNumber;
    dayOfMonth = udd.dayOfMonth;
  }
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  var span;
  span = document.createElement("span");
  span.setAttribute("id", "discount_" + product);
  printx(line, span);
  span.innerHTML = span.innerHTML.replace("${choice_discount_ends}", "<span id=discountdate_"+product+">"+shortMonthString + " " + parseInt(dayOfMonth, 10) + "</span>") + " ";

  if (!discountEligible) {
    span.style.display = "none";
  }

  text.appendChild(span);
}

function rewriteDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth) {
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  window.updatedDiscountDates[product] = {fullYear:fullYear, oneBasedMonthNumber:oneBasedMonthNumber, dayOfMonth:dayOfMonth};
  var span = document.getElementById("discount_"+product);
  if (!span) return;
  var shortMonthString = shortMonthStrings[oneBasedMonthNumber];
  var discountTimestamp = new Date(shortMonthString + " " + dayOfMonth + ", " + fullYear).getTime();
  var discountEligible = new Date().getTime() < discountTimestamp;
  if (discountEligible) {
    var dateSpan = document.getElementById("discountdate_"+product);
    if (!dateSpan) return;
    span.style.display = "";
    dateSpan.innerHTML = shortMonthString + " " + parseInt(dayOfMonth, 10);
  } else {
    span.style.display = "none";
  }
}

function handleDiscountResponse(ok, response) {
  if (!ok || !response || !window.storeName || !response[storeName]) return;
  if (!window.updatedDiscountDates) window.updatedDiscountDates = {};
  var udds = response[storeName];
  for (var product in udds) {
    if (!udds.hasOwnProperty(product)) continue;
    var udd = udds[product];
    var result = udd.split("-");
    rewriteDiscount(product, result[0], parseInt(result[1],10), parseInt(result[2], 10));
  }
}

function registerNativeAchievement(name) {
  if (window.blockNativeAchievements) return;
  if (window.isIosApp) {
    callIos("achieve", name+"/");
  } else if (window.isMacApp && window.macAchievements) {
    macAchievements.achieve_(name);
  } else if (window.isWinOldApp) {
    window.external.Achieve(name);
  } else if (window.isCef) {
    cefQuerySimple("Achieve " + name);
  }
}

function achieve(name, title, description) {
  if (initStore()) window.store.set("achieved", toJson(nav.achieved));
  registerNativeAchievement(name);
  // iOS shows a prominent banner; no need to show our own
  if (window.isIosApp) return;
  var escapedTitle = title+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
  var escapedDescription = description+"".replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/\[b\]/g, '<b>')
    .replace(/\[\/b\]/g, '</b>')
    .replace(/\[i\]/g, '<i>')
    .replace(/\[\/i\]/g, '</i>');
  var html = "<b>Achievement: "+escapedTitle+"</b><br>" + escapedDescription;
  alertify.log(html);
}

function checkAchievements(callback) {
  safeTimeout(function() {
    if (!initStore()) return callback();
    window.store.get("achieved", function(ok, value){
      function mergeNativeAchievements(achieved) {
        window.checkAchievementCallback = null;
        var nativeRegistered = {};
        for (var i = 0; i < achieved.length; i++) {
          nav.achieved[achieved[i]] = true;
          nativeRegistered[achieved[i]] = true;
        }
        for (var achievement in nav.achieved) {
          if (nav.achieved[achievement] && !nativeRegistered[achievement]) {
            registerNativeAchievement(achievement);
          }
        }
        callback();
      }
      var alreadyLoadingAchievements = false;
      if (ok && value) {
        var achievementRecord = jsonParse(value);
        for (var achieved in achievementRecord) {
          if (achievementRecord[achieved]) nav.achieved[achieved] = true;
        }
      }
      if (window.isIosApp) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) callIos("checkachievements");
      } else if (window.isMacApp && window.macAchievements) {
        alreadyLoadingAchievements = !!window.checkAchievementCallback;
        window.checkAchievementCallback = mergeNativeAchievements;
        if (!alreadyLoadingAchievements) macAchievements.checkAchievements();
      } else if (window.isWinOldApp) {
        var checkWinAchievements = function () {
          var achieved = eval(window.external.GetAchieved());
          if (achieved) {
            mergeNativeAchievements(achieved);
          } else {
            safeTimeout(checkWinAchievements, 100);
          }
        };
        checkWinAchievements();
      } else if (window.isCef) {
        var checkCefAchievements = function() {
          cefQuery({
            request:"GetAchieved ",
            onSuccess: function(response) {
              //console.log("GetAchieved " + response);
              var achieved = eval(response);
              mergeNativeAchievements(achieved);
            },
            onFailure: function(error_code, error_message) {
              //console.error("GetAchieved error " + error_message);
              if (error_code == 1) {
                safeTimeout(checkCefAchievements, 100);
              } else {
                callback();
              }
            }
          });
        };
        checkCefAchievements();
      } else {
        callback();
      }
    });
  },0);
}

function isAdvertisingSupported() {
  return typeof window != "undefined" && (window.isIosApp || window.isAndroidApp);
}

function isFullScreenAdvertisingSupported() {
  return window.isIosApp || window.isAndroidApp;
}

function showFullScreenAdvertisement(callback) {
  if (window.isIosApp) {
    callIos("advertisement");
    safeTimeout(callback, 0);
  } else if (window.isAndroidApp && window.adBridge) {
    adBridge.displayFullScreenAdvertisement();
    safeTimeout(callback, 0);
  } else {
    safeTimeout(callback, 0);
  }
}

function showTicker(target, endTimeInSeconds, finishedCallback) {
  if (!target) target = document.getElementById('text');
  var div = document.createElement("span");
  div.setAttribute("id", "delayTicker");
  target.appendChild(div);
  var timerDisplay = document.createElement("span");
  div.appendChild(timerDisplay);
  var timer;

  var statsButton = document.getElementById("statsButton");
  if (statsButton) {
    var defaultStatsButtonDisplay = statsButton.style.display;
    statsButton.style.display = "none";
  }

  if (endTimeInSeconds > Math.floor(new Date().getTime() / 1000)) {
    if (window.isAndroidApp) {
      notificationBridge.scheduleNotification(endTimeInSeconds);
    } else if (window.isIosApp) {
      callIos("schedulenotification", endTimeInSeconds);
    }
  }

  function cleanUpTicker() {
    window.tickerRunning = false;
    if (window.isAndroidApp) {
      notificationBridge.cancelNotification();
    } else if (window.isIosApp) {
      callIos("cancelnotifications");
    }
    clearInterval(timer);
    if (statsButton) statsButton.style.display = defaultStatsButtonDisplay;
  }

  function formatSecondsRemaining(secondsRemaining, forceMinutes) {
    if (!forceMinutes && secondsRemaining < 60) {
      return ""+secondsRemaining+"s";
    } else {
      var minutesRemaining = Math.floor(secondsRemaining / 60);
      var remainderSeconds;
      if (minutesRemaining < 60) {
        remainderSeconds = secondsRemaining - minutesRemaining * 60;
        return ""+minutesRemaining+"m " + formatSecondsRemaining(remainderSeconds);
      } else {
        var hoursRemaining = Math.floor(secondsRemaining / 3600);
        remainderSeconds = secondsRemaining - hoursRemaining * 3600;
        return ""+hoursRemaining+"h " + formatSecondsRemaining(remainderSeconds, true);
      }
    }
  }

  function tick() {
    window.tickerRunning = true;
    var tickerElement = document.getElementById("delayTicker");
    var tickerStillVisible = tickerElement && tickerElement.parentNode && tickerElement.parentNode.parentNode;
    if (!tickerStillVisible) {
      cleanUpTicker();
      return;
    }
    var nowInSeconds = Math.floor(new Date().getTime() / 1000);
    var secondsRemaining = endTimeInSeconds - nowInSeconds;
    if (secondsRemaining >= 0) {
      timerDisplay.innerHTML = "" + formatSecondsRemaining(secondsRemaining) + " seconds remaining";
    } else {
      cleanUpTicker();
      tickerElement.innerHTML = "0s remaining";
      if (finishedCallback) safeCall(null, finishedCallback);
    }
  }

  timer = setInterval(tick, 1000);
  tick();
}

function printButton(name, parent, isSubmit, code) {
  var button;
  if (isSubmit) {
    button = document.createElement("input");
    button.type = "submit";
    button.value = name;
    button.name = name;
  } else {
    button = document.createElement("button");
    button.setAttribute("type", "button");
    printx(name, button);
  }
  setClass(button, "next");
  button.setAttribute("accesskey", "n");
  if (code) button.onclick = function(event) {
    if (window.isIosApp) {
      window.freezeCallback = function() {
        window.freezeCallback = null;
        code(event);
      };
      callIos("freeze");
    } else {
      safeCall(null, function() {code(event);});
    }
  };
  if (!isMobile) try { button.focus(); } catch (e) {}
  parent.appendChild(button);
  return button;
}

function printLink(target, href, anchorText, onclick) {
  if (!target) target = document.getElementById('text');
  var link = document.createElement("a");
  link.setAttribute("href", href);
  link.appendChild(document.createTextNode(anchorText));
  if (onclick) {
    if (link.addEventListener) {
      link.addEventListener("click", onclick, true);
    } else {
      link.onclick = onclick;
    }
  }
  target.appendChild(link);
  target.appendChild(document.createTextNode(" "));
}

function kindleButton(target, query, buttonName) {
  printButton(buttonName, main, false,
    function() {
      try {
        window.location.href="http://www.amazon.com/s?rh=n%3A133140011%2Ck%3A" + encodeURIComponent(query);
      } catch (e) {} // xulrunner will intercept this link and throw an exception, opening it in the external browser
    }
  );
}

function printInput(target, inputType, callback, minimum, maximum, step) {
    if (!target) target = document.getElementById('text');
    var form = document.createElement("form");
    target.appendChild(form);
    var self = this;
    form.action="#";


    if (inputType == "textarea") {
      var input = document.createElement("textarea");
      input.setAttribute("rows", 4);
    } else {
      var input = document.createElement("input");
      input.setAttribute("type", inputType);
      if (inputType == "number") {
        input.setAttribute("min", minimum);
        input.setAttribute("max", maximum);
        step = step || "any";
        input.setAttribute("step", step);
      }
    }

    input.name="text";
    input.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(input);

    form.onsubmit = function(e) {
        preventDefault(e);
        if (!input.value) {
            // TODO optional value?
            // TODO configurable error message?
            asyncAlert("Don't just leave it blank!  Type something!");
            return;
        }
        if (window.isIosApp) {
          window.freezeCallback = function() {
            window.freezeCallback = null;
            safeCall(null, function() {callback(input.value);});
          };
          callIos("freeze");
        } else {
          safeCall(null, function() {callback(input.value);});
        }
        return false;
    };

    form.appendChild(document.createElement("br"));
    form.appendChild(document.createElement("br"));
    printButton("Next", form, true);

}

function promptEmailAddress(target, defaultEmail, callback) {
  if (!target) target = document.getElementById('text');
  var form = document.createElement("form");
  var self = this;
  form.action="#";

  var message = document.createElement("div");
  message.style.color = "red";
  message.style.fontWeight = "bold";
  message.setAttribute("id", "errorMessage");
  form.appendChild(message);

  var input = document.createElement("input");
  // This can fail on IE
  try { input.type="email"; } catch (e) {}
  input.name="email";
  input.value=defaultEmail;
  input.setAttribute("style", "font-size: 25px; width: 90%;");
  form.appendChild(input);
  target.appendChild(form);
  println("", form);
  println("", form);
  printButton("Next", form, true);

  printButton("No, Thanks", target, false, function() {
    callback(true);
  });

  form.onsubmit = function(e) {
    preventDefault(e);
    safeCall(this, function() {
      var email = trim(input.value);
      if (!/^\S+@\S+\.\S+$/.test(email)) {
        var messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
        message.innerHTML = "";
        message.appendChild(messageText);
      } else {
        recordEmail(email, function() {
          callback(false, email);
        });
      }
    });
  };

  curl();
}

function loginForm(target, optional, errorMessage, callback) {
  if (!isRegisterAllowed() || !initStore()) return safeTimeout(function() {
    callback(!"ok");
  }, 0);
  var optional_start = 1;
  var optional_returning_subscribe = 2;
  var optional_returning_no_subscribe = 3;
  var optional_new_subscribe = 4;
  var optional_new_no_subscribe = 5;
  startLoading();
  fetchEmail(function(defaultEmail) {
    isRegistered(function(registered) {
      if (registered) {
        if (defaultEmail) {
          doneLoading();
          loginDiv(registered, defaultEmail);
          return safeTimeout(callback, 0);
        }
        // Cookie says I'm logged in, but we have no local record of the email address
        return getRemoteEmail(function(ok, response) {
          doneLoading();
          if (ok) {
            if (response.email) {
              loginDiv(registered, response.email);
              return recordEmail(response.email, callback);
            } else {
              // not really logged in after all
              logout();
              loginDiv();
              return loginForm(target, optional, errorMessage, callback);
            }
          } else {
            // missed an opportunity to record email locally. meh.
            return safeCall(null, callback);
          }
        });
      }
      doneLoading();
      var form = document.createElement("form");

    if (!errorMessage) errorMessage = "";

      var escapedEmail = defaultEmail.replace(/'/g, "&apos;");
      var passwordButton;
      if (optional == optional_start) {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><div class='choice'>"+
          "<label for=yes class=firstChild><input type=radio name=choice value=yes id=yes checked> My email address is: "+
          "<input type=email name=email id=email value='"+escapedEmail+"' style='font-size: 25px; width: 11em'></label>"+
          ((isWeb && window.facebookAppId)?"<label for=facebook><input type=radio name=choice value=facebook id=facebook > Sign in with Facebook.</label>":"")+
          ((isWeb && window.googleAppId)?"<label for=google><input type=radio name=choice value=google id=google > Sign in with Google.</label>":"")+
          "<label for=no class=lastChild><input type=radio name=choice value=no id=no > No, thanks.</label>"+
          "<p><label class=noBorder for=subscribe><input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p>";

        form.email.onclick = function() {
          setTimeout(function() {form.email.focus();}, 0);
        };
        setTimeout(function() {form.email.focus();}, 0);
      } else {
        form.innerHTML = "<div id=message style='color:red; font-weight:bold'>"+errorMessage+
          "</div><span><span>My email address is: </span><input type=email name=email id=email value='"+
          escapedEmail+"' style='font-size: 25px; width: 12em'></span><p><label class=noBorder id=subscribeLabel for=subscribe>"+
          "<input type=checkbox name=subscribe id=subscribe checked> "+
          "Email me when new games are available.</label></p><p>Do you have a Choiceofgames.com password?</p>"+
          "<div class='choice'>"+
          "<label for=new class=firstChild><input type=radio name=choice value=new id=new checked> No, I'm new.</label>"+
          "<label for=passwordButton><input type=radio name=choice value=passwordButton id=passwordButton> "+
          "Yes, I have a password: <input id=password type=password name=password disabled class=needsclick style='font-size: 25px; width: 11em'></label>"+
          "<label for=forgot><input type=radio name=choice value=forgot id=forgot> I forgot my password.</label>"+
          ((isWeb && window.facebookAppId)?"<label for=facebook><input type=radio name=choice value=facebook id=facebook> Sign in with Facebook.</label>":"")+
          ((isWeb && window.googleAppId)?"<label for=google><input type=radio name=choice value=google id=google> Sign in with Google.</label>":"")+
          (optional ? "<label for=no><input type=radio name=choice value=no id=no> Cancel.</label>" : "") +
          "</div><br>";

        var labels = form.getElementsByTagName("label");
        setClass(labels[labels.length-1], "lastChild");

        var password = form.password;
        passwordButton = form.passwordButton;

        passwordButton.parentNode.onclick = function() {
          passwordButton.checked = true;
          passwordButton.onchange();
        };

        var radioButtons = form.choice;
        var onchange = function() {
          var enabled = passwordButton.checked;
          password.disabled = !enabled;
          if (enabled) {
            password.focus();
            setTimeout(function() {password.parentNode.scrollIntoView();}, 0);
          }
        };
        for (var i = radioButtons.length - 1; i >= 0; i--) {
          radioButtons[i].onchange = onchange;
        }
        if (optional) {
          form.subscribe.checked = (optional == optional_returning_subscribe || optional == optional_new_subscribe);
          passwordButton.checked = (optional == optional_returning_subscribe || optional == optional_returning_no_subscribe);
        }
      }

      function showMessage(msg) {
        var message = document.getElementById('message');
        var messageText = document.createTextNode(msg);
        message.innerHTML = "";
        message.appendChild(messageText);
      }

      form.onsubmit = function(event) {
        preventDefault(event);
        var email = trim(form.email.value);
        var subscribe = form.subscribe.checked;
        var choice = getFormValue("choice");
        if ("facebook" == choice) {
          if (!window.FB) return asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var loginParams = {scope:'email',return_scopes:true};
          if (window.facebookReRequest) loginParams.auth_type = "rerequest";
          return FB.login(function(response){
            if ("connected" == response.status) {
              var grantedScopes = [];
              try { grantedScopes = response.authResponse.grantedScopes.split(","); } catch (e) {}
              var grantedEmail = false;
              for (var i = 0; i < grantedScopes.length; i++) {
                if ("email" == grantedScopes[i]) {
                  grantedEmail = true;
                  break;
                }
              }
              if (grantedEmail) {
                xhrAuthRequest("POST", "facebook-login", function(ok, response){
                  if (ok) {
                    loginDiv(ok, response.email);
                    recordLogin(ok, response.email);
                    cacheKnownPurchases(response.purchases);
                    safeCall(null, function() {callback("ok");});
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Facebook. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "app_id", facebookAppId);
              } else {
                showMessage("Sorry, we require an email address to sign you in. Please grant access to your email address, or type your email address below.");
                window.facebookReRequest = true;
              }
            }
          },loginParams);
        }
        if ("google" == choice) {
          if (!window.gapi) return asyncAlert("Sorry, we weren't able to sign you in with Google. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
          var done = false;
          return gapi.auth.signIn({callback: function (authResult) {
            if (done) return;
            done = true;
            if (authResult['status']['signed_in']) {
              isRegistered(function(registered) {
                if (!registered) xhrAuthRequest("POST", "google-login", function(ok, response){
                  loginDiv(ok, response.email);
                  recordLogin(ok, response.email);
                  cacheKnownPurchases(response.purchases);
                  if (ok) {
                    callback("ok");
                  } else {
                    asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                }, "code", authResult['code'], "client_id", googleAppId);
              });
            } else {
              asyncAlert("Sorry, we weren't able to sign you in with Google. Please try again later, or contact support@choiceofgames.com for assistance.");
            }
          }});
        }
        if (!/^\S+@\S+\.\S+$/.test(email) && "no" != choice) {
          showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
        } else {
          recordEmail(email, function() {
            if ("yes" == choice) {
              clearScreen(function() {
                if (defaultEmail) {
                  optional = subscribe ? optional_returning_subscribe : optional_returning_no_subscribe;
                } else {
                  optional = subscribe ? optional_new_subscribe : optional_new_no_subscribe;
                }
                loginForm(document.getElementById("text"), optional, null, callback);
              });
            } else if ("no" == choice) {
              safeCall(null, function() {callback(false);});
            } else if ("new" == choice) {
              target.innerHTML = "";
              window.scrollTo(0,0);
              form = document.createElement("form");
              var escapedEmail = email.replace(/'/g, "&apos;");
              form.innerHTML = "<div id=message style='color:red; font-weight:bold'></div>"+
                "<div>My email address is: </div><div><input type=email name=email id=email value='"+
                escapedEmail+"' style='font-size: 25px; width: 12em'></div>"+
                "<div>Type it again: </div><div><input type=email name=email2 id=email2 autocomplete='off' style='font-size: 25px; width: 12em'></div>"+
                "<div>Enter a new password:&nbsp;</div><div>"+
                "<input type=password name=password id=password style='font-size: 25px; width: 12em'></div>";
              form.onsubmit = function(event) {
                preventDefault(event);
                var email = trim(form.email.value);
                var email2 = trim(form.email2.value);
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                  showMessage('Sorry, "'+email+'" is not an email address.  Please type your email address again.');
                  return;
                } else if (email != email2) {
                  showMessage('Those email addresses don\'t match.  Please type your email address again.');
                  return;
                }
                startLoading();
                form.style.display = "none";
                window.scrollTo(0,0);
                login(email, form.password.value, /*register*/true, subscribe, function(ok, response) {
                  doneLoading();
                  if (ok) {
                    target.innerHTML = "";
                    loginDiv(ok, email);
                    recordLogin(ok, email);
                    cacheKnownPurchases(response.purchases);
                    safeCall(null, function() {callback("ok");});
                  } else if ("incorrect password" == response.error) {
                    target.innerHTML = "";
                    loginForm(target, optional, 'Sorry, the email address "'+email+'" is already in use. Please type your password below, or use a different email address.', callback);
                  } else {
                    form.style.display = "";
                    showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                  }
                });
              };
              target.appendChild(form);
              println("", form);
              printButton("Next", form, true);
              if (optional) {
                printButton("Cancel", form, false, function() {
                  safeCall(null, function() {callback(false);});
                });
              }
            } else if ("passwordButton" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,0);
              login(email, form.password.value, /*register*/false, form.subscribe.checked, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  target.innerHTML = "";
                  loginDiv(ok, email);
                  recordLogin(ok, email);
                  cacheKnownPurchases(response.purchases);
                  safeCall(null, function() {callback("ok");});
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else if ("incorrect password" == response.error) {
                  showMessage('Sorry, that password is incorrect. Please try again, or select "I forgot my password" to reset your password.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            } else if ("forgot" == choice) {
              startLoading();
              form.style.display = "none";
              window.scrollTo(0,0);
              forgotPassword(email, function(ok, response) {
                doneLoading();
                form.style.display = "";
                if (ok) {
                  showMessage("We've emailed you a link to reset your password. Please check your email and click on the link, then return here to sign in.");
                  document.getElementById('passwordButton').checked = true;
                  document.getElementById('passwordButton').onchange();
                } else if ("unknown email" == response.error) {
                  showMessage('Sorry, we can\'t find a record for the email address "'+email+'". Please try a different email address, or create a new account.');
                } else {
                  showMessage("Sorry, we weren't able to sign you in. (Your network connection may be down.) Please try again later, or contact support@choiceofgames.com for assistance.");
                }
              });
            }
          });
        }
      };

      target.appendChild(form);
      if (passwordButton && passwordButton.checked) passwordButton.onchange();
      if (optional && optional > 1) document.getElementById("subscribeLabel").style.display = "none";
      printButton("Next", form, true);
      printFooter();
    });
  });
}

function loginDiv(registered, email) {
  var domain = "https://www.choiceofgames.com/";
  var identity = document.getElementById("identity");
  if (!identity) return;
  if (registered) {
    var emailLink = document.getElementById("email");
    emailLink.setAttribute("href", domain + "profile" + "/");
    emailLink.innerHTML = "";
    emailLink.appendChild(document.createTextNode(email));
    identity.style.display = "block";
    var logoutLink = document.getElementById("logout");
    logoutLink.onclick = function(event) {
      preventDefault(event);
      logout();
      loginDiv();
    };
  } else {
    identity.style.display = "none";
  }
}

function isRegistered(callback) {
  if (window.isWeb) {
    return safeTimeout(function() {
      if (!window.registered) window.registered = !!getCookieByName("login");
      callback(window.registered);
    }, 0);
  } else if (initStore()) {
    return window.store.get("login", function(ok, value) {
      safeTimeout(function() {
        window.registered = ok && value && "false" != value;
        callback(window.registered);
      }, 0);
    });
  } else {
    safeCall(null, function() {
      window.registered = false;
      callback(false);
    });
  }
}

function isRegisterAllowed() {
  return window.isWeb || window.isIosApp;
}

function preventDefault(event) {
  if (!event) event = window.event;
  if (!event) return;
  if (event.preventDefault) {
    event.preventDefault();
  } else {
    event.returnValue = false;
  }
}

function getPassword(target, code) {
  if (!target) target = document.getElementById('text');
  var textArea = document.createElement("textarea");
  textArea.cols = 41;
  textArea.rows = 30;
  setClass(textArea, "savePassword");
  target.appendChild(textArea);
  println("", target);
  printButton("Next", target, false, function() {
    code(false, textArea.value);
  });

  printButton("Cancel", target, false, function() {
    code(true);
  });
}

function showPassword(target, password) {
  if (!target) target = document.getElementById('text');

  var textBuffer = [];
  var colWidth = 40;
  for (var i = 0; i < password.length; i++) {
    textBuffer.push(password.charAt(i));
    if ((i + 1) % colWidth === 0) {
      textBuffer.push('\n');
    }
  }
  password = "----- BEGIN PASSWORD -----\n" + textBuffer.join('') + "\n----- END PASSWORD -----";

  var shouldButton = isMobile;
  if (shouldButton) {
    var button = printButton("Email My Password to Me", target, false,
      function() {
        safeCall(self, function() {
            if (isWeb) {
              // TODO more reliable system
            }
            window.location.href = "mailto:?subject=Save%20this%20password&body=" + encodeURIComponent(password);
        });
      }
    );
    setClass(button, "");
  }

  var shouldTextArea = !isMobile;
  if (shouldTextArea) {
    var textArea = document.createElement("textarea");
    textArea.cols = colWidth + 1;
    textArea.rows = 30;
    setClass(textArea, "savePassword");

    textArea.setAttribute("readonly", true);
    textArea.onclick = function() {textArea.select();};
    textArea.value = (password);
    target.appendChild(textArea);
  }
}

function changeTitle(title) {
  document.title = title;
  var h1 = document.getElementsByTagName("h1");
  if (h1) h1 = h1[0];
  h1.innerHTML = "";
  h1.appendChild(document.createTextNode(title));
  if (window.isWinOldApp) {
    window.external.SetTitle(title);
  }
}

function changeAuthor(author) {
  var authorTag = document.getElementById("author");
  authorTag.innerHTML = "";
  authorTag.appendChild(document.createTextNode("by " + author));
}


function reportBug() {
  var prompt = "Please explain the problem. Be sure to describe what you expect, as well as what actually happened.";
  alertify.prompt(prompt, function(ok, body) {
    var statMsg = "(unknown)";
    try {
        statMsg = toJson(window.stats, '\n');
    } catch (ex) {}
    body += "\n\nGame: " + window.storeName;
    if (window.stats && window.stats.scene) {
      body += "\nScene: " + window.stats.scene.name;
      body += "\nLine: " + (window.stats.scene.lineNum+1);
    }
    body += "\nUser Agent: " + navigator.userAgent;
    body += "\nLoad time: " + window.loadTime;
    if (window.Persist) body += "\nPersist: " + window.Persist.type;
    body += "\nversion=" + window.version;
    body += "\n\n" + statMsg;
    if (window.nav && window.nav.bugLog) body += "\n\n" + window.nav.bugLog.join("\n");
    console.log(body);
    if (ok) alertify.prompt("Please type your email address.", function(ok, email) {
      if (ok) xhrAuthRequest("POST", "support-mail", function(ok, response) {
        if (ok) {
          alertify.log("Thank you for reporting a bug!");
        } else {
          alertify.alert("Bug reporting failed. Please email your bug report to support@choiceofgames.com (and be sure to mention that the bug reporter failed!)");
        }
      }, "email", encodeURIComponent(email),
        "subject", encodeURIComponent("bug report " + window.storeName),
        "text", encodeURIComponent(body));
    });
  });
}

window.registered = false;

function getSupportEmail() {
  if (window.storeName) {
    return "support-" + storeName + "-" + platformCode() + "@choiceofgames.com";
  }
  try {
    return document.getElementById("supportEmail").getAttribute("href").substring(7);
  } catch (e) {
    return "support-external@choiceofgames.com";
  }
}

function absolutizeAboutLink() {
  var aboutAnchor = document.getElementById("aboutLink");
  if (aboutLink) {
    var aboutHref = aboutLink.getAttribute("href");
    if (/^https?:/.test(aboutHref)) return;

    var linkTags = document.getElementsByTagName("link");
    var canonical;
    for (var i = 0; i < linkTags.length; i++) {
      if (linkTags[i].getAttribute("rel") == "canonical") {
        canonical = linkTags[i].getAttribute("href");
        break;
      }
    }

    if (!canonical) return;

    var absoluteCanonical;
    if (/^https?:/.test(canonical)) {
      absoluteCanonical = canonical;
    } else if (/^\//.test(canonical)) {
      absoluteCanonical = "https://www.choiceofgames.com" + canonical;
    } else {
      absoluteCanonical = "https://www.choiceofgames.com/" + canonical;
    }
    if (!/\/$/.test(canonical)) {
      absoluteCanonical += "/";
    }

    aboutLink.setAttribute("href", absoluteCanonical + aboutHref);
  }
}

function aboutClick() {
    window.location.href = document.getElementById("aboutLink").href;
}

window.onerror=function(msg, file, line, stack) {
    if (window.console) {
      window.console.error(msg);
      if (file) window.console.error("file: " + file);
      if (line) window.console.error("line: " + line);
    }
    if (window.Event && msg instanceof window.Event && /WebKit/.test(navigator.userAgent)) {
      return; // ignore "adsense offline" error
    } else if (/(Error loading script|Script error)/.test(msg) && /(show_ads|google-analytics|version\.js)/.test(file)) {
      return; // ignore "adsense offline" error
    }
    alert(msg);
    if (!window.storeName) return;
    var ok = confirm("Sorry, an error occured.  Click OK to email error data to support.");
    if (ok) {
        var statMsg = "(unknown)";
        try {
            statMsg = toJson(window.stats, '\n');
        } catch (ex) {}
        var body = "What were you doing when the error occured?\n\nError: " + msg;
        if (window.stats && window.stats.scene && window.stats.scene.name) body += "\nScene: " + window.stats.scene.name;
        if (file) body += "\nFile: " + file;
        if (line) body += "\nLine: " + line;
        if (stack) body += "\nStack: " + stack;
        body += "\nUser Agent: " + navigator.userAgent;
        body += "\nLoad time: " + window.loadTime;
        if (window.Persist) body += "\nPersist: " + window.Persist.type;
        body += "\n\n" + statMsg + "\n\nversion=" + window.version;
        var supportEmailHref = "mailto:support-external@choiceofgames.com";
        try {
          supportEmailHref="mailto:"+getSupportEmail();
          supportEmailHref=supportEmailHref.replace(/\+/g,"%2B");
        } catch (e) {}
        window.location.href=(supportEmailHref + "?subject=Error Report&body=" + encodeURIComponent(body));
    }
};

window.onload=function() {
    if (window.alreadyLoaded) return;
    window.alreadyLoaded = true;
    window.main = document.getElementById("main");
    var head = document.getElementsByTagName("head")[0];
    window.nav.setStartingStatsClone(window.stats);
    if (window.achievements && window.achievements.length) {
      nav.loadAchievements(window.achievements);
      checkAchievements(function() {});
      setButtonTitles();
    }
    stats.sceneName = window.nav.getStartupScene();
    var map = parseQueryString(window.location.search);
    if (!map) {
      if (window.androidQueryString) {
        map = parseQueryString(window.androidQueryString);
      } else if (window.forcedScreenshots) {
        map = {forcedScene:"screenshots"};
      }
    }

    if (map) {
      window.forcedScene = map.forcedScene;
      window.slot = map.slot;
      window.debug = map.debug;
      if (map.restart) {
        restartGame();
      } else if (map.achievements) {
        doneLoading();
        showAchievements("hideNextButton");
      } else if (map.forcedScene) {
        safeCall(null, function() {loadAndRestoreGame(window.slot, window.forcedScene);});
      } else if (map.persistence) {
        window.storeName = map.persistence;
        var startupScene = new Scene("startup", window.stats, window.nav, {secondaryMode:"startup", saveSlot:"startup"});
        startupScene.startupCallback = function() {
          safeCall(null, loadAndRestoreGame);
        }
        startupScene.execute();
      } else {
        safeCall(null, loadAndRestoreGame);
      }
    } else {
      safeCall(null, loadAndRestoreGame);
    }
    if (window.Touch && window.isWeb) {
      // INSERT ADMOB AD
    }
    isRegistered(function(registered){
      if (registered) {
        fetchEmail(function(email) {
          loginDiv(registered, email);
        });
      } else {
        loginDiv();
      }
    });
    if (window.isWinStoreApp || window.isWinOldApp) {
        var subscribeAnchor = document.getElementById("subscribeLink");
        if (subscribeAnchor) {
            subscribeAnchor.onclick = function() {
              safeCall(null, subscribeLink);
              return false;
            };
        }
    }
    if (window.isCef) {
      var buttons = document.getElementById("buttons");
      buttons.appendChild(document.createTextNode(" "));
      var menuButton = document.createElement("button");
      menuButton.id = "menuButton";
      setClass(menuButton, "spacedLink");
      menuButton.onclick = showMenu;
      menuButton.innerHTML = "Menu";
      buttons.appendChild(menuButton);
    }
    if (window.isWinOldApp) {
        absolutizeAboutLink();
        var h1s = document.getElementsByTagName("h1");
        if (h1s.length) window.external.SetTitle(document.getElementsByTagName("h1")[0].innerText);
    }
    if (isFollowEnabled()) {
      var shareElement = document.getElementById("share");
      if (shareElement) shareElement.innerHTML = '<iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fchoiceofgames&amp;send=false'+
      '&amp;layout=button_count&amp;width=90&amp;show_faces=true&amp;font&amp;colorscheme=light&amp;action=like&amp;height=20&amp;appId=190439350983878"'+
      ' scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:90px; height:20px;" allowTransparency="true"></iframe>'+
      '<iframe allowtransparency="true" frameborder="0" scrolling="no" '+
      'src="//platform.twitter.com/widgets/follow_button.html?screen_name=choiceofgames&amp;show_screen_name=false"'+
      ' style="width:150px; height:20px;"></iframe>';
    }
    var supportEmailLink = document.getElementById("supportEmail");
    if (window.storeName && supportEmailLink) {
      supportEmailLink.href = "mailto:" + getSupportEmail();
    }

    submitAnyDirtySaves();

    if (window.purchaseSubscriptions) {
      var productList = "";
      for (var key in purchaseSubscriptions) {
        productList += (productList ? " " : "") + key;
      }
      if (productList) checkPurchase(productList, function() {});
    }
};

if ( document.addEventListener ) {
  document.addEventListener( "DOMContentLoaded", window.onload, false );
}

try {
  var style = document.createElement('style');
  style.type = 'text/css';
  try {style.innerHTML = 'noscript {display: none;}'; } catch (e) {}
  document.getElementsByTagName('head')[0].appendChild(style);
} catch (e) {}

if (window.isWeb) {
  document.write("<style>.webOnly { display: block !important; }</style>\n");
  var checkoutScript = document.createElement("script");
  checkoutScript.async = 1;
  checkoutScript.src="https://checkout.stripe.com/v2/checkout.js";
  document.getElementsByTagName("head")[0].appendChild(checkoutScript);

  var metas = document.getElementsByTagName("meta");
  var facebookAppId, googleAppId;
  var googleLoginCallbackCallback;
  for (var i = 0; i < metas.length; i++) {
    var meta = metas[i];
    if ("fb:app_id" == meta.getAttribute("property")) {
      facebookAppId = meta.getAttribute("content");
    } else if ("google-signin-clientid" == meta.getAttribute("name")) {
      googleAppId = meta.getAttribute("content");
    }
  }

  if (facebookAppId) {
    window.fbAsyncInit = function() {
      FB.init({
        appId      : facebookAppId,
        cookie     : true,  // enable cookies to allow the server to access 
                            // the session
        xfbml      : true,  // parse social plugins on this page
        version    : 'v2.0' // use version 2.0
      });
    };

    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src ="//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document,'script','facebook-jssdk'));
  }

  if (googleAppId) (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/client:plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
  
}
if (!window.isWeb && window.isIosApp) {
  document.write("<style>"+
  "#header { display: none; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }"+
  "</style>"+
  // Use UIWebView width, not screen width, on iPad
  "<meta name = 'viewport' content = 'width = "+window.innerWidth+"'>"
  );
  window.addEventListener("resize", function() {
      document.querySelector("meta[name=viewport]").setAttribute("content", "width="+window.innerWidth);
      // this dummy element seems to be required to get the viewport to stick
      var dummy = document.createElement("p");
      dummy.innerHTML = "&nbsp;";
      document.body.appendChild(dummy);
      window.setTimeout(function() {document.body.removeChild(dummy);}, 10);
    }, false);
  callIos("checkdiscounts");
} else if (window.isAndroidApp) {
  document.write("<style>"+
  "#header { display: none; }"+
  ""+
  "#emailUs { display: none; }"+
  ""+
  "#main { padding-top: 1em; }"+
  "</style>");
}
if (window.isWebOS) document.write("<style>body {font-family: Prelude; font-size: 14pt}\n#header {font-size: 13pt}</style>");
if (window.isMacApp || window.isWinOldApp || window.isCef || window.isAndroidApp) {
  document.write("<style>"+
    "#headerLinks { display: none; }"+
    ""+
    "#emailUs { display: none; }"+
    ""+
    "</style>");
}
if (window.isWeb && !window.Touch) {
  document.write("<style>label:hover {background-color: #E4DED8;}</style>");
}
if (window.isChromeApp) {
  var base = document.createElement('base');
  base.setAttribute("target", "_blank");
  document.head.appendChild(base);

  document.addEventListener( "DOMContentLoaded", function() {
    var aboutLink = document.getElementById("aboutLink");
    aboutLink.addEventListener("click", function() {
      if (chrome.app.window) {
        event.preventDefault();
        chrome.app.window.create("credits.html", {}, function(w) {
          w.contentWindow.addEventListener( "DOMContentLoaded", function() {
            var win = this;
            var back = win.document.getElementById("back");
            back.addEventListener("click", function(event) {
              event.preventDefault();
              win.close();
            }, false);
            var base = win.document.createElement('base');
            base.setAttribute("target", "_blank");
            win.document.head.appendChild(base);
            win.document.documentElement.style.overflowY = "scroll";
          }, false);
        });
      }
    }, false);

    var statsButton = document.getElementById("statsButton");
    if (statsButton) {
      statsButton.onclick = undefined;
      statsButton.addEventListener("click", function() {
        showStats();
      }, false);
    }

    var achievementsButton = document.getElementById("achievementsButton");
    if (achievementsButton) {
      achievementsButton.onclick = undefined;
      achievementsButton.addEventListener("click", function() {
        showAchievements();
      }, false);
    }

    var restartButton = document.getElementById("restartButton");
    restartButton.onclick = undefined;
    restartButton.addEventListener("click", function() {
      restartGame("prompt");
    }, false);

    var subscribeAnchor = document.getElementById("subscribeLink");
    subscribeAnchor.onclick = undefined;
    subscribeAnchor.addEventListener("click", function() {
      subscribeLink();
    }, false);

    var supportAnchor = document.getElementById("supportEmail");
    supportAnchor.addEventListener("click", function(event) {
      event.preventDefault();
    }, false);

  }, false );
}
if (window.isCef) {
  var pollPurchases = function() {
    cefQuery({
      request:"PollPurchases",
      onSuccess:function(response){
        //console.log("PollPurchases: '"+response+"'");
        if (response) {
          clearScreen(loadAndRestoreGame);
        }
        safeTimeout(pollPurchases, 100);
      },
      onFailure:function(error_code, error_message) {
        console.error("PollPurchases error: " + error_message);
      }
    });
  };
  pollPurchases();
}

function winStoreShareLinkHandler(e) {
    var request = e.request;
    var canonical = document.querySelector("link[rel=canonical]");
    var canonicalHref = canonical && canonical.getAttribute("href");
    if (!/^https?:/.test(canonicalHref)) {
        canonicalHref = "https://www.choiceofgames.com" + canonicalHref;
    }
    if (!/\/$/.test(canonicalHref)) {
        canonicalHref += "/";
    }
    canonicalHref += "redirect.php?src=winshare";
    request.data.properties.title = document.title;
    request.data.properties.description = document.querySelector("meta[name=description]").getAttribute("content");
    request.data.setUri(new Windows.Foundation.Uri(canonicalHref));
}

if (window.isWinStoreApp) {
    var dataTransferManager = Windows.ApplicationModel.DataTransfer.DataTransferManager.getForCurrentView();
    dataTransferManager.addEventListener("datarequested", winStoreShareLinkHandler);

    baseScript = document.createElement("script");
    baseScript.src = "//Microsoft.WinJS.1.0/js/base.js";
    baseScript.onload = function () {
        WinJS.Application.onsettings = function (e) {
            var privacyCmd = new Windows.UI.ApplicationSettings.SettingsCommand("privacy", "Privacy Policy", function () {
                window.open("https://www.choiceofgames.com/privacy-policy");
            });
            e.detail.e.request.applicationCommands.append(privacyCmd);
        };
        WinJS.Application.start();
    };
    document.head.appendChild(baseScript);

    uiScript = document.createElement("script");
    uiScript.src = "//Microsoft.WinJS.1.0/js/ui.js";
    document.head.appendChild(uiScript);
} else if (window.isWinOldApp) {
    console = {
        log: function (message) { window.external.ConsoleLog(message); },
        error: function (message) { window.external.ConsoleError(message); }
    };
    document.oncontextmenu = function() {return false;};
}

function platformCode() {
  if (window.isIosApp) return "ios";
  if (window.isAndroidApp) return "android";
  if (window.isMacApp) return "mac";
  if (window.isWinStoreApp) return "windows";
  if (window.isWinOldApp) return "csharp";
  if (window.isChromeApp) return "chrome";
  if (window.isWebOS) return "palm";
  if (window.isCef) return "cef";
  if (window.isWeb) return "web";
  return "unknown";
}

/*
 * Copyright 2010 by Dan Fabulich.
 *
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 *
 * See the License for the specific language governing
 * permissions and limitations under the License.
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function Scene(name, stats, nav, options) {
    if (!name) name = "";
    if (!stats) stats = {};
    // the name of the scene
    this.name = name;

    // the permanent statistics and the temporary values
    this.stats = stats;
    this.temps = {choice_reuse:"allow", choice_user_restored:false};

    // the navigator determines which scene comes next
    this.nav = nav;

    options = options || {};

    // should we print debugging information?
    this.debugMode = options.debugMode || false;

    // used for stats screen, and maybe other secondary views someday
    this.secondaryMode = options.secondaryMode;

    this.saveSlot = options.saveSlot || "";

    // the array of lines in the scene file
    this.lines = [];

    // the current line number (WARNING 0-based!)
    this.lineNum = 0;
    this.rollbackLineCoverage();

    // when this is true, the main printLoop will halt
    this.finished = false;

    // map of label names to line numbers
    this.labels = {};

    // the current amount of indentation
    this.indent = 0;

    // Did the previous line contain text?
    this.prevLine = "empty";

    // Have we ever printed any text?
    this.screenEmpty = true;

    // Have we run any commands (except for create and scene_list) yet?
    this.initialCommands = true;

    this.stats.sceneName = name;

    // for easy reachability from the window
    this.stats.scene = this;

    // where should we print text?
    this.target = null;
}

Scene.prototype.reexecute = function reexecute() {
  this.lineNum = this.stats.testEntryPoint || 0;
  this.finished = 0;
  this.indent = this.getIndent(this.lines[this.lineNum]);
  this.prevLine = "empty";
  this.screenEmpty = true;
  this.execute();
};

// the main loop of the scene
Scene.prototype.printLoop = function printLoop() {
    var line;
    for (;!this.finished && this.lineNum < this.lines.length; this.lineNum++) {
        line = this.lines[this.lineNum];
        if (!trim(line)) {
            this.paragraph();
            continue;
        }
        var indent = this.getIndent(line);
        if (indent > this.indent) {
            // ignore indentation level of *comments
            if (/\s*\*comment\b/.test(line)) continue;
            throw new Error(this.lineMsg() + "increasing indent not allowed, expected " + this.indent + " was " + indent);
        } else if (indent < this.indent) {
            this.dedent(indent);
        }
        if (this.temps.fakeChoiceLines && this.temps.fakeChoiceLines[this.lineNum]) {
          this.rollbackLineCoverage();
          this.lineNum = this.temps.fakeChoiceEnd;
          this.rollbackLineCoverage();
          delete this.temps.fakeChoiceEnd;
          delete this.temps.fakeChoiceLines;
          continue;
        }
        this.indent = indent;
        if (!this.runCommand(line)) {
            if (/^\s*#/.test(line)) {
                if (this.temps.fakeChoiceEnd) {
                    this.rollbackLineCoverage();
                    this.lineNum = this.temps.fakeChoiceEnd;
                    this.rollbackLineCoverage();
                    delete this.temps.fakeChoiceEnd;
                    delete this.temps.fakeChoiceLines;
                    continue;
                } else {
                    throw new Error(this.lineMsg() + "It is illegal to fall out of a *choice statement; you must *goto or *finish before the end of the indented block.");
                }
            }
            this.prevLine = "text";
            this.screenEmpty = false;
            this.printLine(trim(line));
            printx(' ', this.target);
        }
    }
    this.rollbackLineCoverage();
    if (!this.finished) {
        this.autofinish();
    }
    this.save("temp");
    if (this.skipFooter) {
        this.skipFooter = false;
    } else {
        printFooter();
    }
};

Scene.prototype.dedent = function dedent(newDent) {};

Scene.prototype.printLine = function printLine(line, parent) {
    if (!line) return null;
    line = this.replaceVariables(line);
    if (!parent) parent = this.target;
    return printx(line, parent);
};

Scene.prototype.replaceVariables = function (line) {
  line = String(line);
  var replacer = /(\$(\!?\!?)\{)/;
  var index = 0;
  var output = [];
  for (var result = replacer.exec(line); result; result = replacer.exec(line.substring(index))) {
    output.push(line.substring(index, index + result.index));
    var curlies = 0;
    var closingCurly = -1;
    var exprStart = index + result.index + result[1].length;
    for (var i = exprStart; i < line.length; i++) {
      var c = line.charAt(i);
      if (c === "{") {
        curlies++;
      } else if (c === "}") {
        if (curlies) {
          curlies--;
        } else {
          closingCurly = i;
          break;
        }
      }
    }
    if (closingCurly == -1) {
      throw new Error(this.lineMsg() + "invalid ${} variable substitution at letter " + (index + result.index + 1));
    }
    var expr = line.substring(exprStart, closingCurly);
    var stack = this.tokenizeExpr(expr);
    var value = this.evaluateExpr(stack);
    var capitalize = result[2];
    if (capitalize) value = String(value);
    if (capitalize == "!") {
      value = value.charAt(0).toUpperCase() + value.slice(1);
    } else if (capitalize == "!!") {
      value = value.toUpperCase();
    }
    if (typeof highlightGenderPronouns != "undefined" && highlightGenderPronouns && /\b(he|him|his|she|her|hers)\b/gi.test(value)) {
      // this zero-width space will give us a hint for highlighting
      output.push("\u200b");
    }
    output.push(value);
    index = closingCurly+1;
  }
  if (index === 0) return line;
  output.push(line.substring(index));
  return output.join("");
};

Scene.prototype.paragraph = function paragraph() {
    if (this.prevLine == "text") {
        println("", this.target);
        println("", this.target);
    } else if (this.prevLine == "block") {
      println("", this.target);
    }
    this.prevLine = "empty";
};

Scene.prototype.loadSceneFast = function loadSceneFast(url) {
    if (this.loading) return;
    this.loading = true;
    var result;
    if (window.cachedResults && window.cachedResults[this.name]) {
      result = window.cachedResults[this.name];
      return this.loadLinesFast(result.crc, result.lines, result.labels);
    } else if (typeof allScenes != "undefined") {
      result = allScenes[this.name];
      if (!result) throw new Error("Couldn't load scene '" + this.name + "'\nThe file doesn't exist.");
      return this.loadLinesFast(result.crc, result.lines, result.labels);
    }
    startLoading();
    if (!url) {
        url = Scene.baseUrl + "/" + this.name.replace(/ /g, "_") + ".txt.json";
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        done = true;

        var result;
        try {
          result = jsonParse(xhr.responseText);
        } catch (e) {
          if (window.console) console.error(e, e.stack);
        }
        if (window.isWeb && (xhr.status != 200 || !result)) {
          var status = xhr.status;
          if (status == 200 || !status) status = "network";
          main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
          "  Please refresh your browser now; if that doesn't work, please click the Restart button and email "+getSupportEmail()+" with details.</p>"+
          " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
          return;
        } else if (xhr.responseText === "") {
          throw new Error("Couldn't load " + url + "\nThe file is probably missing or empty.");
        }
        
        if (!window.cachedResults) window.cachedResults = {};
        cachedResults[self.name] = result;
        self.loadLinesFast(result.crc, result.lines, result.labels);
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.onerror("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          }
        }
        window.onerror("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.loadLinesFast = function loadLinesFast(crc, lines, labels) {
  this.checkSum(crc);
  this.lines = lines;
  this.labels = labels;
  this.loading = false;
  this.loaded = true;
  var self = this;
  if (this.executing) {
    safeCall(this, function() {
      doneLoading();
      self.execute();
    });
  }
};

// load the scene file from the specified URL (or from default URL by name)
Scene.prototype.loadScene = function loadScene(url) {
    if (this.loading) return;
    this.loading = true;
    startLoading();
    if (!url) {
        url = Scene.baseUrl + "/" + this.name + ".txt";
    }
    var xhr = findXhr();
    xhr.open("GET", url, true);
    var self = this;
    var done = false;
    xhr.onreadystatechange = function() {
        if (done) return;
        if (xhr.readyState != 4) return;
        done = true;
        if (xhr.status == 403) {
          try {
            var err = JSON.parse(xhr.responseText);
            if (err.error == "not registered") {
              return isRegistered(function(registered) {
                if (registered) {
                  logout();
                  loginDiv();
                }
                return clearScreen(function() {
                  loginForm(main, 0/*optional*/,
                    "Please sign in to access this part of the game.", function() {
                      clearScreen(loadAndRestoreGame);
                    });
                });
              });
            }
          } catch (e) {} // JSON parse failure? must not be a login prompt
        }
        if (window.isWeb && xhr.status != 200) {
            var status = xhr.status || "network";
            main.innerHTML = "<p>Our apologies; there was a " + status + " error while loading game data."+
            "  Please refresh your browser now; if that doesn't work, please email "+getSupportEmail()+" with details.</p>"+
            " <p><button onclick='window.location.reload();'>Refresh Now</button></p>";
            return;
        } else if (xhr.responseText === "") {
          throw new Error("Couldn't load " + url + "\nThe file is probably missing or empty.");
        }
        var result = xhr.responseText;
        scene = result;
        scene = scene.replace(/\r/g, "");
        this.loading = false;
        self.loadLines(scene);
        if (self.executing) {
            safeCall(self, function () {
              doneLoading();
              self.execute();
            });
        }
    };
    if (isIE) {
      // IE8 swallows errors in onreadystatechange if xhr.send is in a try block
      xhr.send(null);
    } else {
      try {
        xhr.send(null);
      } catch (e) {
        if (window.location.protocol == "file:" && !window.isMobile) {
          if (/Chrome/.test(navigator.userAgent)) {
            window.onerror("We're sorry, Google Chrome has blocked ChoiceScript from functioning.  (\"file:\" URLs cannot "+
            "load files in Chrome.)  ChoiceScript works just fine in Chrome, but only on a published website like "+
            "choiceofgames.com.  For the time being, please try another browser like Mozilla Firefox.");
            return;
          } else if (e.code === 1012 /*NS_ERROR_DOM_BAD_URI*/) {
            window.onerror("Couldn't load scene file: " + url + "\nThe file is probably missing.");
            return;
          }
        }
        window.onerror("Couldn't load URL: " + url + "\n" + e);
      }
    }
};

Scene.prototype.checkSum = function checkSum(crc) {
  if (this.temps.choice_crc) {
    if (this.temps.choice_crc != crc) {
      // The scene has changed; restart the scene
      var userRestored = this.temps.choice_user_restored || false;
      this.temps = {choice_reuse:"allow", choice_user_restored:userRestored, choice_crc: crc};
      this.lineNum = 0;
      this.indent = 0;
    }
  } else {
    this.temps.choice_crc = crc;
  }
};

Scene.prototype.loadLines = function loadLines(str) {
    var crc = crc32(str);
    this.checkSum(crc);
    this.lines = str.split('\n');
    this.parseLabels();
    this.loaded = true;
};

// launch the vignette as soon as it's available
Scene.prototype.execute = function execute() {
    if (!this.loaded) {
        this.executing = true;
        if (Scene.generatedFast || (typeof generatedFast != "undefined" && generatedFast) || typeof allScenes != 'undefined') {
          this.loadSceneFast();
        } else {
          this.loadScene();
        }
        return;
    }
    if (this.nav) this.nav.repairStats(stats);
    doneLoading();
    if (typeof this.targetLabel != "undefined") {
      var label = this.targetLabel.label.toLowerCase();
      if (typeof(this.labels[label]) != "undefined") {
          this.lineNum = this.labels[label];
          this.indent = this.getIndent(this.lines[this.lineNum]);
          delete this.targetLabel;
      } else {
          throw new Error(this.targetLabel.origin + " line " + (this.targetLabel.originLine+1) + ": "+this.name+" doesn't contain label " + label);
      }
    }
    this.printLoop();
};

// loop through the file looking for *label commands
Scene.prototype.parseLabels = function parseLabels() {
    var lineLength = this.lines.length;
    var oldLineNum = this.lineNum;
    var screenshots = ("choicescript_screenshots" == this.name);
    var seenChoiceWithoutSet = 0;
    for (this.lineNum = 0; this.lineNum < lineLength; this.lineNum++) {
        this.rollbackLineCoverage();
        var line = this.lines[this.lineNum];
        var result = /^(\s*)\*(\w+)(.*)/.exec(line);
        if (!result) continue;
        var indentation = result[1];
        var indent = indentation.length;
        var command = result[2].toLowerCase();
        var data = trim(result[3]);
        if ("label" == command) {
            data = data.toLowerCase();
            if (/\s/.test(data)) throw new Error(this.lineMsg() + "label '"+data+"' is not allowed to contain spaces");
            if (this.labels.hasOwnProperty(data)) {
              throw new Error(this.lineMsg() + "label '"+data+"' already defined on line " + (this.labels[data]*1+1));
            }
            this.labels[data] = this.lineNum;
        } else if (screenshots) {
          if ("fake_choice" == command) {
            if (seenChoiceWithoutSet) throw new Error(this.lineMsg() +
              "In choicescript_screenshots, you need to *set at least one variable between *fake_choice commands, so the stat screen looks interesting. " +
              "There was no *set since the last *fake_choice on line " + seenChoiceWithoutSet + ".");
            seenChoiceWithoutSet = this.lineNum+1;
          } else if ("set" == command) {
            seenChoiceWithoutSet = 0;
          }
        }
    }
    this.rollbackLineCoverage();
    this.lineNum = oldLineNum;
};

// if this is a command line, run it
Scene.prototype.runCommand = function runCommand(line) {
    var result = /^\s*\*(\w+)(.*)/.exec(line);
    if (!result) {
      if (this.secondaryMode == "startup" && this.startupCallback) {
        this.finished = true;
        this.skipFooter = true;
        this.startupCallback();
        return true;
      }
      return false;
    }
    var command = result[1].toLowerCase();
    var data = trim(result[2]);
    if (Scene.validCommands[command]) {
        if ("comment" == command) return true;
        if (Scene.initialCommands[command]) {
          if ("startup" != this.name || !this.initialCommands) {
            throw new Error(this.lineMsg() + "Invalid "+command+" instruction, only allowed at the top of startup.txt");
          }
        } else {
          if (this.secondaryMode == "startup" && this.startupCallback) {
            this.finished = true;
            this.skipFooter = true;
            this.startupCallback();
            return true;
          }
          this.initialCommands = false;
        }
        if (command == "choice" && String(this.name).toLowerCase() == "choicescript_screenshots") {
          throw new Error(this.lineMsg() + "choicescript_screenshots files should only contain *fake_choice commands, not real *choice commands");
        }
        this[command](data);
    } else {
        throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
    }
    return true;
};

// *choice [group1] [group2] ...
// prompt the user with a multiple choice question.
// nested lines are options to be presented to the user
//
// Examples:
// *choice
//    good
//      Good choice
//      *finish
//    bad
//      Bad choice
//      *finish
//
// *choice toy
//    spaceship
//      Nice spaceship
//      *finish
//    train
//      Nice train
//      *finish
//    doll
//      Nice doll
//      *finish
//
// *choice color toy
//    red
//      spaceship
//        Nice red spaceship
//        *finish
//      train
//        Nice red train
//        *finish
//    blue
//       spaceship
//         Nice blue spaceship
//        *finish
//       train
//         Nice red train
//        *finish

// If a group is specified, generate a prompt message, e.g. "*choice toy" -> "Select a toy:"
// If no group is specified, don't generate a prompt message
// if multiple groups are specified, allow the user to make multiple choices simultaneously
//   all multi-dimensional choices must be valid (otherwise throw a parse error)
Scene.prototype.choice = function choice(data) {
    var startLineNum = this.lineNum;
    var groups = data.split(/ /);
    for (var i = 0; i < groups.length; i++) {
      if (!/^\w*$/.test(groups[i])) {
        throw new Error(this.lineMsg() + "invalid choice group name: " + groups[i]);
      }
    }
    var options = this.parseOptions(this.indent, groups);
    var self = this;
    this.renderOptions(groups, options, function(option) {
      self.standardResolution(option);
    });
    this.finished = true;
    if (this.fakeChoice) {
      this.temps.fakeChoiceEnd = this.lineNum;
      var fakeChoiceLines = {};
      for (i = 0; i < options.length; i++) {
        fakeChoiceLines[options[i].line-1] = 1;
      }
      this.temps.fakeChoiceLines = fakeChoiceLines;
    }
    this.lineNum = startLineNum;
};

Scene.prototype.fake_choice = function fake_choice(data) {
    this.fakeChoice = true;
    this.choice(data, true);
    delete this.fakeChoice;
};

Scene.prototype.standardResolution = function(option) {
  var self = this;
  self.lineNum = option.line;
  self.indent = self.getIndent(self.nextNonBlankLine(true/*includingThisOne*/));
  if (option.reuse && option.reuse != "allow") self.temps.choice_used[option.line-1] = 1;
  if (this.nav) this.nav.bugLog.push("#"+(option.line+1) + " " + option.name);

  self.finished = false;
  self.resetPage();
};

Scene.prototype.nextNonBlankLine = function nextNonBlankLine(includingThisOne) {
    var line;
    var i = this.lineNum;
    if (!includingThisOne) i++;
    while(isDefined(line = this.lines[i]) && !trim(line)) {
      i++;
    }
    return line;
};

Scene.prototype.resetCheckedPurchases = function resetCheckedPurchases() {
  for (var temp in this.temps) {
    if (/^choice_purchased/.test(temp)) {
      delete this.temps[temp];
    }
  }
};

// reset the page and invoke code after clearing the screen
Scene.prototype.resetPage = function resetPage() {
    var self = this;
    this.resetCheckedPurchases();
    clearScreen(function() {
      // save in the background, eventually
      self.save("");
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
};

/* The function needs some explaining.
We want the game to be "refreshable," e.g. on the web.
So we only make a "real" autosave as you click "Next"
But if we do it that way, when we visit the stat screen, it's out of date
So we make a "temp" autosave slot, right as the page finishes redrawing,
and the stat screen uses the "temp" autosave to display your current data.
When you refresh the page, the "temp" autosave is rewritten.

If you save stats on the stat screen, they're written into tempStatWrites;
when the stat screen saves, we transfer tempStatWrites back to the main
game (if the main game is running in a separate iframe, e.g. iOS).

If the main game is about to write the main "" slot, we merge the temp
stat writes into the main stats (and clear the stat writes) before
saving.

Thus, stat changes on the stat screen will only be permanently saved when
the player clicks "Next" in the main game, ensuring that the game is still
refreshable.
*/
Scene.prototype.save = function save(slot) {
    if (this.saveSlot) {
      transferTempStatWrites();
    } else {
      if (!slot) {
        slot = "";
        for (var key in tempStatWrites) {
          if (tempStatWrites.hasOwnProperty(key)) {
            this.stats[key] = tempStatWrites[key];
          }
        }
        tempStatWrites = {};
      }
      
      saveCookie(function() {}, slot, this.stats, this.temps, this.lineNum, this.indent, this.debugMode, this.nav);
    }
};

// *goto labelName
// Go to the line labeled with the label command *label labelName
// 
// goto by reference
//   *create foo "labelName"
//   *goto {foo}
Scene.prototype["goto"] = function scene_goto(line) {
    var label;
    if (/[\[\{]/.test(line)) {
      label = this.evaluateReference(this.tokenizeExpr(line));
    } else {
      label = String(line).toLowerCase();
    }
    if (typeof(this.labels[label]) != "undefined") {
        this.lineNum = this.labels[label];
        this.indent = this.getIndent(this.lines[this.lineNum]);
    } else {
        throw new Error(this.lineMsg() + "bad label " + label);
    }
};

Scene.prototype.gosub = function scene_gosub(label) {
    if (!this.temps.choice_substack) {
      this.temps.choice_substack = [];
    }
    this.temps.choice_substack.push({lineNum: this.lineNum, indent: this.indent});
    this["goto"](label);
};

Scene.prototype.gosub_scene = function scene_gosub_scene(data) {
    if (!this.stats.choice_subscene_stack) {
      this.stats.choice_subscene_stack = [];
    }
    this.stats.choice_subscene_stack.push({name:this.name, lineNum: this.lineNum + 1, indent: this.indent, temps: this.temps});
    this.goto_scene(data);
};

Scene.prototype["return"] = function scene_return() {
    var stackFrame;
    if (this.temps.choice_substack && this.temps.choice_substack.length) {
      stackFrame = this.temps.choice_substack.pop();
      this.lineNum = stackFrame.lineNum;
      this.indent = stackFrame.indent;
    } else if (this.stats.choice_subscene_stack && this.stats.choice_subscene_stack.length) {
      stackFrame = this.stats.choice_subscene_stack.pop();
      this.finished = true;
      this.skipFooter = true;
      var scene = new Scene(stackFrame.name, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
      scene.temps = stackFrame.temps;
      scene.screenEmpty = this.screenEmpty;
      scene.prevLine = this.prevLine;
      scene.lineNum = stackFrame.lineNum;
      scene.indent = stackFrame.indent;
      scene.execute();
    } else if (!this.temps.choice_substack && !this.stats.choice_subscene_stack) {
      throw new Error(this.lineMsg() + "invalid return; gosub has not yet been called");
    } else {
      throw new Error(this.lineMsg() + "invalid return; we've already returned from the last gosub");
    }
    
};

// *gotoref expression
// Go to the label identified by the expression
//
// *temp foo
// *set foo "bar"
// *gotoref foo
// Skipped!
// *label bar
Scene.prototype["gotoref"] = function scene_gotoref(expression) {
    var stack = this.tokenizeExpr(expression);
    var value = this.evaluateExpr(stack);
    this["goto"](value);
};


// *finish
// halt the scene
Scene.prototype.finish = function finish(buttonName) {
    this.paragraph();
    this.finished = true;
    var self = this;
    if (this.secondaryMode == "stats") {
      if (typeof window == "undefined") return;
      if (window.forcedScene == "choicescript_stats") return;
      if (window.isAndroidApp && window.statsMode.get()) return;
      printButton(buttonName || "Next", main, false,
        function() {
          clearScreen(loadAndRestoreGame);
        }
      );
      return;
    }
    var nextSceneName = this.nav && nav.nextSceneName(this.name);
    // if there are no more scenes, then just halt
    if (!nextSceneName) {
        if (!this.secondaryMode) this.ending();
        return;
    }
    if (this.screenEmpty) {
      this.goto_scene(nextSceneName);
      return;
    }
    if (!buttonName) buttonName = "Next Chapter";
    buttonName = this.replaceVariables(buttonName);


    printButton(buttonName, main, false,
      function() {
        safeCall(self, function() {
            var scene = new Scene(nextSceneName, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:self.secondaryMode});
            scene.resetPage();
        });
      }
    );
    if (this.debugMode) println(toJson(this.stats));
};

Scene.prototype.autofinish = function autofinish(buttonName) {
  this.finish(buttonName);
};

// *reset
// clear all stats
Scene.prototype.reset = function reset() {
    this.nav.resetStats(this.stats);
    this.stats.scene = this;
};

Scene.prototype.parseGotoScene = function parseGotoScene(data) {
  var sceneName, label;
  if (/[\[\{]/.test(data)) {
    var stack = this.tokenizeExpr(data);
    sceneName = this.evaluateReference(stack, {toLowerCase: false});
    if (stack.length) {
      label = this.evaluateReference(stack);
    }
    if (stack.length) {
      throw new Error(this.lineMsg() + "Invalid *goto_scene command; nothing should appear after the label " + label);
    }
  } else {
    var words = data.split(/ /);
    sceneName = words[0];
    if (words.length > 2) {
      throw new Error(this.lineMsg() + "Invalid *goto_scene command; nothing should appear after the label " + words[1]);
    } else if (words.length == 2) {
      label = words[1];
    }
  }
  return {sceneName:sceneName, label:label};
};

// *goto_scene foo
//
Scene.prototype.goto_scene = function gotoScene(data) {
    var result = this.parseGotoScene(data);

    this.finished = true;
    this.skipFooter = true;
    var scene = new Scene(result.sceneName, this.stats, this.nav, {debugMode:this.debugMode, secondaryMode:this.secondaryMode, saveSlot:this.saveSlot});
    scene.screenEmpty = this.screenEmpty;
    scene.prevLine = this.prevLine;
    if (typeof result.label != "undefined") scene.targetLabel = {label:result.label, origin:this.name, originLine:this.lineNum};
    scene.execute();
};

// *redirect_scene foo
Scene.prototype.redirect_scene = function redirectScene(data) {
  if (this.secondaryMode != "stats") throw new Error(this.lineMsg() + "The *redirect_scene command can only be used from the stats screen.");
  var args = trim(data).split(/ /);
  var sceneName, label;
  if (args.length == 1) {
    sceneName = data;
  } else {
    sceneName = args[0];
    label = args[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  redirectFromStats(sceneName, label, this.lineNum, function() {
    delete self.secondaryMode;
    self.goto_scene(data);
  });
};

Scene.prototype.restore_purchases = function scene_restorePurchases(data) {
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Restore Purchases", target, false,
    function() {
      safeCall(self, function() {
          restorePurchases(function() {
            self["goto"](data);
            self.finished = false;
            self.resetPage();
          });
      });
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.check_purchase = function scene_checkPurchase(data) {
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  checkPurchase(data, function(ok, result) {
    self.finished = false;
    self.skipFooter = false;
    if (!ok) {
      result = {billingSupported:true};
      self.temps.choice_purchase_error = true;
    }
    result = result || {};
    var products = data.split(/ /);
    var everything = true;
    for (var i = 0; i < products.length; i++) {
      var purchasedProduct = result[products[i]] || false;
      self.temps["choice_purchased_"+products[i]] = purchasedProduct;
      if (!purchasedProduct) everything = false;
    }
    self.temps.choice_purchased_everything = everything;
    self.temps.choice_purchase_supported = !!result.billingSupported;
    self.execute();
  });
};

Scene.prototype.purchase = function purchase_button(data) {
  var result = /^(\w+)\s+(\S+)\s+(.*)/.exec(data);
  if (!result) throw new Error(this.lineMsg() + "invalid line; can't parse purchaseable product: " + data);
  var product = result[1];
  var priceGuess = trim(result[2]);
  var label = trim(result[3]);
  if (typeof this.temps["choice_purchased_"+product] === "undefined") throw new Error(this.lineMsg() + "Didn't check_purchases on this page");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  getPrice(product, function (price) {
    if (!price || "free" == price) {
      self["goto"](label);
      self.finished = false;
      self.resetPage();
    } else {
      if (price == "guess") price = priceGuess;
      var target = self.target;
      if (!target) target = document.getElementById('text');
      self.paragraph();
      var button = printButton("Buy It Now for " + price, target, false,
        function() {
          safeCall(self, function() {
              purchase(product, function() {
                safeCall(self, function() {
                  self["goto"](label);
                  self.finished = false;
                  self.resetPage();
                });
              });
          });
        }
      );
      self.prevLine = "block";
      if (isRestorePurchasesSupported()) {
        self.prevLine = "text";
        printLink(target, "#", "Restore Purchases",
          function() {
            safeCall(self, function() {
                restorePurchases(function(error) {
                  checkPurchase([product], function(ok, purchases) {
                    if (ok && purchases[product]) {
                      self["goto"](label);
                      self.finished = false;
                      self.resetPage();
                    } else {
                      if (error || !ok) {
                        asyncAlert("Restore failed. Please try again.");
                      } else {
                        asyncAlert("Restore completed. This product is not yet purchased.");
                      }
                      if (ok) { // don't refresh if not OK, but should we refresh on error? assuming yes?
                        // refresh, in case we're on web showing a full-screen login. Not necessary on mobile? But, meh.
                        if (!self.secondaryMode) clearScreen(loadAndRestoreGame);
                      }
                    }
                  });
                });
            });
          }
        );
      }
      
      self.skipFooter = false;
      self.finished = false;
      self.execute();
    }
  });
};

Scene.prototype.purchase_discount = function purchase_discount(line) {
  var args = trim(String(line)).split(" ");
  if (args.length != 5) throw new Error(this.lineMsg() + "expected five arguments, saw "+args.length+": " + line);
  var product = args[0];
  var expectedEndDateString = args[1];
  var expectedEndDate = parseDateStringInCurrentTimezone(expectedEndDateString, this.lineNum+1);
  var fullPriceGuess = this.replaceVariables(args[2]);
  var discountedPriceGuess = this.replaceVariables(args[3]);
  var label = args[4];
  var startsWithDollar = /^\$/;
  if (!startsWithDollar.test(fullPriceGuess)) {
    throw new Error(this.lineMsg() + "full price guess "+fullPriceGuess+"doesn't start with dollar: " + line);
  }
  if (!startsWithDollar.test(discountedPriceGuess)) {
    throw new Error(this.lineMsg() + "discounted price guess "+discountedPriceGuess+"doesn't start with dollar: " + line);
  }
  var discountText = "[b]On sale until "+shortMonthStrings[expectedEndDate.getMonth()+1]+" "+expectedEndDate.getDate()+"! Buy now before the price increases![/b]"
  if (typeof printDiscount != "undefined") {
    printDiscount(product, expectedEndDate.getYear()+1900, expectedEndDate.getMonth()+1, expectedEndDate.getDate(), discountText);
  }
  var priceGuess;
  if (new Date().getTime() < expectedEndDate.getTime()) {
    priceGuess = discountedPriceGuess;
  } else {
    priceGuess = fullPriceGuess;
  }
  this.purchase([product, priceGuess, label].join(" "));
}

Scene.prototype.print_discount = function print_Discount(line) {
  var result = /(\w+) (\d{4})-(\d{2})-(\d{2}) (.*$)/.exec(line);
  if (!result) throw new Error("invalid discount: " + line);
  var product = result[1];
  var fullYear = result[2];
  var oneBasedMonthNumber = parseInt(result[3],10);
  var dayOfMonth = parseInt(result[4],10);
  var discountText = result[5];
  this.temps.choice_discount_ends = "POISONTOKEN";
  discountText = this.replaceVariables(discountText).replace("POISONTOKEN", "${choice_discount_ends}");
  delete this.temps.choice_discount_ends;
  if (typeof printDiscount != "undefined") printDiscount(product, fullYear, oneBasedMonthNumber, dayOfMonth, discountText);
};

// *abort
// halt the scene without showing a button
Scene.prototype.abort = function() {
  this.paragraph();
  this.finished = true;
};

// *create
// create a new permanent stat
Scene.prototype.create = function create(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid create instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    variable = variable.toLowerCase();
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid create instruction, no value specified: " + line);
    var self = this;
    function complexError() {
      throw new Error(self.lineMsg()+"Invalid create instruction, value must be a a number, true/false, or a quoted string: " + line);
    }
    if (stack.length > 1) complexError();
    var token = stack[0];
    if (!/STRING|NUMBER|VAR/.test(token.name)) complexError();
    if ("VAR" == token.name && !/^true|false$/i.test(token.value)) complexError();
    if ("STRING" == token.name && /\$!?!?{/.test(token.value)) throw new Error(this.lineMsg() + "Invalid create instruction, value must be a simple string without ${}: " + line);
    var value = this.evaluateExpr(stack);
    this.stats[variable] = value;
    if (this.nav) this.nav.startingStats[variable] = value;
};

// *temp
// create a temporary stat for the current scene
Scene.prototype.temp = function temp(line) {
    var result = /^(\w*)(.*)/.exec(line);
    if (!result) throw new Error(this.lineMsg()+"Invalid temp instruction, no variable specified: " + line);
    var variable = result[1];
    this.validateVariable(variable);
    var expr = result[2];
    var stack = this.tokenizeExpr(expr);
    if (stack.length === 0) {
      this.temps[variable.toLowerCase()] = null;
      return;
    }
    var value = this.evaluateExpr(stack);
    this.temps[variable.toLowerCase()] = value;
};

// retrieve the value of the variable, preferring temp scope
Scene.prototype.getVar = function getVar(variable) {
    var value;
    variable = String(variable).toLowerCase();
    if (variable && !isNaN(1*variable) && String(1*variable) === variable) return 1*variable;
    if (variable == "true") return true;
    if (variable == "false") return false;
    if (variable == "choice_subscribe_allowed") return true;
    if (variable == "choice_register_allowed") return isRegisterAllowed();
    if (variable == "choice_registered") return typeof window != "undefined" && !!window.registered;
    if (variable == "choice_is_web") return typeof window != "undefined" && !!window.isWeb;
    if (variable == "choice_is_steam") return typeof window != "undefined" && !!window.isSteamApp;
    if (variable == "choice_is_advertising_supported") return typeof isAdvertisingSupported != "undefined" && !!isAdvertisingSupported();
    if (variable == "choice_is_trial") return !!(typeof isTrial != "undefined" && isTrial);
    if (variable == "choice_kindle") return false;
    if (variable == "choice_randomtest") return !!this.randomtest;
    if (variable == "choice_restore_purchases_allowed") return isRestorePurchasesSupported();
    if (variable == "choice_save_allowed") return areSaveSlotsSupported();
    if (variable == "choice_time_stamp") return Math.floor(new Date()/1000);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        value = this.stats[variable];
        if (value === null || value === undefined) {
            throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
        }
        if (this.debugMode) println("stats["+ variable + "]==" + value);
        return value;
    }
    value = this.temps[variable];
    if (value === null || value === undefined) {
        throw new Error(this.lineMsg() + "Variable '"+variable+"' exists but has no value");
    }
    if (this.debugMode) println("temps["+ variable + "]==" + value);
    return value;
};

// set the value of the variable, preferring temp scope
Scene.prototype.setVar = function setVar(variable, value) {
    variable = variable.toLowerCase();
    if (this.debugMode) println(variable +"="+ value);
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        this.stats[variable] = value;
        if (this.saveSlot == "temp") tempStatWrites[variable] = value;
    } else {
        this.temps[variable] = value;
    }
};

// *delete variable
// deletes the named variable
Scene.prototype["delete"] = function scene_delete(variable) {
    variable = variable.toLowerCase();
    if ("undefined" === typeof this.temps[variable]) {
        if ("undefined" === typeof this.stats[variable]) {
            throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
        }
        delete this.stats[variable];
    } else {
        delete this.temps[variable];
    }
};

// during a choice, recursively parse the options
Scene.prototype.parseOptions = function parseOptions(startIndent, choicesRemaining, expectedSubOptions) {
    // nextIndent: the level of indentation after the current line
    // For example, in the color/toy sample above, we start at 0
    // then the nextIndent is 2 for "red"
    // then the nextIndent is 4 for "spaceship"
    var nextIndent = null;
    var options = [];
    var line;
    var currentChoice = choicesRemaining[0];
    if (!currentChoice) currentChoice = "choice";
    var suboptionsEncountered = false;
    var bodyExpected = false;
    var previousSubOptions;
    var namesEncountered = {};
    var atLeastOneSelectableOption = false;
    var prevOption, ifResult;
    var startingLine = this.lineNum;
    function removeModifierCommand() {
      line = trim(line.replace(/^\s*\*(\w+)(.*)/, "$2"));
      parsed = /^\s*\*(\w+)(.*)/.exec(line);
      if (parsed) {
        command = parsed[1].toLowerCase();
        data = trim(parsed[2]);
      } else {
        command = "";
      }
    }
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one '" + currentChoice + "'");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            // TODO is this error test valid?
            if (choicesRemaining.length>1 && !suboptionsEncountered) {
                throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            }
            if (bodyExpected && !this.fakeChoice) {
                throw new Error(this.lineMsg() + "Expected choice body");
            }
            if (!atLeastOneSelectableOption) this.conflictingOptions("line " + (startingLine+1) + ": No selectable options");
            if (expectedSubOptions) {
                this.verifyOptionsMatch(expectedSubOptions, options);
            }
            this.rollbackLineCoverage();
            prevOption = options[options.length-1];
            if (!prevOption.endLine) prevOption.endLine = this.lineNum;
            this.lineNum--;
            this.rollbackLineCoverage();
            return options;
        }
        if (indent < this.indent) {
            // TODO drift detection
            if (false) /*(indent != nextIndent)*/ {
                // error: indentation has decreased, but not all the way back
                // Example:
                // *choice
                //     red
                //   blue
                throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
            }

            // we must be falling out of a sub-block
            this.dedent(indent);
            this.indent = indent;
        }
        if (indent > this.indent) {
            // body of the choice
            // ...unless we haven't identified our choices yet
            // TODO is this error test valid?
            if (choicesRemaining.length>1) throw new Error(this.lineMsg() + "invalid indent, there were subchoices remaining: [" + choicesRemaining.join(",") + "]");
            this.rollbackLineCoverage();
            bodyExpected = false;
            continue;
        }

        // here's the end of the previous option
        if (options.length) {
          prevOption = options[options.length-1];
          if (!prevOption.endLine) prevOption.endLine = this.lineNum;
        }

        // Execute *if commands (etc.) during option loop
        // sub-commands may modify this.indent
        var parsed = /^\s*\*(\w+)(.*)/.exec(line);
        var unselectable = false;
        var inlineIf = null;
        var selectableIf = null;
        var self = this;

        var overrideDefaultReuseSetting = false;
        var reuse = this.temps.choice_reuse;
        if (parsed) {
            var command = parsed[1].toLowerCase();
            var data = trim(parsed[2]);
            // TODO whitelist commands
            if ("hide_reuse" == command) {
              reuse = "hide";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("disable_reuse" == command) {
              reuse = "disable";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }
            if ("allow_reuse" == command) {
              reuse = "allow";
              overrideDefaultReuseSetting = true;
              removeModifierCommand();
            }

            if ("print" == command) {
                line = this.evaluateExpr(this.tokenizeExpr(data));
            } else if ("if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (ifResult) {
                inlineIf = ifResult.condition;
                if (ifResult.result) {
                  line = ifResult.line;
                } else {
                  continue;
                }
              } else {
                this["if"](data, true /*inChoice*/);
                continue;
              }
            } else if (/^(else|elseif|elsif)$/.test(command)) {
              this[command](data, true /*inChoice*/);
              continue;
            } else if ("selectable_if" == command) {
              ifResult = this.parseOptionIf(data, command);
              if (!ifResult) throw new Error(this.lineMsg() + "Couldn't parse the line after *selectable_if: " + data);
              line = ifResult.line;
              selectableIf = ifResult.condition;
              unselectable = unselectable || !ifResult.result;
            } else if ("comment" == command) {
                continue;
            } else if (!command) {
              // command was rewritten by earlier modifier
            } else {
                if (Scene.validCommands[command]) {
                  throw new Error(this.lineMsg() + "Invalid indent? Expected an #option here, not *"+command);
                }  else {
                    throw new Error(this.lineMsg() + "Non-existent command '"+command+"'");
                }
            }
        }

        if ("allow" != reuse) {
          if (!this.temps.choice_used) this.temps.choice_used = {};
          if (this.temps.choice_used[this.lineNum]) {
            if ("hide" == reuse) continue;
            unselectable = true;
          }
        }

        // this line should be a valid option
        if (!/^\s*\#\s*\S/.test(line)) {
            throw new Error(this.lineMsg() + "Expected option starting with #");
        }
        // replace variables here and discard the result, so error messages display the correct line
        this.replaceVariables(line);
        line = trim(trim(line).substring(1));
        var option = {name:line, group:currentChoice};
        if (reuse != "allow") option.reuse = reuse;
        if (this.displayOptionConditions) {
          option.displayIf = [];
          for (var i = 0; i < this.displayOptionConditions.length; i++) {
            option.displayIf[i] = this.displayOptionConditions[i];
          }
          if (inlineIf) option.displayIf.push(inlineIf);
        } else if (inlineIf) {
          option.displayIf = [inlineIf];
        }
        if (selectableIf) {
          option.selectableIf = selectableIf;
        }
        option.line = this.lineNum + 1;
        if (unselectable) {
          option.unselectable = true;
        }
        if (namesEncountered[line]) {
            this.conflictingOptions(this.lineMsg() + "Invalid option; conflicts with option '"+option.name+"' on line " + namesEncountered[line]);
        } else {
            namesEncountered[line] = option.line;
        }
        options.push(option);
        if (choicesRemaining.length>1) {
            // recursive call will modify this.indent
            option.suboptions = this.parseOptions(this.indent, choicesRemaining.slice(1), previousSubOptions);
            // now restore it
            this.indent = nextIndent;
            if (!previousSubOptions) previousSubOptions = option.suboptions;
            suboptionsEncountered = true;
        } else {
            bodyExpected = true;
        }
        if (!unselectable) atLeastOneSelectableOption = true;
    }
    if (bodyExpected && !this.fakeChoice) {
        throw new Error(this.lineMsg() + "Expected choice body");
    }
    prevOption = options[options.length-1];
    if (!prevOption.endLine) prevOption.endLine = this.lineNum;
    if (!atLeastOneSelectableOption) this.conflictingOptions("line " + (startingLine+1) + ": No selectable options");
    return options;
};

// compute *if statement during options
Scene.prototype.parseOptionIf = function parseOptionIf(data) {
  var parsed = /^\s*\((.*)\)\s+(#.*)/.exec(data);
  if (!parsed) {
    return;
  }
  var condition = parsed[1];
  var stack = this.tokenizeExpr(condition);
  var result = this.evaluateExpr(stack);
  if (this.debugMode) println(condition + " :: " + result);
  result = bool(result, this.lineNum+1);
  // In the autotester, all conditionals are enabled
  result = result || this.testPath;
  return {result:result, line:parsed[2], condition:null};
};

// Add this as a separate method so we can override it elsewhere
// We want this error during randomtest but not during autotest
// Because autotest makes impossible situations happen
Scene.prototype.conflictingOptions = function conflictingOptions(str) {
  throw new Error(str);
};

// verify that the current option set corresponds to the previous option set
// (for multichoices)
Scene.prototype.verifyOptionsMatch = function verifyOptionsMatch(prev, current) {
    // find matching option by name
    function findMatch(name, options) {
        for (var i = 0; i < options.length; i++) {
            var option = options[i];
            if (option && name == option.name) {
                return option;
            }
        }
        return null;
    }

    var prevOpt, curOpt;
    for (var i = 0; i < prev.length; i++) {
        prevOpt = prev[i];
        curOpt = findMatch(prevOpt.name, current);
        if (!curOpt) throw new Error(this.lineMsg()+"Missing expected suboption '"+prevOpt.name+"'; all suboptions must have same option list");
    }

    if (prev.length == current.length) return;

    for (i = 0; i < current.length; i++) {
        curOpt = current[i];
        prevOpt = findMatch(curOpt.name, prev);
        if (!prevOpt) throw new Error(this.lineMsg()+"Added unexpected suboption '"+curOpt.name+"'; all suboptions must have same option list");
    }

    throw new Error(this.lineMsg()+"Bug? previous options and current options mismatch, but no particular missing element");
};

// render the prompt and the radio buttons
Scene.prototype.renderOptions = function renderOptions(groups, options, callback) {
    for (var i = 0; i < options.length; i++) {
      var option = options[i];
      option.name = this.replaceVariables(option.name);
    }
    this.paragraph();
    printOptions(groups, options, callback);

    if (this.debugMode) println(toJson(this.stats));

    if (this.finished) printFooter();
};

// *page_break
// pause and prompt the user to press "Next"
Scene.prototype.page_break = function page_break(buttonName) {
    if (this.screenEmpty) return;
    if (!buttonName) buttonName = "Next";
    buttonName = this.replaceVariables(buttonName);
    this.paragraph();
    this.finished = true;

    var self = this;
    printButton(buttonName, main, false,
      function() {
        self.finished = false;
        self.resetPage();
      }
    );
    if (this.debugMode) println(toJson(this.stats));
};

// *line_break
// single line break in the middle of a paragraph
Scene.prototype.line_break = function line_break() {
    println("", this.target);
};

// *image
// display named image
Scene.prototype.image = function image(data) {
    data = data || "";
    data = this.replaceVariables(data);
    var match = /(\S+) (\S+)(.*)/.exec(data);
    var source, alignment;
    var alt = null;
    if (match) {
      var source = match[1];
      var alignment = match[2];
      var alt = trim(match[3]);
    } else {
      source = data;
    }
    alignment = alignment || "center";
    if (!/(right|left|center|none)/.test(alignment)) throw new Error(this.lineMsg()+"Invalid alignment, expected right, left, center, or none: " + data);
    printImage(source, alignment, alt);
    if (this.verifyImage) this.verifyImage(source);
};

// *sound
// play named sound file
Scene.prototype.sound = function sound(source) {
    if (typeof playSound == "function") playSound(source);
    if (this.verifyImage) this.verifyImage(source);
};

// *link
// Display URL with anchor text
Scene.prototype.link = function link(data) {
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    printLink(this.target, href, anchorText);
    this.prevLine = "text";
    this.screenEmpty = false;
};

// *link_button
// Display button that takes you to an URL
Scene.prototype.link_button = function linkButton(data) {
    if (typeof window == "undefined") return;
    var result = /^(\S+)\s*(.*)/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have an URL: " + data);
    var href = result[1];
    var anchorText = trim(result[2]) || href;
    var target = this.target;
    if (!target) target = document.getElementById('text');
    printButton(anchorText, target, false, function() {
      window.location.href = href;
    });
    this.prevLine = "empty";
    this.screenEmpty = false;
};

// how many spaces is this line indented?
Scene.prototype.getIndent = function getIndent(line) {
    if (line === null || line === undefined) return 0;
    var spaces = line.match(/^([ \t]*)/);
    if (spaces === null || spaces === undefined) return 0;
    var whitespace = spaces[0];
    var len = whitespace.length;
    if (0 === len) return 0;
    var tab = /\t/.test(whitespace);
    var space = / /.test(whitespace);
    if (tab && space) {
        throw new Error(this.lineMsg()+"Tabs and spaces appear on the same line");
    }
    if (tab) {
        this.firstTab = this.lineNum+1;
        if (this.firstSpace) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a tab, but there were spaces on line " + this.firstSpace);
        }
    } else {
        this.firstSpace = this.lineNum + 1;
        if (this.firstTab) {
            throw new Error(this.lineMsg()+"Illegal mixing of spaces and tabs; this line has a space, but there were tabs on line " + this.firstTab);
        }
    }
    return len;
};

// *comment ignorable text
Scene.prototype.comment = function comment(line) {
    if (this.debugMode) println("*comment " + line);
};

Scene.prototype.advertisement = function advertisement() {
  if (typeof isFullScreenAdvertisingSupported != "undefined" && isFullScreenAdvertisingSupported()) {
    this.finished = true;
    this.skipFooter = true;

    var self = this;
    showFullScreenAdvertisement(function() {
      self.finished = false;
      self.skipFooter = false;
      self.resetPage();
    });
  }

};

// *looplimit 5
// The number of times a given line is allowed to be accessed
Scene.prototype.looplimit = function looplimit() {}; // TODO looplimit

Scene.prototype.hide_reuse = function hide_reuse() {
  this.temps.choice_reuse = "hide";
};

Scene.prototype.disable_reuse = function disable_reuse() {
  this.temps.choice_reuse = "disable";
};

Scene.prototype.allow_reuse = function allow_reuse() {
  this.temps.choice_reuse = "allow";
};

// *label labelName
// Labels a line for use later in *goto
// Do nothing here; these labels are parsed in this.parseLabel
Scene.prototype.label = function label() {};

// *print expr
// print the value of the specified expression
Scene.prototype.print = function scene_print(expr) {
    var value = this.evaluateExpr(this.tokenizeExpr(expr));
    this.prevLine = "text";
    this.screenEmpty = false;
    this.printLine(value);
    printx(' ', this.target);
};

// *input_text var
// record text typed by the user and store it in the specified variable
Scene.prototype.input_text = function input_text(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    var inputType = "text";
    if (stack.length == 1 && stack[0].name == "VAR" && stack[0].value == "long") {
      inputType = "textarea";
    }
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, inputType, function(value) {
      safeCall(self, function() {
        value = trim(String(value));
        value = value.replace(/\n/g, "[n/]");
        if (self.nav) self.nav.bugLog.push("*input_text " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, value);
        self.resetPage();
      });
    });
    if (this.debugMode) println(toJson(this.stats));
};

// *input_number var min max
// record number typed by the user and store it in the specified variable
Scene.prototype.input_number = function input_number(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (isNaN(minimum*1)) throw new Error(this.lineMsg() + "Invalid minimum, not numeric: " + minimum);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");

    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid input_number statement, expected three args: varname min max");
    if (isNaN(maximum*1)) throw new Error(this.lineMsg() + "Invalid maximum, not numeric: " + maximum);

    if (parseFloat(minimum) > parseFloat(maximum)) throw new Error(this.lineMsg() + "Minimum " + minimum+ " should not be greater than maximum " + maximum);

    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var intRequired;
    if (isInt(minimum) && isInt(maximum)) {
      intRequired = 1;
    }
    this.finished = true;
    this.paragraph();
    var self = this;
    printInput(this.target, "number", function(value) {
      safeCall(self, function() {
        var numValue = parseFloat(""+value);
        if (isNaN(numValue)) {
          asyncAlert("Please type in a number.");
          return;
        }
        if (intRequired && !isInt(value)) {
          asyncAlert("Please type in an integer number.");
          return;
        }
        if (numValue < minimum * 1) {
          asyncAlert("Please use a number greater than or equal to " + minimum);
          return;
        }
        if (numValue > maximum * 1) {
          asyncAlert("Please use a number less than or equal to " + maximum);
          return;
        }
        if (self.nav) self.nav.bugLog.push("*input_number " + variable + " " + value);
        self.finished = false;
        self.setVar(variable, numValue);
        self.resetPage();
      });
    }, minimum, maximum, intRequired);
    if (this.debugMode) println(toJson(this.stats));
};

// *script code
// evaluate the specified ECMAScript
Scene.prototype.script = function script(code) {
    var stats = this.stats;
    var temps = this.temps;
    try {
      if (typeof window == "undefined") {
        (function() {
          var window = _global;
          eval(code);
        }).call(this);
      } else {
        eval(code);
      }
    } catch (e) {
      throw new Error(this.lineMsg() + "error executing *script: " + e + (e.stack ? "\n" + e.stack : ""));
    }
};

// is this a valid variable name?
Scene.prototype.validateVariable = function validateVariable(variable) {
    if (!variable || !/^[a-zA-Z]/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name, must start with a letter: " + variable);
    }
    if (!/^\w+$/.test(variable)) {
        throw new Error(this.lineMsg()+"Invalid variable name: '" + variable + "'");
    }
    if (/^(and|or|true|false)$/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, '" + variable + "' is a reserved word");
    if (/^choice_/.test(variable)) throw new Error(this.lineMsg()+"Invalid variable name, variables may not start with 'choice_'; this is a reserved prefix");
};

// *rand varname min max
// Set varname to a random number from min to max
//
// Example:
// *rand foo 1 6
//   roll a cube die
// *rand foo 1.0 6.0
//   compute a decimal from [1.0,6.0)
Scene.prototype.rand = function rand(data) {
    var stack = this.tokenizeExpr(data);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var minimum = this.evaluateValueToken(stack.shift(), stack);
    if (!stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var maximum = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) throw new Error(this.lineMsg() + "Invalid rand statement, expected three args: varname min max");
    var diff;

    diff = maximum - minimum;
    if (isNaN(diff)) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min and max must be numbers");
    }
    if (diff < 0) {
        throw new Error(this.lineMsg() + "Invalid rand statement, min must be less than max: " + minimum + " > " + maximum);
    }
    if (diff === 0) {
      this.setVar(variable, minimum);
      return;
    }
    function isInt(x) {
       var y=parseInt(x,10);
       if (isNaN(y)) return false;
       return x==y && x.toString()==y.toString();
    }
    var result;
    var random = Math.random();
    if (isInt(minimum) && isInt(maximum)) {
        // int random
        result = 1*minimum + Math.floor(random*(diff+1));
    } else {
        result = 1*minimum + random*diff;
    }
    this.setVar(variable, result);
    if (this.randomLog) {
      this.randomLog("*rand " + variable + " " + result);
    }
    if (this.nav) this.nav.bugLog.push("*rand " + variable + " " + result);
};

// *set varname expr
// sets the specified varname to the value of the expr
//
// Examples:
//
// literal
//     literal int: 2
//     literal decimal: 2.3
//     boolean value: true
//     quoted string: "fie"
//         with backslash escaping "she said it was \"ironic\"!"  "c:\\foo"
//     variable name: foo
//
// math
//     +: 2+2
//     -: foo-3
//     *: 2*3
//     /: 8/2
//     if one operand is a string, we'll try to parse it as a number, fail if that doesn't work
//
// fairmath
//     %+: foo%+30
//     %-: foo%-20
//
// concatenate
//     &: "foo"&bar
//
// may omit leading operand
//     *set foo +2
//     *set foo %+30
//     *set foo &"blah blah"
//
// spaces optional
//     *set foo+2
//     *set foo bar + 2
//     *set bar% +30
//
// multiple operators in one line, parentheses mandatory
//     *set foo (foo+2)/4
//     *set foo 2+(foo/2)
//     *set foo (foo/2)+(bar/3)
//     *set foo +(bar/3)
//
// set variable by reference
//
//     *set foo bar
//     *set {foo} 3
//     *comment now bar=3
Scene.prototype.set = function set(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateReference(stack);
    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }
    if (stack.length === 0) throw new Error(this.lineMsg()+"Invalid set instruction, no expression specified: " + line);
    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

// *setref variableExpr expr
// just like *set, but variableExpr is a string expression naming a variable reference
//
// Example:
// *set foo "bar"
// *setref foo 3
// *comment now bar=3
Scene.prototype.setref = function setref(line) {
    var stack = this.tokenizeExpr(line);
    var variable = this.evaluateValueToken(stack.shift(), stack);
    variable = String(variable).toLowerCase();

    if ("undefined" === typeof this.temps[variable] && "undefined" === typeof this.stats[variable]) {
      throw new Error(this.lineMsg() + "Non-existent variable '"+variable+"'");
    }

    // if the first token is an operator, then it's implicitly based on the variable
    if (/OPERATOR|FAIRMATH/.test(stack[0].name)) stack.unshift({name:"VAR", value:variable, pos:"(implicit)"});
    var value = this.evaluateExpr(stack);
    this.setVar(variable, value);
};

Scene.prototype.share_this_game = function share_links(now) {
  now = !!trim(now);
  this.paragraph();
  printShareLinks(this.target, now);
  this.prevLine = "empty"; // printShareLinks provides its own paragraph break
};

Scene.prototype.more_games = function more_games(now) {
  if (typeof window == "undefined" || typeof moreGames == "undefined") return;
  if (!!trim(now)) {
    moreGames();
    return;
  }
  var self = this;
  var target = this.target;
  if (!target) target = document.getElementById('text');
  var button = printButton("Play More Games Like This", target, false,
    function() {
      safeCall(self, moreGames);
    }
  );

  setClass(button, "");
  this.prevLine = "block";
};

Scene.prototype.ending = function ending() {
    if (typeof window == "undefined") return;
    this.paragraph();
    var groups = [""];
    options = [];
    options.push({name:"Play again.", group:"choice", restart:true});
    options.push({name:"Play more games like this.", group:"choice", moreGames:true});
    options.push({name:"Share this game with friends.", group:"choice", share:true});
    options.push({name:"Email me when new games are available.", group:"choice", subscribe:true});

    var self = this;
    function endingMenu() {
      printFollowButtons();
      self.renderOptions([""], options, function(option) {
        if (option.restart) {
          self.restart();
          return;
        } else if (option.moreGames) {
          self.more_games("now");
          if (typeof curl != "undefined") curl();
        } else if (option.share) {
          clearScreen(function() {
            self.share_this_game("now");
            endingMenu();
          });
        } else if (option.subscribe) {
          subscribeLink();
        }
      });
    }
    endingMenu();
    this.finished = true;
};

Scene.prototype.restart = function restart() {
  if (this.secondaryMode) throw new Error(this.lineMsg() + "Cannot *restart in " + this.secondaryMode + " mode");
  this.finished = true;
  delayBreakEnd();
  var self = this;
  self.reset();
  var startupScene = self.nav.getStartupScene();
  var scene = new Scene(startupScene, self.stats, self.nav, {debugMode:self.debugMode, secondaryMode:false});
  scene.resetPage();
  
};

Scene.prototype.subscribe = function scene_subscribe(now) {
  // "now" means we should immediately display the signup form
  // otherwise, we should display a Subscribe button which displays the form
  // On some platforms, "now" is impossible, so we ignore it.
  now = ("now" == now);
  this.prevLine = "block";
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  subscribe(this.target, now, function(now) {
    self.finished = false;
    // if "now" actually worked, then continue the scene
    // otherwise, reset the page before continuing
    if (now) {
      self.skipFooter = false;
      self.execute();
    } else {
      self.resetPage();
    }
  });
};

Scene.prototype.restore_game = function restore_game(data) {
  var cancelLabel;
  if (data) {
    var result = /^cancel=(\S+)$/.exec(data);
    if (!result) throw new Error(this.lineMsg() + "invalid restore_game line: " + data);
    cancelLabel = result[1];
  }
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(false/*alreadyFinished*/);
  function renderRestoreMenu(saveList, dirtySaveList) {
    self.paragraph();
    var options = [];
    for (var i = 0; i < saveList.length; i++) {
      var save = saveList[i];
      var date = new Date(save.timestamp*1);
      if (!save) continue;
      var name = "";
      if (save.temps && save.temps.choice_restore_name) name = save.temps.choice_restore_name;
      options.push({name:name + " ("+simpleDateTimeFormat(date)+")", group:"choice", state:save});
    }
    if (false) options.push({name:"Restore using a password.", group:"choice", password:true});
    options.push({name:"Retrieve saved games online from choiceofgames.com.", group:"choice", fetch:true});
    if (dirtySaveList.length) options.push({name:"Upload saved games to choiceofgames.com.", group:"choice", upload:true});
    options.push({name:"Cancel.", group:"choice", cancel:true});
    var groups = [""];
    self.renderOptions(groups, options, function(option) {
      if (option.upload) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            promptEmailAddress(this.target, defaultEmail, function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                submitDirtySaves(dirtySaveList, email, function(ok) {
                  doneLoading();
                  self.prevLine = "text"; // Put some space between the message and the option list
                  if (!ok) {
                    self.printLine("Error uploading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    var count = dirtySaveList.length + (dirtySaveList.length == 1 ? " save" : " saves");
                    self.printLine("Uploaded " + count + ".");
                    renderRestoreMenu(saveList, []);
                  }
                });
              });
            });
          });
        });
      } else if (option.fetch) {
        clearScreen(function() {
          fetchEmail(function(defaultEmail){
            self.printLine("Please type your email address to identify yourself.");
            promptEmailAddress(this.target, defaultEmail, function(cancel, email) {
              if (cancel) {
                self.finished = false;
                if (typeof cancelLabel !== "undefined") {
                  self["goto"](cancelLabel);
                }
                self.resetPage();
                return;
              }
              clearScreen(function() {
                startLoading();
                getRemoteSaves(email, function (remoteSaveList) {
                  doneLoading();
                  self.prevLine = "text";
                  if (!remoteSaveList) {
                    self.printLine("Error downloading saves. Please try again later.");
                    renderRestoreMenu(saveList, dirtySaveList);
                  } else {
                    mergeRemoteSaves(remoteSaveList, "recordDirty", function(saveList, newRemoteSaves, dirtySaveList) {
                      if (!remoteSaveList.length) {
                        self.printLine("No saves downloaded for email address \""+email+"\". (Is that the correct email address?) If you're having trouble, please contact support at "+getSupportEmail()+".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      } else {
                        var downloadCount = remoteSaveList.length + " saved " + (remoteSaveList.length == 1 ? "game" : "games");
                        var newCount = newRemoteSaves + " new saved " + (newRemoteSaves == 1 ? "game" : "games");
                        self.printLine("Synchronized " + downloadCount + ". Downloaded " + newCount + ".");
                        renderRestoreMenu(saveList, dirtySaveList);
                      }
                    });
                  }
                });
              });
            });
          });
        });
      } else if (option.password) {
        clearScreen(function() {
          self.restore_password();
        });
      } else {
        if (option.cancel) {
          self.finished = false;
          if (typeof cancelLabel !== "undefined") {
            self["goto"](cancelLabel);
          }
          self.resetPage();
        } else {
          var state = option.state;
          var sceneName = null;
          if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();
          var unrestorable = unrestorableScenes[sceneName];

          if (unrestorable) {
            asyncAlert(unrestorable);
            self.finished = false;
            self.resetPage();
            return;
          }

          saveCookie(function() {
            clearScreen(function() {
              restoreGame(state, null, /*userRestored*/true);
            });
          }, "", state.stats, state.temps, state.lineNum, state.indent, this.debugMode, this.nav);
        }
      }
    });
  }
  getDirtySaveList(function(dirtySaveList) {
    getSaves(function(saveList) {
      renderRestoreMenu(saveList, dirtySaveList);
    });
  });
};

Scene.prototype.restore_password = function restore_password() {
  var alreadyFinished = this.finished;
  this.finished = true;
  this.paragraph();
  this.printLine('Please paste your password here, then press "Next" below to continue.');
  this.prevLine = "text";
  this.paragraph();
  var self = this;
  var unrestorableScenes = this.parseRestoreGame(alreadyFinished);
  getPassword(this.target, function (cancel, password) {
    if (cancel) {
      self.finished = false;
      self.resetPage();
      return;
    }
    password = password.replace(/\s/g, "");
    password = password.replace(/^.*BEGINPASSWORD-----/, "");
    var token = self.deobfuscatePassword(password);
    token = token.replace(/^[^\{]*/, "");
    token = token.replace(/[^\}]*$/, "");
    var state;
    try {
      state = jsonParse(token);
    } catch (e) {
      asyncAlert("Sorry, that password was invalid. Please contact " + getSupportEmail() + " for assistance. Be sure to include your password in the email.");
      return;
    }

    var sceneName = null;
    if (state.stats && state.stats.sceneName) sceneName = (""+state.stats.sceneName).toLowerCase();

    var unrestorable = unrestorableScenes[sceneName];
    if (unrestorable) {
      asyncAlert(unrestorable);
      self.finished = false;
      self.resetPage();
      return;
    }

    saveCookie(function() {
      clearScreen(function() {
        // we're going to pretend not to be user restored, so we get reprompted to save
        restoreGame(state, null, /*userRestored*/false);
      });
    }, "", state.stats, state.temps, state.lineNum, state.indent, this.debugMode, this.nav);
  });
  if (alreadyFinished) printFooter();
};

Scene.prototype.parseRestoreGame = function parseRestoreGame(alreadyFinished) {
    if (alreadyFinished) {
      // if we're already finished, the printLoop bumped us an extra line ahead
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var unrestorableScenes = {};
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent > startIndent) {
                this.indent = nextIndent = indent;
            }
        }
        if (indent <= startIndent) {
            // it's over!
            if (!alreadyFinished) {
              this.lineNum--;
              this.rollbackLineCoverage();
            }
            return unrestorableScenes;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *restore_game
        //   ending You can't restore to the ending.

        line = trim(line);
        var result = /^(\w+)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should have a scene name followed by an error message: " + line);
        var sceneName = result[1].toLowerCase();
        var error = trim(result[2]);
        unrestorableScenes[sceneName] = error;
    }
    if (!alreadyFinished) {
      this.lineNum--;
      this.rollbackLineCoverage();
    }
    return unrestorableScenes;
};

Scene.prototype.check_registration = function scene_checkRegistration() {
  if (typeof window == "undefined" || typeof isRegistered == "undefined") return;
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  isRegistered(function() {
    self.finished = false;
    self.skipFooter = false;
    self.execute();
  });
};

Scene.prototype.login = function scene_login(optional) {
  if (typeof window == "undefined" || typeof loginForm == "undefined") return;
  optional = trim(optional);
  if (optional) {
    if (optional != "optional") throw new Error(this.lineMsg() + "invalid *login option: " + optional);
    optional = 1;
  }
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  this.paragraph();
  var target = this.target;
  if (!target) target = document.getElementById('text');
  loginForm(target, optional, null, function() {
    clearScreen(function() {
      self.finished = false;
      self.prevLine = "empty";
      self.screenEmpty = true;
      self.execute();
    });
  });
};

Scene.prototype.save_game = function save_game(destinationSceneName) {
  if (!destinationSceneName) throw new Error(this.lineMsg()+"*save_game requires a destination file name, e.g. *save_game Episode2");
  if (this.temps.choice_user_restored) return;
  var self = this;
  this.finished = true;
  this.skipFooter = true;
  fetchEmail(function(defaultEmail){
    self.paragraph();
    var form = document.createElement("form");
    setClass(form, "saveGame");

    form.action="#";

    var message = document.createElement("div");
    message.style.color = "red";
    message.style.fontWeight = "bold";
    form.appendChild(message);

    var saveName = document.createElement("input");
    saveName.type="text";
    saveName.name="saveName";
    saveName.setAttribute("placeholder", "Type a name for your saved game");
    saveName.setAttribute("style", "font-size: 25px; width: 90%;");
    form.appendChild(saveName);

    var hideEmailForm = false;
    // hideEmailForm = _global.automaticCloudStorage;
    if (hideEmailForm) {
      println("", form);
    } else {
      println("", form);
      println("", form);
      println("Please login to the choiceofgames.com save system with your email address below.", form);

      var emailInput = document.createElement("input");
      // This can fail on IE
      try { emailInput.type="email"; } catch (e) {}
      emailInput.name="email";
      emailInput.value=defaultEmail;
      emailInput.setAttribute("placeholder", "you@example.com");
      emailInput.setAttribute("style", "font-size: 25px; width: 90%;");
      form.appendChild(emailInput);

      println("", form);
      println("", form);

      var subscribeLabel = document.createElement("label");
      subscribeLabel.setAttribute("for", "subscribeBox");
      var subscribeBox = document.createElement("input");
      subscribeBox.type = "checkbox";
      subscribeBox.name = "subscribe";
      subscribeBox.setAttribute("id", "subscribeBox");
      subscribeBox.setAttribute("checked", true);
      subscribeLabel.appendChild(subscribeBox);
      subscribeLabel.appendChild(document.createTextNode("Email me when new games are available."));
      form.appendChild(subscribeLabel);
    }

    println("", form);
    var target = this.target;
    if (!target) target = document.getElementById('text');
    target.appendChild(form);
    printButton("Next", form, true);

    printButton("Cancel", target, false, function() {
      clearScreen(function() {
        self.finished = false;
        self.prevLine = "empty";
        self.screenEmpty = true;
        self.execute();
      });
    });

    form.onsubmit = function(e) {
      preventDefault(e);
      safeCall(this, function() {
        var messageText;
        if (!trim(saveName.value)) {
          messageText = document.createTextNode("Please type a name for your saved game.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }

        var slot = "save" + new Date().getTime();
        // create a clone stats object whose scene name is the destination scene
        var saveStats = {};
        for (var stat in self.stats) {
          if ("scene" == stat) continue;
          saveStats[stat] = self.stats[stat];
        }
        saveStats.scene = {name:destinationSceneName};

        if (hideEmailForm) {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                self.finished = false;
                self.prevLine = "empty";
                self.screenEmpty = true;
                self.execute();
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0, false, self.nav);
          });
          return;
        }

        var shouldSubscribe = subscribeBox.checked;
        var email = trim(emailInput.value);
        if (!/^\S+@\S+\.\S+$/.test(email)) {
          messageText = document.createTextNode("Sorry, \""+email+"\" is not an email address.  Please type your email address again.");
          message.innerHTML = "";
          message.appendChild(messageText);
          return;
        }
        
        recordEmail(email, function() {
          clearScreen(function() {
            saveCookie(function() {
              recordSave(slot, function() {
                startLoading();
                submitRemoteSave(slot, email, shouldSubscribe, function(ok) {
                  doneLoading();
                  if (!ok) {
                    asyncAlert("Couldn't upload your saved game to choiceofgames.com. You can try again later from the Restore menu.", function() {
                      self.finished = false;
                      self.prevLine = "empty";
                      self.screenEmpty = true;
                      self.execute();
                    });
                  } else {
                    self.finished = false;
                    self.prevLine = "empty";
                    self.screenEmpty = true;
                    self.execute();
                  }
                });
              });
            }, slot, saveStats, {choice_reuse:"allow", choice_user_restored:true, choice_restore_name:saveName.value}, 0, 0, false, self.nav);
          });
        });
      });
    };

    printFooter();
  });
};

Scene.prototype.show_password = function show_password() {
  if (this.temps.choice_user_restored) return;
  this.paragraph();
  if (typeof(window) != "undefined" && !window.isMobile) {
    this.printLine('Please copy and paste the password in a safe place, then press "Next" below to continue.');
    println("", this.target);
    println("", this.target);
  }
  var password = computeCookie(this.stats, this.temps, this.lineNum, this.indent);
  password = this.obfuscate(password);
  showPassword(this.target, password);
  this.prevLine = "block";
};

Scene.prototype.obfuscate = function obfuscate(password) {
  var self = this;
  return password.replace(/./g,
    function(x) {
      var y = self.obfuscator[x];
      return y;
    }
  );
};

// The obfuscator must take US-ASCII and obfuscate it
// for use in a password.  This password will be sent via
// HTML email and its whitespace handling will be unpredictable,
// So we can't output any of these characters: [ <>&]
// Since we're losing four characters of output, we JSON-escape
// four characters of input [^`|~].
Scene.prototype.obfuscator = {
  " ": "k",
  "!": "E",
  "\"": "`",
  "#": "\\",
  "$": "r",
  "%": "J",
  "&": "o",
  "'": "0",
  "(": "Z",
  ")": "M",
  "*": "G",
  "+": "t",
  ",": "Y",
  "-": "f",
  ".": "2",
  "/": "!",
  "0": "i",
  "1": "*",
  "2": "1",
  "3": "3",
  "4": "[",
  "5": "6",
  "6": "v",
  "7": "\"",
  "8": "F",
  "9": "9",
  ":": "{",
  ";": "Q",
  "<": "?",
  "=": "5",
  ">": "#",
  "?": "K",
  "@": "/",
  "A": "=",
  "B": "N",
  "C": "z",
  "D": "$",
  "E": "W",
  "F": "(",
  "G": ")",
  "H": "q",
  "I": "C",
  "J": "+",
  "K": "U",
  "L": ".",
  "M": "H",
  "N": "B",
  "O": "S",
  "P": "X",
  "Q": "I",
  "R": "-",
  "S": "m",
  "T": "D",
  "U": "^",
  "V": "A",
  "W": "a",
  "X": "y",
  "Y": ",",
  "Z": "d",
  "[": "O",
  "\\": "s",
  "]": "8",
  "^": "sVii6h",
  "_": "]",
  "`": "sViivi",
  "a": "4",
  "b": "g",
  "c": "%",
  "d": "w",
  "e": "h",
  "f": "n",
  "g": "b",
  "h": "7",
  "i": "x",
  "j": "~",
  "k": "_",
  "l": "l",
  "m": ":",
  "n": "c",
  "o": "L",
  "p": "j",
  "q": "u",
  "r": "R",
  "s": "}",
  "t": "p",
  "u": "V",
  "v": "P",
  "w": "'",
  "x": "T",
  "y": "|",
  "z": "@",
  "{": "e",
  "|": "sVii\"%",
  "}": ";",
  "~": "sVii\"h"
};
Scene.prototype.deobfuscator = {
  "k": " ",
  "E": "!",
  "`": "\"",
  "\\": "#",
  "r": "$",
  "J": "%",
  "o": "&",
  "0": "'",
  "Z": "(",
  "M": ")",
  "G": "*",
  "t": "+",
  "Y": ",",
  "f": "-",
  "2": ".",
  "!": "/",
  "i": "0",
  "*": "1",
  "1": "2",
  "3": "3",
  "[": "4",
  "6": "5",
  "v": "6",
  "\"": "7",
  "F": "8",
  "9": "9",
  "{": ":",
  "Q": ";",
  "?": "<",
  "5": "=",
  "#": ">",
  "K": "?",
  "/": "@",
  "=": "A",
  "N": "B",
  "z": "C",
  "$": "D",
  "W": "E",
  "(": "F",
  ")": "G",
  "q": "H",
  "C": "I",
  "+": "J",
  "U": "K",
  ".": "L",
  "H": "M",
  "B": "N",
  "S": "O",
  "X": "P",
  "I": "Q",
  "-": "R",
  "m": "S",
  "D": "T",
  "^": "U",
  "A": "V",
  "a": "W",
  "y": "X",
  ",": "Y",
  "d": "Z",
  "O": "[",
  "s": "\\",
  "8": "]",
  "]": "_",
  "4": "a",
  "g": "b",
  "%": "c",
  "w": "d",
  "h": "e",
  "n": "f",
  "b": "g",
  "7": "h",
  "x": "i",
  "~": "j",
  "_": "k",
  "l": "l",
  ":": "m",
  "c": "n",
  "L": "o",
  "j": "p",
  "u": "q",
  "R": "r",
  "}": "s",
  "p": "t",
  "V": "u",
  "P": "v",
  "'": "w",
  "T": "x",
  "|": "y",
  "@": "z",
  "e": "{",
  ";": "}"
};

Scene.prototype.deobfuscatePassword = function deobfuscatePassword(password) {
  var self = this;
  password = password.replace(/./g,
    function(x) {
      var y = self.deobfuscator[x];
      return y;
    }
  );
  return password;
};

Scene.prototype.stat_chart = function stat_chart() {
  var rows = this.parseStatChart();
  var target = this.target;
  if (!target) target = document.getElementById('text');

  if (this.prevLine == "text") println("", target);

  var barWidth = 0;
  var standardFontSize = 0;

  function fixFontSize(span1, span2) {
    if (!standardFontSize) {
      if (window.getComputedStyle) {
        standardFontSize = parseInt(getComputedStyle(document.body).fontSize, 10);
      } else if (document.body.currentStyle) {
        standardFontSize = parseInt(document.body.currentStyle.fontSize, 10);
      } else {
        standardFontSize = 16;
      }
    }
    if (!barWidth) barWidth = span1.parentNode.offsetWidth;
    var spanMaxWidth, biggestSpanWidth;
    if (span2) {
      spanMaxWidth = barWidth / 2 - 1; /* minus one as a fudge factor; why is this needed? */
      biggestSpanWidth = Math.max(span1.offsetWidth, span2.offsetWidth);
    } else {
      spanMaxWidth = barWidth;
      biggestSpanWidth = span1.offsetWidth;
    }

    if (biggestSpanWidth > spanMaxWidth) {
      var newSize = Math.floor(standardFontSize * spanMaxWidth / biggestSpanWidth);
      span1.parentNode.style.fontSize = newSize + "px";
      if (window.getComputedStyle) {
        // on Android, if the user is using non-standand styles, browser may try to ignore our font setting
        var actual = parseInt(getComputedStyle(span1).fontSize, 10);
        if (actual > newSize) {
          newSize *= newSize / actual;
          span1.parentNode.style.fontSize = newSize + "px";
        }
      }
    }

  }

  for (i = 0; i < rows.length; i++) {
    var row = rows[i];
    var type = row.type;
    var variable = row.variable;
    var value = this.evaluateExpr(this.tokenizeExpr(variable));
    var label = this.replaceVariables(row.label);
    var definition = this.replaceVariables(row.definition || "");

    var statWidth, div, span, statValue;
    if (type == "text") {
      div = document.createElement("div");
      setClass(div, "statLine");
      span = document.createElement("span");
      if (trim(label) || trim(value)) {
        printx("\u00a0\u00a0"+label + ": " + value, span);
      } else {
        // unofficial line_break
        printx(" ", span);
      }
      div.appendChild(span);
      target.appendChild(div);
    } else if (type == "percent") {
      div = document.createElement("div");
      setClass(div, "statBar statLine");
      span = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"%", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span);
    } else if (type == "opposed_pair") {
      div = document.createElement("div");
      setClass(div, "statBar statLine opposed");
      span0 = document.createElement("span");
      printx("\u00a0\u00a0"+label+": "+value+"% ", span0);
      div.appendChild(span0);
      span = document.createElement("span");
      span.setAttribute("style", "float: right");
      printx(row.opposed_label+": "+(100-value)+"%\u00a0\u00a0", span);
      div.appendChild(span);
      statValue = document.createElement("div");
      setClass(statValue, "statValue");
      statValue.style.width = value+"%";
      statValue.innerHTML = "&nbsp;";
      div.appendChild(statValue);
      target.appendChild(div);
      fixFontSize(span0, span);
    } else {
      throw new Error("Bug! Parser accepted an unknown row type: " + type);
    }
  }
  this.prevLine = "block";
  this.screenEmpty = false;
};

Scene.prototype.parseStatChart = function parseStatChart() {
    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var rows = [];
    var line, line1, line2, line2indent;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            return rows;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }

        //
        // *stat_chart
        //   text wounds Wounds
        //     Definition
        //   percent Infamy Infamy
        //     Definition
        //   opposed_pair brutality
        //     Brutality
        //       Strength and cruelty
        //     Finesse
        //       Precision and aerial maneuverability
        //

        // TODO opposed_pair
        // TODO definitions
        // TODO variable substitutions
        // TODO *if/*else
        // TODO *line_break
        line = trim(line);
        var result = /^(text|percent|opposed_pair)\s+(.*)/.exec(line);
        if (!result) throw new Error(this.lineMsg() + "invalid line; this line should start with 'percent', 'text', or 'opposed_pair'");
        var type = result[1].toLowerCase();
        var data = trim(result[2]);
        if ("opposed_pair" == type) {
          this.getVar(data);
          line1 = this.lines[++this.lineNum];
          this.replaceVariables(line1);
          line1indent = this.getIndent(line1);
          if (line1indent <= this.indent) throw new Error(this.lineMsg() + "invalid indent; expected at least one indented line to indicate opposed pair name. indent: " + line1indent + ", expected greater than " + this.indent);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // line1 was the only line
            rows.push({type: type, variable: data, label: data, opposed_label: trim(line1)});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            if (line2indent == line1indent) {
              // two lines: first label, second label
              rows.push({type: type, variable: data, label: trim(line1), opposed_label: trim(line2)});
            } else if (line2indent > line1indent) {
              // line 2 is a definition; therefore the opposed_label and its definition must be on lines 3 and 4
              var line1definition = line2;
              var line3 = this.lines[++this.lineNum];
              this.replaceVariables(line3);
              var line3indent = this.getIndent(line3);
              if (line3indent != line1indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label name. expected " + line1indent + " was " + line3indent);
              var line4 = this.lines[++this.lineNum];
              this.replaceVariables(line4);
              var line4indent = this.getIndent(line4);
              if (line4indent != line2indent) throw new Error(this.lineMsg() + "invalid indent; this line should be the opposing label definition. expected " + line2indent + " was " + line4indent);
              rows.push({type: type, variable: data, label: trim(line1), definition:trim(line2), opposed_label: trim(line3), opposed_definition: trim(line4)});
            } else {
              throw new Error(this.lineMsg() + "invalid indent; expected a second line with indent " + line1indent + " to match line " + this.lineNum + ", or else no more opposed_pair lines");
            }
          }
        } else {
          var variable, label;
          if (!/ /.test(data)) {
            variable = data;
            label = data;
          } else if (/^\(/.test(data)) {
            var parens = 0;
            var closingParen = -1;
            for (var i = 1; i < data.length; i++) {
              var c = data.charAt(i);
              if (c === "(") {
                parens++;
              } else if (c === ")") {
                if (parens) {
                  parens--;
                } else {
                  closingParen = i;
                  break;
                }
              }
            }
            if (closingParen == -1) {
              throw new Error(this.lineMsg() + "missing closing parenthesis");
            }
            variable = data.substring(1, closingParen);
            label = trim(data.substring(closingParen+1))
            if (label === "") {
              label = variable;
            }
          } else {
            result = /^(\S+) (.*)/.exec(data);
            if (!result) throw new Error(this.lineMsg() + "Bug! can't find a space when a space was found");
            variable = result[1];
            label = result[2];
          }
          this.evaluateExpr(this.tokenizeExpr(variable));
          this.replaceVariables(label);
          line2 = this.lines[this.lineNum + 1];
          line2indent = this.getIndent(line2);
          if (line2indent <= this.indent) {
            // No definition line
            rows.push({type: type, variable: variable, label: label});
          } else {
            this.lineNum++;
            this.replaceVariables(line2);
            rows.push({type: type, variable: variable, label: label, definition: trim(line2)});
          }
        }
    }
    return rows;
};

Scene.prototype.delay_break = function(durationInSeconds) {
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  this.finished = true;
  this.skipFooter = true;
  var target = this.target;
  if (!target) {
    target = document.createElement("p");
    document.getElementById('text').appendChild(target);
  }
  var self = this;
  delayBreakStart(function(delayStart) {
    var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
    showTicker(target, endTimeInSeconds, function() {
      printButton("Next", target, false, function() {
        delayBreakEnd();
        self.finished = false;
        self.resetPage();
      });
    });
    printFooter();
  });
};

Scene.prototype.delay_ending = function(data) {
  var args = data.split(/ /);
  var durationInSeconds = args[0];
  var fullPriceGuess = args[1];
  var singleUsePriceGuess = args[2];
  if (isNaN(durationInSeconds * 1)) throw new Error(this.lineMsg() + "invalid duration");
  if (!/^\$/.test(fullPriceGuess)) throw new Error(this.lineMsg() + "invalid fullPriceGuess: \""+fullPriceGuess+"\"");
  if (singleUsePriceGuess && !/^\$/.test(singleUsePriceGuess)) throw new Error(this.lineMsg() + "invalid singleUsePriceGuess: \""+singleUsePriceGuess+"\"");
  this.finished = true;
  this.skipFooter = true;
  var self = this;
  checkPurchase("adfree", function(ok, result) {
    if (result.adfree || !result.billingSupported) {
      self.ending();
      return;
    }
    getPrice("adfree", function (fullPrice) {
      if (fullPrice == "guess") fullPrice = fullPriceGuess;
      getPrice("skiponce", function (singleUsePrice) {
        if (singleUsePrice == "guess") singleUsePrice = singleUsePriceGuess;

        options = [];
        var finishedWaiting = {name: "Play again after a short wait. ", unselectable: true};
        options.push(finishedWaiting);
        var upgradeSkip = {name: "Upgrade to the unlimited version for " + fullPrice + " to skip the wait forever."};
        options.push(upgradeSkip);
        var skipOnce = {name: "Skip the wait one time for " + singleUsePrice + "."};
        if (singleUsePriceGuess) options.push(skipOnce);
        var restorePurchasesOption = {name: "Restore purchases from another device."};
        if (isRestorePurchasesSupported()) options.push(restorePurchasesOption);
        var playMoreGames = {name: "Play more games like this."};
        options.push(playMoreGames);
        var emailMe = {name: "Email me when new games are available."};
        options.push(emailMe);
        
        self.paragraph();
        printOptions([""], options, function(option) {
          if (option == playMoreGames) {
            self.more_games("now");
            if (typeof curl != "undefined") curl();
          } else if (option == emailMe) {
            subscribeLink();
          } else if (option == upgradeSkip) {
            purchase("adfree", function() {
              safeCall(self, function() {
                self.restart();
              });
            });
          } else if (option == skipOnce) {
            purchase("skiponce", function() {
              safeCall(self, function() {
                self.restart();
              });
            });
          } else if (option == restorePurchasesOption) {
            restorePurchases(function() {
              clearScreen(loadAndRestoreGame);
            });
          } else {
            self.restart();
          }
        });

        var target = document.getElementById("0").parentElement;

        delayBreakStart(function(delayStart) {
          var endTimeInSeconds = durationInSeconds * 1 + delayStart * 1;
          showTicker(target, endTimeInSeconds, function() {
            clearScreen(function() {
              self.ending();
            });
          });
          printFooter();
        });
      });
    });
  });

};

// *if booleanExpr
// execute different code depending on whether the booleanExpr is true or false
//
// Examples:
// *if bool-expression
//     blah
//     blah
// *elseif bool-expression
//     blah
//     blah
// *else
//     blah
//     blah
// bool-expression
//     by reference
//         *set foo true
//         *if foo ...
//     equality
//         foo=2
//         foo="blah"
//         2="2"
//             true
//     inequality
//         foo>2
//         foo<2
//         foo<=2
//         foo>=2
//     and/or logic, parentheses mandatory
//         (foo=2) or (foo=3)
//         ((foo>4) and (foo<8)) or (bar=0)
//
// NOTE: *if commands may be used inside *choices, to make some choices conditionally available
Scene.prototype["if"] = function scene_if(line) {
    var stack = this.tokenizeExpr(line);
    var result = this.evaluateExpr(stack);
    if (this.debugMode) println(line + " :: " + result);
    result = bool(result, this.lineNum+1);
    if (result) {
        // "true" branch, just go on to the next line
        this.indent = this.getIndent(this.nextNonBlankLine());
    } else {
        // "false" branch; skip over the true branch
        this.skipTrueBranch(false);
    }
};

// TODO Rename this function to just skipBranch
Scene.prototype.skipTrueBranch = function skipTrueBranch(inElse) {
  var self = this;
  function prevNonBlankLine() {
    var line;
    var i = self.lineNum - 1;
    while(isDefined(line = self.lines[i]) && !trim(line)) {
      i--;
    }
    return i;
  }
  var startIndent = this.indent;
  var nextIndent = null;
  while (isDefined(line = this.lines[++this.lineNum])) {
      this.rollbackLineCoverage();
      if (!trim(line)) continue;
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          if (indent <= startIndent) throw new Error(this.lineMsg() + "invalid indent, expected at least one line in 'if' true block");
          nextIndent = indent;
      }
      if (indent <= startIndent) {
          // true block is over
          var parsed;
          // check to see if this is an *else or *elseif
          if (indent == startIndent) parsed = /^\s*\*(\w+)(.*)/.exec(line);
          if (!parsed || inElse) {
              this.lineNum = prevNonBlankLine();
              this.rollbackLineCoverage();
              this.indent = indent;
              return;
          }
          var command = parsed[1].toLowerCase();
          var data = trim(parsed[2]);
          if ("else" == command) {
              if (data) {
                if (/^if\b/.test(data)) {
                  throw new Error(this.lineMsg() + "'else if' is invalid, use 'elseif'");
                }
                throw new Error(this.lineMsg() + "nothing should appear on a line after 'else': " + data);
              }
              this.lineNum = this.lineNum; // code coverage
              // go on to the next line
              this.indent = this.getIndent(this.nextNonBlankLine());
          } else if (/^else?if$/.test(command)) {
              this.lineNum = this.lineNum; // code coverage
              this["if"](data);
          } else {
              this.lineNum = prevNonBlankLine();
              this.rollbackLineCoverage();
              this.indent = this.getIndent(this.nextNonBlankLine());
          }
          return;
      }
      if (indent < nextIndent) {
          // *if foo
          //      foo
          //    bar
          throw new Error(this.lineMsg() + "invalid indent, expected "+nextIndent+", was " + indent);
      }
  }
};

Scene.prototype["else"] = Scene.prototype.elsif = Scene.prototype.elseif = function scene_else(data, inChoice) {
    if (inChoice) {
      this.skipTrueBranch(true);
      return;
    }
    throw new Error(this.lineMsg() + "It is illegal to fall in to an *else statement; you must *goto or *finish before the end of the indented block.");
};

// break the string up into a stack of tokens, defined in Scene.tokens below
Scene.prototype.tokenizeExpr = function tokenizeExpr(str) {
    var stack = [];
    var tokenTypes = Scene.tokens;
    var tokenTypesLength = tokenTypes.length;
    var pos = 0;
    while (str) {
        var matched = false;
        for (var i = 0; i < tokenTypesLength; i++) {
            var tokenType = tokenTypes[i];
            var token = tokenType.test(str, this.lineNum+1);
            if (token) {
                matched = true;
                str = str.substr(token.length);
                pos += token.length;
                if ("WHITESPACE" == tokenType.name) {
                    break;
                }
                stack.push({name:tokenType.name, value:token, pos:pos});
                break;
            }
        }
        if (!matched) throw new Error(this.lineMsg()+"Invalid expression, couldn't extract another token: " + str);
    }
    return stack;
};

// evaluate the stack of tokens
// parenthetical == true if we're evaluating a parenthetical expression
// all expressions consist of either a "singleton" value (2) or two values and one operator (2+2)
Scene.prototype.evaluateExpr = function evaluateExpr(stack, parenthetical) {
    if (!stack.length) {
        throw new Error(this.lineMsg() + "no expression specified");
    }
    var self = this;
    function getToken() {
        var token = stack.shift();
        if (!token) throw new Error(self.lineMsg() + "null token");
        return token;
    }

    var token, value1, value2, operator, result;

    value1 = this.evaluateValueToken(getToken(), stack);

    if (!stack.length) {
        if (parenthetical) {
            throw new Error(this.lineMsg() + "Invalid expression, expected final closing parenthesis");
        }
        return value1;
    }

    token = getToken();

    if (parenthetical && parenthetical == token.name) {
        return value1;
    }

    // Since this isn't a singleton, it must be an operator
    operator = Scene.operators[token.value];
    if (!operator) throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected OPERATOR, was: " + token.name + " [" + token.value + "]");

    value2 = this.evaluateValueToken(getToken(), stack);

    // and do the operator
    result = operator(value1, value2, this.lineNum+1, this);

    if (parenthetical) {
        // expect close parenthesis
        if (stack.length) {
            token = getToken();
            if (parenthetical == token.name) {
                return result;
            } else {
                throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected closing parenthesis, was: " + token.name + " [" + token.value + "]");
            }
        } else {
            throw new Error(this.lineMsg() + "Invalid expression, expected final closing parenthesis");
        }
    } else {
        // if not parenthetical, expect no more tokens
        if (stack.length) {
            token = getToken();
            throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
        } else {
            return result;
        }
    }
    throw new Error(this.lineMsg() + "bug, how did I get here?");
};

// turn a number, string, or var token into its value
// or, if this is an open parenthesis, evaluate the parenthetical expression
Scene.prototype.evaluateValueToken = function evaluateValueToken(token, stack) {
    var name = token.name;
    var value;
    if ("OPEN_PARENTHESIS" == name) {
        return this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
    } else if ("OPEN_CURLY" == name) {
        value = this.evaluateExpr(stack, "CLOSE_CURLY");
        return this.getVar(value);
    } else if ("FUNCTION" == name) {
        var functionName = /^\w+/.exec(token.value)[0];
        if (!this.functions[functionName]) throw new Error(this.lineMsg + "Unknown function " + functionName);
        value = this.evaluateExpr(stack, "CLOSE_PARENTHESIS");
        return this.functions[functionName].call(this, value);
    } else if ("NUMBER" == name) {
        return token.value;
    } else if ("STRING" == name) {
        // strip off the quotes and unescape backslashes
        return this.replaceVariables(token.value.slice(1,-1).replace(/\\(.)/g, "$1"));
    } else if ("VAR" == name) {
        var variable = String(token.value);
        while (stack.length && stack[0].name == "OPEN_SQUARE") {
          stack.shift();
          variable += "_" + this.evaluateExpr(stack, "CLOSE_SQUARE");
        }
        return this.getVar(variable);
    } else {
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected NUMBER, STRING, VAR or PARENTHETICAL, was: " + name + " [" + token.value + "]");
    }
};

// turn a var token into its name, remove it from the stack
// or if it's a curly parenthesis, evaluate that
// or if it's an array expression, convert it into its raw underscore name
Scene.prototype.evaluateReference = function evaluateReference(stack, options) {
  var toLowerCase = true;
  if (options && options.hasOwnProperty("toLowerCase")) toLowerCase = !!options.toLowerCase;
  function findClosingBracket(stack, type, offset) {
    if (!offset) offset = 0;
    var opens = 0;
    var openType = "OPEN_"+type;
    var closeType = "CLOSE_"+type;
    for (var i = offset; i < stack.length; i++) {
      if (stack[i].name == openType) {
        opens++;
      } else if (stack[i].name == closeType) {
        if (opens) {
          opens--;
        } else {
          return i;
        }
      }
    }
    return -1;
  }
  function normalizeCase(name) {
    if (toLowerCase) {
      return String(name).toLowerCase();
    } else {
      return name;
    }
  }
  if (!stack.length) throw new Error(this.lineMsg()+"Invalid expression, expected a name");
  var name;
  if (stack[0].name === "OPEN_CURLY") {
    stack.shift();
    var closingCurly = findClosingBracket(stack, "CURLY");
    if (closingCurly == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing curly bracket: " + data);
    name = this.evaluateExpr(stack.slice(0, closingCurly));
    stack.splice(0, closingCurly+1);
    return normalizeCase(name);
  } else if (stack[0].name === "NUMBER") {
    // you could have a label that's just a number
    name = stack[0].value;
    stack.shift();
    return name;
  } else {
    if (stack[0].name !== "VAR") throw new Error(this.lineMsg() + "Invalid expression; expected name, found " + stack[0].name + " at char " + stack[0].pos);
    name = String(stack[0].value);
    stack.shift();
    while(stack.length && stack[0].name == "OPEN_SQUARE") {
      var closingBracket = findClosingBracket(stack, "SQUARE", 1);
      if (closingBracket == -1) throw new Error(this.lineMsg()+"Invalid expression, no closing array bracket at char " + stack[1].pos);
      var index = this.evaluateExpr(stack.slice(1, closingBracket));
      name += "_" + index;
      stack.splice(0, closingBracket+1);
    }
    return normalizeCase(name);
  }
};

Scene.prototype.functions = {
  not: function(value) {
    return !bool(value, this.lineNum+1);
  },
  round: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"round() value is not a number: " + value);
    return Math.round(value);
  },
  timestamp: function(value) {
    return Date.parse(value)/1000;
  },
  log: function(value) {
    if (isNaN(value*1)) throw new Error(this.lineMsg()+"log() value is not a number: " + value);
    return Math.log(value)/Math.log(10);
  },
  length: function(value) {
    return String(value).length;
  }
};

Scene.prototype.evaluateValueExpr = function evaluateValueExpr(expr) {
    var stack = this.tokenizeExpr(expr);
    var token = stack.shift();
    if (!token) throw new Error(this.lineMsg() + "null token");
    var value = this.evaluateValueToken(token, stack);
    if (stack.length) {
        token = stack.shift();
        if (!token) throw new Error(this.lineMsg() + "null token");
        throw new Error(this.lineMsg() + "Invalid expression at char "+token.pos+", expected no more tokens, found: " + token.name + " [" + token.value + "]");
    }
    return value;
};

Scene.prototype.goto_random_scene = function gotoRandomScene(data) {
  var parsed = this.parseGotoRandomScene(data);
  var allowReuseGlobally = /\ballow_reuse\b/.test(data);
  var allowNoSelection = /\ballow_no_selection\b/.test(data);
  var option = this.computeRandomSelection(Math.random(), parsed, allowReuseGlobally);

  if (option) {
    this.goto_scene(option.name);
  } else {
    if (allowNoSelection) {
      return;
    } else {
      throw new Error(this.lineMsg() + "No selectable scenes");
    }
  }

};

Scene.prototype.parseGotoRandomScene = function parseGotoRandomScene(data) {
    data = data || "";
    var directives = data.split(" ");
    var allowReuseGlobally = false;
    var allowNoSelection = false;
    for (var i = 0; i < directives; i++) {
      var directive = trim(directives[i]);
      if (!directive) continue;
      if (directive == "allow_reuse") {
        allowReuseGlobally = true;
      } else if (directive == "allow_no_selection") {
        allowNoSelection = true;
      } else {
        throw new Error(this.lineMsg() + "invalid command: '" + directive + "'");
      }
    }

    // nextIndent: the level of indentation after the current line
    var nextIndent = null;
    var options = [];
    var line;
    var startIndent = this.indent;
    while(isDefined(line = this.lines[++this.lineNum])) {
        if (!trim(line)) {
            this.rollbackLineCoverage();
            continue;
        }
        var indent = this.getIndent(line);
        if (nextIndent === null || nextIndent === undefined) {
            // initialize nextIndent with whatever indentation the line turns out to be
            // ...unless it's not indented at all
            if (indent <= startIndent) {
                throw new Error(this.lineMsg() + "invalid indent, expected at least one line in *goto_random_scene");
            }
            this.indent = nextIndent = indent;
        }
        if (indent <= startIndent) {
            // it's over!
            this.rollbackLineCoverage();
            this.lineNum--;
            this.rollbackLineCoverage();
            break;
        }
        if (indent != this.indent) {
            // all chart rows are supposed to be at the same indentation level
            // anything at the wrong indentation level might be a mis-indented title/definition
            // or just a typo
            throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
        }
        line = trim(line);

        var option = {allowReuse:allowReuseGlobally};
        var command;
        while(!!(command = /^\*(\S+)/.exec(line))) {
          command = command[1];
          if ("allow_reuse" == command) {
            option.allowReuse = true;
            line = trim(line.substring("*allow_reuse".length));
            command = /^\*(\S+)/.exec(line);
            continue;
          } else if ("if" == command) {
            var conditional = /^\*if\s+\((.+)\)\s+([^\)]+)/.exec(line);
            if (!conditional) throw new Error(this.lineMsg() + " invalid *if, expected () followed by scene name: " + line);
            line = conditional[2];
            var stack = this.tokenizeExpr(conditional[1]);
            this.evaluateExpr(stack);
            option.conditional = conditional[1];
          } else {
            throw new Error(this.lineMsg() + " invalid command: " + line);
          }
        }
        // TODO weights
        option.name = trim(line);
        options.push(option);
    }
    return options;
};

Scene.prototype.computeRandomSelection = function computeRandomSelection(randomFloat, options, allowReuseGlobally) {
  var filtered = [];
  var finished = {};
  if (!allowReuseGlobally) {
    if (!this.stats.choice_grs) this.stats.choice_grs = [];
  }
  var grs = this.stats.choice_grs;
  for (var i = 0; i < grs.length; i++) {
    finished[grs[i]] = 1;
  }
  var option;
  for (i = 0; i < options.length; i++) {
    option = options[i];
    if (!option.allowReuse) {
      if (finished[option.name]) continue;
    }
    if (option.conditional) {
      var stack = this.tokenizeExpr(option.conditional);
      var pass = this.evaluateExpr(stack);
      if (!pass) continue;
    }
    filtered.push(option);
  }
  if (!filtered.length) return null;
  // TODO weights
  var randomSelection = Math.floor(randomFloat*filtered.length);
  option = filtered[randomSelection];
  if (!option.allowReuse) {
    this.stats.choice_grs.push(option.name);
  }
  return option;
};

Scene.prototype.end_trial = function endTrial() {
  this.paragraph();
  printLink(this.target, "#", "Start Over from the Beginning", function(e) {
    preventDefault(e);
    return restartGame("prompt");
  });
  this.prevLine = "block";
  this.screenEmpty = false;
  this.finished = true;
};

Scene.prototype.achieve = function scene_achieve(name) {
  name = name.toLowerCase();
  if (!this.nav.achievements.hasOwnProperty(name)) {
    throw new Error(this.lineMsg() + "the achievement name "+name+" was not declared as an *achievement in startup");
  }
  var achievement = this.nav.achievements[name];
  this.nav.achieved[name] = true;
  if (typeof window != "undefined" && typeof achieve != "undefined") {
    achieve(name, achievement.title, achievement.earnedDescription);
  }
};

Scene.prototype.check_achievements = function scene_checkAchievements() {
  var self = this;
  function callback(immediately) {
    for (var achievement in nav.achievements) {

      self.temps["choice_achieved_"+achievement] = nav.achieved.hasOwnProperty(achievement);
    }
    if (!immediately) {
      self.finished = false;
      self.skipFooter = false;
      self.execute();
    }
  }
  if (typeof checkAchievements == "undefined") {
    callback("immediately");
  } else {
    this.finished = true;
    this.skipFooter = true;
    checkAchievements(callback);
  }
};

Scene.prototype.scene_list = function scene_list() {
  var scenes = this.parseSceneList();
  this.nav.setSceneList(scenes);
};

Scene.prototype.parseSceneList = function parseSceneList() {
  var nextIndent = null;
  var scenes = [];
  var line;
  var startIndent = this.indent;
  while(isDefined(line = this.lines[++this.lineNum])) {
      if (!trim(line)) {
          this.rollbackLineCoverage();
          continue;
      }
      var indent = this.getIndent(line);
      if (nextIndent === null || nextIndent === undefined) {
          // initialize nextIndent with whatever indentation the line turns out to be
          // ...unless it's not indented at all
          if (indent <= startIndent) {
              throw new Error(this.lineMsg() + "invalid indent, expected at least one row");
          }
          this.indent = nextIndent = indent;
      }
      if (indent <= startIndent) {
          // it's over!
          this.rollbackLineCoverage();
          this.lineNum--;
          this.rollbackLineCoverage();
          return scenes;
      }
      if (indent != this.indent) {
          // all scenes are supposed to be at the same indentation level
          throw new Error(this.lineMsg() + "invalid indent, expected "+this.indent+", was " + indent);
      }

      line = trim(line);
      var purchaseMatch = /^\$(\w*)\s+(.*)/.exec(line);
      if (purchaseMatch) {
        line = purchaseMatch[2];
      }
      if (!scenes.length && "startup" != line) scenes.push("startup");
      scenes.push(line);
  }
  return scenes;
};

Scene.prototype.title = function scene_title(title) {
  if (typeof changeTitle != "undefined") {
    changeTitle(title);
  }
};

Scene.prototype.author = function scene_author(author) {
  if (typeof changeAuthor != "undefined") {
    changeAuthor(author);
  }
};

// *achievement name hidden|visible 100 Achievement Title
//     Earned description
//     Pre-earned description
Scene.prototype.achievement = function scene_achievement(data) {
  var parsed = /(\S+)\s+(\S+)\s+(\S+)\s+(.*)/.exec(data);
  if (!parsed) throw new Error(this.lineMsg() + "Invalid *achievement, requires short name, visibility, points, and display title: " + data);
  var achievementName = parsed[1];
  if (!/^[a-z][a-z0-9_]+$/.test(achievementName)) throw new Error(this.lineMsg()+"Invalid achievement name: " +achievementName);

  
  if (this.nav.achievements.hasOwnProperty(achievementName)) {
    // this achievement already exists...
    if (!this.nav.achievements[achievementName].lineNumber) {
      // blow away pre-existing mygame.js achievements
      this.nav.achievements = {};
      this.nav.achievementList = [];
    } else if (this.nav.achievements[achievementName].lineNumber != (this.lineNum+1)) {
      // don't allow redefining achievements
      // restarting/randomtest will naturally re-run *achievements; ignore those
      throw new Error(this.lineMsg()+"Achievement "+achievementName+" already defined on line " + this.nav.achievements[achievementName].lineNumber);
    }
  }

  var lineNumber = this.lineNum+1;
  var visibility = parsed[2];
  if (visibility != "hidden" && visibility != "visible") {
    throw new Error(this.lineMsg()+"Invalid *achievement, the second word should be either 'hidden' or 'visible': " +visibility);
  }
  var visible = (visibility != "hidden");
  var pointString = parsed[3];
  if (!/[1-9][0-9]*/.test(pointString)) {
    throw new Error(this.lineMsg()+"Invalid *achievement, the third word should be an integer number of points: " + pointString);
  }
  var points = parseInt(pointString, 10);
  if (points > 100) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth more than 100 points: " + points);
  if (points < 1) throw new Error(this.lineMsg()+"Invalid *achievement, no achievement may be worth less than 1 point: " + points);
  if (!this.achievementTotal) this.achievementTotal = 0;
  this.achievementTotal += points;
  if (this.achievementTotal > 1000) {
    throw new Error(this.lineMsg()+"Invalid achievements. Adding " + points + " would add up to more than 1,000 points: " + this.achievementTotal);
  }
  var title = parsed[4];
  if (/(\$\{)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement title: " + title);
  if (/(\[)/.test(title)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement title: " + title);

  // Get the description from the next indented line
  var line = this.lines[++this.lineNum];
  var indent = this.getIndent(line);
  if (!indent) {
    throw new Error(this.lineMsg()+"Invalid *achievement. An indented description is required.");
  }
  var preEarnedDescription = trim(line);
  if (/(\$\{)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + preEarnedDescription);
  if (/(\[)/.test(preEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + preEarnedDescription);

  if (!visible) {
    if (preEarnedDescription.toLowerCase() != "hidden") throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set their pre-earned description to 'hidden'.");
  }

  // Optionally get a post-earned description from the next line
  var postEarnedDescription = null;
  while(isDefined(line = this.lines[++this.lineNum])) {
    if (trim(line)) break;
    this.rollbackLineCoverage();
  }
  indent = this.getIndent(line);
  if (indent) {
    postEarnedDescription = trim(line);
    if (/(\$\{)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. ${} not permitted in achievement description: " + postEarnedDescription);
    if (/(\[)/.test(postEarnedDescription)) throw new Error(this.lineMsg()+"Invalid *achievement. [] not permitted in achievement description: " + postEarnedDescription);
  } else {
    // No indent means the next line is not a post-earned description
    this.rollbackLineCoverage();
    this.lineNum--;
    this.rollbackLineCoverage();
  }

  if (!postEarnedDescription) {
    if (!visible) throw new Error(this.lineMsg()+"Invalid *achievement. Hidden achievements must set a post-earned description.");
    postEarnedDescription = preEarnedDescription;
  }

  if (!this.nav.achievements.hasOwnProperty(achievementName)) {
    this.nav.achievementList.push(achievementName);
    if (this.nav.achievementList.length > 100) {
      throw new Error(this.lineMsg()+"Too many *achievements. Each game can have up to 100 achievements.");
    }
  }

  if (!this.seenAchievementTitles) this.seenAchievementTitles = {};

  if (this.seenAchievementTitles[title]) {
    throw new Error(this.lineMsg()+"An achievement with display title \"" + title + "\" was already defined at line " + this.seenAchievementTitles[title]);
  }

  this.seenAchievementTitles[title] = this.lineNum+1;

  this.nav.achievements[achievementName] = {
    visible: visible,
    points: points,
    title: title,
    earnedDescription: postEarnedDescription,
    preEarnedDescription: preEarnedDescription,
    lineNumber: lineNumber
  };

  if (typeof setButtonTitles != "undefined") setButtonTitles();
};


Scene.prototype.bug = function scene_bug(message) {
  if (message) {
    message = "Bug: " + this.replaceVariables(message);
  } else {
    message = "Bug";
  }
  throw new Error(this.lineMsg() + message);
};

Scene.prototype.parseTrackEvent = function(data) {
  var event = {};
  var stack = this.tokenizeExpr(data);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.category = this.evaluateValueToken(stack.shift(), stack);
  if (!stack.length) throw new Error(this.lineMsg() + "Invalid track_event statement, expected at least two args: category and action");
  event.action = this.evaluateValueToken(stack.shift(), stack);
  if (stack.length) {
    event.label = this.evaluateValueToken(stack.shift(), stack);
    if (stack.length) {
      event.value = this.evaluateValueToken(stack.shift(), stack);
      if (stack.length) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, expected at most four args: category, action, label, value");
      }
      var intValue = parseInt(event.value, 10);
      if (isNaN(intValue) || event.value != intValue || event.value.toString() != intValue.toString()) {
        throw new Error(this.lineMsg() + "Invalid track_event statement, value must be an integer: " + event.value);
      }
    }
  }
  return event;
}

Scene.prototype.track_event = function track_event(data) {
  var event = this.parseTrackEvent(data);
  if (typeof ga !== "undefined") {
    ga('send', 'event', event.category, event.action, event.label, event.value);
  }
}

Scene.prototype.lineMsg = function lineMsg() {
    return this.name + " line " + (this.lineNum+1) + ": ";
};

Scene.prototype.rollbackLineCoverage = function() {};

Scene.baseUrl = "scenes";
Scene.regexpMatch = function regexpMatch(str, re) {
    var result = re.exec(str);
    if (!result) return null;
    return result[0];
};
// Each token has a name and a test, which returns the matching string
Scene.tokens = [
    {name:"OPEN_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\(/); } },
    {name:"CLOSE_PARENTHESIS", test:function(str){ return Scene.regexpMatch(str,/^\)/); } },
    {name:"OPEN_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\{/); } },
    {name:"CLOSE_CURLY", test:function(str){ return Scene.regexpMatch(str,/^\}/); } },
    {name:"OPEN_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\[/); } },
    {name:"CLOSE_SQUARE", test:function(str){ return Scene.regexpMatch(str,/^\]/); } },
    {name:"FUNCTION", test:function(str){ return Scene.regexpMatch(str,/^(not|round|timestamp|log|length)\s*\(/); } },
    {name:"NUMBER", test:function(str){ return Scene.regexpMatch(str,/^\d+(\.\d+)?\b/); } },
    {name:"STRING", test:function(str, line) {
            var i;
            if (!/^\"/.test(str)) return null;
            for (i = 1; i < str.length; i++) {
                var x = str.charAt(i);
                if ("\\" == x) {
                    i++;
                } else if ('"' == x) {
                    return str.substring(0,i+1);
                }
            }
            throw new Error("line "+line+": Invalid string, open quote with no close quote: " + str);
        }
    },
    {name:"WHITESPACE", test:function(str){ return Scene.regexpMatch(str,/^\s+/); } },
    {name:"BOOLEAN_OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^(and|or)\b/); } },
    {name:"VAR", test:function(str){ return Scene.regexpMatch(str,/^\w*/); } },
    {name:"FAIRMATH", test:function(str){ return Scene.regexpMatch(str,/^%[\+\-]/); } },
    {name:"OPERATOR", test:function(str){ return Scene.regexpMatch(str,/^[\+\-\*\/\&\%\^\#]/); } },
    {name:"INEQUALITY", test:function(str){ return Scene.regexpMatch(str,/^[\!<>]\=?/); } },
    {name:"EQUALITY", test:function(str){ return Scene.regexpMatch(str,/^=/); } }
    //
];
Scene.operators = {
    "+": function add(v1,v2,line) { return num(v1,line) + num(v2,line); },
    "-": function subtract(v1,v2,line) { return num(v1,line) - num(v2,line); },
    "*": function multiply(v1,v2,line) { return num(v1,line) * num(v2,line); },
    "/": function divide(v1,v2,line) { return num(v1,line) / num(v2,line); },
    "%": function modulo(v1,v2,line) { return num(v1,line) % num(v2,line); },
    "^": function exponent(v1,v2,line) { return Math.pow(num(v1,line), num(v2,line)); },
    "&": function concatenate(v1,v2) { return [v1,v2].join(""); },
    "#": function charAt(v1,v2,line) {
      var i = num(v2,line);
      if (i < 1) {
        throw new Error("line "+line+": There is no character at position " + i + "; the position must be greater than or equal to 1.");
      }
      if (i > String(v1).length) {
        throw new Error("line "+line+": There is no character at position " + i + ". \""+v1+"\" is only " + String(v1).length + " characters long.");
      }
      return String(v1).charAt(i-1);
    },
    "%+": function fairAdd(v1, v2, line) {
        v1 = num(v1,line);
        v2 = num(v2,line);
        var validValue = (v1 >= 0 && v1 <= 100);
        if (!validValue) {
            throw new Error("line "+line+": Can't fairAdd to non-percentile value: " + v1);
        }
        if (v2 > 0) {
          var multiplier = (100 - v1) / 100;
          var actualModifier = v2 * multiplier;
          var value = 1 * v1 + actualModifier;
          value = Math.floor(value);
          if (value > 99) value = 99;
          return value;
        } else {
          var multiplier = v1 / 100;
          var actualModifier = (0-v2) * multiplier;
          var value = v1 - actualModifier;
          value = Math.ceil(value);
          if (value < 1) value = 1;
          return value;
        }
    },
    "%-": function fairSubtract(v1, v2, line) {
        v2 = num(v2,line);
        return Scene.operators["%+"](v1,0-v2,line);
    },
    "=": function equals(v1,v2) { return v1 == v2 || String(v1) == String(v2); },
    "<": function lessThan(v1,v2,line) {
        return num(v1,line) < num(v2,line); },
    ">": function greaterThan(v1,v2,line) { return num(v1,line) > num(v2,line); },
    "<=": function lessThanOrEquals(v1,v2,line) { return num(v1,line) <= num(v2,line); },
    ">=": function greaterThanOrEquals(v1,v2,line) { return num(v1,line) >= num(v2,line); },
    "!=": function notEquals(v1,v2) { return v1 != v2; },
    "and": function and(v1, v2, line) {
        return bool(v1,line) && bool(v2,line);
    },
    "or": function or(v1, v2, line) {
        return bool(v1,line) || bool(v2,line);
    }
};

Scene.initialCommands = {"create":1,"scene_list":1,"title":1,"author":1,"comment":1,"achievement":1};

Scene.validCommands = {"comment":1, "goto":1, "gotoref":1, "label":1, "looplimit":1, "finish":1, "abort":1,
    "choice":1, "create":1, "temp":1, "delete":1, "set":1, "setref":1, "print":1, "if":1, "rand":1,
    "page_break":1, "line_break":1, "script":1, "else":1, "elseif":1, "elsif":1, "reset":1,
    "goto_scene":1, "fake_choice":1, "input_text":1, "ending":1, "share_this_game":1, "stat_chart":1,
    "subscribe":1, "show_password":1, "gosub":1, "return":1, "hide_reuse":1, "disable_reuse":1, "allow_reuse":1,
    "check_purchase":1,"restore_purchases":1,"purchase":1,"restore_game":1,"advertisement":1,
    "save_game":1,"delay_break":1,"image":1,"link":1,"input_number":1,"goto_random_scene":1,
    "restart":1,"more_games":1,"delay_ending":1,"end_trial":1,"login":1,"achieve":1,"scene_list":1,"title":1,
    "bug":1,"link_button":1,"check_registration":1,"sound":1,"author":1,"gosub_scene":1,"achievement":1,
    "check_achievements":1,"redirect_scene":1,"print_discount":1,"purchase_discount":1,"track_event":1
    };
/*
 * Copyright 2010 by Dan Fabulich.
 * 
 * Dan Fabulich licenses this file to you under the
 * ChoiceScript License, Version 1.0 (the "License"); you may
 * not use this file except in compliance with the License. 
 * You may obtain a copy of the License at
 * 
 *  http://www.choiceofgames.com/LICENSE-1.0.txt
 * 
 * See the License for the specific language governing
 * permissions and limitations under the License.
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
 * either express or implied.
 */
function SceneNavigator(sceneList) {
    this.setSceneList(sceneList);
    this.startingStats = {};
}

SceneNavigator.prototype.setSceneList = function setSceneList(sceneList) {
    this._sceneList = sceneList;
    this._sceneMap = {};
    for (var i = 0; i < sceneList.length-1; i++) {
        var scene1 = sceneList[i];
        var scene2 = sceneList[i+1];
        this._sceneMap[scene1] = scene2;
    }
    this._startupScene = sceneList[0];
};

SceneNavigator.prototype.nextSceneName = function nextSceneName(currentSceneName) {
    var nextScene = this._sceneMap[currentSceneName];
    //if (!nextScene) throw new Error("No scene follows " + currentSceneName);
    return nextScene;
};

SceneNavigator.prototype.getStartupScene = function getStartupScene() {
    return this._startupScene;
};

SceneNavigator.prototype.setStartingStatsClone = function setStartingStatsClone(stats) {
  this.startingStats = {};
  for (var i in stats) {
    this.startingStats[i] = stats[i];
  }
};

SceneNavigator.prototype.resetStats = function resetStats(stats) {
  for (var i in stats) {
    delete stats[i];
  }
  for (i in this.startingStats) {
    stats[i] = this.startingStats[i];
  }
  this.bugLog = [];
};

SceneNavigator.prototype.repairStats = function repairStats(stats) {
  for (var i in this.startingStats) {
    var startingStat = this.startingStats[i];
    if (startingStat === null || startingStat === undefined) continue;
    if (typeof(stats[i]) === "undefined" || stats[i] === null) {
      stats[i] = this.startingStats[i];
    }
  }
};

SceneNavigator.prototype.bugLog = [];
SceneNavigator.prototype.achievements = {};
SceneNavigator.prototype.achievementList = [];
SceneNavigator.prototype.achieved = {};

SceneNavigator.prototype.loadAchievements = function(achievementArray) {
  if (!achievementArray) return;
  for (var i = 0; i < achievementArray.length; i++) {
    var achievement = achievementArray[i];
    var achievementName = achievement[0];
    var visible = achievement[1];
    var points = achievement[2];
    var title = achievement[3];
    var earnedDescription = achievement[4];
    var preEarnedDescription = achievement[5];
    this.achievements[achievementName] = {
      visible: visible,
      points: points,
      title: title,
      earnedDescription: earnedDescription,
      preEarnedDescription: preEarnedDescription
    };
    this.achievementList.push(achievementName);
  }
};nav = new SceneNavigator(["startup"]);
stats = {};

</script><style>.alertify-show,
.alertify-log {
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1); /* older webkit */
	-webkit-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	   -moz-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	    -ms-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	     -o-transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275);
	        transition: all 500ms cubic-bezier(0.175, 0.885, 0.320, 1.275); /* easeOutBack */
}
.alertify-hide {
	-webkit-transition: all 250ms cubic-bezier(0.600, 0, 0.735, 0.045); /* older webkit */
	-webkit-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	   -moz-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	    -ms-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	     -o-transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045);
	        transition: all 250ms cubic-bezier(0.600, -0.280, 0.735, 0.045); /* easeInBack */
}
.alertify-cover {
	position: fixed; z-index: 99999;
	top: 0; right: 0; bottom: 0; left: 0;
}
.alertify {
	position: fixed; z-index: 99999;
	top: 50px; left: 50%;
	width: 550px;
	margin-left: -275px;
}
	.alertify-hidden {
		top: -50px;
		visibility: hidden;
	}
.alertify-logs {
	position: fixed;
	z-index: 5000;
	bottom: 10px;
	right: 10px;
	width: 300px;
}
	.alertify-log {
		display: block;
		margin-top: 10px;
		position: relative;
		right: -300px;
	}
	.alertify-log-show {
		right: 0;
	}
	.alertify-dialog {
		padding: 25px;
	}
		.alertify-resetFocus {
			border: 0;
			clip: rect(0 0 0 0);
			height: 1px;
			margin: -1px;
			overflow: hidden;
			padding: 0;
			position: absolute;
			width: 1px;
		}
		.alertify-inner {
			text-align: center;
		}
		.alertify-text {
			margin-bottom: 15px;
			width: 100%;
			-webkit-box-sizing: border-box;
			   -moz-box-sizing: border-box;
			        box-sizing: border-box;
			font-size: 100%;
		}
		.alertify-buttons {
		}
			.alertify-button {
				/* line-height and font-size for input button */
				line-height: 1.5;
				font-size: 100%;
				display: inline-block;
				cursor: pointer;
				margin-left: 5px;
			}

@media only screen and (max-width: 680px) {
	.alertify,
	.alertify-logs {
		width: 90%;
		-webkit-box-sizing: border-box;
		   -moz-box-sizing: border-box;
		        box-sizing: border-box;
	}
	.alertify {
		left: 5%;
		margin: 0;
	}
}
/**
 * Default Look and Feel
 */
.alertify,
.alertify-log {
	font-family: sans-serif;
}
.alertify {
	background: #FFF;
	border: 10px solid #333; /* browsers that don't support rgba */
	border: 10px solid rgba(0,0,0,.7);
	border-radius: 8px;
	box-shadow: 0 3px 3px rgba(0,0,0,.3);
	-webkit-background-clip: padding;     /* Safari 4? Chrome 6? */
	   -moz-background-clip: padding;     /* Firefox 3.6 */
	        background-clip: padding-box; /* Firefox 4, Safari 5, Opera 10, IE 9 */
}
	.alertify-text {
		border: 1px solid #CCC;
		padding: 10px;
		border-radius: 4px;
	}
	.alertify-button {
		border-radius: 4px;
		color: #FFF;
		font-weight: bold;
		padding: 6px 15px;
		text-decoration: none;
		text-shadow: 1px 1px 0 rgba(0,0,0,.5);
		box-shadow: inset 0 1px 0 0 rgba(255,255,255,.5);
		background-image: -webkit-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:    -moz-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:     -ms-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:      -o-linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
		background-image:         linear-gradient(top, rgba(255,255,255,.3), rgba(255,255,255,0));
	}
	.alertify-button:hover,
	.alertify-button:focus {
		outline: none;
		box-shadow: 0 0 15px #2B72D5;
		background-image: -webkit-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:    -moz-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:     -ms-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:      -o-linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
		background-image:         linear-gradient(top, rgba(0,0,0,.1), rgba(0,0,0,0));
	}
	.alertify-button:active {
		position: relative;
		top: 1px;
	}
		.alertify-button-cancel {
			background-color: #FE1A00;
			border: 1px solid #D83526;
		}
		.alertify-button-ok {
			background-color: #5CB811;
			border: 1px solid #3B7808;
		}
		
.alertify-log {
	background: #1F1F1F;
	background: rgba(0,0,0,.9);
	padding: 15px;
	border-radius: 4px;
	color: #FFF;
	text-shadow: -1px -1px 0 rgba(0,0,0,.5);
}
	.alertify-log-error {
		background: #FE1A00;
		background: rgba(254,26,0,.9);
	}
	.alertify-log-success {
		background: #5CB811;
		background: rgba(92,184,17,.9);
	}body {
  max-width: 680px;
  _width:expression(this.scrollWidth > 680 ? "680px" : "auto");
  font-size: 100%;  /* reset for CWS */
  font: -apple-system-body; /* we'll override the font, but keep the size from iOS dynamic text sizing */
  font-family: Georgia,"Times New Roman",serif;
  background-color: #F7F4F1;
  color: rgba(0, 0, 0, 0.85);
  margin: 8px auto; 
  padding: 0 8px;
  -webkit-user-select: text; /* selectable text for Chrome app support */
}

a {
  /* colored underlined links for XULRunner support */
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}

#main {
	line-height: 1.5;
}

#text img {
  max-width: 100%;
}

.statBar {
  background-color: #949291;
  height: 2em;
  line-height: 2em;
  margin: 4px 0;
  width: 300px;
  color: #f7f4f1;
  position: relative; /* to allow absolute positioned value */
  z-index: 0;
}
.opposed {
  background-color: #6D6DFC;
}

table {
  margin-bottom: 1.5em;
}

.statBar > span, .statLine > span {
  position: relative;
  z-index: 1; /* visible over stat value */
  white-space: nowrap; /* remain on single line so we can resize font based on width */
}
.statValue {
  background-color: #ff5955;
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  z-index: -1;
  /* width will be determined at runtime, 0-100% */
}

.choice label{
    padding: 11px 8px 12px;
    display:block;
    border-color:#a9acaf;
    border-style:solid;
    border-width: 1px 1px 0px 1px
}

.choice .firstChild{
    border-top-width:1px;
    -webkit-border-top-right-radius:8px;
    -webkit-border-top-left-radius:8px;
    border-top-right-radius:8px;
    border-top-left-radius:8px;
}
/* IE doesn't support label:last-child */
.choice .lastChild{
    border-bottom-width:1px;
    -webkit-border-bottom-right-radius:8px;
    -webkit-border-bottom-left-radius:8px;
    -moz-border-radius:0px 0px 8px 8px;
    border-bottom-right-radius:8px;
    border-bottom-left-radius:8px;
}
.choice .onlyChild{
    border-width:1px;
    -webkit-border-radius:8px;
    -moz-border-radius:8px;
    border-radius:8px;
}

.choice .noBorder {
  border-width: 0;
}

input[type="radio"], input[type="checkbox"] {
  margin-right: 8px;
}

.saveGame>label {
  display:block;
}

.choice .disabled {
  color: gray;
}

input[type=password]:disabled {
  background-color: lightgray;
}

/* Reset for Firefox vs. Chrome */
input[type=email],input[type=password] {
  padding: 1px;
  margin: 2px 0;
}

.next {
    clear: both;
    display:block;
    width:100%;
    font-size:1.5em;
    font-weight:bolder;
    font-family: -apple-system, sans-serif; /* reset, for Android */
    margin-bottom: 1em; /* reset button margin */
    -webkit-appearance: none; /* Safari, don't override my CSS styles */
    color: #f7f4f1; /* Match background color */ 
    background-color: #626160;
    border: none;
    -webkit-border-radius: 0.5em;
    -moz-border-radius: 0.5em;
    border-radius: 0.5em;
    padding: 6px;
}

.next:hover {
  color: #E4DED8;
}

h1 {
  font-size: x-large;
  font-weight: normal;
}

h2 {
  font-size: large;
  font-weight: normal;
}

#identity {
  float: right;
  display: none;
}

#identity > a {
  display: block;
  text-align: end;
}

#footer {
  margin:10px 0px 75px 0px;
}

#mobileLinks a img {
  border: 0;
}

.mobileBadges {
  margin: 0;
}

.spacedLink {
  margin-right:0.5em;
}

.spacedLink:last-child {
  margin-right:0;
}

#sharelist {
  margin: 0; /* Eliminate leading space before share links */
}

#sharelist li {
  line-height: 1cm; /* Don't let the links bunch up */
}

.alertify-cover {
  background-color: black;
  filter:alpha(opacity=50);
  opacity: 0.5;
}

#greybackground {
    position: fixed;
    width:100%;
    height:100%;
    background-color: black;
    filter:alpha(opacity=50);
    opacity: 0.5;
    top:0;
    left:0;
}

.savePassword {
  font-family: monospace;
  display: block;
}

.webOnly { /* We'll override this in JavaScript */
  display: none;
}

.alignleft {
  display: inline;
  float: left;
  margin-right: 1.625em;
  margin-bottom: 1em;
}
.alignright {
  display: inline;
  float: right;
  margin-left: 1.625em;
  margin-bottom: 1em;
}
.aligncenter {
  clear: both;
  display: block;
  margin-left: auto;
  margin-right: auto;
  margin-bottom: 1em;
}

#main form {
  clear: both;
}

@media only screen and (max-width: 480px) {
  .definition{
    display: none;
  }
  
  #headerLinks {
    line-height: 2; /* For tapability */
  }

  .gameTitle {
    display: none;
  }

  #advertisement {
    margin: -8px;
  }
  
  .mobileBadges {
    float: none;
  }
  
  #header {
    margin-top: 30px;
  }

  /** Floating images should leave enough room for text */
  #text .alignleft, #text .alignright {
    max-width: 45%;
  }
  
}
</style></head>
<body>
<div id="advertisement">
</div>
<div id="header">
  <div id="identity"><a href="#" id="email">you@example.com</a><a href="#" id="logout">Sign Out</a></div>

  <h1 class='gameTitle'>Dreams and Tea Leaves</h1>
<h2 id="author" class="gameTitle"><!--by INSERTINSERTINSERT --></h2>

  <p id="headerLinks">
      <!-- <a href="credits.html" id="aboutLink" class="spacedLink">About</a> -->
    </p>
  <p id="buttons"><button id="statsButton" class="spacedLink" onclick="showStats()">Show Stats</button> <button id="restartButton" class="spacedLink" onclick="restartGame('prompt')">Restart</button> <button id="achievementsButton" onclick="showAchievements()" class="spacedLink" style="display: none">Achievements</button></p>
</div>
<div id="main">
<div id="text">
</div>
<script>
startLoading();
</script>
</div>
<div id="mobileLinks" class="webOnly">
</div>
<noscript>
<p>This game requires JavaScript; please enable JavaScript and refresh this page.</p>
</noscript>
<a href="https://www.choiceofgames.com/make-your-own-games/choicescript-intro/">Make your own games with ChoiceScript</a>
</body>
</html>
